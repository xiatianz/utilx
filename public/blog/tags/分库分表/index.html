<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>åˆ†åº“åˆ†è¡¨ | æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</title><meta name=keywords content><meta name=description content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·ï¼šåˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒ"><meta name=author content="util.cn Team"><link rel=canonical href=/blog/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.7e8505b7cdf8bb22ab2305e53c2700bb06c7e64faeb72cd3468823a9a3bd3d6e.css integrity="sha256-foUFt834uyKrIwXlPCcAuwbH5k+utyzTRogjqaO9PW4=" rel="preload stylesheet" as=style><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=apple-touch-icon href=/blog/apple-touch-icon.png><link rel=mask-icon href=/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=/blog/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/feed.xml title=rss><link rel=alternate hreflang=zh-cn href=/blog/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=/js/external-link-config.js></script><script src=/js/external-link-interceptor.js></script><link rel=stylesheet href=/blog/css/custom.css media=screen><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«","url":"https://www.util.cn/blog/","description":"æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚","publisher":{"@type":"Organization","name":"æœ‰æ¡å·¥å…·","url":"https://www.util.cn","logo":{"@type":"ImageObject","url":"https://www.util.cn/blog/logo/logo-256.png","width":256,"height":256}},"potentialAction":[{"@type":"SearchAction","target":"https://www.util.cn/blog/search?q={search_term_string}","query-input":"required name=search_term_string"}]}</script><meta property="og:type" content="website"><meta property="og:title" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta property="og:description" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚"><meta property="og:url" content="https://www.util.cn/blog/"><meta property="og:site_name" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢"><meta property="og:image" content="https://www.util.cn/blog/logo/logo-256.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta name=twitter:description content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚"><meta name=twitter:image content="https://www.util.cn/blog/logo/logo-256.png"><meta name=baidu-site-verification content><meta name=category content="æŠ€æœ¯åšå®¢,å¼€å‘è€…å·¥å…·,ç¼–ç¨‹æ•™ç¨‹"><meta name=coverage content="Worldwide"><meta name=distribution content="Global"><meta name=rating content="General"><script id=51la_code async crossorigin=anonymous src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=pro"></script><script>window.addEventListener("load",function(){setTimeout(function(){typeof la!="undefined"?console.log("51laç»Ÿè®¡å·²åŠ è½½"):(console.warn("51laç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"),function(){var e=document.createElement("script");e.src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=backup",e.async=!0,document.head.appendChild(e)}())},3e3)})</script><meta property="og:url" content="/blog/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/"><meta property="og:site_name" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·"><meta property="og:title" content="åˆ†åº“åˆ†è¡¨"><meta property="og:description" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·ï¼šåˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒ"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="åˆ†åº“åˆ†è¡¨"><meta name=twitter:description content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·ï¼šåˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒ"></head><body class=list id=top><header class=header><nav class=nav><div class=logo><a href=/blog/ accesskey=h title="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· (Alt + H)">æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=/blog/posts/ title="æ‰€æœ‰æ–‡ç« åˆ—è¡¨ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŸ¥çœ‹æ‰€æœ‰æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ–‡ç« </span></a></li><li><a href=https://www.util.cn title="æœ‰æ¡å·¥å…· - å¼€å‘è€…çš„å¸¸ç”¨å·¥å…·é›†åˆï¼šæ— å¹¿å‘Š Â· æœ¬åœ°è®¡ç®— Â· å³å¼€å³ç”¨çš„åœ¨çº¿å·¥å…·å¹³å°ï¼Œæä¾›JSONæ ¼å¼åŒ–ã€SQLæ ¼å¼åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰å®ç”¨å·¥å…·"><span>æœ‰æ¡å·¥å…·</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=/blog/categories/ title="æ–‡ç« åˆ†ç±» - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æŠ€æœ¯é¢†åŸŸåˆ†ç±»çš„ä¼˜è´¨æ–‡ç« ï¼ŒåŒ…æ‹¬å‰ç«¯å¼€å‘ã€å·¥å…·ä½¿ç”¨ã€ç¼–ç¨‹æŠ€å·§ç­‰"><span>åˆ†ç±»</span></a></li><li><a href=/blog/tags/ title="æ ‡ç­¾äº‘ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡æ ‡ç­¾å¿«é€Ÿæ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ ‡ç­¾</span></a></li><li><a href=/blog/archives/ title="æ–‡ç« å½’æ¡£ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æ—¶é—´æŸ¥çœ‹å†å²æ–‡ç« "><span>å½’æ¡£</span></a></li><li><a href=/blog/search/ title="æœç´¢æ–‡ç«  - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡å…³é”®è¯æœç´¢æ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹ï¼Œæ”¯æŒæ ‡é¢˜ã€å†…å®¹ã€åˆ†ç±»å’Œæ ‡ç­¾æœç´¢"><span>æœç´¢</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>åˆ†åº“åˆ†è¡¨</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>æ•°æ®åº“åˆ†åº“åˆ†è¡¨æ¶æ„è®¾è®¡æŒ‡å—ï¼šä»å•è¡¨åˆ°ç™¾äº¿çº§æ•°æ®çš„æ¼”è¿›ä¹‹è·¯</h2></header><div class=entry-content><p>å¼•è¨€ï¼šä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ MySQL å•è¡¨æ€§èƒ½ç“¶é¢ˆï¼š
æ•°æ®é‡ï¼šå•è¡¨è¶…è¿‡ 1000 ä¸‡è¡Œï¼ŒæŸ¥è¯¢æ€§èƒ½æ˜¾è‘—ä¸‹é™ ç´¢å¼•å¤§å°ï¼šç´¢å¼•æ ‘é«˜åº¦å¢åŠ ï¼Œç£ç›˜ I/O å¢å¤š é”ç«äº‰ï¼šé«˜å¹¶å‘ä¸‹é”ç­‰å¾…ä¸¥é‡ å¤‡ä»½æ¢å¤ï¼šå•è¡¨è¿‡å¤§ï¼Œå¤‡ä»½è€—æ—¶é•¿ åˆ†åº“åˆ†è¡¨æ˜¯çªç ´å•æœºæ•°æ®åº“ç“¶é¢ˆçš„æœ‰æ•ˆæ‰‹æ®µï¼Œä½†å®ƒä¹Ÿå¸¦æ¥äº†å¤æ‚çš„è·¯ç”±é€»è¾‘å’Œè¿ç»´æˆæœ¬ã€‚æœ¬æ–‡å°†ç³»ç»Ÿåœ°ä»‹ç»åˆ†åº“åˆ†è¡¨çš„å®è·µæ–¹æ¡ˆã€‚
ä¸€ã€å‚ç›´æ‹†åˆ† vs æ°´å¹³æ‹†åˆ† 1.1 å‚ç›´æ‹†åˆ†ï¼ˆæŒ‰ä¸šåŠ¡ç»´åº¦ï¼‰ å•ä½“æ•°æ®åº“ï¼š â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ single_database â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ user â”‚ â”‚ order â”‚ â”‚ product â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ å‚ç›´æ‹†åˆ† â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚user_db â”‚ â”‚order_db â”‚ â”‚product_dbâ”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ user â”‚ â”‚ order â”‚ â”‚ product â”‚ â”‚ profile â”‚ â”‚ payment â”‚ â”‚ inventoryâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ ä¼˜ç‚¹ï¼š
...</p></div><footer class=entry-footer><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/ class=category-link>æ¶æ„è®¾è®¡</a></div><span class=post-date>2026-01-05</span><span class=post-author>æŠ€æœ¯å›¢é˜Ÿ</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></footer><a class=entry-link aria-label="post link to æ•°æ®åº“åˆ†åº“åˆ†è¡¨æ¶æ„è®¾è®¡æŒ‡å—ï¼šä»å•è¡¨åˆ°ç™¾äº¿çº§æ•°æ®çš„æ¼”è¿›ä¹‹è·¯" href=/blog/articles/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E6%8C%87%E5%8D%97%E4%BB%8E%E5%8D%95%E8%A1%A8%E5%88%B0%E7%99%BE%E4%BA%BF%E7%BA%A7%E6%95%B0%E6%8D%AE%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B9%8B%E8%B7%AF/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>æ•°æ®åº“ä¼˜åŒ–ä¸åˆ†å¸ƒå¼å­˜å‚¨ï¼šæ„å»ºé«˜æ€§èƒ½æ•°æ®æ¶æ„</h2></header><div class=entry-content><p>å¼•è¨€ æ•°æ®æ˜¯ç°ä»£åº”ç”¨çš„æ ¸å¿ƒèµ„äº§ã€‚éšç€æ•°æ®é‡çš„çˆ†ç‚¸å¼å¢é•¿ï¼Œæ•°æ®åº“æ€§èƒ½å’Œå¯æ‰©å±•æ€§æˆä¸ºç³»ç»Ÿè®¾è®¡çš„å…³é”®æŒ‘æˆ˜ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨æ•°æ®åº“ä¼˜åŒ–æŠ€å·§å’Œåˆ†å¸ƒå¼å­˜å‚¨æ¶æ„ï¼Œå¸®åŠ©è¯»è€…æ„å»ºé«˜æ€§èƒ½çš„æ•°æ®æ¶æ„ã€‚
ä¸€ã€æ•°æ®åº“æ€§èƒ½ä¼˜åŒ– 1.1 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 -- ========== ç´¢å¼•åŸºç¡€ ========== -- 1. B-Treeç´¢å¼•ï¼ˆæœ€å¸¸ç”¨ï¼‰ -- é€‚åˆï¼šç­‰å€¼æŸ¥è¯¢ã€èŒƒå›´æŸ¥è¯¢ã€æ’åº CREATE INDEX idx_user_email ON users(email); CREATE INDEX idx_order_created ON orders(created_at); -- 2. å¤åˆç´¢å¼• -- æ³¨æ„ï¼šæœ€å·¦å‰ç¼€åŸåˆ™ CREATE INDEX idx_user_status_created ON users(status, created_at); -- æœ‰æ•ˆçš„æŸ¥è¯¢ï¼ˆèƒ½ä½¿ç”¨ç´¢å¼•ï¼‰ SELECT * FROM users WHERE status = 1 AND created_at > '2024-01-01'; SELECT * FROM users WHERE status = 1; -- æ— æ•ˆçš„æŸ¥è¯¢ï¼ˆä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼‰ SELECT * FROM users WHERE created_at > '2024-01-01'; -- 3. è¦†ç›–ç´¢å¼• -- åŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰å­—æ®µï¼Œé¿å…å›è¡¨ CREATE INDEX idx_user_cover ON users(status, created_at, id, name); -- 4. å”¯ä¸€ç´¢å¼• CREATE UNIQUE INDEX idx_user_username ON users(username); -- ========== ç´¢å¼•è®¾è®¡åŸåˆ™ ========== /* 1. é€‰æ‹©æ€§é«˜çš„å­—æ®µé€‚åˆå»ºç´¢å¼• - é«˜é€‰æ‹©æ€§ï¼šå”¯ä¸€å€¼å¤šï¼ˆå¦‚ç”¨æˆ·IDã€é‚®ç®±ï¼‰ - ä½é€‰æ‹©æ€§ï¼šé‡å¤å€¼å¤šï¼ˆå¦‚æ€§åˆ«ã€çŠ¶æ€ï¼‰ 2. WHEREã€JOINã€ORDER BYå­å¥çš„å­—æ®µ 3. å°å­—æ®µä¼˜å…ˆ - æ•´æ•° > æ—¥æœŸ > çŸ­å­—ç¬¦ä¸² > é•¿å­—ç¬¦ä¸² 4. è”åˆç´¢å¼•çš„é¡ºåº - æœ€å¸¸æŸ¥è¯¢çš„å­—æ®µæ”¾å‰é¢ - èŒƒå›´æŸ¥è¯¢å­—æ®µæ”¾åé¢ 5. é¿å…è¿‡å¤šç´¢å¼• - é™ä½å†™å…¥æ€§èƒ½ - å ç”¨å­˜å‚¨ç©ºé—´ */ -- ========== ç´¢å¼•ä¼˜åŒ–æ¡ˆä¾‹ ========== -- é—®é¢˜ï¼šæŸ¥è¯¢æ…¢ -- è€—æ—¶ï¼š2.5ç§’ SELECT * FROM orders o LEFT JOIN users u ON o.user_id = u.id WHERE o.status = 'pending' AND o.created_at > '2024-01-01' ORDER BY o.created_at DESC LIMIT 20; -- ä¼˜åŒ–1ï¼šæ·»åŠ åˆé€‚ç´¢å¼• CREATE INDEX idx_orders_status_created ON orders(status, created_at DESC); CREATE INDEX idx_orders_user_id ON orders(user_id); -- è€—æ—¶ï¼š0.3ç§’ -- ä¼˜åŒ–2ï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ SELECT o.id, o.order_no, o.total_amount, u.username FROM orders o LEFT JOIN users u ON o.user_id = u.id WHERE o.status = 'pending' AND o.created_at > '2024-01-01' ORDER BY o.created_at DESC LIMIT 20; -- è€—æ—¶ï¼š0.1ç§’ -- ä¼˜åŒ–3ï¼šä½¿ç”¨è¦†ç›–ç´¢å¼• CREATE INDEX idx_orders_cover ON orders( status, created_at DESC, id, order_no, total_amount, user_id ); -- è€—æ—¶ï¼š0.05ç§’ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 # ========== ç´¢å¼•åˆ†æä¸ç»´æŠ¤ ========== import pymysql from typing import List, Dict, Tuple class IndexAnalyzer: """ç´¢å¼•åˆ†æå™¨""" def __init__(self, connection_config: dict): self.conn = pymysql.connect(**connection_config) def analyze_table_indexes(self, table_name: str) -> List[Dict]: """åˆ†æè¡¨çš„ç´¢å¼•ä½¿ç”¨æƒ…å†µ""" with self.conn.cursor() as cursor: # æŸ¥è¯¢ç´¢å¼•ä¿¡æ¯ sql = """ SHOW INDEX FROM %s """ % table_name cursor.execute(sql) indexes = cursor.fetchall() # æŸ¥è¯¢ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡ sql = """ SELECT table_name, index_name, cardinality, column_name, seq_in_index FROM information_schema.statistics WHERE table_schema = DATABASE() AND table_name = %s ORDER BY index_name, seq_in_index """ cursor.execute(sql, (table_name,)) stats = cursor.fetchall() return { 'indexes': indexes, 'statistics': stats } def find_unused_indexes(self) -> List[Dict]: """æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•""" with self.conn.cursor() as cursor: # MySQL 5.7+ ä½¿ç”¨performance_schema sql = """ SELECT object_schema AS table_schema, object_name AS table_name, index_name FROM performance_schema.table_io_waits_summary_by_index_usage WHERE index_name IS NOT NULL AND count_star = 0 AND index_name != 'PRIMARY' ORDER BY object_schema, object_name """ cursor.execute(sql) return cursor.fetchall() def find_duplicate_indexes(self, table_name: str) -> List[Tuple]: """æŸ¥æ‰¾å†—ä½™ç´¢å¼•""" with self.conn.cursor() as cursor: # æŸ¥è¯¢ç´¢å¼•åŠå…¶åˆ— sql = """ SELECT index_name, GROUP_CONCAT(column_name ORDER BY seq_in_index) as columns FROM information_schema.statistics WHERE table_schema = DATABASE() AND table_name = %s GROUP BY index_name HAVING COUNT(*) > 1 """ cursor.execute(sql, (table_name,)) indexes = cursor.fetchall() # æŸ¥æ‰¾å†—ä½™ç´¢å¼• duplicates = [] for i, idx1 in enumerate(indexes): for idx2 in indexes[i+1:]: # æ£€æŸ¥æ˜¯å¦åŒ…å«å…³ç³» if idx2[1].startswith(idx1[1]): duplicates.append((idx1[0], idx2[0])) return duplicates def suggest_indexes(self, table_name: str) -> List[Dict]: """æ¨èç´¢å¼•""" with self.conn.cursor() as cursor: # åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿— sql = """ SELECT sql_text, count(*) as frequency FROM mysql.slow_log WHERE sql_text LIKE %s GROUP BY sql_text ORDER BY frequency DESC LIMIT 10 """ cursor.execute(sql, (f'%{table_name}%',)) slow_queries = cursor.fetchall() suggestions = [] for query, freq in slow_queries: # æå–WHEREæ¡ä»¶å­—æ®µ # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦è§£æSQL # ... suggestions.append({ 'query': query, 'frequency': freq, 'suggested_index': 'å»ºè®®åŸºäºWHEREå­å¥åˆ›å»ºç´¢å¼•' }) return suggestions 1.2 æŸ¥è¯¢ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 -- ========== SQLæŸ¥è¯¢ä¼˜åŒ– ========== -- 1. é¿å…SELECT * -- ä¸æ¨è SELECT * FROM users WHERE id = 1; -- æ¨è SELECT id, username, email FROM users WHERE id = 1; -- 2. ä½¿ç”¨LIMITé™åˆ¶ç»“æœé›† SELECT * FROM orders WHERE status = 'pending' LIMIT 100; -- 3. ä¼˜åŒ–JOIN -- å°è¡¨é©±åŠ¨å¤§è¡¨ SELECT * FROM small_table s JOIN large_table l ON s.id = l.small_id; -- 4. å­æŸ¥è¯¢ä¼˜åŒ– -- ä¸æ¨è SELECT * FROM users WHERE id IN (SELECT user_id FROM orders WHERE amount > 1000); -- æ¨è SELECT DISTINCT u.* FROM users u INNER JOIN orders o ON u.id = o.user_id WHERE o.amount > 1000; -- 5. EXISTS vs IN -- å°è¡¨ç”¨INï¼Œå¤§è¡¨ç”¨EXISTS -- å°è¡¨ SELECT * FROM users WHERE id IN (1, 2, 3); -- å¤§è¡¨ SELECT * FROM users u WHERE EXISTS ( SELECT 1 FROM orders o WHERE o.user_id = u.id AND o.status = 'pending' ); -- 6. é¿å…åœ¨WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•° -- ä¸æ¨è SELECT * FROM orders WHERE DATE(created_at) = '2024-01-01'; -- æ¨è SELECT * FROM orders WHERE created_at >= '2024-01-01' AND created_at &lt; '2024-01-02'; -- 7. ä½¿ç”¨UNION ALLä»£æ›¿UNION -- ä¸æ¨èï¼ˆå»é‡å¼€é”€å¤§ï¼‰ SELECT user_id FROM orders_2024 UNION SELECT user_id FROM orders_2023; -- æ¨è SELECT user_id FROM orders_2024 UNION ALL SELECT user_id FROM orders_2023; -- 8. æ‰¹é‡æ“ä½œ -- ä¸æ¨èï¼ˆå¤šæ¬¡å•æ¡æ’å…¥ï¼‰ INSERT INTO logs (message) VALUES ('log1'); INSERT INTO logs (message) VALUES ('log2'); INSERT INTO logs (message) VALUES ('log3'); -- æ¨è INSERT INTO logs (message) VALUES ('log1'), ('log2'), ('log3'); 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 # ========== æŸ¥è¯¢ä¼˜åŒ–å™¨ ========== import re from typing import List, Dict, Tuple class SQLQueryOptimizer: """SQLæŸ¥è¯¢ä¼˜åŒ–å™¨""" def __init__(self): self.rules = { 'select_star': self._check_select_star, 'missing_where': self._check_missing_where, 'function_in_where': self._check_function_in_where, 'subquery': self._check_subquery, 'nplus1': self._check_nplus1 } def optimize(self, sql: str) -> Dict: """ä¼˜åŒ–SQL""" issues = [] suggestions = [] for rule_name, rule_func in self.rules.items(): result = rule_func(sql) if result: issues.append(result['issue']) suggestions.append(result['suggestion']) return { 'original_sql': sql, 'issues': issues, 'suggestions': suggestions } def _check_select_star(self, sql: str) -> Dict: """æ£€æŸ¥SELECT ***""" if re.search(r'SELECT\s+\*\s+FROM', sql, re.IGNORECASE): return { 'issue': 'ä½¿ç”¨SELECT *', 'suggestion': 'åªæŸ¥è¯¢éœ€è¦çš„åˆ—ï¼Œå‡å°‘æ•°æ®ä¼ è¾“' } return None def _check_missing_where(self, sql: str) -> Dict: """æ£€æŸ¥ç¼ºå°‘WHEREæ¡ä»¶""" if re.search(r'(DELETE|UPDATE)\s+\w+\s+(?!WHERE)', sql, re.IGNORECASE): return { 'issue': 'DELETE/UPDATEç¼ºå°‘WHEREæ¡ä»¶', 'suggestion': 'æ·»åŠ WHEREæ¡ä»¶ï¼Œé¿å…å…¨è¡¨æ“ä½œ' } return None def _check_function_in_where(self, sql: str) -> Dict: """æ£€æŸ¥WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•°""" if re.search( r'WHERE\s+.*(?:DATE|YEAR|MONTH|DAY)\(', sql, re.IGNORECASE ): return { 'issue': 'WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•°', 'suggestion': 'å°†å‡½æ•°ä½œç”¨åˆ°æ¯”è¾ƒå€¼ä¸Šï¼Œè€Œéå­—æ®µ' } return None def _check_subquery(self, sql: str) -> Dict: """æ£€æŸ¥å­æŸ¥è¯¢""" if 'IN (SELECT' in sql.upper(): return { 'issue': 'ä½¿ç”¨INå­æŸ¥è¯¢', 'suggestion': 'è€ƒè™‘æ”¹ç”¨JOINæˆ–EXISTS' } return None def _check_nplus1(self, sql: str) -> Dict: """æ£€æŸ¥N+1æŸ¥è¯¢""" # è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦åˆ†ææ‰§è¡Œæ¨¡å¼ return None class QueryExecutionAnalyzer: """æŸ¥è¯¢æ‰§è¡Œåˆ†æå™¨""" def __init__(self, connection): self.conn = connection def explain_query(self, sql: str) -> Dict: """åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’""" with self.conn.cursor() as cursor: # æ‰§è¡ŒEXPLAIN explain_sql = f"EXPLAIN {sql}" cursor.execute(explain_sql) result = cursor.fetchall() analysis = { 'type': [], 'table': [], 'possible_keys': [], 'key': [], 'rows': [], 'filtered': [], 'extra': [] } for row in result: analysis['type'].append(row['type']) analysis['table'].append(row['table']) analysis['possible_keys'].append(row['possible_keys']) analysis['key'].append(row['key']) analysis['rows'].append(row['rows']) analysis['filtered'].append(row['filtered']) analysis['extra'].append(row['Extra']) # åˆ†æç»“æœ suggestions = [] # æ£€æŸ¥æ˜¯å¦å…¨è¡¨æ‰«æ if 'ALL' in analysis['type']: suggestions.append( 'è­¦å‘Šï¼šå­˜åœ¨å…¨è¡¨æ‰«æï¼Œè€ƒè™‘æ·»åŠ ç´¢å¼•' ) # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†ç´¢å¼• if None in analysis['key']: suggestions.append( 'éƒ¨åˆ†æŸ¥è¯¢æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œæ£€æŸ¥ç´¢å¼•è®¾è®¡' ) # æ£€æŸ¥æ‰«æè¡Œæ•° if analysis['rows'] and sum(analysis['rows']) > 10000: suggestions.append( 'æ‰«æè¡Œæ•°è¾ƒå¤šï¼Œè€ƒè™‘ä¼˜åŒ–æŸ¥è¯¢æˆ–ç´¢å¼•' ) return { 'explain_plan': result, 'suggestions': suggestions } def profile_query(self, sql: str) -> Dict: """åˆ†ææŸ¥è¯¢æ€§èƒ½""" with self.conn.cursor() as cursor: # å¼€å¯profiling cursor.execute("SET profiling = 1") # æ‰§è¡ŒæŸ¥è¯¢ cursor.execute(sql) # è·å–profilingç»“æœ cursor.execute("SHOW PROFILE") profile = cursor.fetchall() # è·å–æŸ¥è¯¢ç»Ÿè®¡ cursor.execute("SHOW PROFILE FOR QUERY 1") stats = cursor.fetchall() return { 'profile': profile, 'statistics': stats } äºŒã€åˆ†åº“åˆ†è¡¨ç­–ç•¥ 2.1 æ°´å¹³åˆ†è¡¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 # ========== åˆ†è¡¨ç­–ç•¥ ========== class ShardingStrategy: """åˆ†ç‰‡ç­–ç•¥""" def __init__(self, shard_count: int): self.shard_count = shard_count def hash_sharding(self, key: str) -> int: """å“ˆå¸Œåˆ†ç‰‡""" hash_value = hash(key) return hash_value % self.shard_count def range_sharding(self, key: int) -> int: """èŒƒå›´åˆ†ç‰‡""" # å‡è®¾keyæ˜¯è‡ªå¢ID shard_size = 1000000 # æ¯ä¸ªåˆ†ç‰‡100ä¸‡æ¡ return key // shard_size def modulo_sharding(self, key: int) -> int: """å–æ¨¡åˆ†ç‰‡""" return key % self.shard_count def consistent_hash_sharding(self, key: str) -> int: """ä¸€è‡´æ€§å“ˆå¸Œåˆ†ç‰‡""" import hashlib hash_value = int(hashlib.md5(key.encode()).hexdigest(), 16) return hash_value % self.shard_count class ShardingManager: """åˆ†ç‰‡ç®¡ç†å™¨""" def __init__(self, shard_configs: List[dict]): self.shards = {} for config in shard_configs: shard_id = config['id'] self.shards[shard_id] = { 'connection': self._create_connection(config), 'config': config } self.strategy = ShardingStrategy(len(shard_configs)) def _create_connection(self, config: dict): """åˆ›å»ºæ•°æ®åº“è¿æ¥""" import pymysql return pymysql.connect( host=config['host'], port=config['port'], user=config['user'], password=config['password'], database=config['database'] ) def get_shard(self, shard_key: str, sharding_type: str = 'hash'): """è·å–åˆ†ç‰‡è¿æ¥""" if sharding_type == 'hash': shard_id = self.strategy.hash_sharding(shard_key) elif sharding_type == 'consistent': shard_id = self.strategy.consistent_hash_sharding(shard_key) elif sharding_type == 'modulo': shard_id = self.strategy.modulo_sharding(int(shard_key)) else: raise ValueError(f"Unknown sharding type: {sharding_type}") return self.shards[shard_id]['connection'] def execute_on_shard(self, shard_key: str, sql: str, params=None): """åœ¨æŒ‡å®šåˆ†ç‰‡æ‰§è¡ŒSQL""" conn = self.get_shard(shard_key) with conn.cursor() as cursor: cursor.execute(sql, params or ()) return cursor.fetchall() def query_all_shards(self, sql: str, params=None): """æŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡""" results = [] for shard_id, shard in self.shards.items(): conn = shard['connection'] with conn.cursor() as cursor: cursor.execute(sql, params or ()) shard_results = cursor.fetchall() # æ·»åŠ åˆ†ç‰‡æ ‡è¯† for row in shard_results: if isinstance(row, dict): row['_shard_id'] = shard_id results.extend(shard_results) return results def broadcast_write(self, sql: str, params=None): """å¹¿æ’­å†™å…¥æ‰€æœ‰åˆ†ç‰‡""" results = [] for shard_id, shard in self.shards.items(): conn = shard['connection'] with conn.cursor() as cursor: cursor.execute(sql, params or ()) conn.commit() results.append({ 'shard_id': shard_id, 'affected_rows': cursor.rowcount }) return results # ========== åˆ†è¡¨è·¯ç”± ========== class TableRouter: """è¡¨è·¯ç”±""" def __init__(self, sharding_manager: ShardingManager): self.manager = sharding_manager self.table_rules = {} def add_rule(self, table_name: str, sharding_key: str, sharding_type: str): """æ·»åŠ åˆ†è¡¨è§„åˆ™""" self.table_rules[table_name] = { 'sharding_key': sharding_key, 'sharding_type': sharding_type } def get_table_name(self, original_table: str, shard_key: str) -> str: """è·å–å®é™…è¡¨å""" rule = self.table_rules.get(original_table) if not rule: return original_table # è®¡ç®—åˆ†ç‰‡ID if rule['sharding_type'] == 'hash': shard_id = hash(shard_key) % self.manager.strategy.shard_count elif rule['sharding_type'] == 'modulo': shard_id = int(shard_key) % self.manager.strategy.shard_count else: shard_id = 0 return f"{original_table}_{shard_id:04d}" def execute_query(self, table_name: str, query_template: str, **kwargs): """æ‰§è¡Œåˆ†è¡¨æŸ¥è¯¢""" # è·å–åˆ†ç‰‡é”®å€¼ rule = self.table_rules.get(table_name) if not rule: # ä¸åˆ†è¡¨ï¼Œç›´æ¥æ‰§è¡Œ return self.manager.execute_on_shard('0', query_template, kwargs) shard_key_value = kwargs.get(rule['sharding_key']) if not shard_key_value: raise ValueError(f"Missing sharding key: {rule['sharding_key']}") # è·å–å®é™…è¡¨å actual_table = self.get_table_name(table_name, str(shard_key_value)) # æ›¿æ¢è¡¨å actual_query = query_template.replace(f'FROM {table_name}', f'FROM {actual_table}') return self.manager.execute_on_shard(str(shard_key_value), actual_query, kwargs) # ä½¿ç”¨ç¤ºä¾‹ shard_configs = [ { 'id': 0, 'host': 'db0.example.com', 'port': 3306, 'user': 'root', 'password': 'password', 'database': 'app_db_0' }, { 'id': 1, 'host': 'db1.example.com', 'port': 3306, 'user': 'root', 'password': 'password', 'database': 'app_db_1' }, { 'id': 2, 'host': 'db2.example.com', 'port': 3306, 'user': 'root', 'password': 'password', 'database': 'app_db_2' }, { 'id': 3, 'host': 'db3.example.com', 'port': 3306, 'user': 'root', 'password': 'password', 'database': 'app_db_3' } ] sharding_manager = ShardingManager(shard_configs) table_router = TableRouter(sharding_manager) # é…ç½®ordersè¡¨æŒ‰user_idåˆ†è¡¨ table_router.add_rule('orders', 'user_id', 'modulo') # æ’å…¥è®¢å•ï¼ˆè‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®çš„åˆ†ç‰‡ï¼‰ table_router.execute_query( 'orders', "INSERT INTO orders (user_id, order_no, total_amount) VALUES (:user_id, :order_no, :total_amount)", user_id=12345, order_no='ORD2024010112345', total_amount=9999.99 ) # æŸ¥è¯¢è®¢å•ï¼ˆè‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®çš„åˆ†ç‰‡ï¼‰ results = table_router.execute_query( 'orders', "SELECT * FROM orders WHERE user_id = :user_id", user_id=12345 ) 2.2 å‚ç›´åˆ†åº“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 # ========== å‚ç›´åˆ†åº“ç­–ç•¥ ========== class VerticalSharding: """å‚ç›´åˆ†åº“""" def __init__(self): self.databases = { 'user_db': None, # ç”¨æˆ·ç›¸å…³è¡¨ 'order_db': None, # è®¢å•ç›¸å…³è¡¨ 'product_db': None, # å•†å“ç›¸å…³è¡¨ 'log_db': None # æ—¥å¿—ç›¸å…³è¡¨ } def route_by_module(self, table_name: str): """æŒ‰æ¨¡å—è·¯ç”±""" module_mapping = { # ç”¨æˆ·æ¨¡å— 'users': 'user_db', 'user_profiles': 'user_db', 'user_addresses': 'user_db', 'user_preferences': 'user_db', # è®¢å•æ¨¡å— 'orders': 'order_db', 'order_items': 'order_db', 'order_payments': 'order_db', 'order_shippings': 'order_db', # å•†å“æ¨¡å— 'products': 'product_db', 'categories': 'product_db', 'product_skus': 'product_db', 'inventory': 'product_db', # æ—¥å¿—æ¨¡å— 'operation_logs': 'log_db', 'access_logs': 'log_db', 'error_logs': 'log_db' } return self.databases.get(module_mapping.get(table_name)) def cross_database_query(self, queries: List[dict]): """è·¨åº“æŸ¥è¯¢""" results = {} for query_info in queries: db_name = query_info['database'] sql = query_info['sql'] params = query_info.get('params', {}) conn = self.databases[db_name] with conn.cursor() as cursor: cursor.execute(sql, params) results[db_name] = cursor.fetchall() # åœ¨åº”ç”¨å±‚åˆå¹¶ç»“æœ return self._merge_results(results) def _merge_results(self, results: dict) -> List[dict]: """åˆå¹¶è·¨åº“æŸ¥è¯¢ç»“æœ""" # æ ¹æ®ä¸šåŠ¡é€»è¾‘åˆå¹¶ç»“æœ # è¿™é‡Œæ˜¯ç®€åŒ–ç¤ºä¾‹ merged = [] # ä»user_dbè·å–ç”¨æˆ·ä¿¡æ¯ users = results.get('user_db', []) # ä»order_dbè·å–è®¢å•ä¿¡æ¯ orders = results.get('order_db', []) # åˆå¹¶æ•°æ® user_dict = {user['id']: user for user in users} for order in orders: user_id = order['user_id'] if user_id in user_dict: merged.append({ **user_dict[user_id], 'order': order }) return merged # ========== åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSagaæ¨¡å¼ï¼‰ ========== class DistributedTransaction: """åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†å™¨""" def __init__(self): self.participants = [] self.compensations = [] def add_participant(self, database: str, operation: str, compensation: str): """æ·»åŠ äº‹åŠ¡å‚ä¸è€…""" self.participants.append({ 'database': database, 'operation': operation }) self.compensations.append({ 'database': database, 'operation': compensation }) async def execute(self) -> bool: """æ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡""" executed = [] try: # é¡ºåºæ‰§è¡Œå„åˆ†åº“æ“ä½œ for participant in self.participants: conn = self.databases[participant['database']] with conn.cursor() as cursor: cursor.execute(participant['operation']) conn.commit() executed.append(participant) return True except Exception as e: # æ‰§è¡Œè¡¥å¿æ“ä½œ for i in range(len(executed) - 1, -1, -1): compensation = self.compensations[i] try: conn = self.databases[compensation['database']] with conn.cursor() as cursor: cursor.execute(compensation['operation']) conn.commit() except Exception as ce: # è¡¥å¿å¤±è´¥ï¼Œè®°å½•æ—¥å¿— print(f"Compensation failed: {ce}") return False ä¸‰ã€åˆ†å¸ƒå¼æ•°æ®åº“ 3.1 NewSQLæ•°æ®åº“ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 # ========== TiDBé›†æˆç¤ºä¾‹ ========== import MySQLdb class TiDBClient: """TiDBå®¢æˆ·ç«¯""" def __init__(self, host: str, port: int, user: str, password: str, database: str): self.conn = MySQLdb.connect( host=host, port=port, user=user, password=password, database=database, charset='utf8mb4' ) def insert_batch(self, table: str, records: List[dict]) -> int: """æ‰¹é‡æ’å…¥""" if not records: return 0 # æ„å»ºæ‰¹é‡æ’å…¥SQL columns = list(records[0].keys()) placeholders = ', '.join(['%s'] * len(columns)) sql = f""" INSERT INTO {table} ({', '.join(columns)}) VALUES ({placeholders}) """ values = [ tuple(record[col] for col in columns) for record in records ] with self.conn.cursor() as cursor: cursor.executemany(sql, values) self.conn.commit() return cursor.rowcount def select_with_pagination( self, table: str, where: str = None, order_by: str = None, limit: int = 100, offset: int = 0 ) -> List[dict]: """åˆ†é¡µæŸ¥è¯¢""" sql = f"SELECT * FROM {table}" if where: sql += f" WHERE {where}" if order_by: sql += f" ORDER BY {order_by}" sql += f" LIMIT {limit} OFFSET {offset}" with self.conn.cursor(MySQLdb.cursors.DictCursor) as cursor: cursor.execute(sql) return cursor.fetchall() def get_transaction_info(self) -> dict: """è·å–äº‹åŠ¡ä¿¡æ¯""" with self.conn.cursor() as cursor: # æŸ¥è¯¢å½“å‰äº‹åŠ¡ä¿¡æ¯ cursor.execute("SELECT @@txn_version as version") version = cursor.fetchone() cursor.execute("SELECT @@autocommit as autocommit") autocommit = cursor.fetchone() return { 'version': version[0] if version else None, 'autocommit': autocommit[0] if autocommit else None } # ========== åˆ†å¸ƒå¼äº‹åŠ¡ä½¿ç”¨ ========== class DistributedOrderService: """åˆ†å¸ƒå¼è®¢å•æœåŠ¡""" def __init__(self, tidb_client: TiDBClient): self.tidb = tidb_client async def create_order(self, order_data: dict, items: List[dict]) -> str: """åˆ›å»ºè®¢å•ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰""" try: # å¼€å¯äº‹åŠ¡ with self.tidb.conn as cursor: # 1. åˆ›å»ºè®¢å• order_sql = """ INSERT INTO orders (user_id, order_no, total_amount, status) VALUES (%s, %s, %s, %s) """ cursor.execute(order_sql, ( order_data['user_id'], order_data['order_no'], order_data['total_amount'], 'pending' )) order_id = cursor.lastrowid # 2. åˆ›å»ºè®¢å•æ˜ç»† for item in items: item_sql = """ INSERT INTO order_items ( order_id, product_id, quantity, price ) VALUES (%s, %s, %s, %s) """ cursor.execute(item_sql, ( order_id, item['product_id'], item['quantity'], item['price'] )) # 3. æ‰£å‡åº“å­˜ for item in items: inventory_sql = """ UPDATE inventory SET stock = stock - %s WHERE product_id = %s AND stock >= %s """ affected = cursor.execute(inventory_sql, ( item['quantity'], item['product_id'], item['quantity'] )) if affected == 0: # åº“å­˜ä¸è¶³ï¼Œå›æ»šäº‹åŠ¡ raise Exception(f"Insufficient stock for product {item['product_id']}") # 4. åˆ›å»ºæ”¯ä»˜è®°å½• payment_sql = """ INSERT INTO payments ( order_id, amount, status, payment_method ) VALUES (%s, %s, %s, %s) """ cursor.execute(payment_sql, ( order_id, order_data['total_amount'], 'pending', order_data['payment_method'] )) # æäº¤äº‹åŠ¡ self.tidb.conn.commit() return order_id except Exception as e: # å›æ»šäº‹åŠ¡ self.tidb.conn.rollback() raise e 3.2 åˆ†å¸ƒå¼ç¼“å­˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 # ========== Redisé›†ç¾¤ ========== import redis from rediscluster import RedisCluster class RedisClusterClient: """Redisé›†ç¾¤å®¢æˆ·ç«¯""" def __init__(self, startup_nodes: List[dict]): """ startup_nodes: [ {'host': 'redis1.example.com', 'port': 7000}, {'host': 'redis2.example.com', 'port': 7001}, {'host': 'redis3.example.com', 'port': 7002} ] """ self.client = RedisCluster( startup_nodes=startup_nodes, decode_responses=True, skip_full_coverage_check=True, max_connections=32 ) def set(self, key: str, value: str, expire: int = None): """è®¾ç½®é”®å€¼""" return self.client.set(key, value, ex=expire) def get(self, key: str) -> str: """è·å–å€¼""" return self.client.get(key) def mget(self, keys: List[str]) -> List[str]: """æ‰¹é‡è·å–""" return self.client.mget(keys) def delete(self, *keys: str): """åˆ é™¤é”®""" return self.client.delete(*keys) def exists(self, *keys: str) -> int: """æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨""" return self.client.exists(*keys) def expire(self, key: str, seconds: int): """è®¾ç½®è¿‡æœŸæ—¶é—´""" return self.client.expire(key, seconds) def incr(self, key: str, amount: int = 1) -> int: """é€’å¢""" return self.client.incrby(key, amount) def decr(self, key: str, amount: int = 1) -> int: """é€’å‡""" return self.client.decrby(key, amount) def hset(self, name: str, key: str, value: str): """å“ˆå¸Œè¡¨è®¾ç½®""" return self.client.hset(name, key, value) def hget(self, name: str, key: str) -> str: """å“ˆå¸Œè¡¨è·å–""" return self.client.hget(name, key) def hgetall(self, name: str) -> dict: """è·å–æ•´ä¸ªå“ˆå¸Œè¡¨""" return self.client.hgetall(name) # ========== ç¼“å­˜ç­–ç•¥ ========== class CacheStrategy: """ç¼“å­˜ç­–ç•¥""" def __init__(self, redis_client: RedisClusterClient): self.redis = redis_client def cache_aside(self, key: str, load_func, expire: int = 3600): """Cache-Asideæ¨¡å¼""" # å…ˆæŸ¥ç¼“å­˜ value = self.redis.get(key) if value is not None: return value # ç¼“å­˜æœªå‘½ä¸­ï¼ŒåŠ è½½æ•°æ® value = load_func() # å†™å…¥ç¼“å­˜ self.redis.set(key, value, expire) return value def invalidate(self, *keys: str): """ä½¿ç¼“å­˜å¤±æ•ˆ""" self.redis.delete(*keys) def warm_up(self, data: dict, expire: int = 3600): """ç¼“å­˜é¢„çƒ­""" pipe = self.redis.client.pipeline() for key, value in data.items(): pipe.set(key, value, expire) pipe.execute() def update(self, key: str, value: str, expire: int = 3600): """æ›´æ–°ç¼“å­˜""" self.redis.set(key, value, expire) # ========== åˆ†å¸ƒå¼é” ========== class DistributedLock: """åˆ†å¸ƒå¼é”""" def __init__(self, redis_client: RedisClusterClient): self.redis = redis_client def acquire( self, lock_name: str, acquire_timeout: int = 10, lock_timeout: int = 30 ) -> bool: """è·å–é”""" import time lock_key = f"lock:{lock_name}" lock_value = f"{time.time()}" end_time = time.time() + acquire_timeout while time.time() &lt; end_time: # å°è¯•è·å–é” if self.redis.client.set( lock_key, lock_value, nx=True, ex=lock_timeout ): return True time.sleep(0.001) return False def release(self, lock_name: str): """é‡Šæ”¾é”""" lock_key = f"lock:{lock_name}" # ä½¿ç”¨Luaè„šæœ¬ç¡®ä¿åªé‡Šæ”¾è‡ªå·±çš„é” lua_script = """ if redis.call("get", KEYS[1]) == ARGV[1] then return redis.call("del", KEYS[1]) else return 0 end """ self.redis.client.eval( lua_script, 1, lock_key, self.redis.get(lock_key) ) # ========== é™æµå™¨ ========== class RateLimiter: """åˆ†å¸ƒå¼é™æµå™¨""" def __init__(self, redis_client: RedisClusterClient): self.redis = redis_client def is_allowed( self, key: str, limit: int, window: int ) -> bool: """ æ»‘åŠ¨çª—å£é™æµ key: é™æµé”®ï¼ˆå¦‚ç”¨æˆ·IDã€IPç­‰ï¼‰ limit: æ—¶é—´çª—å£å†…æœ€å¤§è¯·æ±‚æ•° window: æ—¶é—´çª—å£ï¼ˆç§’ï¼‰ """ import time now = time.time() window_start = now - window pipe = self.redis.client.pipeline() # ç§»é™¤æ—¶é—´çª—å£å¤–çš„è®°å½• pipe.zremrangebyscore(key, 0, window_start) # è·å–å½“å‰è®¡æ•° pipe.zcard(key) # æ·»åŠ å½“å‰è¯·æ±‚ pipe.zadd(key, {str(now): now}) # è®¾ç½®è¿‡æœŸæ—¶é—´ pipe.expire(key, window + 1) results = pipe.execute() current_count = results[1] return current_count &lt; limit å››ã€æ•°æ®åº“ç›‘æ§ä¸è¿ç»´ 4.1 æ€§èƒ½ç›‘æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 # ========== æ•°æ®åº“ç›‘æ§ ========== class DatabaseMonitor: """æ•°æ®åº“ç›‘æ§""" def __init__(self, connection): self.conn = connection def get_connection_stats(self) -> dict: """è·å–è¿æ¥ç»Ÿè®¡""" with self.conn.cursor() as cursor: cursor.execute(""" SHOW STATUS LIKE 'Threads%' """) stats = cursor.fetchall() return { 'threads_connected': next( (s[1] for s in stats if s[0] == 'Threads_connected'), 0 ), 'threads_running': next( (s[1] for s in stats if s[0] == 'Threads_running'), 0 ) } def get_query_stats(self) -> dict: """è·å–æŸ¥è¯¢ç»Ÿè®¡""" with self.conn.cursor() as cursor: # æ…¢æŸ¥è¯¢ç»Ÿè®¡ cursor.execute(""" SELECT COUNT(*) as slow_query_count, AVG(query_time) as avg_query_time, MAX(query_time) as max_query_time FROM mysql.slow_log WHERE start_time > DATE_SUB(NOW(), INTERVAL 1 HOUR) """) slow_stats = cursor.fetchone() # QPS/TPSç»Ÿè®¡ cursor.execute(""" SHOW STATUS LIKE 'Questions' """) questions = cursor.fetchone() cursor.execute(""" SHOW STATUS LIKE 'Uptime' """) uptime = cursor.fetchone() qps = questions[1] / uptime[1] if uptime[1] > 0 else 0 return { 'slow_query_count': slow_stats[0], 'avg_query_time': float(slow_stats[1]) if slow_stats[1] else 0, 'max_query_time': float(slow_stats[2]) if slow_stats[2] else 0, 'qps': round(qps, 2) } def get_replication_lag(self) -> int: """è·å–ä¸»ä»å»¶è¿Ÿ""" with self.conn.cursor() as cursor: cursor.execute("SHOW SLAVE STATUS") status = cursor.fetchone() if status: return status['Seconds_Behind_Master'] return 0 def get_innodb_stats(self) -> dict: """è·å–InnoDBç»Ÿè®¡""" with self.conn.cursor() as cursor: cursor.execute(""" SHOW STATUS LIKE 'Innodb_%' """) stats = cursor.fetchall() return { 'row_lock_waits': next( (s[1] for s in stats if s[0] == 'Innodb_row_lock_current_waits'), 0 ), 'deadlocks': next( (s[1] for s in stats if s[0] == 'Innodb_deadlocks'), 0 ), 'buffer_pool_hit_rate': self._calculate_hit_rate(stats) } def _calculate_hit_rate(self, stats: list) -> float: """è®¡ç®—ç¼“å†²æ± å‘½ä¸­ç‡""" reads = next( (s[1] for s in stats if s[0] == 'Innodb_buffer_pool_reads'), 0 ) read_requests = next( (s[1] for s in stats if s[0] == 'Innodb_buffer_pool_read_requests'), 1 ) if read_requests == 0: return 100.0 hit_rate = (1 - reads / read_requests) * 100 return round(hit_rate, 2) # ========== æ…¢æŸ¥è¯¢åˆ†æ ========== class SlowQueryAnalyzer: """æ…¢æŸ¥è¯¢åˆ†æå™¨""" def __init__(self, connection): self.conn = connection def get_slow_queries(self, limit: int = 100) -> List[dict]: """è·å–æ…¢æŸ¥è¯¢""" with self.conn.cursor() as cursor: sql = """ SELECT query_time, lock_time, rows_sent, rows_examined, sql_text FROM mysql.slow_log ORDER BY query_time DESC LIMIT %s """ cursor.execute(sql, (limit,)) return cursor.fetchall() def analyze_slow_query(self, query: str) -> dict: """åˆ†ææ…¢æŸ¥è¯¢""" analyzer = SQLQueryOptimizer() return analyzer.optimize(query) def suggest_indexes(self, query: str) -> List[str]: """æ¨èç´¢å¼•""" # æå–WHEREã€JOINã€ORDER BYå­å¥ä¸­çš„å­—æ®µ # è¿™é‡Œç®€åŒ–å¤„ç† import re # æå–è¡¨å tables = re.findall(r'FROM\s+(\w+)', query, re.IGNORECASE) tables += re.findall(r'JOIN\s+(\w+)', query, re.IGNORECASE) # æå–WHEREæ¡ä»¶å­—æ®µ where_fields = re.findall( r'WHERE\s+(\w+)\.\w+\s*=', query, re.IGNORECASE ) suggestions = [] for table in set(tables): for field in set(where_fields): suggestions.append( f"CREATE INDEX idx_{table}_{field} ON {table}({field})" ) return suggestions 4.2 å¤‡ä»½ä¸æ¢å¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 # ========== æ•°æ®åº“å¤‡ä»½ ========== import subprocess import os from datetime import datetime from typing import List class DatabaseBackup: """æ•°æ®åº“å¤‡ä»½""" def __init__( self, host: str, user: str, password: str, backup_dir: str = '/backup' ): self.host = host self.user = user self.password = password self.backup_dir = backup_dir os.makedirs(backup_dir, exist_ok=True) def backup_database( self, database: str, backup_type: str = 'full' ) -> str: """å¤‡ä»½æ•°æ®åº“""" timestamp = datetime.now().strftime('%Y%m%d_%H%M%S') backup_file = os.path.join( self.backup_dir, f"{database}_{backup_type}_{timestamp}.sql" ) # ä½¿ç”¨mysqldumpå¤‡ä»½ command = [ 'mysqldump', f'--host={self.host}', f'--user={self.user}', f'--password={self.password}', '--single-transaction', '--routines', '--triggers', '--events', '--quick', database ] with open(backup_file, 'w') as f: subprocess.run( command, stdout=f, stderr=subprocess.PIPE, check=True ) # å‹ç¼©å¤‡ä»½æ–‡ä»¶ self._compress_file(backup_file) return f"{backup_file}.gz" def backup_all_databases(self) -> str: """å¤‡ä»½æ‰€æœ‰æ•°æ®åº“""" timestamp = datetime.now().strftime('%Y%m%d_%H%M%S') backup_file = os.path.join( self.backup_dir, f"all_databases_{timestamp}.sql" ) command = [ 'mysqldump', f'--host={self.host}', f'--user={self.user}', f'--password={self.password}', '--all-databases', '--single-transaction', '--routines', '--triggers', '--events' ] with open(backup_file, 'w') as f: subprocess.run( command, stdout=f, stderr=subprocess.PIPE, check=True ) self._compress_file(backup_file) return f"{backup_file}.gz" def _compress_file(self, filepath: str): """å‹ç¼©æ–‡ä»¶""" import gzip with open(filepath, 'rb') as f_in: with gzip.open(f"{filepath}.gz", 'wb') as f_out: f_out.writelines(f_in) os.remove(filepath) def restore_database(self, backup_file: str, database: str = None): """æ¢å¤æ•°æ®åº“""" # è§£å‹å¤‡ä»½æ–‡ä»¶ if backup_file.endswith('.gz'): import gzip temp_file = backup_file[:-3] with gzip.open(backup_file, 'rb') as f_in: with open(temp_file, 'wb') as f_out: f_out.writelines(f_in) backup_file = temp_file # æ¢å¤æ•°æ®åº“ command = [ 'mysql', f'--host={self.host}', f'--user={self.user}', f'--password={self.password}' ] if database: command.append(database) with open(backup_file, 'r') as f: subprocess.run( command, stdin=f, stderr=subprocess.PIPE, check=True ) # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ if backup_file.endswith('.sql'): os.remove(backup_file) def list_backups(self) -> List[dict]: """åˆ—å‡ºå¤‡ä»½æ–‡ä»¶""" backups = [] for filename in os.listdir(self.backup_dir): if filename.endswith('.sql.gz'): filepath = os.path.join(self.backup_dir, filename) stat = os.stat(filepath) backups.append({ 'filename': filename, 'size': stat.st_size, 'created_at': datetime.fromtimestamp(stat.st_ctime) }) return sorted(backups, key=lambda x: x['created_at'], reverse=True) def cleanup_old_backups(self, keep_days: int = 7): """æ¸…ç†æ—§å¤‡ä»½""" from datetime import timedelta cutoff_time = datetime.now() - timedelta(days=keep_days) for filename in os.listdir(self.backup_dir): filepath = os.path.join(self.backup_dir, filename) stat = os.stat(filepath) if datetime.fromtimestamp(stat.st_ctime) &lt; cutoff_time: os.remove(filepath) print(f"Removed old backup: {filename}") æ€»ç»“ æ„å»ºé«˜æ€§èƒ½çš„æ•°æ®æ¶æ„éœ€è¦ï¼š
...</p></div><footer class=entry-footer><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/ class=category-link>æ•°æ®åº“</a><a href=/blog/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/ class=category-link>åˆ†å¸ƒå¼ç³»ç»Ÿ</a></div><span class=post-date>2025-12-30</span><span class=post-author>æœ‰æ¡å·¥å…·å›¢é˜Ÿ</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></footer><a class=entry-link aria-label="post link to æ•°æ®åº“ä¼˜åŒ–ä¸åˆ†å¸ƒå¼å­˜å‚¨ï¼šæ„å»ºé«˜æ€§èƒ½æ•°æ®æ¶æ„" href=/blog/articles/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E6%9E%84%E5%BB%BA%E9%AB%98%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84/></a></article></main><footer class=footer><span>Â© 2024-2025 æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢</span> Â·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>