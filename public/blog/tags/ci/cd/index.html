<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CI/CD | æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</title><meta name=keywords content><meta name=description content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·ï¼šåˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒ"><meta name=author content="util.cn Team"><link rel=canonical href=/blog/tags/ci/cd/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.7e8505b7cdf8bb22ab2305e53c2700bb06c7e64faeb72cd3468823a9a3bd3d6e.css integrity="sha256-foUFt834uyKrIwXlPCcAuwbH5k+utyzTRogjqaO9PW4=" rel="preload stylesheet" as=style><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=apple-touch-icon href=/blog/apple-touch-icon.png><link rel=mask-icon href=/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=/blog/tags/ci/cd/feed.xml title=rss><link rel=alternate hreflang=zh-cn href=/blog/tags/ci/cd/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=/js/external-link-config.js></script><script src=/js/external-link-interceptor.js></script><link rel=stylesheet href=/blog/css/custom.css media=screen><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«","url":"https://www.util.cn/blog/","description":"æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚","publisher":{"@type":"Organization","name":"æœ‰æ¡å·¥å…·","url":"https://www.util.cn","logo":{"@type":"ImageObject","url":"https://www.util.cn/blog/logo/logo-256.png","width":256,"height":256}},"potentialAction":[{"@type":"SearchAction","target":"https://www.util.cn/blog/search?q={search_term_string}","query-input":"required name=search_term_string"}]}</script><meta property="og:type" content="website"><meta property="og:title" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta property="og:description" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚"><meta property="og:url" content="https://www.util.cn/blog/"><meta property="og:site_name" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢"><meta property="og:image" content="https://www.util.cn/blog/logo/logo-256.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta name=twitter:description content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚"><meta name=twitter:image content="https://www.util.cn/blog/logo/logo-256.png"><meta name=baidu-site-verification content><meta name=category content="æŠ€æœ¯åšå®¢,å¼€å‘è€…å·¥å…·,ç¼–ç¨‹æ•™ç¨‹"><meta name=coverage content="Worldwide"><meta name=distribution content="Global"><meta name=rating content="General"><script id=51la_code async crossorigin=anonymous src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=pro"></script><script>window.addEventListener("load",function(){setTimeout(function(){typeof la!="undefined"?console.log("51laç»Ÿè®¡å·²åŠ è½½"):(console.warn("51laç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"),function(){var e=document.createElement("script");e.src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=backup",e.async=!0,document.head.appendChild(e)}())},3e3)})</script><meta property="og:url" content="/blog/tags/ci/cd/"><meta property="og:site_name" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·"><meta property="og:title" content="CI/CD"><meta property="og:description" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·ï¼šåˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒ"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="CI/CD"><meta name=twitter:description content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·ï¼šåˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒ"></head><body class=list id=top><header class=header><nav class=nav><div class=logo><a href=/blog/ accesskey=h title="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· (Alt + H)">æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=/blog/posts/ title="æ‰€æœ‰æ–‡ç« åˆ—è¡¨ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŸ¥çœ‹æ‰€æœ‰æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ–‡ç« </span></a></li><li><a href=https://www.util.cn title="æœ‰æ¡å·¥å…· - å¼€å‘è€…çš„å¸¸ç”¨å·¥å…·é›†åˆï¼šæ— å¹¿å‘Š Â· æœ¬åœ°è®¡ç®— Â· å³å¼€å³ç”¨çš„åœ¨çº¿å·¥å…·å¹³å°ï¼Œæä¾›JSONæ ¼å¼åŒ–ã€SQLæ ¼å¼åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰å®ç”¨å·¥å…·"><span>æœ‰æ¡å·¥å…·</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=/blog/categories/ title="æ–‡ç« åˆ†ç±» - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æŠ€æœ¯é¢†åŸŸåˆ†ç±»çš„ä¼˜è´¨æ–‡ç« ï¼ŒåŒ…æ‹¬å‰ç«¯å¼€å‘ã€å·¥å…·ä½¿ç”¨ã€ç¼–ç¨‹æŠ€å·§ç­‰"><span>åˆ†ç±»</span></a></li><li><a href=/blog/tags/ title="æ ‡ç­¾äº‘ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡æ ‡ç­¾å¿«é€Ÿæ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ ‡ç­¾</span></a></li><li><a href=/blog/archives/ title="æ–‡ç« å½’æ¡£ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æ—¶é—´æŸ¥çœ‹å†å²æ–‡ç« "><span>å½’æ¡£</span></a></li><li><a href=/blog/search/ title="æœç´¢æ–‡ç«  - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡å…³é”®è¯æœç´¢æ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹ï¼Œæ”¯æŒæ ‡é¢˜ã€å†…å®¹ã€åˆ†ç±»å’Œæ ‡ç­¾æœç´¢"><span>æœç´¢</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>CI/CD</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Serverlessæ¶æ„ä¸å‰ç«¯éƒ¨ç½²ï¼šç°ä»£åŒ–éƒ¨ç½²ç­–ç•¥</h2></header><div class=entry-content><p>Serverlessæ¶æ„æ¦‚è¿° Serverlessæ¶æ„è®©å¼€å‘è€…æ— éœ€ç®¡ç†æœåŠ¡å™¨å³å¯éƒ¨ç½²åº”ç”¨ï¼Œä¸»è¦ä¼˜åŠ¿åŒ…æ‹¬ï¼š
æŒ‰éœ€ä»˜è´¹ - åªä¸ºå®é™…ä½¿ç”¨çš„èµ„æºä»˜è´¹ è‡ªåŠ¨æ‰©å±• - æ ¹æ®æµé‡è‡ªåŠ¨è°ƒæ•´ é›¶è¿ç»´ - æ— éœ€ç®¡ç†æœåŠ¡å™¨ å…¨çƒCDN - å†…å®¹åˆ†å‘ç½‘ç»œåŠ é€Ÿ Verceléƒ¨ç½² é¡¹ç›®é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // vercel.json { "buildCommand": "npm run build", "outputDirectory": ".output/public", "devCommand": "npm run dev", "installCommand": "npm install", "framework": "nuxt", "regions": ["hkg1", "sin1"], "headers": [ { "source": "/api/(.*)", "headers": [ { "key": "Access-Control-Allow-Origin", "value": "*" } ] } ], "rewrites": [ { "source": "/api/:path*", "destination": "/api/:path*" } ] } ç¯å¢ƒå˜é‡ 1 2 3 4 # åœ¨Vercelæ§åˆ¶å°è®¾ç½®ç¯å¢ƒå˜é‡ # æˆ–é€šè¿‡vercel CLI vercel env add DATABASE_URL production vercel env add API_KEY production Serverlesså‡½æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // api/hello.js export default function handler(req, res) { const { name } = req.query res.status(200).json({ message: `Hello ${name || 'World'}!`, timestamp: Date.now() }) } // api/users/[id].js export default function handler(req, res) { const { id } = req.query switch (req.method) { case 'GET': res.status(200).json({ id, name: `User ${id}` }) break case 'PUT': res.status(200).json({ id, ...req.body }) break default: res.setHeader('Allow', ['GET', 'PUT']) res.status(405).end(`Method ${req.method} Not Allowed`) } } Netlifyéƒ¨ç½² netlify.tomlé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [build] command = "npm run build" publish = "dist" [build.environment] NODE_VERSION = "18" [[redirects]] from = "/api/*" to = "/.netlify/functions/:splat" status = 200 [[redirects]] from = "/*" to = "/index.html" status = 200 [functions] directory = "netlify/functions" [[plugins]] package = "@netlify/plugin-lighthouse" Netlify Functions 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // netlify/functions/hello.js exports.handler = async (event, context) => { const { name } = event.queryStringParameters || {} return { statusCode: 200, body: JSON.stringify({ message: `Hello ${name || 'World'}!` }), headers: { 'Content-Type': 'application/json' } } } // netlify/functions/users/[id].js exports.handler = async (event, context) => { const { id } = event.pathParameters switch (event.httpMethod) { case 'GET': return { statusCode: 200, body: JSON.stringify({ id, name: `User ${id}` }) } default: return { statusCode: 405, body: 'Method Not Allowed' } } } Cloudflare Workers Workeré…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // worker.js export default { async fetch(request, env, ctx) { const url = new URL(request.url) // APIè·¯ç”± if (url.pathname.startsWith('/api/')) { return handleAPI(request, env) } // é™æ€èµ„æº return env.ASSETS.fetch(request) } } async function handleAPI(request, env) { const url = new URL(request.url) const path = url.pathname.replace('/api/', '') switch (path) { case 'hello': return new Response(JSON.stringify({ message: 'Hello from Cloudflare!' }), { headers: { 'Content-Type': 'application/json' } }) default: return new Response('Not Found', { status: 404 }) } } wrangler.tomlé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 name = "my-worker" main = "worker.js" compatibility_date = "2024-01-01" [env.production] routes = [ { pattern = "https://example.com/api/*", zone_name = "example.com" } ] [env.production.vars] ENVIRONMENT = "production" API_URL = "https://api.example.com" [[env.production.kv_namespaces]] binding = "KV" id = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" CI/CDé…ç½® GitHub Actions 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 # .github/workflows/deploy.yml name: Deploy on: push: branches: [main] pull_request: branches: [main] jobs: test: runs-on: ubuntu-latest steps: - uses: actions/checkout@v3 - name: Setup Node.js uses: actions/setup-node@v3 with: node-version: '18' - name: Install dependencies run: npm ci - name: Run tests run: npm test - name: Build run: npm run build deploy-vercel: needs: test if: github.ref == 'refs/heads/main' runs-on: ubuntu-latest steps: - uses: actions/checkout@v3 - name: Deploy to Vercel uses: amondnet/vercel-action@v20 with: vercel-token: ${{ secrets.VERCEL_TOKEN }} vercel-org-id: ${{ secrets.ORG_ID }} vercel-project-id: ${{ secrets.PROJECT_ID }} vercel-args: '--prod' deploy-netlify: needs: test if: github.ref == 'refs/heads/main' runs-on: ubuntu-latest steps: - uses: actions/checkout@v3 - name: Deploy to Netlify uses: nwtgck/actions-netlify@v1.2 with: publish-dir: './dist' production-branch: main github-token: ${{ secrets.GITHUB_TOKEN }} deploy-message: "Deploy from GitHub Actions" env: NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }} NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }} GitLab CI 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 # .gitlab-ci.yml stages: - test - build - deploy test: stage: test image: node:18 script: - npm ci - npm test build: stage: build image: node:18 script: - npm ci - npm run build artifacts: paths: - dist deploy: stage: deploy image: node:18 script: - npm install -g vercel - vercel --prod --token=$VERCEL_TOKEN only: - main Dockeréƒ¨ç½² Dockerfile 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # å¤šé˜¶æ®µæ„å»º FROM node:18-alpine AS builder WORKDIR /app COPY package*.json ./ RUN npm ci COPY . . RUN npm run build # ç”Ÿäº§é•œåƒ FROM node:18-alpine WORKDIR /app COPY package*.json ./ RUN npm ci --production COPY --from=builder /app/.output ./.output EXPOSE 3000 CMD ["node", ".output/server/index.mjs"] docker-compose.yml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 version: '3.8' services: app: build: . ports: - "3000:3000" environment: - NODE_ENV=production - DATABASE_URL=${DATABASE_URL} restart: unless-stopped nginx: image: nginx:alpine ports: - "80:80" - "443:443" volumes: - ./nginx.conf:/etc/nginx/nginx.conf - ./ssl:/etc/nginx/ssl depends_on: - app æ€§èƒ½ä¼˜åŒ– CDNé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 // nuxt.config.ts export default defineNuxtConfig({ app: { cdnURL: 'https://cdn.example.com' }, nitro: { routeRules: { '/': { cache: { maxAge: 3600 } }, '/api/**': { cache: { maxAge: 60 } }, '/_nuxt/**': { cache: { maxAge: 31536000 } } } } }) å›¾ç‰‡ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 &lt;script setup> // ä½¿ç”¨Nuxt Imageç»„ä»¶ import { NuxtImg } from '#components' &lt;/script> &lt;template> &lt;NuxtImg src="/image.jpg" width="500" height="300" format="webp" loading="lazy" placeholder /> &lt;/template> ç›‘æ§å’Œæ—¥å¿— æ€§èƒ½ç›‘æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // æœåŠ¡ç«¯æ€§èƒ½è¿½è¸ª export default defineEventHandler(async (event) => { const start = Date.now() // å¤„ç†è¯·æ±‚ const result = await fetchData() const duration = Date.now() - start // ä¸ŠæŠ¥æ€§èƒ½æ•°æ® $fetch('/api/analytics', { method: 'POST', body: { path: event.path, duration, timestamp: Date.now() } }) return result }) é”™è¯¯è¿½è¸ª 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // é›†æˆSentry import * as Sentry from '@sentry/node' Sentry.init({ dsn: process.env.SENTRY_DSN, environment: process.env.NODE_ENV, tracesSampleRate: 0.2 }) export default defineEventHandler(async (event) => { try { return await fetchData() } catch (error) { Sentry.captureException(error) throw error } }) æœ€ä½³å®è·µ è‡ªåŠ¨åŒ–éƒ¨ç½² - ä½¿ç”¨CI/CDè‡ªåŠ¨éƒ¨ç½² ç¯å¢ƒéš”ç¦» - åŒºåˆ†å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒ ç›‘æ§å‘Šè­¦ - è®¾ç½®æ€§èƒ½å’Œé”™è¯¯ç›‘æ§ å¤‡ä»½ç­–ç•¥ - å®šæœŸå¤‡ä»½é‡è¦æ•°æ® ç¾éš¾æ¢å¤ - å‡†å¤‡å›æ»šæ–¹æ¡ˆ æ€»ç»“ Serverlessæ¶æ„ä¸ºå‰ç«¯éƒ¨ç½²æä¾›äº†çµæ´»ã€é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡åˆç†é€‰æ‹©å¹³å°å’Œé…ç½®CI/CDæµç¨‹ï¼Œå¯ä»¥æ˜¾è‘—æå‡éƒ¨ç½²æ•ˆç‡å’Œåº”ç”¨çš„ç¨³å®šæ€§ã€‚
...</p></div><footer class=entry-footer><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF/ class=category-link>å‰ç«¯æŠ€æœ¯</a><a href=/blog/categories/%E9%83%A8%E7%BD%B2/ class=category-link>éƒ¨ç½²</a></div><span class=post-date>2026-01-04</span><span class=post-author>æŠ€æœ¯å›¢é˜Ÿ</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></footer><a class=entry-link aria-label="post link to Serverlessæ¶æ„ä¸å‰ç«¯éƒ¨ç½²ï¼šç°ä»£åŒ–éƒ¨ç½²ç­–ç•¥" href=/blog/articles/serverless%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%89%8D%E7%AB%AF%E9%83%A8%E7%BD%B2%E7%8E%B0%E4%BB%A3%E5%8C%96%E9%83%A8%E7%BD%B2%E7%AD%96%E7%95%A5/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>DevOpsä¸CI/CDå®Œå…¨æŒ‡å—ï¼šæ„å»ºé«˜æ•ˆçš„è½¯ä»¶äº¤ä»˜æµæ°´çº¿</h2></header><div class=entry-content><p>å¼•è¨€ åœ¨å½“ä»Šå¿«é€Ÿè¿­ä»£çš„è½¯ä»¶å¼€å‘ç¯å¢ƒä¸­ï¼ŒDevOpså®è·µå’ŒCI/CDæµæ°´çº¿å·²æˆä¸ºå›¢é˜Ÿæé«˜äº¤ä»˜æ•ˆç‡ã€ä¿è¯è½¯ä»¶è´¨é‡çš„å…³é”®ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å¦‚ä½•æ„å»ºå®Œæ•´çš„DevOpsä½“ç³»ï¼Œä»ä»£ç æäº¤åˆ°ç”Ÿäº§éƒ¨ç½²çš„å…¨æµç¨‹è‡ªåŠ¨åŒ–å®è·µã€‚
ä¸€ã€DevOpsæ ¸å¿ƒç†å¿µ 1.1 DevOpsçš„CALMSæ¨¡å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 # ========== DevOps CALMSæ¨¡å‹ ========== """ C - Culture (æ–‡åŒ–) â”œâ”€â”€ åä½œç²¾ç¥ â”œâ”€â”€ æŒç»­æ”¹è¿› â”œâ”€â”€ å®¹é”™å¿ƒæ€ â””â”€â”€ é€æ˜æ²Ÿé€š A - Automation (è‡ªåŠ¨åŒ–) â”œâ”€â”€ æ„å»ºè‡ªåŠ¨åŒ– â”œâ”€â”€ æµ‹è¯•è‡ªåŠ¨åŒ– â”œâ”€â”€ éƒ¨ç½²è‡ªåŠ¨åŒ– â””â”€â”€ ç›‘æ§è‡ªåŠ¨åŒ– L - Lean (ç²¾ç›Š) â”œâ”€â”€ æ¶ˆé™¤æµªè´¹ â”œâ”€â”€ æŒç»­äº¤ä»˜ â”œâ”€â”€ å¿«é€Ÿåé¦ˆ â””â”€â”€ ä»·å€¼æµä¼˜åŒ– M - Measurement (åº¦é‡) â”œâ”€â”€ å…³é”®æŒ‡æ ‡è¿½è¸ª â”œâ”€â”€ æ•°æ®é©±åŠ¨å†³ç­– â”œâ”€â”€ æŒç»­ç›‘æ§ â””â”€â”€ æ•ˆæœè¯„ä¼° S - Sharing (åˆ†äº«) â”œâ”€â”€ çŸ¥è¯†å…±äº« â”œâ”€â”€ æœ€ä½³å®è·µä¼ æ’­ â”œâ”€â”€ å·¥å…·å…±äº« â””â”€â”€ ç»éªŒæ€»ç»“ """ # DevOpsæˆç†Ÿåº¦è¯„ä¼°æ¨¡å‹ DEVOPS_MATURITY_LEVELS = { "Level 1 - åˆå§‹çº§": { "characteristics": [ "æ‰‹åŠ¨æ“ä½œä¸ºä¸»", "ç¼ºä¹æ ‡å‡†åŒ–æµç¨‹", "å¼€å‘å’Œè¿ç»´åˆ†ç¦»" ], "practices": [], "improvements": [ "å»ºç«‹åŸºç¡€è‡ªåŠ¨åŒ–æµç¨‹", "åˆ¶å®šæ ‡å‡†åŒ–è§„èŒƒ" ] }, "Level 2 - å¯é‡å¤çº§": { "characteristics": [ "æœ‰åŸºæœ¬çš„CIæµç¨‹", "ç¯å¢ƒé…ç½®åˆæ­¥æ ‡å‡†åŒ–", "æ–‡æ¡£åŒ–æµç¨‹" ], "practices": [ "ç‰ˆæœ¬æ§åˆ¶", "å•å…ƒæµ‹è¯•", "åŸºç¡€è‡ªåŠ¨åŒ–æ„å»º" ], "improvements": [ "æ‰©å±•è‡ªåŠ¨åŒ–èŒƒå›´", "å¢åŠ æµ‹è¯•è¦†ç›–ç‡" ] }, "Level 3 - å·²å®šä¹‰çº§": { "characteristics": [ "å®Œæ•´çš„CI/CDæµæ°´çº¿", "åŸºç¡€è®¾æ–½å³ä»£ç ", "è‡ªåŠ¨åŒ–æµ‹è¯•ä½“ç³»" ], "practices": [ "æŒç»­é›†æˆ", "æŒç»­éƒ¨ç½²", "è‡ªåŠ¨åŒ–æµ‹è¯•", "é…ç½®ç®¡ç†" ], "improvements": [ "ä¼˜åŒ–éƒ¨ç½²æµç¨‹", "å¢å¼ºç›‘æ§èƒ½åŠ›" ] }, "Level 4 - å¯ç®¡ç†çº§": { "characteristics": [ "å…¨é“¾è·¯è‡ªåŠ¨åŒ–", "å®Œå–„çš„ç›‘æ§ä½“ç³»", "å¿«é€Ÿæ•…éšœæ¢å¤" ], "practices": [ "è‡ªåŠ¨åŒ–è¿ç»´", "ç›‘æ§å‘Šè­¦", "æ•…éšœè‡ªæ„ˆ", "æ€§èƒ½ä¼˜åŒ–" ], "improvements": [ "æŒç»­ä¼˜åŒ–", "æˆæœ¬æ§åˆ¶" ] }, "Level 5 - ä¼˜åŒ–çº§": { "characteristics": [ "æ™ºèƒ½è¿ç»´", "é¢„æµ‹æ€§ç»´æŠ¤", "æŒç»­åˆ›æ–°" ], "practices": [ "AIè¾…åŠ©å†³ç­–", "æ··æ²Œå·¥ç¨‹", "è‡ªåŠ¨åŒ–ä¼˜åŒ–" ], "improvements": [ "æŒç»­æ¼”è¿›" ] } } 1.2 DevOpsæŒ‡æ ‡ä½“ç³» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 # ========== DORAæŒ‡æ ‡ ========== class DORAMetrics: """DORA (DevOps Research and Assessment) æ ¸å¿ƒæŒ‡æ ‡""" @staticmethod def deployment_frequency(deployments: int, days: int) -> float: """ éƒ¨ç½²é¢‘ç‡ - ç²¾è‹±çº§ï¼šæŒ‰éœ€éƒ¨ç½² (æ¯å¤©å¤šæ¬¡) - é«˜ç»©æ•ˆï¼šæ¯å‘¨1-6ä¸ªæœˆ - ä¸­ç­‰ç»©æ•ˆï¼šæ¯æœˆ1-6ä¸ªæœˆ - ä½ç»©æ•ˆï¼šå°‘äºæ¯6ä¸ªæœˆ1æ¬¡ """ return deployments / days @staticmethod def lead_time_for_changes(commit_time: str, deploy_time: str) -> float: """ å˜æ›´å‰ç½®æ—¶é—´ ä»ä»£ç æäº¤åˆ°æˆåŠŸéƒ¨ç½²çš„æ—¶é—´ - ç²¾è‹±çº§ï¼šå°äº1å°æ—¶ - é«˜ç»©æ•ˆï¼šå°äº1å¤© - ä¸­ç­‰ç»©æ•ˆï¼š1å‘¨-1ä¸ªæœˆ - ä½ç»©æ•ˆï¼šè¶…è¿‡1ä¸ªæœˆ """ from datetime import datetime commit = datetime.fromisoformat(commit_time) deploy = datetime.fromisoformat(deploy_time) return (deploy - commit).total_seconds() / 3600 # å°æ—¶ @staticmethod def time_to_restore_service(incident_time: str, restore_time: str) -> float: """ æœåŠ¡æ¢å¤æ—¶é—´ - ç²¾è‹±çº§ï¼šå°äº1å°æ—¶ - é«˜ç»©æ•ˆï¼šå°äº1å¤© - ä¸­ç­‰ç»©æ•ˆï¼š1å¤©-1å‘¨ - ä½ç»©æ•ˆï¼šè¶…è¿‡1å‘¨ """ from datetime import datetime incident = datetime.fromisoformat(incident_time) restore = datetime.fromisoformat(restore_time) return (restore - incident).total_seconds() / 3600 # å°æ—¶ @staticmethod def change_failure_rate(total_deployments: int, failed_deployments: int) -> float: """ å˜æ›´å¤±è´¥ç‡ - ç²¾è‹±çº§ï¼š0-15% - é«˜ç»©æ•ˆï¼š15-30% - ä¸­ç­‰ç»©æ•ˆï¼š30-60% - ä½ç»©æ•ˆï¼šè¶…è¿‡60% """ return (failed_deployments / total_deployments) * 100 @classmethod def evaluate_performance(cls, metrics: dict) -> str: """è¯„ä¼°å›¢é˜ŸDevOpsç»©æ•ˆç­‰çº§""" score = 0 if metrics['deployment_frequency'] >= 1: # æ¯å¤©è‡³å°‘1æ¬¡ score += 1 if metrics['lead_time'] &lt;= 1: # å°äº1å°æ—¶ score += 1 if metrics['restore_time'] &lt;= 1: # å°äº1å°æ—¶ score += 1 if metrics['failure_rate'] &lt;= 15: # å°äº15% score += 1 levels = { 4: "ç²¾è‹±çº§", 3: "é«˜ç»©æ•ˆ", 2: "ä¸­ç­‰ç»©æ•ˆ", 1: "ä½ç»©æ•ˆ", 0: "ä½ç»©æ•ˆ" } return levels[score] # ========== è‡ªå®šä¹‰DevOpsæŒ‡æ ‡ ========== class DevOpsMetricsCollector: """DevOpsæŒ‡æ ‡æ”¶é›†å™¨""" def __init__(self): self.metrics = { 'builds': [], 'deployments': [], 'incidents': [], 'tests': [] } def record_build(self, build_info: dict): """è®°å½•æ„å»ºä¿¡æ¯""" self.metrics['builds'].append({ 'timestamp': build_info['timestamp'], 'branch': build_info['branch'], 'commit': build_info['commit'], 'status': build_info['status'], 'duration': build_info['duration'], 'triggered_by': build_info['triggered_by'] }) def record_deployment(self, deployment_info: dict): """è®°å½•éƒ¨ç½²ä¿¡æ¯""" self.metrics['deployments'].append({ 'timestamp': deployment_info['timestamp'], 'environment': deployment_info['environment'], 'version': deployment_info['version'], 'status': deployment_info['status'], 'duration': deployment_info['duration'], 'deployed_by': deployment_info['deployed_by'] }) def record_incident(self, incident_info: dict): """è®°å½•æ•…éšœä¿¡æ¯""" self.metrics['incidents'].append({ 'detected_at': incident_info['detected_at'], 'resolved_at': incident_info.get('resolved_at'), 'severity': incident_info['severity'], 'affected_services': incident_info['affected_services'], 'root_cause': incident_info.get('root_cause') }) def calculate_metrics(self, days: int = 30) -> dict: """è®¡ç®—DevOpsæŒ‡æ ‡""" from datetime import datetime, timedelta cutoff_time = datetime.now() - timedelta(days=days) # ç­›é€‰æ—¶é—´èŒƒå›´å†…çš„æ•°æ® recent_builds = [ b for b in self.metrics['builds'] if datetime.fromisoformat(b['timestamp']) > cutoff_time ] recent_deployments = [ d for d in self.metrics['deployments'] if datetime.fromisoformat(d['timestamp']) > cutoff_time ] recent_incidents = [ i for i in self.metrics['incidents'] if datetime.fromisoformat(i['detected_at']) > cutoff_time ] # è®¡ç®—æŒ‡æ ‡ total_builds = len(recent_builds) successful_builds = len([b for b in recent_builds if b['status'] == 'success']) build_success_rate = (successful_builds / total_builds * 100) if total_builds > 0 else 0 total_deployments = len(recent_deployments) successful_deployments = len([d for d in recent_deployments if d['status'] == 'success']) deployment_success_rate = (successful_deployments / total_deployments * 100) if total_deployments > 0 else 0 deployment_frequency = total_deployments / days total_incidents = len(recent_incidents) resolved_incidents = len([i for i in recent_incidents if i.get('resolved_at')]) avg_resolution_time = 0 if resolved_incidents > 0: resolution_times = [] for incident in recent_incidents: if incident.get('resolved_at'): detected = datetime.fromisoformat(incident['detected_at']) resolved = datetime.fromisoformat(incident['resolved_at']) resolution_times.append((resolved - detected).total_seconds() / 3600) avg_resolution_time = sum(resolution_times) / len(resolution_times) return { 'build_metrics': { 'total_builds': total_builds, 'success_rate': round(build_success_rate, 2), 'avg_duration': round( sum(b['duration'] for b in recent_builds) / total_builds if total_builds > 0 else 0, 2 ) }, 'deployment_metrics': { 'total_deployments': total_deployments, 'success_rate': round(deployment_success_rate, 2), 'frequency_per_day': round(deployment_frequency, 2) }, 'incident_metrics': { 'total_incidents': total_incidents, 'resolved_incidents': resolved_incidents, 'avg_resolution_time_hours': round(avg_resolution_time, 2) } } äºŒã€æŒç»­é›†æˆ(CI)å®è·µ 2.1 Gitå·¥ä½œæµ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 # ========== Gitå·¥ä½œæµæ¨¡å‹ ========== class GitWorkflow: """Gitå·¥ä½œæµç®¡ç†""" BRANCH_STRATEGIES = { "Git Flow": { "branches": { "main": "ç”Ÿäº§åˆ†æ”¯ï¼Œåªæ¥å—æ¥è‡ªreleaseçš„åˆå¹¶", "develop": "å¼€å‘ä¸»åˆ†æ”¯", "feature": "åŠŸèƒ½å¼€å‘åˆ†æ”¯ï¼Œä»developåˆ›å»º", "release": "å‘å¸ƒå‡†å¤‡åˆ†æ”¯ï¼Œä»developåˆ›å»º", "hotfix": "ç´§æ€¥ä¿®å¤åˆ†æ”¯ï¼Œä»mainåˆ›å»º" }, "workflow": """ 1. ä»developåˆ›å»ºfeatureåˆ†æ”¯ 2. å®Œæˆå¼€å‘ååˆå¹¶å›develop 3. å‡†å¤‡å‘å¸ƒæ—¶åˆ›å»ºreleaseåˆ†æ”¯ 4. æµ‹è¯•é€šè¿‡ååˆå¹¶åˆ°mainå’Œdevelop 5. ç´§æ€¥ä¿®å¤ä»mainåˆ›å»ºhotfixåˆ†æ”¯ 6. ä¿®å¤ååˆå¹¶åˆ°mainå’Œdevelop """ }, "GitHub Flow": { "branches": { "main": "å§‹ç»ˆå¯éƒ¨ç½²çš„ç”Ÿäº§åˆ†æ”¯", "feature": "åŠŸèƒ½åˆ†æ”¯ï¼Œä»mainåˆ›å»º" }, "workflow": """ 1. ä»mainåˆ›å»ºfeatureåˆ†æ”¯ 2. æäº¤å¹¶æ¨é€åˆ°è¿œç¨‹ 3. åˆ›å»ºPull Request 4. Code Reviewå’Œè®¨è®º 5. åˆå¹¶åˆ°main 6. ç«‹å³éƒ¨ç½² """ }, "GitLab Flow": { "branches": { "main": "ä¸»åˆ†æ”¯", "feature": "åŠŸèƒ½åˆ†æ”¯", "environment": "ç¯å¢ƒåˆ†æ”¯ï¼ˆstaging, productionï¼‰" }, "workflow": """ 1. ä»mainåˆ›å»ºfeatureåˆ†æ”¯ 2. å®Œæˆååˆå¹¶å›main 3. mainåˆ†æ”¯è§¦å‘CI/CD 4. é€šè¿‡æµ‹è¯•åéƒ¨ç½²åˆ°staging 5. äººå·¥éªŒè¯åéƒ¨ç½²åˆ°production """ }, "Trunk Based Development": { "branches": { "trunk/main": "ä¸»åˆ†æ”¯ï¼Œæ‰€æœ‰å¼€å‘åœ¨æ­¤è¿›è¡Œ" }, "workflow": """ 1. å¼€å‘è€…ç›´æ¥åœ¨ä¸»åˆ†æ”¯æäº¤ 2. ä½¿ç”¨Feature Flagsæ§åˆ¶åŠŸèƒ½å‘å¸ƒ 3. é¢‘ç¹é›†æˆåˆ°ä¸»åˆ†æ”¯ 4. æŒç»­éƒ¨ç½² """ } } class BranchProtectionRules: """åˆ†æ”¯ä¿æŠ¤è§„åˆ™""" def __init__(self): self.rules = {} def add_protection(self, branch: str, rules: dict): """æ·»åŠ åˆ†æ”¯ä¿æŠ¤è§„åˆ™""" self.rules[branch] = { 'require_pull_request': rules.get('require_pull_request', True), 'require_approvals': rules.get('require_approvals', 1), 'dismiss_stale_reviews': rules.get('dismiss_stale_reviews', True), 'require_status_checks': rules.get('require_status_checks', True), 'required_status_checks': rules.get('required_status_checks', []), 'require_linear_history': rules.get('require_linear_history', True), 'allow_force_pushes': rules.get('allow_force_pushes', False), 'allow_deletions': rules.get('allow_deletions', False) } def check_protection(self, branch: str) -> dict: """æ£€æŸ¥åˆ†æ”¯ä¿æŠ¤çŠ¶æ€""" return self.rules.get(branch, {}) 2.2 CIæµæ°´çº¿é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 # ========== Jenkins Pipeline ========== # Jenkinsfile pipeline { agent any tools { maven 'Maven 3.8' jdk 'JDK 11' } environment { APP_NAME = 'my-application' VERSION = "${env.BUILD_ID}" REGISTRY = 'registry.example.com' IMAGE_NAME = "${REGISTRY}/${APP_NAME}:${VERSION}" } stages { stage('Checkout') { steps { checkout scm } } stage('Setup') { steps { sh ''' echo "Setting up build environment..." python3 -m venv venv . venv/bin/activate pip install -r requirements.txt ''' } } stage('Code Quality') { parallel { stage('Lint') { steps { sh ''' . venv/bin/activate flake8 src/ --max-line-length=120 ''' } } stage('Security Scan') { steps { sh ''' . venv/bin/activate bandit -r src/ ''' } } } } stage('Unit Tests') { steps { sh ''' . venv/bin/activate pytest tests/unit/ --cov=src --cov-report=xml --cov-report=html ''' } post { always { junit 'test-results/*.xml' publishHTML([ allowMissing: false, alwaysLinkToLastBuild: true, keepAll: true, reportDir: 'htmlcov', reportFiles: 'index.html', reportName: 'Coverage Report' ]) } } } stage('Integration Tests') { steps { sh ''' docker-compose -f docker-compose.test.yml up -d sleep 10 . venv/bin/activate pytest tests/integration/ docker-compose -f docker-compose.test.yml down ''' } } stage('Build') { steps { sh ''' . venv/bin/activate python setup.py sdist bdist_wheel ''' } } stage('Docker Build') { steps { script { docker.build(image: IMAGE_NAME) } } } stage('Security Scan Image') { steps { sh ''' trivy image ${IMAGE_NAME} --severity HIGH,CRITICAL ''' } } stage('Push to Registry') { when { branch 'main' } steps { script { docker.withRegistry("https://${REGISTRY}", 'docker-registry-credentials') { docker.image(IMAGE_NAME).push() docker.image(IMAGE_NAME).push('latest') } } } } stage('Deploy to Staging') { when { branch 'main' } steps { sh ''' kubectl set image deployment/${APP_NAME} \ ${APP_NAME}=${IMAGE_NAME} \ --namespace=staging kubectl rollout status deployment/${APP_NAME} \ --namespace=staging ''' } } stage('Smoke Tests') { when { branch 'main' } steps { sh ''' . venv/bin/activate pytest tests/smoke/ --base-url=https://staging.example.com ''' } } stage('Deploy to Production') { when { branch 'main' approval { input 'Deploy to Production?' } } steps { sh ''' kubectl set image deployment/${APP_NAME} \ ${APP_NAME}=${IMAGE_NAME} \ --namespace=production kubectl rollout status deployment/${APP_NAME} \ --namespace=production ''' } } } post { success { echo "Pipeline succeeded!" cleanWs() } failure { echo "Pipeline failed!" mail to: 'team@example.com', subject: "Build Failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}", body: "Check console output at ${env.BUILD_URL}" } always { sh ''' docker system prune -f ''' } } } # ========== GitHub Actions Workflow ========== # .github/workflows/ci-cd.yml name: CI/CD Pipeline on: push: branches: [main, develop] pull_request: branches: [main, develop] env: REGISTRY: ghcr.io IMAGE_NAME: ${{ github.repository }} jobs: lint: name: Lint runs-on: ubuntu-latest steps: - uses: actions/checkout@v3 - name: Set up Python uses: actions/setup-python@v4 with: python-version: '3.9' cache: 'pip' - name: Install dependencies run: | python -m pip install --upgrade pip pip install flake8 black isort - name: Run flake8 run: | flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics - name: Check code formatting run: | black --check src/ tests/ - name: Check import ordering run: | isort --check-only src/ tests/ test: name: Test runs-on: ubuntu-latest strategy: matrix: python-version: ['3.8', '3.9', '3.10', '3.11'] steps: - uses: actions/checkout@v3 - name: Set up Python ${{ matrix.python-version }} uses: actions/setup-python@v4 with: python-version: ${{ matrix.python-version }} cache: 'pip' - name: Install dependencies run: | python -m pip install --upgrade pip pip install -r requirements.txt pip install -r requirements-dev.txt - name: Run tests run: | pytest tests/ --cov=src --cov-report=xml --cov-report=html - name: Upload coverage uses: codecov/codecov-action@v3 with: file: ./coverage.xml flags: unittests name: codecov-umbrella security: name: Security Scan runs-on: ubuntu-latest steps: - uses: actions/checkout@v3 - name: Run Bandit run: | pip install bandit[toml] bandit -r src/ - name: Run Safety run: | pip install safety safety check --file requirements.txt - name: Run Trivy uses: aquasecurity/trivy-action@master with: scan-type: 'fs' scan-ref: '.' format: 'sarif' output: 'trivy-results.sarif' - name: Upload Trivy results uses: github/codeql-action/upload-sarif@v2 with: sarif_file: 'trivy-results.sarif' build: name: Build Docker Image runs-on: ubuntu-latest needs: [lint, test, security] if: github.event_name == 'push' && github.ref == 'refs/heads/main' permissions: contents: read packages: write steps: - uses: actions/checkout@v3 - name: Set up Docker Buildx uses: docker/setup-buildx-action@v2 - name: Log in to Container Registry uses: docker/login-action@v2 with: registry: ${{ env.REGISTRY }} username: ${{ github.actor }} password: ${{ secrets.GITHUB_TOKEN }} - name: Extract metadata id: meta uses: docker/metadata-action@v4 with: images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} tags: | type=ref,event=branch type=semver,pattern={{version}} type=semver,pattern={{major}}.{{minor}} type=sha,prefix={{branch}}- - name: Build and push uses: docker/build-push-action@v4 with: context: . push: true tags: ${{ steps.meta.outputs.tags }} labels: ${{ steps.meta.outputs.labels }} cache-from: type=gha cache-to: type=gha,mode=max deploy: name: Deploy runs-on: ubuntu-latest needs: build if: github.event_name == 'push' && github.ref == 'refs/heads/main' environment: name: production url: https://example.com steps: - uses: actions/checkout@v3 - name: Configure AWS credentials uses: aws-actions/configure-aws-credentials@v2 with: aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }} aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }} aws-region: us-east-1 - name: Update kubeconfig run: | aws eks update-kubeconfig --name production-cluster --region us-east-1 - name: Deploy to Kubernetes run: | kubectl set image deployment/app \ app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \ --namespace=production - name: Verify deployment run: | kubectl rollout status deployment/app --namespace=production 2.3 æµ‹è¯•è‡ªåŠ¨åŒ–ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 # ========== æµ‹è¯•é‡‘å­—å¡” ========== class TestAutomationStrategy: """æµ‹è¯•è‡ªåŠ¨åŒ–ç­–ç•¥""" TEST_PYRAMID = { "Unit Tests (70%)": { "scope": "å•ä¸ªå‡½æ•°/ç±»", "speed": "æ¯«ç§’çº§", "cost": "ä½", "isolation": "å®Œå…¨éš”ç¦»", "examples": [ "å‡½æ•°è¿”å›å€¼éªŒè¯", "è¾¹ç•Œæ¡ä»¶æµ‹è¯•", "å¼‚å¸¸å¤„ç†æµ‹è¯•" ] }, "Integration Tests (20%)": { "scope": "å¤šä¸ªç»„ä»¶åä½œ", "speed": "ç§’çº§", "cost": "ä¸­", "isolation": "éƒ¨åˆ†éš”ç¦»", "examples": [ "APIé›†æˆæµ‹è¯•", "æ•°æ®åº“é›†æˆæµ‹è¯•", "æœåŠ¡é—´é€šä¿¡æµ‹è¯•" ] }, "E2E Tests (10%)": { "scope": "å®Œæ•´ç”¨æˆ·æµç¨‹", "speed": "åˆ†é’Ÿçº§", "cost": "é«˜", "isolation": "æ— éš”ç¦»", "examples": [ "ç”¨æˆ·æ³¨å†Œæµç¨‹", "è´­ç‰©è½¦å®Œæ•´æµç¨‹", "æ”¯ä»˜å®Œæ•´æµç¨‹" ] } } class AutomatedTestSuite: """è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶""" def __init__(self): self.unit_tests = [] self.integration_tests = [] self.e2e_tests = [] def add_unit_test(self, test_func): """æ·»åŠ å•å…ƒæµ‹è¯•""" self.unit_tests.append(test_func) def add_integration_test(self, test_func): """æ·»åŠ é›†æˆæµ‹è¯•""" self.integration_tests.append(test_func) def add_e2e_test(self, test_func): """æ·»åŠ E2Eæµ‹è¯•""" self.e2e_tests.append(test_func) def run_all_tests(self): """è¿è¡Œæ‰€æœ‰æµ‹è¯•""" results = { 'unit': self._run_tests(self.unit_tests), 'integration': self._run_tests(self.integration_tests), 'e2e': self._run_tests(self.e2e_tests) } return results def _run_tests(self, tests): """è¿è¡Œæµ‹è¯•""" passed = 0 failed = 0 for test in tests: try: test() passed += 1 except AssertionError as e: failed += 1 print(f"Test failed: {e}") return { 'total': len(tests), 'passed': passed, 'failed': failed } # ========== æµ‹è¯•é©±åŠ¨å¼€å‘(TDD)å·¥ä½œæµ ========== class TDDWorkflow: """TDDå·¥ä½œæµ""" @staticmethod def red_green_refactor(feature_name: str): """ Red-Green-Refactorå¾ªç¯ Red: ç¼–å†™å¤±è´¥çš„æµ‹è¯• Green: ç¼–å†™æœ€å°‘ä»£ç ä½¿æµ‹è¯•é€šè¿‡ Refactor: é‡æ„ä»£ç  """ print(f"\n=== TDD Workflow for {feature_name} ===") # Red: ç¼–å†™æµ‹è¯• print("\n[RED] Writing failing test...") test_code = f""" def test_{feature_name}(): result = {feature_name}() assert result is not None """ print(test_code) # Green: å®ç°åŠŸèƒ½ print("\n[GREEN] Implementing minimum code to pass...") impl_code = f""" def {feature_name}(): return True """ print(impl_code) # Refactor: é‡æ„ print("\n[REFACTOR] Improving code quality...") print("Optimizing implementation...") return True # ========== è¡Œä¸ºé©±åŠ¨å¼€å‘(BDD) ========== class BDDScenario: """BDDåœºæ™¯å®šä¹‰""" def __init__(self, name: str): self.name = name self.given_steps = [] self.when_steps = [] self.then_steps = [] def given(self, description: str, action=None): """Givenæ­¥éª¤""" self.given_steps.append({ 'description': description, 'action': action }) return self def when(self, description: str, action=None): """Whenæ­¥éª¤""" self.when_steps.append({ 'description': description, 'action': action }) return self def then(self, description: str, assertion=None): """Thenæ­¥éª¤""" self.then_steps.append({ 'description': description, 'assertion': assertion }) return self def execute(self): """æ‰§è¡Œåœºæ™¯""" print(f"\nScenario: {self.name}") # æ‰§è¡ŒGivenæ­¥éª¤ print("\nGiven:") context = {} for step in self.given_steps: print(f" {step['description']}") if step['action']: context.update(step['action'](context) or {}) # æ‰§è¡ŒWhenæ­¥éª¤ print("\nWhen:") for step in self.when_steps: print(f" {step['description']}") if step['action']: context.update(step['action'](context) or {}) # æ‰§è¡ŒThenæ­¥éª¤ print("\nThen:") for step in self.then_steps: print(f" {step['description']}") if step['assertion']: step['assertion'](context) return context # ä½¿ç”¨ç¤ºä¾‹ def user_login_scenario(): """ç”¨æˆ·ç™»å½•åœºæ™¯""" scenario = BDDScenario("User successfully logs in") scenario.given("a registered user with email 'user@example.com' and password 'password123'") .when("the user submits valid credentials") .then("the user should be authenticated") .then("the user should receive an authentication token") # å®é™…æ‰§è¡Œæ—¶ä¼šå®ç°å…·ä½“çš„actionå’Œassertion return scenario ä¸‰ã€æŒç»­éƒ¨ç½²(CD)å®è·µ 3.1 éƒ¨ç½²ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 # ========== éƒ¨ç½²ç­–ç•¥ ========== class DeploymentStrategy: """éƒ¨ç½²ç­–ç•¥""" @staticmethod def rolling_update(deployment_config: dict): """ æ»šåŠ¨æ›´æ–° é€æ­¥æ›¿æ¢æ—§å®ä¾‹ï¼Œç¡®ä¿æœåŠ¡å§‹ç»ˆå¯ç”¨ """ total_replicas = deployment_config['replicas'] max_unavailable = deployment_config.get('max_unavailable', 1) max_surge = deployment_config.get('max_surge', 1) print(f"Starting rolling update...") print(f"Total replicas: {total_replicas}") print(f"Max unavailable: {max_unavailable}") print(f"Max surge: {max_surge}") for i in range(total_replicas): print(f"Updating replica {i+1}/{total_replicas}...") # éƒ¨ç½²æ–°å®ä¾‹ # ç­‰å¾…å¥åº·æ£€æŸ¥é€šè¿‡ # ç»ˆæ­¢æ—§å®ä¾‹ print("Rolling update completed!") @staticmethod def blue_green_deployment(deployment_config: dict): """ è“ç»¿éƒ¨ç½² å¹¶è¡Œç»´æŠ¤ä¸¤å¥—ç¯å¢ƒï¼Œé€šè¿‡åˆ‡æ¢æµé‡å®ç°é›¶åœæœºéƒ¨ç½² """ print("Starting blue-green deployment...") # å½“å‰ç¯å¢ƒ current_env = deployment_config['current_environment'] # 'blue' or 'green' # ç›®æ ‡ç¯å¢ƒ target_env = 'green' if current_env == 'blue' else 'blue' print(f"Current environment: {current_env}") print(f"Target environment: {target_env}") # 1. åœ¨ç›®æ ‡ç¯å¢ƒéƒ¨ç½²æ–°ç‰ˆæœ¬ print(f"\n1. Deploying new version to {target_env} environment...") # éƒ¨ç½²åˆ°ç›®æ ‡ç¯å¢ƒ # 2. ç­‰å¾…ç›®æ ‡ç¯å¢ƒå¥åº·æ£€æŸ¥ print(f"\n2. Waiting for {target_env} to be healthy...") # å¥åº·æ£€æŸ¥ # 3. åˆ‡æ¢æµé‡ print(f"\n3. Switching traffic from {current_env} to {target_env}...") # åˆ‡æ¢è´Ÿè½½å‡è¡¡å™¨ # 4. éªŒè¯æ–°ç‰ˆæœ¬ print(f"\n4. Validating {target_env}...") # è¿è¡ŒçƒŸé›¾æµ‹è¯• # 5. ä¿ç•™æ—§ç¯å¢ƒï¼ˆå¯é€‰å›æ»šï¼‰ print(f"\n5. Keeping {current_env} as rollback option...") print("Blue-green deployment completed!") @staticmethod def canary_deployment(deployment_config: dict): """ é‡‘ä¸é›€éƒ¨ç½² é€æ­¥å°†æµé‡å¼•å¯¼åˆ°æ–°ç‰ˆæœ¬ï¼Œç›‘æ§é—®é¢˜å¹¶å¿«é€Ÿå›æ»š """ print("Starting canary deployment...") canary_steps = deployment_config.get('canary_steps', [ {'percentage': 5, 'duration': 300}, # 5% æµé‡ï¼Œ5åˆ†é’Ÿ {'percentage': 25, 'duration': 600}, # 25% æµé‡ï¼Œ10åˆ†é’Ÿ {'percentage': 50, 'duration': 600}, # 50% æµé‡ï¼Œ10åˆ†é’Ÿ {'percentage': 100, 'duration': 0} # 100% æµé‡ ]) for step in canary_steps: percentage = step['percentage'] duration = step['duration'] print(f"\nRouting {percentage}% of traffic to canary...") # è°ƒæ•´æµé‡åˆ†é… # ç›‘æ§å…³é”®æŒ‡æ ‡ # å¦‚æœæ£€æµ‹åˆ°é—®é¢˜ï¼Œç«‹å³å›æ»š if duration > 0: print(f"Monitoring for {duration} seconds...") # ç­‰å¾…å¹¶ç›‘æ§ print("\nAll traffic routed to new version!") print("Canary deployment completed!") @staticmethod def a_b_testing_deployment(deployment_config: dict): """ A/Bæµ‹è¯•éƒ¨ç½² åŒæ—¶è¿è¡Œå¤šä¸ªç‰ˆæœ¬ï¼ŒæŒ‰ç‰¹å®šè§„åˆ™åˆ†é…æµé‡ """ print("Starting A/B testing deployment...") variants = deployment_config['variants'] # [{'name': 'A', 'percentage': 50}, ...] total_percentage = sum(v['percentage'] for v in variants) if total_percentage != 100: raise ValueError(f"Total percentage must be 100%, got {total_percentage}%") print("Traffic allocation:") for variant in variants: print(f" {variant['name']}: {variant['percentage']}%") # é…ç½®æµé‡åˆ†é…è§„åˆ™ # è®¾ç½®æŒ‡æ ‡æ”¶é›† # é…ç½®è‡ªåŠ¨å›æ»šè§„åˆ™ print("A/B testing deployment completed!") # ========== éƒ¨ç½²å›æ»š ========== class DeploymentRollback: """éƒ¨ç½²å›æ»š""" def __init__(self, deployment_manager): self.deployment_manager = deployment_manager self.rollback_history = [] def execute_rollback(self, target_version: str, reason: str): """æ‰§è¡Œå›æ»š""" print(f"\nInitiating rollback to version {target_version}") print(f"Reason: {reason}") # 1. è®°å½•å›æ»š rollback_record = { 'timestamp': datetime.now().isoformat(), 'from_version': self.deployment_manager.get_current_version(), 'to_version': target_version, 'reason': reason } self.rollback_history.append(rollback_record) # 2. æ‰§è¡Œå›æ»š try: # åœæ­¢å½“å‰ç‰ˆæœ¬ print("Stopping current version...") # éƒ¨ç½²ç›®æ ‡ç‰ˆæœ¬ print(f"Deploying version {target_version}...") # éªŒè¯å›æ»š print("Verifying rollback...") print(f"Rollback to version {target_version} completed successfully!") except Exception as e: print(f"Rollback failed: {e}") raise def get_rollback_history(self): """è·å–å›æ»šå†å²""" return self.rollback_history 3.2 GitOpså®è·µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 # ========== GitOps with ArgoCD ========== # åº”ç”¨éƒ¨ç½²æ¸…å• # apps/application.yaml apiVersion: argoproj.io/v1alpha1 kind: Application metadata: name: my-application namespace: argocd spec: project: default source: repoURL: https://github.com/org/infrastructure.git targetRevision: main path: apps/my-application helm: valueFiles: - values-prod.yaml destination: server: https://kubernetes.default.svc namespace: production syncPolicy: automated: prune: true selfHeal: true syncOptions: - CreateNamespace=true # Kuberneteséƒ¨ç½²æ¸…å• # apps/my-application/deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-application labels: app: my-application spec: replicas: 3 selector: matchLabels: app: my-application template: metadata: labels: app: my-application spec: containers: - name: app image: registry.example.com/my-application:{{ .Values.image.tag }} ports: - containerPort: 8080 resources: requests: memory: "128Mi" cpu: "100m" limits: memory: "256Mi" cpu: "200m" livenessProbe: httpGet: path: /health port: 8080 initialDelaySeconds: 30 periodSeconds: 10 readinessProbe: httpGet: path: /ready port: 8080 initialDelaySeconds: 5 periodSeconds: 5 --- apiVersion: v1 kind: Service metadata: name: my-application spec: selector: app: my-application ports: - port: 80 targetPort: 8080 type: ClusterIP --- apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: my-application annotations: cert-manager.io/cluster-issuer: letsencrypt-prod nginx.ingress.kubernetes.io/ssl-redirect: "true" spec: ingressClassName: nginx tls: - hosts: - app.example.com secretName: my-application-tls rules: - host: app.example.com http: paths: - path: / pathType: Prefix backend: service: name: my-application port: number: 80 # Helm Values # apps/my-application/values-prod.yaml image: tag: "1.2.3" replicas: 3 resources: requests: memory: "256Mi" cpu: "200m" limits: memory: "512Mi" cpu: "500m" autoscaling: enabled: true minReplicas: 3 maxReplicas: 10 targetCPUUtilizationPercentage: 70 targetMemoryUtilizationPercentage: 80 database: host: postgres-production.example.com port: 5432 name: app_production sslMode: require å››ã€åŸºç¡€è®¾æ–½å³ä»£ç (IaC) 4.1 Terraformé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 # ========== Terraformé…ç½®ç¤ºä¾‹ ========== # ä¸»é…ç½®æ–‡ä»¶ # main.tf terraform { required_version = ">= 1.0" required_providers { aws = { source = "hashicorp/aws" version = "~> 5.0" } } backend "s3" { bucket = "terraform-state-prod" key = "production/terraform.tfstate" region = "us-east-1" encrypt = true dynamodb_table = "terraform-locks" } } provider "aws" { region = var.aws_region default_tags { tags = { Environment = var.environment Project = var.project_name ManagedBy = "Terraform" } } } # VPCé…ç½® # modules/vpc/main.tf resource "aws_vpc" "main" { cidr_block = var.vpc_cidr enable_dns_hostnames = true enable_dns_support = true tags = { Name = "${var.project_name}-vpc" } } resource "aws_internet_gateway" "main" { vpc_id = aws_vpc.main.id tags = { Name = "${var.project_name}-igw" } } resource "aws_subnet" "public" { count = length(var.availability_zones) vpc_id = aws_vpc.main.id cidr_block = cidrsubnet(var.vpc_cidr, 8, count.index) availability_zone = var.availability_zones[count.index] map_public_ip_on_launch = true tags = { Name = "${var.project_name}-public-${count.index}" Type = "Public" } } resource "aws_subnet" "private" { count = length(var.availability_zones) vpc_id = aws_vpc.main.id cidr_block = cidrsubnet(var.vpc_cidr, 8, count.index + length(var.availability_zones)) availability_zone = var.availability_zones[count.index] tags = { Name = "${var.project_name}-private-${count.index}" Type = "Private" } } resource "aws_eip" "nat" { count = length(var.availability_zones) domain = "vpc" tags = { Name = "${var.project_name}-nat-${count.index}" } depends_on = [aws_internet_gateway.main] } resource "aws_nat_gateway" "main" { count = length(var.availability_zones) allocation_id = aws_eip.nat[count.index].id subnet_id = aws_subnet.public[count.index].id tags = { Name = "${var.project_name}-nat-${count.index}" } depends_on = [aws_internet_gateway.main] } # EKSé›†ç¾¤é…ç½® # modules/eks/main.tf resource "aws_eks_cluster" "main" { name = "${var.project_name}-cluster" role_arn = aws_iam_role.cluster.arn version = var.kubernetes_version vpc_config { subnet_ids = concat( aws_subnet.private[*].id, aws_subnet.public[*].id ) endpoint_private_access = true endpoint_public_access = true public_access_cidrs = var.allowed_public_access_cidrs } enabled_cluster_log_types = var.cluster_log_types depends_on = [ aws_iam_role_policy_attachment.cluster_amazon_eks_cluster_policy, aws_iam_role_policy_attachment.cluster_amazon_eks_vpc_resource_controller, ] tags = { Name = "${var.project_name}-eks" } } resource "aws_eks_node_group" "main" { cluster_name = aws_eks_cluster.main.name node_group_name = "${var.project_name}-node-group" node_role_arn = aws_iam_role.node.arn subnet_ids = aws_subnet.private[*].id scaling_config { desired_size = var.node_group_desired_size max_size = var.node_group_max_size min_size = var.node_group_min_size } instance_types = var.node_instance_types remote_access { ec2_ssh_key = var.ssh_key_name source_security_group_ids = [aws_security_group.node.id] } labels = { Environment = var.environment Project = var.project_name } tags = { Name = "${var.project_name}-node" } depends_on = [ aws_iam_role_policy_attachment.node_amazon_eks_worker_node_policy, aws_iam_role_policy_attachment.node_amazon_eks_cni_policy, aws_iam_role_policy_attachment.node_amazon_ec2_container_registry_read_only, ] } # å˜é‡å®šä¹‰ # variables.tf variable "aws_region" { description = "AWS region" type = string default = "us-east-1" } variable "environment" { description = "Environment name" type = string validation { condition = contains(["development", "staging", "production"], var.environment) error_message = "Environment must be development, staging, or production." } } variable "project_name" { description = "Project name" type = string } variable "vpc_cidr" { description = "CIDR block for VPC" type = string default = "10.0.0.0/16" } variable "availability_zones" { description = "List of availability zones" type = list(string) default = ["us-east-1a", "us-east-1b", "us-east-1c"] } # è¾“å‡ºå®šä¹‰ # outputs.tf output "cluster_id" { description = "EKS cluster ID" value = aws_eks_cluster.main.id } output "cluster_endpoint" { description = "EKS cluster endpoint" value = aws_eks_cluster.main.endpoint } output "cluster_security_group_id" { description = "Security group ID attached to the EKS cluster" value = aws_eks_cluster.main.vpc_config[0].cluster_security_group_id } output "cluster_certificate_authority_data" { description = "Base64 encoded certificate data required to communicate with the cluster" value = aws_eks_cluster.main.certificate_authority[0].data } 4.2 Dockerä¸Kubernetesé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 # ========== Dockeré…ç½® ========== # Dockerfile FROM python:3.11-slim # è®¾ç½®å·¥ä½œç›®å½• WORKDIR /app # è®¾ç½®ç¯å¢ƒå˜é‡ ENV PYTHONDONTWRITEBYTECODE=1 \ PYTHONUNBUFFERED=1 \ PIP_NO_CACHE_DIR=1 \ PIP_DISABLE_PIP_VERSION_CHECK=1 # å®‰è£…ç³»ç»Ÿä¾èµ– RUN apt-get update && \ apt-get install -y --no-install-recommends \ gcc \ libc6-dev \ && rm -rf /var/lib/apt/lists/* # å¤åˆ¶ä¾èµ–æ–‡ä»¶ COPY requirements.txt . # å®‰è£…Pythonä¾èµ– RUN pip install --no-cache-dir -r requirements.txt # å¤åˆ¶åº”ç”¨ä»£ç  COPY src/ ./src/ COPY config/ ./config/ # åˆ›å»ºérootç”¨æˆ· RUN useradd -m -u 1000 appuser && \ chown -R appuser:appuser /app USER appuser # æš´éœ²ç«¯å£ EXPOSE 8080 # å¥åº·æ£€æŸ¥ HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \ CMD curl -f http://localhost:8080/health || exit 1 # å¯åŠ¨åº”ç”¨ CMD ["gunicorn", "src.app:app", "--bind", "0.0.0.0:8080", "--workers", "4"] # docker-compose.yml version: '3.8' services: app: build: context: . dockerfile: Dockerfile image: my-application:latest ports: - "8080:8080" environment: - DATABASE_URL=postgresql://user:password@db:5432/app - REDIS_URL=redis://redis:6379 depends_on: db: condition: service_healthy redis: condition: service_started healthcheck: test: ["CMD", "curl", "-f", "http://localhost:8080/health"] interval: 30s timeout: 10s retries: 3 start_period: 40s restart: unless-stopped db: image: postgres:15-alpine environment: - POSTGRES_DB=app - POSTGRES_USER=user - POSTGRES_PASSWORD=password volumes: - postgres_data:/var/lib/postgresql/data healthcheck: test: ["CMD-SHELL", "pg_isready -U user -d app"] interval: 10s timeout: 5s retries: 5 restart: unless-stopped redis: image: redis:7-alpine volumes: - redis_data:/data restart: unless-stopped nginx: image: nginx:alpine ports: - "80:80" - "443:443" volumes: - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro - ./nginx/ssl:/etc/nginx/ssl:ro depends_on: - app restart: unless-stopped volumes: postgres_data: redis_data: # ========== Kubernetesé…ç½® ========== # deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-application labels: app: my-application spec: replicas: 3 strategy: type: RollingUpdate rollingUpdate: maxSurge: 1 maxUnavailable: 0 selector: matchLabels: app: my-application template: metadata: labels: app: my-application spec: serviceAccountName: my-application securityContext: runAsNonRoot: true runAsUser: 1000 fsGroup: 1000 containers: - name: app image: registry.example.com/my-application:1.0.0 ports: - name: http containerPort: 8080 protocol: TCP env: - name: DATABASE_URL valueFrom: secretKeyRef: name: app-secrets key: database-url - name: REDIS_URL valueFrom: configMapKeyRef: name: app-config key: redis-url resources: requests: memory: "128Mi" cpu: "100m" limits: memory: "256Mi" cpu: "200m" livenessProbe: httpGet: path: /health port: http initialDelaySeconds: 30 periodSeconds: 10 timeoutSeconds: 5 failureThreshold: 3 readinessProbe: httpGet: path: /ready port: http initialDelaySeconds: 5 periodSeconds: 5 timeoutSeconds: 3 failureThreshold: 3 lifecycle: preStop: exec: command: - sh - -c - sleep 15 terminationGracePeriodSeconds: 30 # service.yaml apiVersion: v1 kind: Service metadata: name: my-application spec: type: ClusterIP selector: app: my-application ports: - name: http port: 80 targetPort: http protocol: TCP # hpa.yaml apiVersion: autoscaling/v2 kind: HorizontalPodAutoscaler metadata: name: my-application spec: scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: my-application minReplicas: 3 maxReplicas: 10 metrics: - type: Resource resource: name: cpu target: type: Utilization averageUtilization: 70 - type: Resource resource: name: memory target: type: Utilization averageUtilization: 80 behavior: scaleDown: stabilizationWindowSeconds: 300 policies: - type: Percent value: 50 periodSeconds: 60 scaleUp: stabilizationWindowSeconds: 0 policies: - type: Percent value: 100 periodSeconds: 30 - type: Pods value: 2 periodSeconds: 60 selectPolicy: Max æ€»ç»“ æ„å»ºé«˜æ•ˆçš„DevOpså’ŒCI/CDæµæ°´çº¿éœ€è¦ï¼š
...</p></div><footer class=entry-footer><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/devops/ class=category-link>DevOps</a><a href=/blog/categories/ci/cd/ class=category-link>CI/CD</a></div><span class=post-date>2025-12-30</span><span class=post-author>æœ‰æ¡å·¥å…·å›¢é˜Ÿ</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></footer><a class=entry-link aria-label="post link to DevOpsä¸CI/CDå®Œå…¨æŒ‡å—ï¼šæ„å»ºé«˜æ•ˆçš„è½¯ä»¶äº¤ä»˜æµæ°´çº¿" href=/blog/articles/devops%E4%B8%8Eci/cd%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97%E6%9E%84%E5%BB%BA%E9%AB%98%E6%95%88%E7%9A%84%E8%BD%AF%E4%BB%B6%E4%BA%A4%E4%BB%98%E6%B5%81%E6%B0%B4%E7%BA%BF/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>ç°ä»£å‰ç«¯å·¥ç¨‹åŒ–ä½“ç³»æ­å»ºï¼šä»é›¶æ„å»ºä¼ä¸šçº§å‰ç«¯é¡¹ç›®æ¶æ„</h2></header><div class=entry-content><p>å¼•è¨€ å‰ç«¯å·¥ç¨‹åŒ–æ˜¯æå‡å›¢é˜Ÿå¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡çš„å…³é”®ã€‚ä¸€ä¸ªå®Œå–„çš„å·¥ç¨‹åŒ–ä½“ç³»åŒ…æ‹¬é¡¹ç›®æ¶æ„ã€å¼€å‘è§„èŒƒã€æ„å»ºå·¥å…·ã€æµ‹è¯•ç­–ç•¥ã€CI/CDæµç¨‹ç­‰å¤šä¸ªæ–¹é¢ã€‚æœ¬æ–‡å°†ä»é›¶å¼€å§‹ï¼Œæ­å»ºä¸€å¥—å®Œæ•´çš„ä¼ä¸šçº§å‰ç«¯å·¥ç¨‹åŒ–ä½“ç³»ã€‚
ä¸€ã€é¡¹ç›®æ¶æ„è®¾è®¡ 1.1 å•ä½“ä»“åº“ï¼ˆMonorepoï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # é¡¹ç›®ç»“æ„ my-project/ â”œâ”€â”€ packages/ â”‚ â”œâ”€â”€ shared/ # å…±äº«ä»£ç  â”‚ â”‚ â”œâ”€â”€ src/ â”‚ â”‚ â”œâ”€â”€ package.json â”‚ â”‚ â””â”€â”€ tsconfig.json â”‚ â”œâ”€â”€ ui/ # UIç»„ä»¶åº“ â”‚ â”‚ â”œâ”€â”€ src/ â”‚ â”‚ â”œâ”€â”€ package.json â”‚ â”‚ â””â”€â”€ tsconfig.json â”‚ â”œâ”€â”€ web/ # Webåº”ç”¨ â”‚ â”‚ â”œâ”€â”€ src/ â”‚ â”‚ â”œâ”€â”€ package.json â”‚ â”‚ â””â”€â”€ vite.config.ts â”‚ â””â”€â”€ admin/ # ç®¡ç†åå° â”‚ â”œâ”€â”€ src/ â”‚ â”œâ”€â”€ package.json â”‚ â””â”€â”€ vite.config.ts â”œâ”€â”€ apps/ â”‚ â””â”€â”€ mobile/ # ç§»åŠ¨åº”ç”¨ â”œâ”€â”€ .gitignore â”œâ”€â”€ pnpm-workspace.yaml # pnpm workspaceé…ç½® â”œâ”€â”€ package.json â”œâ”€â”€ nx.json # Nxé…ç½® â””â”€â”€ tsconfig.base.json 1 2 3 4 # pnpm-workspace.yaml packages: - 'packages/*' - 'apps/*' 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // package.json { "name": "my-monorepo", "private": true, "scripts": { "dev": "turbo run dev", "build": "turbo run build", "test": "turbo run test", "lint": "turbo run lint", "format": "prettier --write \"**/*.{ts,tsx,json,md}\"", "changeset": "changeset", "version": "changeset version", "release": "turbo run build && changeset publish" }, "devDependencies": { "@changesets/cli": "^2.27.0", "prettier": "^3.1.0", "turbo": "^1.11.0", "typescript": "^5.3.0" } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // turbo.json { "$schema": "https://turbo.build/schema.json", "globalDependencies": ["**/.env.*local"], "pipeline": { "build": { "dependsOn": ["^build"], "outputs": ["dist/**", ".next/**", "!.next/cache/**"] }, "dev": { "cache": false, "persistent": true }, "lint": { "outputs": [] }, "test": { "dependsOn": ["build"], "outputs": [], "inputs": ["src/**/*.tsx", "src/**/*.ts", "test/**/*.ts", "test/**/*.tsx"] } } } 1.2 åˆ†å±‚æ¶æ„ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // åˆ†å±‚æ¶æ„è®¾è®¡ src/ â”œâ”€â”€ main/ # ä¸»å…¥å£å±‚ â”‚ â”œâ”€â”€ index.ts â”‚ â””â”€â”€ App.vue â”œâ”€â”€ presentation/ # å±•ç¤ºå±‚ï¼ˆé¡µé¢ã€ç»„ä»¶ï¼‰ â”‚ â”œâ”€â”€ pages/ â”‚ â”‚ â”œâ”€â”€ home/ â”‚ â”‚ â”œâ”€â”€ about/ â”‚ â”‚ â””â”€â”€ dashboard/ â”‚ â””â”€â”€ components/ â”‚ â”œâ”€â”€ common/ â”‚ â””â”€â”€ features/ â”œâ”€â”€ application/ # åº”ç”¨å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰ â”‚ â”œâ”€â”€ useCases/ â”‚ â”‚ â”œâ”€â”€ auth/ â”‚ â”‚ â”œâ”€â”€ user/ â”‚ â”‚ â””â”€â”€ product/ â”‚ â””â”€â”€ services/ â”‚ â””â”€â”€ api/ â”œâ”€â”€ domain/ # é¢†åŸŸå±‚ï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰ â”‚ â”œâ”€â”€ entities/ â”‚ â”œâ”€â”€ valueObjects/ â”‚ â””â”€â”€ repositories/ â”œâ”€â”€ infrastructure/ # åŸºç¡€è®¾æ–½å±‚ â”‚ â”œâ”€â”€ api/ â”‚ â”œâ”€â”€ storage/ â”‚ â””â”€â”€ config/ â””â”€â”€ shared/ # å…±äº«ä»£ç  â”œâ”€â”€ utils/ â”œâ”€â”€ constants/ â”œâ”€â”€ types/ â””â”€â”€ validators/ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 // é¢†åŸŸå®ä½“ç¤ºä¾‹ // domain/entities/User.ts export class User { constructor( private readonly _id: string, private _name: string, private _email: string, private _role: UserRole ) {} get id(): string { return this._id } get name(): string { return this._name } get email(): string { return this._email } get role(): UserRole { return this._role } changeName(name: string): void { if (name.length &lt; 2) { throw new Error('Name too short') } this._name = name } hasRole(role: UserRole): boolean { return this._role === role } } enum UserRole { ADMIN = 'ADMIN', USER = 'USER', GUEST = 'GUEST' } äºŒã€ä»£ç è§„èŒƒ 2.1 ESLinté…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 // .eslintrc.cjs module.exports = { root: true, env: { browser: true, es2021: true, node: true }, extends: [ 'eslint:recommended', 'plugin:@typescript-eslint/recommended', 'plugin:vue/vue3-recommended', 'prettier' ], parser: 'vue-eslint-parser', parserOptions: { ecmaVersion: 'latest', parser: '@typescript-eslint/parser', sourceType: 'module' }, plugins: ['@typescript-eslint', 'vue', 'import'], rules: { // TypeScriptè§„åˆ™ '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_' }], '@typescript-eslint/no-explicit-any': 'warn', '@typescript-eslint/explicit-function-return-type': 'off', '@typescript-eslint/explicit-module-boundary-types': 'off', '@typescript-eslint/no-non-null-assertion': 'warn', // Vueè§„åˆ™ 'vue/multi-word-component-names': 'off', 'vue/no-v-html': 'warn', 'vue/require-default-prop': 'error', 'vue/require-prop-types': 'error', 'vue/component-name-in-template-casing': ['error', 'PascalCase'], // Importè§„åˆ™ 'import/order': [ 'error', { groups: [ 'builtin', 'external', 'internal', 'parent', 'sibling', 'index' ], 'newlines-between': 'always', alphabetize: { order: 'asc', caseInsensitive: true } } ], 'import/no-unresolved': 'error', 'import/no-cycle': 'warn', // é€šç”¨è§„åˆ™ 'no-console': process.env.NODE_ENV === 'production' ? 'warn' : 'off', 'no-debugger': process.env.NODE_ENV === 'production' ? 'warn' : 'off' }, globals: { defineProps: 'readonly', defineEmits: 'readonly', defineExpose: 'readonly', withDefaults: 'readonly' } } 2.2 Prettieré…ç½® 1 2 3 4 5 6 7 8 9 10 11 // .prettierrc { "semi": false, "singleQuote": true, "printWidth": 100, "tabWidth": 2, "trailingComma": "es5", "arrowParens": "avoid", "endOfLine": "lf", "vueIndentScriptAndStyle": false } 1 2 3 4 5 6 7 8 9 // .prettierignore node_modules dist build coverage *.min.js *.min.css package-lock.json pnpm-lock.yaml 2.3 Gitæäº¤è§„èŒƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // .commitlintrc.cjs module.exports = { extends: ['@commitlint/config-conventional'], rules: { 'type-enum': [ 2, 'always', [ 'feat', // æ–°åŠŸèƒ½ 'fix', // ä¿®å¤bug 'docs', // æ–‡æ¡£æ›´æ–° 'style', // ä»£ç æ ¼å¼è°ƒæ•´ 'refactor', // é‡æ„ 'perf', // æ€§èƒ½ä¼˜åŒ– 'test', // æµ‹è¯•ç›¸å…³ 'build', // æ„å»ºç³»ç»Ÿ 'ci', // CIé…ç½® 'chore', // å…¶ä»–æ‚é¡¹ 'revert' // å›é€€æäº¤ ] ], 'scope-case': [2, 'always', 'kebab-case'], 'subject-case': [0], 'subject-empty': [2, 'never'], 'subject-max-length': [2, 'always', 100], 'type-empty': [2, 'never'], 'scope-empty': [1, 'never'] } } 1 2 3 4 5 # .husky/pre-commit #!/usr/bin/env sh . "$(dirname -- "$0")/_/husky.sh" pnpm lint-staged 1 2 3 4 5 # .husky/commit-msg #!/usr/bin/env sh . "$(dirname -- "$0")/_/husky.sh" pnpm commitlint --edit $1 1 2 3 4 5 6 7 8 9 10 11 12 // package.json { "lint-staged": { "*.{ts,tsx,vue}": [ "eslint --fix", "prettier --write" ], "*.{json,md,yml,yaml}": [ "prettier --write" ] } } ä¸‰ã€æ„å»ºä¼˜åŒ– 3.1 Viteé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 // vite.config.ts import { defineConfig } from 'vite' import vue from '@vitejs/plugin-vue' import { resolve } from 'path' export default defineConfig({ plugins: [vue()], resolve: { alias: { '@': resolve(__dirname, 'src'), '@shared': resolve(__dirname, '../shared/src') } }, build: { target: 'es2015', outDir: 'dist', assetsDir: 'assets', sourcemap: false, minify: 'terser', rollupOptions: { output: { // æ‰‹åŠ¨åˆ†åŒ… manualChunks: { 'vue-vendor': ['vue', 'vue-router', 'pinia'], 'ui-library': ['element-plus'], 'utils': ['lodash-es', 'axios', 'dayjs'] }, // æ–‡ä»¶å‘½å chunkFileNames: 'js/[name]-[hash].js', entryFileNames: 'js/[name]-[hash].js', assetFileNames: '[ext]/[name]-[hash].[ext]' } }, // Terseré…ç½® terserOptions: { compress: { drop_console: true, drop_debugger: true, pure_funcs: ['console.log'] } }, // chunkå¤§å°è­¦å‘Šé˜ˆå€¼ chunkSizeWarningLimit: 1000 }, server: { port: 3000, host: true, open: true, proxy: { '/api': { target: 'http://localhost:8080', changeOrigin: true, rewrite: (path) => path.replace(/^\/api/, '') } } }, // CSSé…ç½® css: { preprocessorOptions: { scss: { additionalData: `@use "@/styles/variables" as *;` } }, modules: { localsConvention: 'camelCase' } }, // ä¾èµ–ä¼˜åŒ– optimizeDeps: { include: ['vue', 'vue-router', 'pinia', 'axios'], exclude: [] } }) 3.2 ç¯å¢ƒå˜é‡ç®¡ç† 1 2 3 4 5 # .env.development VITE_APP_TITLE=MyApp (Development) VITE_API_BASE_URL=http://localhost:8080/api VITE_ENABLE_MOCK=true VITE_APP_MOCK_PORT=3001 1 2 3 4 # .env.production VITE_APP_TITLE=MyApp VITE_API_BASE_URL=https://api.example.com VITE_ENABLE_MOCK=false 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // src/config/env.ts interface EnvConfig { appTitle: string apiBaseUrl: string enableMock: boolean mockPort?: number } export const env: EnvConfig = { appTitle: import.meta.env.VITE_APP_TITLE || 'MyApp', apiBaseUrl: import.meta.env.VITE_API_BASE_URL || '/api', enableMock: import.meta.env.VITE_ENABLE_MOCK === 'true', mockPort: import.meta.env.VITE_APP_MOCK_PORT ? parseInt(import.meta.env.VITE_APP_MOCK_PORT) : undefined } å››ã€æµ‹è¯•ç­–ç•¥ 4.1 å•å…ƒæµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // vitest.config.ts import { defineConfig } from 'vitest/config' import vue from '@vitejs/plugin-vue' export default defineConfig({ plugins: [vue()], test: { globals: true, environment: 'jsdom', setupFiles: ['./test/setup.ts'], coverage: { provider: 'v8', reporter: ['text', 'json', 'html'], exclude: [ 'node_modules/', 'test/', '**/*.d.ts', '**/*.config.*', '**/mockData', 'src/main.ts' ] } } }) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // test/utils.test.ts import { describe, it, expect } from 'vitest' import { formatDate, calculateAge } from '@/utils/date' describe('Date Utils', () => { describe('formatDate', () => { it('should format date correctly', () => { const date = new Date('2025-01-01') expect(formatDate(date, 'YYYY-MM-DD')).toBe('2025-01-01') }) it('should handle invalid date', () => { expect(formatDate(null, 'YYYY-MM-DD')).toBe('') }) }) describe('calculateAge', () => { it('should calculate age correctly', () => { const birthDate = new Date('1990-01-01') const currentDate = new Date('2025-01-01') expect(calculateAge(birthDate, currentDate)).toBe(35) }) }) }) 4.2 ç»„ä»¶æµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // test/components/Button.test.ts import { describe, it, expect } from 'vitest' import { mount } from '@vue/test-utils' import Button from '@/components/common/Button.vue' describe('Button Component', () => { it('renders properly', () => { const wrapper = mount(Button, { props: { text: 'Click me', type: 'primary' } }) expect(wrapper.text()).toContain('Click me') expect(wrapper.classes()).toContain('btn-primary') }) it('emits click event', async () => { const wrapper = mount(Button, { props: { text: 'Click me' } }) await wrapper.trigger('click') expect(wrapper.emitted('click')).toBeTruthy() }) it('disables button when loading', () => { const wrapper = mount(Button, { props: { text: 'Submit', loading: true } }) const button = wrapper.find('button') expect(button.attributes('disabled')).toBeDefined() }) }) 4.3 E2Eæµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // e2e/auth.spec.ts import { test, expect } from '@playwright/test' test.describe('Authentication', () => { test.beforeEach(async ({ page }) => { await page.goto('http://localhost:3000') }) test('should login with valid credentials', async ({ page }) => { await page.click('text=Login') await page.fill('[name="email"]', 'user@example.com') await page.fill('[name="password"]', 'password123') await page.click('button[type="submit"]') await expect(page).toHaveURL(/.*dashboard/) await expect(page.locator('text=Welcome')).toBeVisible() }) test('should show error with invalid credentials', async ({ page }) => { await page.click('text=Login') await page.fill('[name="email"]', 'invalid@example.com') await page.fill('[name="password"]', 'wrongpassword') await page.click('button[type="submit"]') await expect(page.locator('text=Invalid credentials')).toBeVisible() }) }) äº”ã€CI/CDæµç¨‹ 5.1 GitHub Actionsé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 # .github/workflows/ci.yml name: CI on: push: branches: [main, develop] pull_request: branches: [main, develop] jobs: lint: runs-on: ubuntu-latest steps: - uses: actions/checkout@v4 - name: Setup pnpm uses: pnpm/action-setup@v2 with: version: 8 - name: Setup Node.js uses: actions/setup-node@v4 with: node-version: 20 cache: 'pnpm' - name: Install dependencies run: pnpm install --frozen-lockfile - name: Run ESLint run: pnpm lint - name: Run TypeScript check run: pnpm typecheck test: runs-on: ubuntu-latest steps: - uses: actions/checkout@v4 - name: Setup pnpm uses: pnpm/action-setup@v2 with: version: 8 - name: Setup Node.js uses: actions/setup-node@v4 with: node-version: 20 cache: 'pnpm' - name: Install dependencies run: pnpm install --frozen-lockfile - name: Run unit tests run: pnpm test:unit - name: Run component tests run: pnpm test:component - name: Upload coverage uses: codecov/codecov-action@v3 with: files: ./coverage/lcov.info build: needs: [lint, test] runs-on: ubuntu-latest steps: - uses: actions/checkout@v4 - name: Setup pnpm uses: pnpm/action-setup@v2 with: version: 8 - name: Setup Node.js uses: actions/setup-node@v4 with: node-version: 20 cache: 'pnpm' - name: Install dependencies run: pnpm install --frozen-lockfile - name: Build run: pnpm build - name: Upload build artifacts uses: actions/upload-artifact@v3 with: name: dist path: dist 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 # .github/workflows/deploy.yml name: Deploy on: push: branches: [main] jobs: deploy: runs-on: ubuntu-latest steps: - uses: actions/checkout@v4 - name: Setup pnpm uses: pnpm/action-setup@v2 with: version: 8 - name: Setup Node.js uses: actions/setup-node@v4 with: node-version: 20 cache: 'pnpm' - name: Install dependencies run: pnpm install --frozen-lockfile - name: Build run: pnpm build env: NODE_ENV: production - name: Deploy to Vercel uses: amondnet/vercel-action@v25 with: vercel-token: ${{ secrets.VERCEL_TOKEN }} vercel-org-id: ${{ secrets.VERCEL_ORG_ID }} vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }} vercel-args: '--prod' å…­ã€ç›‘æ§ä¸æ—¥å¿— 6.1 é”™è¯¯ç›‘æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // src/monitoring/sentry.ts import * as Sentry from '@sentry/vue' export function setupSentry(app: any) { if (import.meta.env.PROD) { Sentry.init({ app, dsn: import.meta.env.VITE_SENTRY_DSN, environment: import.meta.env.MODE, release: import.meta.env.VITE_APP_VERSION, // æ€§èƒ½ç›‘æ§ integrations: [ new Sentry.BrowserTracing({ tracePropagationTargets: ['localhost', 'example.com'] }), new Sentry.Replay() ], // é‡‡æ ·ç‡ tracesSampleRate: 0.1, replaysSessionSampleRate: 0.1, replaysOnErrorSampleRate: 1.0, // è¿‡æ»¤æ•æ„Ÿä¿¡æ¯ beforeSend(event) { // ç§»é™¤æ•æ„Ÿæ•°æ® if (event.request?.headers) { delete event.request.headers['authorization'] } return event } }) } } 6.2 æ€§èƒ½ç›‘æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 // src/monitoring/analytics.ts export class Analytics { private queue: any[] = [] private apiKey: string constructor(apiKey: string) { this.apiKey = apiKey this.init() } private init() { // é¡µé¢åŠ è½½æ€§èƒ½ window.addEventListener('load', () => { setTimeout(() => { this.trackPageLoad() }, 0) }) // å®šæœŸå‘é€é˜Ÿåˆ—æ•°æ® setInterval(() => { this.flush() }, 5000) } private trackPageLoad() { const perfData = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming this.track('page_load', { // DNSæŸ¥è¯¢æ—¶é—´ dns: perfData.domainLookupEnd - perfData.domainLookupStart, // TCPè¿æ¥æ—¶é—´ tcp: perfData.connectEnd - perfData.connectStart, // è¯·æ±‚å“åº”æ—¶é—´ request: perfData.responseEnd - perfData.requestStart, // DOMè§£ææ—¶é—´ domParse: perfData.domComplete - perfData.domInteractive, // é¦–æ¬¡ç»˜åˆ¶ firstPaint: performance.getEntriesByName('first-paint')[0]?.startTime, // é¦–æ¬¡å†…å®¹ç»˜åˆ¶ firstContentfulPaint: performance.getEntriesByName('first-contentful-paint')[0]?.startTime }) } track(eventName: string, data?: any) { this.queue.push({ event: eventName, data, timestamp: Date.now(), url: location.href, userAgent: navigator.userAgent }) } private flush() { if (this.queue.length === 0) return const data = [...this.queue] this.queue = [] fetch('/api/analytics', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-API-Key': this.apiKey }, body: JSON.stringify({ events: data }), keepalive: true }).catch(err => { // å¤±è´¥æ—¶é‡æ–°åŠ å…¥é˜Ÿåˆ— this.queue.unshift(...data) }) } } export const analytics = new Analytics(import.meta.env.VITE_ANALYTICS_API_KEY) æ€»ç»“ å‰ç«¯å·¥ç¨‹åŒ–æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§çš„å·¥ä½œï¼š
...</p></div><footer class=entry-footer><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/ class=category-link>å‰ç«¯å·¥ç¨‹åŒ–</a><a href=/blog/categories/%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84/ class=category-link>é¡¹ç›®æ¶æ„</a></div><span class=post-date>2025-12-24</span><span class=post-author>æœ‰æ¡å·¥å…·å›¢é˜Ÿ</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></footer><a class=entry-link aria-label="post link to ç°ä»£å‰ç«¯å·¥ç¨‹åŒ–ä½“ç³»æ­å»ºï¼šä»é›¶æ„å»ºä¼ä¸šçº§å‰ç«¯é¡¹ç›®æ¶æ„" href=/blog/articles/%E7%8E%B0%E4%BB%A3%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96%E4%BD%93%E7%B3%BB%E6%90%AD%E5%BB%BA%E4%BB%8E%E9%9B%B6%E6%9E%84%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Dockerå®¹å™¨åŒ–å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§å®è·µ</h2></header><div class=entry-content><p>å…¨é¢æŒæ¡Dockerå®¹å™¨åŒ–æŠ€æœ¯ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„æœ€ä½³å®è·µã€‚</p></div><footer class=entry-footer><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/devops/ class=category-link>DevOps</a><a href=/blog/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/ class=category-link>åç«¯å¼€å‘</a></div><span class=post-date>2025-12-21</span><span class=post-author>Util Tech Team</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></footer><a class=entry-link aria-label="post link to Dockerå®¹å™¨åŒ–å®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç”Ÿäº§å®è·µ" href=/blog/articles/docker-containerization-guide/></a></article></main><footer class=footer><span>Â© 2024-2025 æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢</span> Â·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>