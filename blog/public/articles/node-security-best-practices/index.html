<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨å¯é çš„æœåŠ¡ç«¯åº”ç”¨ | æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</title><meta name=keywords content="Node.js,å®‰å…¨,Express,JWT,OWASP"><meta name=description content="å…¨é¢ä»‹ç»Node.jsåº”ç”¨çš„å®‰å…¨é˜²æŠ¤ç­–ç•¥ï¼ŒåŒ…æ‹¬è¾“å…¥éªŒè¯ã€è®¤è¯æˆæƒã€æ•°æ®åŠ å¯†ã€å®‰å…¨é…ç½®ç­‰å…³é”®æŠ€æœ¯ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå®‰å…¨çš„æœåŠ¡ç«¯åº”ç”¨ã€‚"><meta name=author content="æœ‰æ¡å·¥å…·å›¢é˜Ÿ"><link rel=canonical href=/blog/articles/node-security-best-practices/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.7e8505b7cdf8bb22ab2305e53c2700bb06c7e64faeb72cd3468823a9a3bd3d6e.css integrity="sha256-foUFt834uyKrIwXlPCcAuwbH5k+utyzTRogjqaO9PW4=" rel="preload stylesheet" as=style><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=apple-touch-icon href=/blog/apple-touch-icon.png><link rel=mask-icon href=/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=/blog/articles/node-security-best-practices/feed.xml title=rss><link rel=alternate hreflang=zh-cn href=/blog/articles/node-security-best-practices/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=/js/external-link-config.js></script><script src=/js/external-link-interceptor.js></script><link rel=stylesheet href=/blog/css/custom.css media=screen><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«","url":"https://www.util.cn/blog/","description":"æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚","publisher":{"@type":"Organization","name":"æœ‰æ¡å·¥å…·","url":"https://www.util.cn","logo":{"@type":"ImageObject","url":"https://www.util.cn/blog/logo/logo-256.png","width":256,"height":256}},"potentialAction":[{"@type":"SearchAction","target":"https://www.util.cn/blog/search?q={search_term_string}","query-input":"required name=search_term_string"}]}</script><meta property="og:type" content="website"><meta property="og:title" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta property="og:description" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚"><meta property="og:url" content="https://www.util.cn/blog/"><meta property="og:site_name" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢"><meta property="og:image" content="https://www.util.cn/blog/logo/logo-256.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta name=twitter:description content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚"><meta name=twitter:image content="https://www.util.cn/blog/logo/logo-256.png"><meta name=baidu-site-verification content><meta name=category content="æŠ€æœ¯åšå®¢,å¼€å‘è€…å·¥å…·,ç¼–ç¨‹æ•™ç¨‹"><meta name=coverage content="Worldwide"><meta name=distribution content="Global"><meta name=rating content="General"><script id=51la_code async crossorigin=anonymous src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=pro"></script><script>window.addEventListener("load",function(){setTimeout(function(){typeof la!="undefined"?console.log("51laç»Ÿè®¡å·²åŠ è½½"):(console.warn("51laç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"),function(){var e=document.createElement("script");e.src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=backup",e.async=!0,document.head.appendChild(e)}())},3e3)})</script><meta property="og:url" content="/blog/articles/node-security-best-practices/"><meta property="og:site_name" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·"><meta property="og:title" content="Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨å¯é çš„æœåŠ¡ç«¯åº”ç”¨"><meta property="og:description" content="å…¨é¢ä»‹ç»Node.jsåº”ç”¨çš„å®‰å…¨é˜²æŠ¤ç­–ç•¥ï¼ŒåŒ…æ‹¬è¾“å…¥éªŒè¯ã€è®¤è¯æˆæƒã€æ•°æ®åŠ å¯†ã€å®‰å…¨é…ç½®ç­‰å…³é”®æŠ€æœ¯ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå®‰å…¨çš„æœåŠ¡ç«¯åº”ç”¨ã€‚"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-16T00:00:00+00:00"><meta property="article:modified_time" content="2025-12-16T00:00:00+00:00"><meta property="article:tag" content="Node.js"><meta property="article:tag" content="å®‰å…¨"><meta property="article:tag" content="Express"><meta property="article:tag" content="JWT"><meta property="article:tag" content="OWASP"><meta name=twitter:card content="summary"><meta name=twitter:title content="Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨å¯é çš„æœåŠ¡ç«¯åº”ç”¨"><meta name=twitter:description content="å…¨é¢ä»‹ç»Node.jsåº”ç”¨çš„å®‰å…¨é˜²æŠ¤ç­–ç•¥ï¼ŒåŒ…æ‹¬è¾“å…¥éªŒè¯ã€è®¤è¯æˆæƒã€æ•°æ®åŠ å¯†ã€å®‰å…¨é…ç½®ç­‰å…³é”®æŠ€æœ¯ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå®‰å…¨çš„æœåŠ¡ç«¯åº”ç”¨ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"æ‰€æœ‰æ–‡ç« ","item":"/blog/posts/"},{"@type":"ListItem","position":2,"name":"Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨å¯é çš„æœåŠ¡ç«¯åº”ç”¨","item":"/blog/articles/node-security-best-practices/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨å¯é çš„æœåŠ¡ç«¯åº”ç”¨","name":"Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨å¯é çš„æœåŠ¡ç«¯åº”ç”¨","description":"å…¨é¢ä»‹ç»Node.jsåº”ç”¨çš„å®‰å…¨é˜²æŠ¤ç­–ç•¥ï¼ŒåŒ…æ‹¬è¾“å…¥éªŒè¯ã€è®¤è¯æˆæƒã€æ•°æ®åŠ å¯†ã€å®‰å…¨é…ç½®ç­‰å…³é”®æŠ€æœ¯ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå®‰å…¨çš„æœåŠ¡ç«¯åº”ç”¨ã€‚","keywords":["Node.js","å®‰å…¨","Express","JWT","OWASP"],"articleBody":"Node.jsåº”ç”¨çš„å®‰å…¨æ€§æ˜¯ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„é‡è¦è€ƒè™‘å› ç´ ã€‚éšç€Node.jsåœ¨æœåŠ¡ç«¯å¼€å‘ä¸­çš„å¹¿æ³›åº”ç”¨ï¼Œå®‰å…¨é—®é¢˜ä¹Ÿæ—¥ç›Šçªå‡ºã€‚æœ¬æ–‡å°†ä»‹ç»Node.jså®‰å…¨å¼€å‘çš„æœ€ä½³å®è·µå’Œé˜²æŠ¤ç­–ç•¥ã€‚\n1. è¾“å…¥éªŒè¯å’Œæ•°æ®æ¸…ç† é˜²æ­¢æ³¨å…¥æ”»å‡» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 // ä½¿ç”¨helmetè®¾ç½®å®‰å…¨HTTPå¤´ const helmet = require('helmet'); app.use(helmet()); // è‡ªå®šä¹‰å®‰å…¨å¤´é…ç½® app.use(helmet({ contentSecurityPolicy: { directives: { defaultSrc: [\"'self'\"], styleSrc: [\"'self'\", \"'unsafe-inline'\"], scriptSrc: [\"'self'\"], imgSrc: [\"'self'\", \"data:\", \"https:\"], }, }, hsts: { maxAge: 31536000, includeSubDomains: true, preload: true } })); // è¾“å…¥éªŒè¯ä¸­é—´ä»¶ const { body, validationResult, check } = require('express-validator'); // ç”¨æˆ·æ³¨å†ŒéªŒè¯ const validateUserRegistration = [ check('username') .isLength({ min: 3, max: 30 }) .withMessage('ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-30ä¸ªå­—ç¬¦ä¹‹é—´') .matches(/^[a-zA-Z0-9_]+$/) .withMessage('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿'), check('email') .isEmail() .normalizeEmail() .withMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€'), check('password') .isLength({ min: 8 }) .withMessage('å¯†ç é•¿åº¦è‡³å°‘8ä¸ªå­—ç¬¦') .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?\u0026])[A-Za-z\\d@$!%*?\u0026]/) .withMessage('å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦'), check('age') .isInt({ min: 18, max: 120 }) .withMessage('å¹´é¾„å¿…é¡»åœ¨18-120ä¹‹é—´'), ]; // éªŒè¯ä¸­é—´ä»¶å¤„ç† app.post('/api/users/register', validateUserRegistration, (req, res) =\u003e { const errors = validationResult(req); if (!errors.isEmpty()) { return res.status(400).json({ success: false, errors: errors.array() }); } // å¤„ç†æ³¨å†Œé€»è¾‘ const { username, email, password, age } = req.body; // ... }); // SQLæ³¨å…¥é˜²æŠ¤ const mysql = require('mysql2/promise'); const getUserById = async (userId) =\u003e { const connection = await mysql.createConnection(dbConfig); try { // âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ const [rows] = await connection.execute( 'SELECT * FROM users WHERE id = ?', [userId] ); return rows[0]; // âŒ å±é™©çš„å­—ç¬¦ä¸²æ‹¼æ¥ // const query = `SELECT * FROM users WHERE id = ${userId}`; // const [rows] = await connection.execute(query); } finally { await connection.end(); } }; // NoSQLæ³¨å…¥é˜²æŠ¤ const mongoSanitize = require('express-mongo-sanitize'); app.use(mongoSanitize()); // ä½¿ç”¨mongooseçš„éªŒè¯å’Œå®‰å…¨æŸ¥è¯¢ const User = require('./models/User'); const findUsers = async (criteria) =\u003e { // âœ… ä½¿ç”¨mongooseçš„æŸ¥è¯¢æ„å»ºå™¨ const query = {}; if (criteria.name) { query.name = new RegExp(criteria.name, 'i'); } if (criteria.age) { query.age = criteria.age; } return await User.find(query).select('-password'); // âŒ å±é™©çš„ç›´æ¥æŸ¥è¯¢ // return await User.find(JSON.parse(criteria)); }; XSSé˜²æŠ¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 const xss = require('xss'); // HTMLå†…å®¹æ¸…ç† const sanitizeHTML = (html) =\u003e { return xss(html, { whiteList: { a: ['href', 'title', 'target'], b: [], i: [], em: [], strong: [], p: [], br: [] }, stripIgnoreTag: true, stripIgnoreTagBody: ['script'] }); }; // ç”¨æˆ·å†…å®¹å¤„ç† app.post('/api/posts', (req, res) =\u003e { const { title, content } = req.body; // æ¸…ç†ç”¨æˆ·è¾“å…¥ const sanitizedContent = sanitizeHTML(content); // ä¿å­˜åˆ°æ•°æ®åº“ const post = new Post({ title: xss(title), content: sanitizedContent, author: req.user.id }); await post.save(); res.json({ success: true, post: post }); }); // è¾“å‡ºæ—¶è½¬ä¹‰ app.set('view engine', 'ejs'); app.get('/posts/:id', async (req, res) =\u003e { const post = await Post.findById(req.params.id); res.render('post', { post }); // EJSæ¨¡æ¿å¼•æ“ä¼šè‡ªåŠ¨è½¬ä¹‰ }); 2. è®¤è¯å’Œæˆæƒ JWTä»¤ç‰Œå®‰å…¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 const jwt = require('jsonwebtoken'); const crypto = require('crypto'); // JWTé…ç½® const JWT_CONFIG = { secret: process.env.JWT_SECRET || crypto.randomBytes(64).toString('hex'), expiresIn: '15m', refreshExpiresIn: '7d' }; // ç”ŸæˆJWTä»¤ç‰Œ const generateTokens = (user) =\u003e { const payload = { id: user.id, email: user.email, role: user.role, type: 'access' }; const accessToken = jwt.sign(payload, JWT_CONFIG.secret, { expiresIn: JWT_CONFIG.expiresIn, issuer: 'your-app', audience: 'your-app-users' }); const refreshToken = jwt.sign( { id: user.id, type: 'refresh', tokenVersion: user.tokenVersion || 0 }, JWT_CONFIG.secret, { expiresIn: JWT_CONFIG.refreshExpiresIn } ); return { accessToken, refreshToken }; }; // éªŒè¯JWTä¸­é—´ä»¶ const authenticateToken = (req, res, next) =\u003e { const authHeader = req.headers['authorization']; const token = authHeader \u0026\u0026 authHeader.split(' ')[1]; if (!token) { return res.status(401).json({ success: false, message: 'è®¿é—®ä»¤ç‰Œç¼ºå¤±' }); } jwt.verify(token, JWT_CONFIG.secret, (err, user) =\u003e { if (err) { return res.status(403).json({ success: false, message: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' }); } if (user.type !== 'access') { return res.status(403).json({ success: false, message: 'ä»¤ç‰Œç±»å‹é”™è¯¯' }); } req.user = user; next(); }); }; // åˆ·æ–°ä»¤ç‰Œ const refreshAccessToken = async (refreshToken) =\u003e { try { const decoded = jwt.verify(refreshToken, JWT_CONFIG.secret); if (decoded.type !== 'refresh') { throw new Error('æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ'); } const user = await User.findById(decoded.id); if (!user || user.tokenVersion !== decoded.tokenVersion) { throw new Error('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼Œè¯·é‡æ–°ç™»å½•'); } const tokens = generateTokens(user); // ä¿å­˜æ–°çš„refresh token user.refreshToken = tokens.refreshToken; await user.save(); return tokens; } catch (error) { throw new Error('ä»¤ç‰Œåˆ·æ–°å¤±è´¥'); } }; åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 // æƒé™æ£€æŸ¥ä¸­é—´ä»¶ const authorize = (...roles) =\u003e { return (req, res, next) =\u003e { if (!req.user) { return res.status(401).json({ success: false, message: 'æœªè®¤è¯ç”¨æˆ·' }); } if (!roles.includes(req.user.role)) { return res.status(403).json({ success: false, message: 'æƒé™ä¸è¶³' }); } next(); }; }; // ç²¾ç»†åŒ–æƒé™æ§åˆ¶ const checkPermission = (resource, action) =\u003e { return (req, res, next) =\u003e { const user = req.user; const permission = `${resource}:${action}`; // ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™ if (user.role === 'admin') { return next(); } // æ£€æŸ¥ç”¨æˆ·æƒé™ if (!user.permissions || !user.permissions.includes(permission)) { return res.status(403).json({ success: false, message: 'æ“ä½œæƒé™ä¸è¶³' }); } next(); }; }; // èµ„æºæ‰€æœ‰è€…æ£€æŸ¥ const checkOwnership = (resourceModel, resourceIdParam = 'id') =\u003e { return async (req, res, next) =\u003e { try { const resourceId = req.params[resourceIdParam]; const resource = await resourceModel.findById(resourceId); if (!resource) { return res.status(404).json({ success: false, message: 'èµ„æºä¸å­˜åœ¨' }); } // ç®¡ç†å‘˜æˆ–èµ„æºæ‰€æœ‰è€…å¯ä»¥è®¿é—® if (req.user.role === 'admin' || resource.owner.toString() === req.user.id) { req.resource = resource; return next(); } res.status(403).json({ success: false, message: 'æ— æƒè®¿é—®æ­¤èµ„æº' }); } catch (error) { res.status(500).json({ success: false, message: 'æƒé™æ£€æŸ¥å¤±è´¥' }); } }; }; // ä½¿ç”¨ç¤ºä¾‹ app.get('/api/users/profile', authenticateToken, (req, res) =\u003e { // ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„èµ„æ–™ }); app.get('/api/users/:id', authenticateToken, authorize('admin'), (req, res) =\u003e { // åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å…¶ä»–ç”¨æˆ·ä¿¡æ¯ } ); app.put('/api/posts/:id', authenticateToken, checkOwnership(Post), (req, res) =\u003e { // åªæœ‰æ–‡ç« ä½œè€…æˆ–ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹ } ); 3. æ•°æ®åŠ å¯†å’Œå­˜å‚¨å®‰å…¨ å¯†ç åŠ å¯† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 const bcrypt = require('bcrypt'); const crypto = require('crypto'); // å¯†ç å“ˆå¸Œ const hashPassword = async (password) =\u003e { const saltRounds = 12; return await bcrypt.hash(password, saltRounds); }; // å¯†ç éªŒè¯ const verifyPassword = async (password, hashedPassword) =\u003e { return await bcrypt.compare(password, hashedPassword); }; // ç”¨æˆ·æ³¨å†Œç¤ºä¾‹ app.post('/api/auth/register', async (req, res) =\u003e { try { const { username, email, password } = req.body; // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨ const existingUser = await User.findOne({ $or: [{ email }, { username }] }); if (existingUser) { return res.status(409).json({ success: false, message: 'ç”¨æˆ·åæˆ–é‚®ç®±å·²å­˜åœ¨' }); } // åŠ å¯†å¯†ç  const hashedPassword = await hashPassword(password); // åˆ›å»ºç”¨æˆ· const user = new User({ username, email, password: hashedPassword, tokenVersion: 0 }); await user.save(); res.status(201).json({ success: true, message: 'æ³¨å†ŒæˆåŠŸ' }); } catch (error) { res.status(500).json({ success: false, message: 'æ³¨å†Œå¤±è´¥' }); } }); æ•æ„Ÿæ•°æ®åŠ å¯† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 const crypto = require('crypto'); // å¯¹ç§°åŠ å¯† class DataEncryption { constructor(secretKey) { this.algorithm = 'aes-256-gcm'; this.secretKey = crypto.scryptSync(secretKey, 'salt', 32); } encrypt(text) { const iv = crypto.randomBytes(16); const cipher = crypto.createCipher(this.algorithm, this.secretKey); cipher.setAAD(Buffer.from('additional-data')); let encrypted = cipher.update(text, 'utf8', 'hex'); encrypted += cipher.final('hex'); const authTag = cipher.getAuthTag(); return { encrypted, iv: iv.toString('hex'), authTag: authTag.toString('hex') }; } decrypt(encryptedData) { const decipher = crypto.createDecipher(this.algorithm, this.secretKey); decipher.setAAD(Buffer.from('additional-data')); decipher.setAuthTag(Buffer.from(encryptedData.authTag, 'hex')); let decrypted = decipher.update(encryptedData.encrypted, 'hex', 'utf8'); decrypted += decipher.final('utf8'); return decrypted; } } const encryption = new DataEncryption(process.env.ENCRYPTION_KEY); // æ•æ„Ÿä¿¡æ¯å­˜å‚¨ const saveSensitiveData = async (userId, sensitiveInfo) =\u003e { const encrypted = encryption.encrypt(JSON.stringify(sensitiveInfo)); const sensitiveData = new SensitiveData({ userId, data: encrypted.encrypted, iv: encrypted.iv, authTag: encrypted.authTag }); await sensitiveData.save(); }; // APIå¯†é’¥ç®¡ç† class APIKeyManager { static generateAPIKey() { return crypto.randomBytes(32).toString('hex'); } static hashAPIKey(apiKey) { return crypto.createHash('sha256').update(apiKey).digest('hex'); } static verifyAPIKey(apiKey, hashedKey) { const hashed = this.hashAPIKey(apiKey); return crypto.timingSafeEqual( Buffer.from(hashed), Buffer.from(hashedKey) ); } } 4. ä¼šè¯å’ŒCookieå®‰å…¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 const session = require('express-session'); const cookieParser = require('cookie-parser'); // å®‰å…¨çš„ä¼šè¯é…ç½® app.use(session({ secret: process.env.SESSION_SECRET || crypto.randomBytes(64).toString('hex'), resave: false, saveUninitialized: false, name: 'sessionId', // è‡ªå®šä¹‰cookieåç§° cookie: { secure: process.env.NODE_ENV === 'production', // HTTPS only httpOnly: true, // é˜²æ­¢XSS maxAge: 24 * 60 * 60 * 1000, // 24å°æ—¶ sameSite: 'strict', // CSRFé˜²æŠ¤ path: '/' } })); // ä¼šè¯ä¸­é—´ä»¶ const sessionMiddleware = (req, res, next) =\u003e { if (!req.session.userId) { req.session.userId = req.user.id; req.session.createdAt = Date.now(); } // ä¼šè¯è¶…æ—¶æ£€æŸ¥ const sessionAge = Date.now() - req.session.createdAt; const maxSessionAge = 24 * 60 * 60 * 1000; // 24å°æ—¶ if (sessionAge \u003e maxSessionAge) { req.session.destroy(); return res.status(401).json({ success: false, message: 'ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•' }); } next(); }; // ç™»å‡ºå¤„ç† app.post('/api/auth/logout', (req, res) =\u003e { req.session.destroy((err) =\u003e { if (err) { return res.status(500).json({ success: false, message: 'ç™»å‡ºå¤±è´¥' }); } res.clearCookie('sessionId'); res.json({ success: true, message: 'å·²æˆåŠŸç™»å‡º' }); }); }); 5. é™æµå’Œé˜²æŠ¤ è¯·æ±‚é™æµ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 const rateLimit = require('express-rate-limit'); // é€šç”¨é™æµ const generalLimiter = rateLimit({ windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ max: 100, // é™åˆ¶æ¯ä¸ªIP 15åˆ†é’Ÿå†…æœ€å¤š100ä¸ªè¯·æ±‚ message: { success: false, message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•' }, standardHeaders: true, legacyHeaders: false, }); // ç™»å½•é™æµ const loginLimiter = rateLimit({ windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ max: 5, // é™åˆ¶æ¯ä¸ªIP 15åˆ†é’Ÿå†…æœ€å¤š5æ¬¡ç™»å½•å°è¯• message: { success: false, message: 'ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯·15åˆ†é’Ÿåå†è¯•' }, skipSuccessfulRequests: true, }); // APIé™æµ const apiLimiter = rateLimit({ windowMs: 1 * 60 * 1000, // 1åˆ†é’Ÿ max: 30, // é™åˆ¶æ¯ä¸ªIP 1åˆ†é’Ÿå†…æœ€å¤š30ä¸ªAPIè¯·æ±‚ keyGenerator: (req) =\u003e { return req.user ? `user_${req.user.id}` : req.ip; }, }); // åº”ç”¨é™æµä¸­é—´ä»¶ app.use('/api/', apiLimiter); app.post('/api/auth/login', loginLimiter); // è‡ªå®šä¹‰é™æµé€»è¾‘ const createCustomLimiter = (maxRequests, windowMs) =\u003e { const requests = new Map(); return (req, res, next) =\u003e { const key = req.user ? `user_${req.user.id}` : req.ip; const now = Date.now(); const windowStart = now - windowMs; // æ¸…ç†è¿‡æœŸè®°å½• if (requests.has(key)) { const userRequests = requests.get(key).filter( timestamp =\u003e timestamp \u003e windowStart ); requests.set(key, userRequests); } // æ£€æŸ¥è¯·æ±‚æ•°é‡ const currentRequests = requests.get(key) || []; if (currentRequests.length \u003e= maxRequests) { return res.status(429).json({ success: false, message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•' }); } // è®°å½•å½“å‰è¯·æ±‚ currentRequests.push(now); requests.set(key, currentRequests); next(); }; }; CSRFé˜²æŠ¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 const csrf = require('csurf'); const csrfProtection = csrf({ cookie: { httpOnly: true, secure: process.env.NODE_ENV === 'production', sameSite: 'strict' } }); app.use(csrfProtection); // æä¾›CSRFä»¤ç‰Œ app.get('/api/csrf-token', (req, res) =\u003e { res.json({ csrfToken: req.csrfToken() }); }); // é”™è¯¯å¤„ç† app.use((err, req, res, next) =\u003e { if (err.code !== 'EBADCSRFTOKEN') return next(err); res.status(403).json({ success: false, message: 'CSRFä»¤ç‰ŒéªŒè¯å¤±è´¥' }); }); 6. æ—¥å¿—å’Œç›‘æ§ å®‰å…¨æ—¥å¿—è®°å½• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 const winston = require('winston'); // å®‰å…¨æ—¥å¿—é…ç½® const securityLogger = winston.createLogger({ level: 'info', format: winston.format.combine( winston.format.timestamp(), winston.format.json() ), transports: [ new winston.transports.File({ filename: 'security.log', maxsize: 5242880, // 5MB maxFiles: 5 }), new winston.transports.Console({ format: winston.format.simple() }) ] }); // å®‰å…¨äº‹ä»¶è®°å½• const logSecurityEvent = (event, details) =\u003e { securityLogger.info({ event, timestamp: new Date().toISOString(), ...details }); }; // ç™»å½•å¤±è´¥ç›‘æ§ const failedLoginAttempts = new Map(); const MAX_FAILED_ATTEMPTS = 5; const LOCKOUT_TIME = 15 * 60 * 1000; // 15åˆ†é’Ÿ const monitorFailedLogin = (email, ip) =\u003e { const key = `${email}_${ip}`; const attempts = failedLoginAttempts.get(key) || { count: 0, lastAttempt: 0 }; attempts.count++; attempts.lastAttempt = Date.now(); failedLoginAttempts.set(key, attempts); // è®°å½•å®‰å…¨äº‹ä»¶ logSecurityEvent('LOGIN_FAILED', { email, ip, attempts: attempts.count }); // æ£€æŸ¥æ˜¯å¦éœ€è¦é”å®šè´¦æˆ· if (attempts.count \u003e= MAX_FAILED_ATTEMPTS) { logSecurityEvent('ACCOUNT_LOCKED', { email, ip, attempts: attempts.count, lockoutDuration: LOCKOUT_TIME / 60000 }); return true; // éœ€è¦é”å®š } return false; // ä¸éœ€è¦é”å®š }; // æ¸…ç†è¿‡æœŸçš„å¤±è´¥è®°å½• setInterval(() =\u003e { const now = Date.now(); for (const [key, attempts] of failedLoginAttempts.entries()) { if (now - attempts.lastAttempt \u003e LOCKOUT_TIME) { failedLoginAttempts.delete(key); } } }, 60000); // æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡ å…¥ä¾µæ£€æµ‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 // å¼‚å¸¸è¯·æ±‚æ£€æµ‹ const detectSuspiciousActivity = (req, res, next) =\u003e { const suspiciousPatterns = [ /\\.\\./, // è·¯å¾„éå† /","wordCount":"3175","inLanguage":"zh-cn","datePublished":"2025-12-16T00:00:00Z","dateModified":"2025-12-16T00:00:00Z","author":{"@type":"Person","name":"æœ‰æ¡å·¥å…·å›¢é˜Ÿ"},"mainEntityOfPage":{"@type":"WebPage","@id":"/blog/articles/node-security-best-practices/"},"publisher":{"@type":"Organization","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·","logo":{"@type":"ImageObject","url":"/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=/blog/ accesskey=h title="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· (Alt + H)">æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=/blog/posts/ title="æ‰€æœ‰æ–‡ç« åˆ—è¡¨ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŸ¥çœ‹æ‰€æœ‰æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ–‡ç« </span></a></li><li><a href=https://www.util.cn title="æœ‰æ¡å·¥å…· - å¼€å‘è€…çš„å¸¸ç”¨å·¥å…·é›†åˆï¼šæ— å¹¿å‘Š Â· æœ¬åœ°è®¡ç®— Â· å³å¼€å³ç”¨çš„åœ¨çº¿å·¥å…·å¹³å°ï¼Œæä¾›JSONæ ¼å¼åŒ–ã€SQLæ ¼å¼åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰å®ç”¨å·¥å…·"><span>æœ‰æ¡å·¥å…·</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=/blog/categories/ title="æ–‡ç« åˆ†ç±» - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æŠ€æœ¯é¢†åŸŸåˆ†ç±»çš„ä¼˜è´¨æ–‡ç« ï¼ŒåŒ…æ‹¬å‰ç«¯å¼€å‘ã€å·¥å…·ä½¿ç”¨ã€ç¼–ç¨‹æŠ€å·§ç­‰"><span>åˆ†ç±»</span></a></li><li><a href=/blog/tags/ title="æ ‡ç­¾äº‘ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡æ ‡ç­¾å¿«é€Ÿæ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ ‡ç­¾</span></a></li><li><a href=/blog/archives/ title="æ–‡ç« å½’æ¡£ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æ—¶é—´æŸ¥çœ‹å†å²æ–‡ç« "><span>å½’æ¡£</span></a></li><li><a href=/blog/search/ title="æœç´¢æ–‡ç«  - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡å…³é”®è¯æœç´¢æ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹ï¼Œæ”¯æŒæ ‡é¢˜ã€å†…å®¹ã€åˆ†ç±»å’Œæ ‡ç­¾æœç´¢"><span>æœç´¢</span></a></li></ul></nav></header><main class=main><article class=post-single><div class=post-content-wrapper><main class=post-content-main><header class=post-header-main><h1 class="post-title entry-hint-parent">Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨å¯é çš„æœåŠ¡ç«¯åº”ç”¨</h1><div class=post-meta><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/ class=category-link>åç«¯å¼€å‘</a></div><span class=post-date>2025-12-16</span><span class=post-author>æœ‰æ¡å·¥å…·å›¢é˜Ÿ</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></div></header><div class=post-content><p>Node.jsåº”ç”¨çš„å®‰å…¨æ€§æ˜¯ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„é‡è¦è€ƒè™‘å› ç´ ã€‚éšç€Node.jsåœ¨æœåŠ¡ç«¯å¼€å‘ä¸­çš„å¹¿æ³›åº”ç”¨ï¼Œå®‰å…¨é—®é¢˜ä¹Ÿæ—¥ç›Šçªå‡ºã€‚æœ¬æ–‡å°†ä»‹ç»Node.jså®‰å…¨å¼€å‘çš„æœ€ä½³å®è·µå’Œé˜²æŠ¤ç­–ç•¥ã€‚</p><h2 id=1-è¾“å…¥éªŒè¯å’Œæ•°æ®æ¸…ç†>1. è¾“å…¥éªŒè¯å’Œæ•°æ®æ¸…ç†<a hidden class=anchor aria-hidden=true href=#1-è¾“å…¥éªŒè¯å’Œæ•°æ®æ¸…ç†>#</a></h2><h3 id=é˜²æ­¢æ³¨å…¥æ”»å‡»>é˜²æ­¢æ³¨å…¥æ”»å‡»<a hidden class=anchor aria-hidden=true href=#é˜²æ­¢æ³¨å…¥æ”»å‡»>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨helmetè®¾ç½®å®‰å…¨HTTPå¤´
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> helmet <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;helmet&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(helmet());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è‡ªå®šä¹‰å®‰å…¨å¤´é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.use(helmet({
</span></span><span style=display:flex><span>    contentSecurityPolicy<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>        directives<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>            defaultSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>],
</span></span><span style=display:flex><span>            styleSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>, <span style=color:#a5d6ff>&#34;&#39;unsafe-inline&#39;&#34;</span>],
</span></span><span style=display:flex><span>            scriptSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>],
</span></span><span style=display:flex><span>            imgSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>, <span style=color:#a5d6ff>&#34;data:&#34;</span>, <span style=color:#a5d6ff>&#34;https:&#34;</span>],
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    hsts<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>        maxAge<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>31536000</span>,
</span></span><span style=display:flex><span>        includeSubDomains<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        preload<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è¾“å…¥éªŒè¯ä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> { body, validationResult, check } <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;express-validator&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç”¨æˆ·æ³¨å†ŒéªŒè¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> validateUserRegistration <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>    check(<span style=color:#a5d6ff>&#39;username&#39;</span>)
</span></span><span style=display:flex><span>        .isLength({ min<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>3</span>, max<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>30</span> })
</span></span><span style=display:flex><span>        .withMessage(<span style=color:#a5d6ff>&#39;ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-30ä¸ªå­—ç¬¦ä¹‹é—´&#39;</span>)
</span></span><span style=display:flex><span>        .matches(<span style=color:#79c0ff>/^[a-zA-Z0-9_]+$/</span>)
</span></span><span style=display:flex><span>        .withMessage(<span style=color:#a5d6ff>&#39;ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿&#39;</span>),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    check(<span style=color:#a5d6ff>&#39;email&#39;</span>)
</span></span><span style=display:flex><span>        .isEmail()
</span></span><span style=display:flex><span>        .normalizeEmail()
</span></span><span style=display:flex><span>        .withMessage(<span style=color:#a5d6ff>&#39;è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€&#39;</span>),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    check(<span style=color:#a5d6ff>&#39;password&#39;</span>)
</span></span><span style=display:flex><span>        .isLength({ min<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>8</span> })
</span></span><span style=display:flex><span>        .withMessage(<span style=color:#a5d6ff>&#39;å¯†ç é•¿åº¦è‡³å°‘8ä¸ªå­—ç¬¦&#39;</span>)
</span></span><span style=display:flex><span>        .matches(<span style=color:#79c0ff>/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&amp;])[A-Za-z\d@$!%*?&amp;]/</span>)
</span></span><span style=display:flex><span>        .withMessage(<span style=color:#a5d6ff>&#39;å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦&#39;</span>),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    check(<span style=color:#a5d6ff>&#39;age&#39;</span>)
</span></span><span style=display:flex><span>        .isInt({ min<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>18</span>, max<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>120</span> })
</span></span><span style=display:flex><span>        .withMessage(<span style=color:#a5d6ff>&#39;å¹´é¾„å¿…é¡»åœ¨18-120ä¹‹é—´&#39;</span>),
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// éªŒè¯ä¸­é—´ä»¶å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.post(<span style=color:#a5d6ff>&#39;/api/users/register&#39;</span>, validateUserRegistration, (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> errors <span style=color:#ff7b72;font-weight:700>=</span> validationResult(req);
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>errors.isEmpty()) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({
</span></span><span style=display:flex><span>            success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>            errors<span style=color:#ff7b72;font-weight:700>:</span> errors.array()
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å¤„ç†æ³¨å†Œé€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> { username, email, password, age } <span style=color:#ff7b72;font-weight:700>=</span> req.body;
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// SQLæ³¨å…¥é˜²æŠ¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> mysql <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;mysql2/promise&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> getUserById <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (userId) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> connection <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> mysql.createConnection(dbConfig);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>const</span> [rows] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> connection.execute(
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;SELECT * FROM users WHERE id = ?&#39;</span>,
</span></span><span style=display:flex><span>            [userId]
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> rows[<span style=color:#a5d6ff>0</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// âŒ å±é™©çš„å­—ç¬¦ä¸²æ‹¼æ¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#8b949e;font-style:italic>// const query = `SELECT * FROM users WHERE id = ${userId}`;
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#8b949e;font-style:italic>// const [rows] = await connection.execute(query);
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    } <span style=color:#ff7b72>finally</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> connection.end();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// NoSQLæ³¨å…¥é˜²æŠ¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> mongoSanitize <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;express-mongo-sanitize&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(mongoSanitize());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨mongooseçš„éªŒè¯å’Œå®‰å…¨æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> User <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;./models/User&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> findUsers <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (criteria) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// âœ… ä½¿ç”¨mongooseçš„æŸ¥è¯¢æ„å»ºå™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> query <span style=color:#ff7b72;font-weight:700>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (criteria.name) {
</span></span><span style=display:flex><span>        query.name <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> RegExp(criteria.name, <span style=color:#a5d6ff>&#39;i&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (criteria.age) {
</span></span><span style=display:flex><span>        query.age <span style=color:#ff7b72;font-weight:700>=</span> criteria.age;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> User.find(query).select(<span style=color:#a5d6ff>&#39;-password&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// âŒ å±é™©çš„ç›´æ¥æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#8b949e;font-style:italic>// return await User.find(JSON.parse(criteria));
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>};
</span></span></code></pre></td></tr></table></div></div><h3 id=xssé˜²æŠ¤>XSSé˜²æŠ¤<a hidden class=anchor aria-hidden=true href=#xssé˜²æŠ¤>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> xss <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;xss&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// HTMLå†…å®¹æ¸…ç†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> sanitizeHTML <span style=color:#ff7b72;font-weight:700>=</span> (html) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> xss(html, {
</span></span><span style=display:flex><span>        whiteList<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>            a<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#39;href&#39;</span>, <span style=color:#a5d6ff>&#39;title&#39;</span>, <span style=color:#a5d6ff>&#39;target&#39;</span>],
</span></span><span style=display:flex><span>            b<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>            i<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>            em<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>            strong<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>            p<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>            br<span style=color:#ff7b72;font-weight:700>:</span> []
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        stripIgnoreTag<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        stripIgnoreTagBody<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#39;script&#39;</span>]
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç”¨æˆ·å†…å®¹å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.post(<span style=color:#a5d6ff>&#39;/api/posts&#39;</span>, (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> { title, content } <span style=color:#ff7b72;font-weight:700>=</span> req.body;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ¸…ç†ç”¨æˆ·è¾“å…¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> sanitizedContent <span style=color:#ff7b72;font-weight:700>=</span> sanitizeHTML(content);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä¿å­˜åˆ°æ•°æ®åº“
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> post <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Post({
</span></span><span style=display:flex><span>        title<span style=color:#ff7b72;font-weight:700>:</span> xss(title),
</span></span><span style=display:flex><span>        content<span style=color:#ff7b72;font-weight:700>:</span> sanitizedContent,
</span></span><span style=display:flex><span>        author<span style=color:#ff7b72;font-weight:700>:</span> req.user.id
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> post.save();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    res.json({
</span></span><span style=display:flex><span>        success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        post<span style=color:#ff7b72;font-weight:700>:</span> post
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è¾“å‡ºæ—¶è½¬ä¹‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.set(<span style=color:#a5d6ff>&#39;view engine&#39;</span>, <span style=color:#a5d6ff>&#39;ejs&#39;</span>);
</span></span><span style=display:flex><span>app.get(<span style=color:#a5d6ff>&#39;/posts/:id&#39;</span>, <span style=color:#ff7b72>async</span> (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> post <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> Post.findById(req.params.id);
</span></span><span style=display:flex><span>    res.render(<span style=color:#a5d6ff>&#39;post&#39;</span>, { post }); <span style=color:#8b949e;font-style:italic>// EJSæ¨¡æ¿å¼•æ“ä¼šè‡ªåŠ¨è½¬ä¹‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>});
</span></span></code></pre></td></tr></table></div></div><h2 id=2-è®¤è¯å’Œæˆæƒ>2. è®¤è¯å’Œæˆæƒ<a hidden class=anchor aria-hidden=true href=#2-è®¤è¯å’Œæˆæƒ>#</a></h2><h3 id=jwtä»¤ç‰Œå®‰å…¨>JWTä»¤ç‰Œå®‰å…¨<a hidden class=anchor aria-hidden=true href=#jwtä»¤ç‰Œå®‰å…¨>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">96
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> jwt <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;jsonwebtoken&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> crypto <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;crypto&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// JWTé…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> JWT_CONFIG <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>    secret<span style=color:#ff7b72;font-weight:700>:</span> process.env.JWT_SECRET <span style=color:#ff7b72;font-weight:700>||</span> crypto.randomBytes(<span style=color:#a5d6ff>64</span>).toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>),
</span></span><span style=display:flex><span>    expiresIn<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;15m&#39;</span>,
</span></span><span style=display:flex><span>    refreshExpiresIn<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;7d&#39;</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç”ŸæˆJWTä»¤ç‰Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> generateTokens <span style=color:#ff7b72;font-weight:700>=</span> (user) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> payload <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>        id<span style=color:#ff7b72;font-weight:700>:</span> user.id,
</span></span><span style=display:flex><span>        email<span style=color:#ff7b72;font-weight:700>:</span> user.email,
</span></span><span style=display:flex><span>        role<span style=color:#ff7b72;font-weight:700>:</span> user.role,
</span></span><span style=display:flex><span>        type<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;access&#39;</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> accessToken <span style=color:#ff7b72;font-weight:700>=</span> jwt.sign(payload, JWT_CONFIG.secret, {
</span></span><span style=display:flex><span>        expiresIn<span style=color:#ff7b72;font-weight:700>:</span> JWT_CONFIG.expiresIn,
</span></span><span style=display:flex><span>        issuer<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;your-app&#39;</span>,
</span></span><span style=display:flex><span>        audience<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;your-app-users&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> refreshToken <span style=color:#ff7b72;font-weight:700>=</span> jwt.sign(
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            id<span style=color:#ff7b72;font-weight:700>:</span> user.id,
</span></span><span style=display:flex><span>            type<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;refresh&#39;</span>,
</span></span><span style=display:flex><span>            tokenVersion<span style=color:#ff7b72;font-weight:700>:</span> user.tokenVersion <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        JWT_CONFIG.secret,
</span></span><span style=display:flex><span>        { expiresIn<span style=color:#ff7b72;font-weight:700>:</span> JWT_CONFIG.refreshExpiresIn }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> { accessToken, refreshToken };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// éªŒè¯JWTä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> authenticateToken <span style=color:#ff7b72;font-weight:700>=</span> (req, res, next) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> authHeader <span style=color:#ff7b72;font-weight:700>=</span> req.headers[<span style=color:#a5d6ff>&#39;authorization&#39;</span>];
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> token <span style=color:#ff7b72;font-weight:700>=</span> authHeader <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> authHeader.split(<span style=color:#a5d6ff>&#39; &#39;</span>)[<span style=color:#a5d6ff>1</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>token) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>401</span>).json({
</span></span><span style=display:flex><span>            success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>            message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;è®¿é—®ä»¤ç‰Œç¼ºå¤±&#39;</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    jwt.verify(token, JWT_CONFIG.secret, (err, user) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (err) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>403</span>).json({
</span></span><span style=display:flex><span>                success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ&#39;</span>
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (user.type <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#a5d6ff>&#39;access&#39;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>403</span>).json({
</span></span><span style=display:flex><span>                success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;ä»¤ç‰Œç±»å‹é”™è¯¯&#39;</span>
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        req.user <span style=color:#ff7b72;font-weight:700>=</span> user;
</span></span><span style=display:flex><span>        next();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åˆ·æ–°ä»¤ç‰Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> refreshAccessToken <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (refreshToken) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> decoded <span style=color:#ff7b72;font-weight:700>=</span> jwt.verify(refreshToken, JWT_CONFIG.secret);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (decoded.type <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#a5d6ff>&#39;refresh&#39;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> user <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> User.findById(decoded.id);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>user <span style=color:#ff7b72;font-weight:700>||</span> user.tokenVersion <span style=color:#ff7b72;font-weight:700>!==</span> decoded.tokenVersion) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°ï¼Œè¯·é‡æ–°ç™»å½•&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> tokens <span style=color:#ff7b72;font-weight:700>=</span> generateTokens(user);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// ä¿å­˜æ–°çš„refresh token
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        user.refreshToken <span style=color:#ff7b72;font-weight:700>=</span> tokens.refreshToken;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> user.save();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> tokens;
</span></span><span style=display:flex><span>    } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;ä»¤ç‰Œåˆ·æ–°å¤±è´¥&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><h3 id=åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶rbac>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰<a hidden class=anchor aria-hidden=true href=#åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶rbac>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">98
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æƒé™æ£€æŸ¥ä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> authorize <span style=color:#ff7b72;font-weight:700>=</span> (...roles) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> (req, res, next) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>req.user) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>401</span>).json({
</span></span><span style=display:flex><span>                success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;æœªè®¤è¯ç”¨æˆ·&#39;</span>
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>roles.includes(req.user.role)) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>403</span>).json({
</span></span><span style=display:flex><span>                success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;æƒé™ä¸è¶³&#39;</span>
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        next();
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç²¾ç»†åŒ–æƒé™æ§åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> checkPermission <span style=color:#ff7b72;font-weight:700>=</span> (resource, action) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> (req, res, next) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> user <span style=color:#ff7b72;font-weight:700>=</span> req.user;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> permission <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span>resource<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>${</span>action<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> (user.role <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;admin&#39;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> next();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥ç”¨æˆ·æƒé™
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>user.permissions <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#ff7b72;font-weight:700>!</span>user.permissions.includes(permission)) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>403</span>).json({
</span></span><span style=display:flex><span>                success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;æ“ä½œæƒé™ä¸è¶³&#39;</span>
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        next();
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// èµ„æºæ‰€æœ‰è€…æ£€æŸ¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> checkOwnership <span style=color:#ff7b72;font-weight:700>=</span> (resourceModel, resourceIdParam <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;id&#39;</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>async</span> (req, res, next) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> resourceId <span style=color:#ff7b72;font-weight:700>=</span> req.params[resourceIdParam];
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> resource <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> resourceModel.findById(resourceId);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>resource) {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>404</span>).json({
</span></span><span style=display:flex><span>                    success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                    message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;èµ„æºä¸å­˜åœ¨&#39;</span>
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// ç®¡ç†å‘˜æˆ–èµ„æºæ‰€æœ‰è€…å¯ä»¥è®¿é—®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>if</span> (req.user.role <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;admin&#39;</span> <span style=color:#ff7b72;font-weight:700>||</span>
</span></span><span style=display:flex><span>                resource.owner.toString() <span style=color:#ff7b72;font-weight:700>===</span> req.user.id) {
</span></span><span style=display:flex><span>                req.resource <span style=color:#ff7b72;font-weight:700>=</span> resource;
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> next();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            res.status(<span style=color:#a5d6ff>403</span>).json({
</span></span><span style=display:flex><span>                success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;æ— æƒè®¿é—®æ­¤èµ„æº&#39;</span>
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>            res.status(<span style=color:#a5d6ff>500</span>).json({
</span></span><span style=display:flex><span>                success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;æƒé™æ£€æŸ¥å¤±è´¥&#39;</span>
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.get(<span style=color:#a5d6ff>&#39;/api/users/profile&#39;</span>, authenticateToken, (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„èµ„æ–™
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.get(<span style=color:#a5d6ff>&#39;/api/users/:id&#39;</span>,
</span></span><span style=display:flex><span>    authenticateToken,
</span></span><span style=display:flex><span>    authorize(<span style=color:#a5d6ff>&#39;admin&#39;</span>),
</span></span><span style=display:flex><span>    (req, res) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å…¶ä»–ç”¨æˆ·ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.put(<span style=color:#a5d6ff>&#39;/api/posts/:id&#39;</span>,
</span></span><span style=display:flex><span>    authenticateToken,
</span></span><span style=display:flex><span>    checkOwnership(Post),
</span></span><span style=display:flex><span>    (req, res) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// åªæœ‰æ–‡ç« ä½œè€…æˆ–ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>);
</span></span></code></pre></td></tr></table></div></div><h2 id=3-æ•°æ®åŠ å¯†å’Œå­˜å‚¨å®‰å…¨>3. æ•°æ®åŠ å¯†å’Œå­˜å‚¨å®‰å…¨<a hidden class=anchor aria-hidden=true href=#3-æ•°æ®åŠ å¯†å’Œå­˜å‚¨å®‰å…¨>#</a></h2><h3 id=å¯†ç åŠ å¯†>å¯†ç åŠ å¯†<a hidden class=anchor aria-hidden=true href=#å¯†ç åŠ å¯†>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> bcrypt <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;bcrypt&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> crypto <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;crypto&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¯†ç å“ˆå¸Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> hashPassword <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (password) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> saltRounds <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>12</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> bcrypt.hash(password, saltRounds);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¯†ç éªŒè¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> verifyPassword <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (password, hashedPassword) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> bcrypt.compare(password, hashedPassword);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç”¨æˆ·æ³¨å†Œç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.post(<span style=color:#a5d6ff>&#39;/api/auth/register&#39;</span>, <span style=color:#ff7b72>async</span> (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> { username, email, password } <span style=color:#ff7b72;font-weight:700>=</span> req.body;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>const</span> existingUser <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> User.findOne({
</span></span><span style=display:flex><span>            $or<span style=color:#ff7b72;font-weight:700>:</span> [{ email }, { username }]
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (existingUser) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>409</span>).json({
</span></span><span style=display:flex><span>                success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;ç”¨æˆ·åæˆ–é‚®ç®±å·²å­˜åœ¨&#39;</span>
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// åŠ å¯†å¯†ç 
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>const</span> hashedPassword <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> hashPassword(password);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// åˆ›å»ºç”¨æˆ·
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>const</span> user <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> User({
</span></span><span style=display:flex><span>            username,
</span></span><span style=display:flex><span>            email,
</span></span><span style=display:flex><span>            password<span style=color:#ff7b72;font-weight:700>:</span> hashedPassword,
</span></span><span style=display:flex><span>            tokenVersion<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> user.save();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        res.status(<span style=color:#a5d6ff>201</span>).json({
</span></span><span style=display:flex><span>            success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>            message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;æ³¨å†ŒæˆåŠŸ&#39;</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>        res.status(<span style=color:#a5d6ff>500</span>).json({
</span></span><span style=display:flex><span>            success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>            message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;æ³¨å†Œå¤±è´¥&#39;</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});
</span></span></code></pre></td></tr></table></div></div><h3 id=æ•æ„Ÿæ•°æ®åŠ å¯†>æ•æ„Ÿæ•°æ®åŠ å¯†<a hidden class=anchor aria-hidden=true href=#æ•æ„Ÿæ•°æ®åŠ å¯†>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> crypto <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;crypto&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¯¹ç§°åŠ å¯†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> DataEncryption {
</span></span><span style=display:flex><span>    constructor(secretKey) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.algorithm <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;aes-256-gcm&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.secretKey <span style=color:#ff7b72;font-weight:700>=</span> crypto.scryptSync(secretKey, <span style=color:#a5d6ff>&#39;salt&#39;</span>, <span style=color:#a5d6ff>32</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    encrypt(text) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> iv <span style=color:#ff7b72;font-weight:700>=</span> crypto.randomBytes(<span style=color:#a5d6ff>16</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> cipher <span style=color:#ff7b72;font-weight:700>=</span> crypto.createCipher(<span style=color:#ff7b72>this</span>.algorithm, <span style=color:#ff7b72>this</span>.secretKey);
</span></span><span style=display:flex><span>        cipher.setAAD(Buffer.from(<span style=color:#a5d6ff>&#39;additional-data&#39;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>let</span> encrypted <span style=color:#ff7b72;font-weight:700>=</span> cipher.update(text, <span style=color:#a5d6ff>&#39;utf8&#39;</span>, <span style=color:#a5d6ff>&#39;hex&#39;</span>);
</span></span><span style=display:flex><span>        encrypted <span style=color:#ff7b72;font-weight:700>+=</span> cipher.<span style=color:#ff7b72>final</span>(<span style=color:#a5d6ff>&#39;hex&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> authTag <span style=color:#ff7b72;font-weight:700>=</span> cipher.getAuthTag();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>            encrypted,
</span></span><span style=display:flex><span>            iv<span style=color:#ff7b72;font-weight:700>:</span> iv.toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>),
</span></span><span style=display:flex><span>            authTag<span style=color:#ff7b72;font-weight:700>:</span> authTag.toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    decrypt(encryptedData) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> decipher <span style=color:#ff7b72;font-weight:700>=</span> crypto.createDecipher(<span style=color:#ff7b72>this</span>.algorithm, <span style=color:#ff7b72>this</span>.secretKey);
</span></span><span style=display:flex><span>        decipher.setAAD(Buffer.from(<span style=color:#a5d6ff>&#39;additional-data&#39;</span>));
</span></span><span style=display:flex><span>        decipher.setAuthTag(Buffer.from(encryptedData.authTag, <span style=color:#a5d6ff>&#39;hex&#39;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>let</span> decrypted <span style=color:#ff7b72;font-weight:700>=</span> decipher.update(encryptedData.encrypted, <span style=color:#a5d6ff>&#39;hex&#39;</span>, <span style=color:#a5d6ff>&#39;utf8&#39;</span>);
</span></span><span style=display:flex><span>        decrypted <span style=color:#ff7b72;font-weight:700>+=</span> decipher.<span style=color:#ff7b72>final</span>(<span style=color:#a5d6ff>&#39;utf8&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> decrypted;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> encryption <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> DataEncryption(process.env.ENCRYPTION_KEY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ•æ„Ÿä¿¡æ¯å­˜å‚¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> saveSensitiveData <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (userId, sensitiveInfo) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> encrypted <span style=color:#ff7b72;font-weight:700>=</span> encryption.encrypt(JSON.stringify(sensitiveInfo));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> sensitiveData <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> SensitiveData({
</span></span><span style=display:flex><span>        userId,
</span></span><span style=display:flex><span>        data<span style=color:#ff7b72;font-weight:700>:</span> encrypted.encrypted,
</span></span><span style=display:flex><span>        iv<span style=color:#ff7b72;font-weight:700>:</span> encrypted.iv,
</span></span><span style=display:flex><span>        authTag<span style=color:#ff7b72;font-weight:700>:</span> encrypted.authTag
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> sensitiveData.save();
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// APIå¯†é’¥ç®¡ç†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> APIKeyManager {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>static</span> generateAPIKey() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> crypto.randomBytes(<span style=color:#a5d6ff>32</span>).toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>static</span> hashAPIKey(apiKey) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> crypto.createHash(<span style=color:#a5d6ff>&#39;sha256&#39;</span>).update(apiKey).digest(<span style=color:#a5d6ff>&#39;hex&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>static</span> verifyAPIKey(apiKey, hashedKey) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> hashed <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.hashAPIKey(apiKey);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> crypto.timingSafeEqual(
</span></span><span style=display:flex><span>            Buffer.from(hashed),
</span></span><span style=display:flex><span>            Buffer.from(hashedKey)
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=4-ä¼šè¯å’Œcookieå®‰å…¨>4. ä¼šè¯å’ŒCookieå®‰å…¨<a hidden class=anchor aria-hidden=true href=#4-ä¼šè¯å’Œcookieå®‰å…¨>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> session <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;express-session&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> cookieParser <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;cookie-parser&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å®‰å…¨çš„ä¼šè¯é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.use(session({
</span></span><span style=display:flex><span>    secret<span style=color:#ff7b72;font-weight:700>:</span> process.env.SESSION_SECRET <span style=color:#ff7b72;font-weight:700>||</span> crypto.randomBytes(<span style=color:#a5d6ff>64</span>).toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>),
</span></span><span style=display:flex><span>    resave<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>    saveUninitialized<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>    name<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;sessionId&#39;</span>, <span style=color:#8b949e;font-style:italic>// è‡ªå®šä¹‰cookieåç§°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    cookie<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>        secure<span style=color:#ff7b72;font-weight:700>:</span> process.env.NODE_ENV <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;production&#39;</span>, <span style=color:#8b949e;font-style:italic>// HTTPS only
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        httpOnly<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>, <span style=color:#8b949e;font-style:italic>// é˜²æ­¢XSS
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        maxAge<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>24</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>, <span style=color:#8b949e;font-style:italic>// 24å°æ—¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        sameSite<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;strict&#39;</span>, <span style=color:#8b949e;font-style:italic>// CSRFé˜²æŠ¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        path<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;/&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä¼šè¯ä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> sessionMiddleware <span style=color:#ff7b72;font-weight:700>=</span> (req, res, next) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>req.session.userId) {
</span></span><span style=display:flex><span>        req.session.userId <span style=color:#ff7b72;font-weight:700>=</span> req.user.id;
</span></span><span style=display:flex><span>        req.session.createdAt <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä¼šè¯è¶…æ—¶æ£€æŸ¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> sessionAge <span style=color:#ff7b72;font-weight:700>=</span> Date.now() <span style=color:#ff7b72;font-weight:700>-</span> req.session.createdAt;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> maxSessionAge <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>24</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>; <span style=color:#8b949e;font-style:italic>// 24å°æ—¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (sessionAge <span style=color:#ff7b72;font-weight:700>&gt;</span> maxSessionAge) {
</span></span><span style=display:flex><span>        req.session.destroy();
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>401</span>).json({
</span></span><span style=display:flex><span>            success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>            message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•&#39;</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    next();
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç™»å‡ºå¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.post(<span style=color:#a5d6ff>&#39;/api/auth/logout&#39;</span>, (req, res) =&gt; {
</span></span><span style=display:flex><span>    req.session.destroy((err) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (err) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>500</span>).json({
</span></span><span style=display:flex><span>                success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;ç™»å‡ºå¤±è´¥&#39;</span>
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        res.clearCookie(<span style=color:#a5d6ff>&#39;sessionId&#39;</span>);
</span></span><span style=display:flex><span>        res.json({
</span></span><span style=display:flex><span>            success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>            message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;å·²æˆåŠŸç™»å‡º&#39;</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></td></tr></table></div></div><h2 id=5-é™æµå’Œé˜²æŠ¤>5. é™æµå’Œé˜²æŠ¤<a hidden class=anchor aria-hidden=true href=#5-é™æµå’Œé˜²æŠ¤>#</a></h2><h3 id=è¯·æ±‚é™æµ>è¯·æ±‚é™æµ<a hidden class=anchor aria-hidden=true href=#è¯·æ±‚é™æµ>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> rateLimit <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;express-rate-limit&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// é€šç”¨é™æµ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> generalLimiter <span style=color:#ff7b72;font-weight:700>=</span> rateLimit({
</span></span><span style=display:flex><span>    windowMs<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>15</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>, <span style=color:#8b949e;font-style:italic>// 15åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    max<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>100</span>, <span style=color:#8b949e;font-style:italic>// é™åˆ¶æ¯ä¸ªIP 15åˆ†é’Ÿå†…æœ€å¤š100ä¸ªè¯·æ±‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    message<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>        success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>        message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•&#39;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    standardHeaders<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>    legacyHeaders<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç™»å½•é™æµ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> loginLimiter <span style=color:#ff7b72;font-weight:700>=</span> rateLimit({
</span></span><span style=display:flex><span>    windowMs<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>15</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>, <span style=color:#8b949e;font-style:italic>// 15åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    max<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>5</span>, <span style=color:#8b949e;font-style:italic>// é™åˆ¶æ¯ä¸ªIP 15åˆ†é’Ÿå†…æœ€å¤š5æ¬¡ç™»å½•å°è¯•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    message<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>        success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>        message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯·15åˆ†é’Ÿåå†è¯•&#39;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    skipSuccessfulRequests<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// APIé™æµ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> apiLimiter <span style=color:#ff7b72;font-weight:700>=</span> rateLimit({
</span></span><span style=display:flex><span>    windowMs<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>1</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>, <span style=color:#8b949e;font-style:italic>// 1åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    max<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>30</span>, <span style=color:#8b949e;font-style:italic>// é™åˆ¶æ¯ä¸ªIP 1åˆ†é’Ÿå†…æœ€å¤š30ä¸ªAPIè¯·æ±‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    keyGenerator<span style=color:#ff7b72;font-weight:700>:</span> (req) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> req.user <span style=color:#ff7b72;font-weight:700>?</span> <span style=color:#a5d6ff>`user_</span><span style=color:#a5d6ff>${</span>req.user.id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span> <span style=color:#ff7b72;font-weight:700>:</span> req.ip;
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åº”ç”¨é™æµä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.use(<span style=color:#a5d6ff>&#39;/api/&#39;</span>, apiLimiter);
</span></span><span style=display:flex><span>app.post(<span style=color:#a5d6ff>&#39;/api/auth/login&#39;</span>, loginLimiter);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è‡ªå®šä¹‰é™æµé€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> createCustomLimiter <span style=color:#ff7b72;font-weight:700>=</span> (maxRequests, windowMs) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> requests <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Map();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> (req, res, next) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> key <span style=color:#ff7b72;font-weight:700>=</span> req.user <span style=color:#ff7b72;font-weight:700>?</span> <span style=color:#a5d6ff>`user_</span><span style=color:#a5d6ff>${</span>req.user.id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span> <span style=color:#ff7b72;font-weight:700>:</span> req.ip;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> now <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> windowStart <span style=color:#ff7b72;font-weight:700>=</span> now <span style=color:#ff7b72;font-weight:700>-</span> windowMs;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ¸…ç†è¿‡æœŸè®°å½•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> (requests.has(key)) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> userRequests <span style=color:#ff7b72;font-weight:700>=</span> requests.get(key).filter(
</span></span><span style=display:flex><span>                timestamp =&gt; timestamp <span style=color:#ff7b72;font-weight:700>&gt;</span> windowStart
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>            requests.set(key, userRequests);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥è¯·æ±‚æ•°é‡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>const</span> currentRequests <span style=color:#ff7b72;font-weight:700>=</span> requests.get(key) <span style=color:#ff7b72;font-weight:700>||</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (currentRequests.length <span style=color:#ff7b72;font-weight:700>&gt;=</span> maxRequests) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>429</span>).json({
</span></span><span style=display:flex><span>                success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•&#39;</span>
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// è®°å½•å½“å‰è¯·æ±‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        currentRequests.push(now);
</span></span><span style=display:flex><span>        requests.set(key, currentRequests);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        next();
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><h3 id=csrfé˜²æŠ¤>CSRFé˜²æŠ¤<a hidden class=anchor aria-hidden=true href=#csrfé˜²æŠ¤>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> csrf <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;csurf&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> csrfProtection <span style=color:#ff7b72;font-weight:700>=</span> csrf({
</span></span><span style=display:flex><span>    cookie<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>        httpOnly<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        secure<span style=color:#ff7b72;font-weight:700>:</span> process.env.NODE_ENV <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;production&#39;</span>,
</span></span><span style=display:flex><span>        sameSite<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;strict&#39;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(csrfProtection);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æä¾›CSRFä»¤ç‰Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.get(<span style=color:#a5d6ff>&#39;/api/csrf-token&#39;</span>, (req, res) =&gt; {
</span></span><span style=display:flex><span>    res.json({
</span></span><span style=display:flex><span>        csrfToken<span style=color:#ff7b72;font-weight:700>:</span> req.csrfToken()
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// é”™è¯¯å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.use((err, req, res, next) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (err.code <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#a5d6ff>&#39;EBADCSRFTOKEN&#39;</span>) <span style=color:#ff7b72>return</span> next(err);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    res.status(<span style=color:#a5d6ff>403</span>).json({
</span></span><span style=display:flex><span>        success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>        message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;CSRFä»¤ç‰ŒéªŒè¯å¤±è´¥&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span></code></pre></td></tr></table></div></div><h2 id=6-æ—¥å¿—å’Œç›‘æ§>6. æ—¥å¿—å’Œç›‘æ§<a hidden class=anchor aria-hidden=true href=#6-æ—¥å¿—å’Œç›‘æ§>#</a></h2><h3 id=å®‰å…¨æ—¥å¿—è®°å½•>å®‰å…¨æ—¥å¿—è®°å½•<a hidden class=anchor aria-hidden=true href=#å®‰å…¨æ—¥å¿—è®°å½•>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> winston <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;winston&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å®‰å…¨æ—¥å¿—é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> securityLogger <span style=color:#ff7b72;font-weight:700>=</span> winston.createLogger({
</span></span><span style=display:flex><span>    level<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;info&#39;</span>,
</span></span><span style=display:flex><span>    format<span style=color:#ff7b72;font-weight:700>:</span> winston.format.combine(
</span></span><span style=display:flex><span>        winston.format.timestamp(),
</span></span><span style=display:flex><span>        winston.format.json()
</span></span><span style=display:flex><span>    ),
</span></span><span style=display:flex><span>    transports<span style=color:#ff7b72;font-weight:700>:</span> [
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>new</span> winston.transports.File({
</span></span><span style=display:flex><span>            filename<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;security.log&#39;</span>,
</span></span><span style=display:flex><span>            maxsize<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>5242880</span>, <span style=color:#8b949e;font-style:italic>// 5MB
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            maxFiles<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>5</span>
</span></span><span style=display:flex><span>        }),
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>new</span> winston.transports.Console({
</span></span><span style=display:flex><span>            format<span style=color:#ff7b72;font-weight:700>:</span> winston.format.simple()
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å®‰å…¨äº‹ä»¶è®°å½•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> logSecurityEvent <span style=color:#ff7b72;font-weight:700>=</span> (event, details) =&gt; {
</span></span><span style=display:flex><span>    securityLogger.info({
</span></span><span style=display:flex><span>        event,
</span></span><span style=display:flex><span>        timestamp<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>new</span> Date().toISOString(),
</span></span><span style=display:flex><span>        ...details
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç™»å½•å¤±è´¥ç›‘æ§
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> failedLoginAttempts <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Map();
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> MAX_FAILED_ATTEMPTS <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>5</span>;
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> LOCKOUT_TIME <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>15</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>; <span style=color:#8b949e;font-style:italic>// 15åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> monitorFailedLogin <span style=color:#ff7b72;font-weight:700>=</span> (email, ip) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span>email<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>_</span><span style=color:#a5d6ff>${</span>ip<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> attempts <span style=color:#ff7b72;font-weight:700>=</span> failedLoginAttempts.get(key) <span style=color:#ff7b72;font-weight:700>||</span> {
</span></span><span style=display:flex><span>        count<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>        lastAttempt<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    attempts.count<span style=color:#ff7b72;font-weight:700>++</span>;
</span></span><span style=display:flex><span>    attempts.lastAttempt <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>    failedLoginAttempts.set(key, attempts);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è®°å½•å®‰å…¨äº‹ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    logSecurityEvent(<span style=color:#a5d6ff>&#39;LOGIN_FAILED&#39;</span>, {
</span></span><span style=display:flex><span>        email,
</span></span><span style=display:flex><span>        ip,
</span></span><span style=display:flex><span>        attempts<span style=color:#ff7b72;font-weight:700>:</span> attempts.count
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥æ˜¯å¦éœ€è¦é”å®šè´¦æˆ·
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> (attempts.count <span style=color:#ff7b72;font-weight:700>&gt;=</span> MAX_FAILED_ATTEMPTS) {
</span></span><span style=display:flex><span>        logSecurityEvent(<span style=color:#a5d6ff>&#39;ACCOUNT_LOCKED&#39;</span>, {
</span></span><span style=display:flex><span>            email,
</span></span><span style=display:flex><span>            ip,
</span></span><span style=display:flex><span>            attempts<span style=color:#ff7b72;font-weight:700>:</span> attempts.count,
</span></span><span style=display:flex><span>            lockoutDuration<span style=color:#ff7b72;font-weight:700>:</span> LOCKOUT_TIME <span style=color:#ff7b72;font-weight:700>/</span> <span style=color:#a5d6ff>60000</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>true</span>; <span style=color:#8b949e;font-style:italic>// éœ€è¦é”å®š
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>false</span>; <span style=color:#8b949e;font-style:italic>// ä¸éœ€è¦é”å®š
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ¸…ç†è¿‡æœŸçš„å¤±è´¥è®°å½•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>setInterval(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> now <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> [key, attempts] <span style=color:#ff7b72>of</span> failedLoginAttempts.entries()) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (now <span style=color:#ff7b72;font-weight:700>-</span> attempts.lastAttempt <span style=color:#ff7b72;font-weight:700>&gt;</span> LOCKOUT_TIME) {
</span></span><span style=display:flex><span>            failedLoginAttempts.<span style=color:#ff7b72>delete</span>(key);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}, <span style=color:#a5d6ff>60000</span>); <span style=color:#8b949e;font-style:italic>// æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
</span></span></span></code></pre></td></tr></table></div></div><h3 id=å…¥ä¾µæ£€æµ‹>å…¥ä¾µæ£€æµ‹<a hidden class=anchor aria-hidden=true href=#å…¥ä¾µæ£€æµ‹>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¼‚å¸¸è¯·æ±‚æ£€æµ‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> detectSuspiciousActivity <span style=color:#ff7b72;font-weight:700>=</span> (req, res, next) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> suspiciousPatterns <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#79c0ff>/\.\./</span>,                    <span style=color:#8b949e;font-style:italic>// è·¯å¾„éå†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#79c0ff>/&lt;script/i</span>,               <span style=color:#8b949e;font-style:italic>// XSSå°è¯•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#79c0ff>/union.*select/i</span>,         <span style=color:#8b949e;font-style:italic>// SQLæ³¨å…¥å°è¯•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#79c0ff>/javascript:/i</span>,           <span style=color:#8b949e;font-style:italic>// JavaScriptåè®®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#79c0ff>/data:/i</span>                  <span style=color:#8b949e;font-style:italic>// Dataåè®®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> url <span style=color:#ff7b72;font-weight:700>=</span> req.url;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> userAgent <span style=color:#ff7b72;font-weight:700>=</span> req.get(<span style=color:#a5d6ff>&#39;User-Agent&#39;</span>) <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>&#39;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥å¯ç–‘URLæ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> pattern <span style=color:#ff7b72>of</span> suspiciousPatterns) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (pattern.test(url)) {
</span></span><span style=display:flex><span>            logSecurityEvent(<span style=color:#a5d6ff>&#39;SUSPICIOUS_REQUEST&#39;</span>, {
</span></span><span style=display:flex><span>                url,
</span></span><span style=display:flex><span>                userAgent,
</span></span><span style=display:flex><span>                ip<span style=color:#ff7b72;font-weight:700>:</span> req.ip,
</span></span><span style=display:flex><span>                pattern<span style=color:#ff7b72;font-weight:700>:</span> pattern.toString()
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({
</span></span><span style=display:flex><span>                success<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;è¯·æ±‚åŒ…å«æ¶æ„å†…å®¹&#39;</span>
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥å¼‚å¸¸User-Agent
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>userAgent <span style=color:#ff7b72;font-weight:700>||</span> userAgent.length <span style=color:#ff7b72;font-weight:700>&lt;</span> <span style=color:#a5d6ff>10</span>) {
</span></span><span style=display:flex><span>        logSecurityEvent(<span style=color:#a5d6ff>&#39;SUSPICIOUS_USER_AGENT&#39;</span>, {
</span></span><span style=display:flex><span>            userAgent,
</span></span><span style=display:flex><span>            ip<span style=color:#ff7b72;font-weight:700>:</span> req.ip
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    next();
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ£€æŸ¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> multer <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;multer&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> path <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;path&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> fileFilter <span style=color:#ff7b72;font-weight:700>=</span> (req, file, cb) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> allowedExtensions <span style=color:#ff7b72;font-weight:700>=</span> [<span style=color:#a5d6ff>&#39;.jpg&#39;</span>, <span style=color:#a5d6ff>&#39;.jpeg&#39;</span>, <span style=color:#a5d6ff>&#39;.png&#39;</span>, <span style=color:#a5d6ff>&#39;.gif&#39;</span>, <span style=color:#a5d6ff>&#39;.pdf&#39;</span>, <span style=color:#a5d6ff>&#39;.doc&#39;</span>, <span style=color:#a5d6ff>&#39;.docx&#39;</span>];
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> fileExtension <span style=color:#ff7b72;font-weight:700>=</span> path.extname(file.originalname).toLowerCase();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>allowedExtensions.includes(fileExtension)) {
</span></span><span style=display:flex><span>        logSecurityEvent(<span style=color:#a5d6ff>&#39;SUSPICIOUS_FILE_UPLOAD&#39;</span>, {
</span></span><span style=display:flex><span>            filename<span style=color:#ff7b72;font-weight:700>:</span> file.originalname,
</span></span><span style=display:flex><span>            mimetype<span style=color:#ff7b72;font-weight:700>:</span> file.mimetype,
</span></span><span style=display:flex><span>            ip<span style=color:#ff7b72;font-weight:700>:</span> req.ip
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> cb(<span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹&#39;</span>), <span style=color:#79c0ff>false</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cb(<span style=color:#79c0ff>null</span>, <span style=color:#79c0ff>true</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> upload <span style=color:#ff7b72;font-weight:700>=</span> multer({
</span></span><span style=display:flex><span>    dest<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;uploads/&#39;</span>,
</span></span><span style=display:flex><span>    fileFilter,
</span></span><span style=display:flex><span>    limits<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>        fileSize<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>5</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1024</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1024</span> <span style=color:#8b949e;font-style:italic>// 5MBé™åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>});
</span></span></code></pre></td></tr></table></div></div><h2 id=7-ç¯å¢ƒå’Œéƒ¨ç½²å®‰å…¨>7. ç¯å¢ƒå’Œéƒ¨ç½²å®‰å…¨<a hidden class=anchor aria-hidden=true href=#7-ç¯å¢ƒå’Œéƒ¨ç½²å®‰å…¨>#</a></h2><h3 id=ç¯å¢ƒå˜é‡å®‰å…¨>ç¯å¢ƒå˜é‡å®‰å…¨<a hidden class=anchor aria-hidden=true href=#ç¯å¢ƒå˜é‡å®‰å…¨>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// .envæ–‡ä»¶ç¤ºä¾‹ï¼ˆä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>NODE_ENV<span style=color:#ff7b72;font-weight:700>=</span>production
</span></span><span style=display:flex><span>PORT<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3000</span>
</span></span><span style=display:flex><span>JWT_SECRET<span style=color:#ff7b72;font-weight:700>=</span>your<span style=color:#ff7b72;font-weight:700>-</span><span style=color:#ff7b72>super</span><span style=color:#ff7b72;font-weight:700>-</span>secret<span style=color:#ff7b72;font-weight:700>-</span>jwt<span style=color:#ff7b72;font-weight:700>-</span>key<span style=color:#ff7b72;font-weight:700>-</span>here
</span></span><span style=display:flex><span>ENCRYPTION_KEY<span style=color:#ff7b72;font-weight:700>=</span>your<span style=color:#ff7b72;font-weight:700>-</span>encryption<span style=color:#ff7b72;font-weight:700>-</span>key<span style=color:#ff7b72;font-weight:700>-</span>here
</span></span><span style=display:flex><span>DATABASE_URL<span style=color:#ff7b72;font-weight:700>=</span>postgresql<span style=color:#ff7b72;font-weight:700>:</span><span style=color:#8b949e;font-style:italic>//username:password@localhost:5432/dbname
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>REDIS_URL<span style=color:#ff7b72;font-weight:700>=</span>redis<span style=color:#ff7b72;font-weight:700>:</span><span style=color:#8b949e;font-style:italic>//localhost:6379
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç¯å¢ƒå˜é‡éªŒè¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> requiredEnvVars <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;JWT_SECRET&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;ENCRYPTION_KEY&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;DATABASE_URL&#39;</span>
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> validateEnvironment <span style=color:#ff7b72;font-weight:700>=</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> missingVars <span style=color:#ff7b72;font-weight:700>=</span> requiredEnvVars.filter(
</span></span><span style=display:flex><span>        varName =&gt; <span style=color:#ff7b72;font-weight:700>!</span>process.env[varName]
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (missingVars.length <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#a5d6ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>`ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: </span><span style=color:#a5d6ff>${</span>missingVars.join(<span style=color:#a5d6ff>&#39;, &#39;</span>)<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥å¯†é’¥é•¿åº¦
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> (process.env.JWT_SECRET.length <span style=color:#ff7b72;font-weight:700>&lt;</span> <span style=color:#a5d6ff>32</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;JWT_SECRETé•¿åº¦è‡³å°‘32ä¸ªå­—ç¬¦&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (process.env.ENCRYPTION_KEY.length <span style=color:#ff7b72;font-weight:700>&lt;</span> <span style=color:#a5d6ff>16</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;ENCRYPTION_KEYé•¿åº¦è‡³å°‘16ä¸ªå­—ç¬¦&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åº”ç”¨å¯åŠ¨æ—¶éªŒè¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>validateEnvironment();
</span></span></code></pre></td></tr></table></div></div><h3 id=dockerå®‰å…¨é…ç½®>Dockerå®‰å…¨é…ç½®<a hidden class=anchor aria-hidden=true href=#dockerå®‰å…¨é…ç½®>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ä½¿ç”¨érootç”¨æˆ·è¿è¡Œ</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>FROM</span><span style=color:#a5d6ff> node:18-alpine</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#8b949e;font-style:italic># åˆ›å»ºåº”ç”¨ç”¨æˆ·</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>RUN</span> addgroup -g <span style=color:#a5d6ff>1001</span> -S nodejs <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    adduser -S nodejs -u <span style=color:#a5d6ff>1001</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>WORKDIR</span><span style=color:#a5d6ff> /app</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#8b949e;font-style:italic># å¤åˆ¶packageæ–‡ä»¶å¹¶å®‰è£…ä¾èµ–</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>COPY</span> package*.json ./<span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>RUN</span> npm ci --only<span style=color:#ff7b72;font-weight:700>=</span>production <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> npm cache clean --force<span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#8b949e;font-style:italic># å¤åˆ¶åº”ç”¨ä»£ç </span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>COPY</span> --chown<span style=color:#ff7b72;font-weight:700>=</span>nodejs:nodejs . .<span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#8b949e;font-style:italic># è®¾ç½®æ–‡ä»¶æƒé™</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>RUN</span> chmod -R <span style=color:#a5d6ff>755</span> /app<span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#8b949e;font-style:italic># åˆ‡æ¢åˆ°érootç”¨æˆ·</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>USER</span><span style=color:#a5d6ff> nodejs</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#8b949e;font-style:italic># æš´éœ²ç«¯å£</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>EXPOSE</span><span style=color:#a5d6ff> 3000</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#8b949e;font-style:italic># å¥åº·æ£€æŸ¥</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>HEALTHCHECK --interval=30s --timeout=3s </span>--start-period<span style=color:#ff7b72;font-weight:700>=</span>5s --retries<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    CMD node healthcheck.js<span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#8b949e;font-style:italic># å¯åŠ¨åº”ç”¨</span><span style=color:#f85149>
</span></span></span><span style=display:flex><span><span style=color:#f85149></span><span style=color:#ff7b72>CMD</span> [<span style=color:#a5d6ff>&#34;node&#34;</span>, <span style=color:#a5d6ff>&#34;server.js&#34;</span>]<span style=color:#f85149>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=httpsé…ç½®>HTTPSé…ç½®<a hidden class=anchor aria-hidden=true href=#httpsé…ç½®>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> https <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;https&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> fs <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;fs&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// HTTPSæœåŠ¡å™¨é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> httpsOptions <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>    key<span style=color:#ff7b72;font-weight:700>:</span> fs.readFileSync(<span style=color:#a5d6ff>&#39;/path/to/private.key&#39;</span>),
</span></span><span style=display:flex><span>    cert<span style=color:#ff7b72;font-weight:700>:</span> fs.readFileSync(<span style=color:#a5d6ff>&#39;/path/to/certificate.crt&#39;</span>),
</span></span><span style=display:flex><span>    ca<span style=color:#ff7b72;font-weight:700>:</span> fs.readFileSync(<span style=color:#a5d6ff>&#39;/path/to/ca_bundle.crt&#39;</span>),
</span></span><span style=display:flex><span>    minVersion<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;TLSv1.2&#39;</span>,
</span></span><span style=display:flex><span>    ciphers<span style=color:#ff7b72;font-weight:700>:</span> [
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;ECDHE-ECDSA-AES256-GCM-SHA384&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;ECDHE-RSA-AES256-GCM-SHA384&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;ECDHE-ECDSA-CHACHA20-POLY1305&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;ECDHE-RSA-CHACHA20-POLY1305&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;ECDHE-ECDSA-AES128-GCM-SHA256&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#39;ECDHE-RSA-AES128-GCM-SHA256&#39;</span>
</span></span><span style=display:flex><span>    ].join(<span style=color:#a5d6ff>&#39;:&#39;</span>),
</span></span><span style=display:flex><span>    honorCipherOrder<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åˆ›å»ºHTTPSæœåŠ¡å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> server <span style=color:#ff7b72;font-weight:700>=</span> https.createServer(httpsOptions, app);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// HSTSå¼ºåˆ¶HTTPS
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.use((req, res, next) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (req.protocol <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;http&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> res.redirect(<span style=color:#a5d6ff>301</span>, <span style=color:#a5d6ff>`https://</span><span style=color:#a5d6ff>${</span>req.headers.host<span style=color:#a5d6ff>}${</span>req.url<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    next();
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¯åŠ¨æœåŠ¡å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>server.listen(<span style=color:#a5d6ff>443</span>, () =&gt; {
</span></span><span style=display:flex><span>    console.log(<span style=color:#a5d6ff>&#39;HTTPSæœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£443&#39;</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></td></tr></table></div></div><h2 id=8-å®‰å…¨æ£€æŸ¥æ¸…å•>8. å®‰å…¨æ£€æŸ¥æ¸…å•<a hidden class=anchor aria-hidden=true href=#8-å®‰å…¨æ£€æŸ¥æ¸…å•>#</a></h2><h3 id=å¼€å‘é˜¶æ®µ>å¼€å‘é˜¶æ®µ<a hidden class=anchor aria-hidden=true href=#å¼€å‘é˜¶æ®µ>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å®‰å…¨æ£€æŸ¥è„šæœ¬
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> securityChecklist <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>    inputValidation<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>        isUserInputSanitized<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        isParameterizedQueryUsed<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        isXSSProtectionEnabled<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        isCSRFTokenImplemented<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    authentication<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>        isPasswordHashed<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        isSessionSecure<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        isJWTSecure<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        isRateLimitingEnabled<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    dataProtection<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>        isSensitiveDataEncrypted<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        isHTTPSUsed<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        isDatabaseSecure<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        isBackupEncrypted<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    infrastructure<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>        isEnvironmentSecure<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        AreDependenciesUpdated<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        isLoggingEnabled<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        isMonitoringSetup<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è‡ªåŠ¨åŒ–å®‰å…¨æµ‹è¯•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> runSecurityTests <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> tests <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>        testSQLInjectionProtection,
</span></span><span style=display:flex><span>        testXSSProtection,
</span></span><span style=display:flex><span>        testCSRFProtection,
</span></span><span style=display:flex><span>        testAuthentication,
</span></span><span style=display:flex><span>        testAuthorization,
</span></span><span style=display:flex><span>        testRateLimiting,
</span></span><span style=display:flex><span>        testInputValidation,
</span></span><span style=display:flex><span>        testDataEncryption
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> test <span style=color:#ff7b72>of</span> tests) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> test();
</span></span><span style=display:flex><span>            console.log(<span style=color:#a5d6ff>`âœ… </span><span style=color:#a5d6ff>${</span>test.name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> é€šè¿‡`</span>);
</span></span><span style=display:flex><span>        } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>            console.error(<span style=color:#a5d6ff>`âŒ </span><span style=color:#a5d6ff>${</span>test.name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> å¤±è´¥:`</span>, error.message);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><h3 id=ç”Ÿäº§éƒ¨ç½²æ£€æŸ¥>ç”Ÿäº§éƒ¨ç½²æ£€æŸ¥<a hidden class=anchor aria-hidden=true href=#ç”Ÿäº§éƒ¨ç½²æ£€æŸ¥>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ£€æŸ¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> productionSecurityCheck <span style=color:#ff7b72;font-weight:700>=</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> checks <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            name<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;ç¯å¢ƒå˜é‡å®‰å…¨&#39;</span>,
</span></span><span style=display:flex><span>            check<span style=color:#ff7b72;font-weight:700>:</span> () =&gt; process.env.NODE_ENV <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;production&#39;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            name<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;HTTPSå¯ç”¨&#39;</span>,
</span></span><span style=display:flex><span>            check<span style=color:#ff7b72;font-weight:700>:</span> () =&gt; process.env.HTTPS <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;true&#39;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            name<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;å¯†é’¥å¼ºåº¦&#39;</span>,
</span></span><span style=display:flex><span>            check<span style=color:#ff7b72;font-weight:700>:</span> () =&gt; process.env.JWT_SECRET <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> process.env.JWT_SECRET.length <span style=color:#ff7b72;font-weight:700>&gt;=</span> <span style=color:#a5d6ff>32</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            name<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;æ•°æ®åº“è¿æ¥å®‰å…¨&#39;</span>,
</span></span><span style=display:flex><span>            check<span style=color:#ff7b72;font-weight:700>:</span> () =&gt; <span style=color:#ff7b72;font-weight:700>!</span>process.env.DATABASE_URL.includes(<span style=color:#a5d6ff>&#39;password&#39;</span>)
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            name<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;æ—¥å¿—çº§åˆ«&#39;</span>,
</span></span><span style=display:flex><span>            check<span style=color:#ff7b72;font-weight:700>:</span> () =&gt; process.env.LOG_LEVEL <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;warn&#39;</span> <span style=color:#ff7b72;font-weight:700>||</span> process.env.LOG_LEVEL <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;error&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> results <span style=color:#ff7b72;font-weight:700>=</span> checks.map(({ name, check }) =&gt; ({
</span></span><span style=display:flex><span>        name,
</span></span><span style=display:flex><span>        passed<span style=color:#ff7b72;font-weight:700>:</span> check()
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> failedChecks <span style=color:#ff7b72;font-weight:700>=</span> results.filter(r =&gt; <span style=color:#ff7b72;font-weight:700>!</span>r.passed);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (failedChecks.length <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#a5d6ff>0</span>) {
</span></span><span style=display:flex><span>        console.error(<span style=color:#a5d6ff>&#39;å®‰å…¨æ£€æŸ¥å¤±è´¥:&#39;</span>, failedChecks);
</span></span><span style=display:flex><span>        process.exit(<span style=color:#a5d6ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    console.log(<span style=color:#a5d6ff>&#39;æ‰€æœ‰å®‰å…¨æ£€æŸ¥é€šè¿‡&#39;</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åº”ç”¨å¯åŠ¨å‰æ‰§è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>productionSecurityCheck();
</span></span></code></pre></td></tr></table></div></div><h2 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h2><p>Node.jsåº”ç”¨å®‰å…¨éœ€è¦ä»å¤šä¸ªå±‚é¢è€ƒè™‘ï¼š</p><p><strong>è¾“å…¥å®‰å…¨ï¼š</strong></p><ul><li>ä¸¥æ ¼çš„è¾“å…¥éªŒè¯</li><li>SQLæ³¨å…¥é˜²æŠ¤</li><li>XSSæ”»å‡»é˜²æŠ¤</li><li>æ–‡ä»¶ä¸Šä¼ å®‰å…¨</li></ul><p><strong>è®¤è¯æˆæƒï¼š</strong></p><ul><li>å¼ºå¯†ç ç­–ç•¥</li><li>JWTä»¤ç‰Œå®‰å…¨</li><li>RBACæƒé™æ§åˆ¶</li><li>ä¼šè¯ç®¡ç†</li></ul><p><strong>æ•°æ®ä¿æŠ¤ï¼š</strong></p><ul><li>å¯†ç åŠ å¯†å­˜å‚¨</li><li>æ•æ„Ÿæ•°æ®åŠ å¯†</li><li>HTTPSä¼ è¾“</li><li>æ•°æ®åº“å®‰å…¨</li></ul><p><strong>è¿è¡Œå®‰å…¨ï¼š</strong></p><ul><li>ç¯å¢ƒå˜é‡ä¿æŠ¤</li><li>ä¾èµ–å®‰å…¨ç®¡ç†</li><li>æ—¥å¿—ç›‘æ§</li><li>é™æµé˜²æŠ¤</li></ul><p>å®‰å…¨æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦å®šæœŸæ›´æ–°å®‰å…¨ç­–ç•¥ã€ç›‘æ§å®‰å…¨äº‹ä»¶ã€åŠæ—¶ä¿®å¤æ¼æ´ã€‚è®°ä½ï¼Œå®‰å…¨æ²¡æœ‰ç»ˆç‚¹ï¼Œåªæœ‰æŒç»­æ”¹è¿›ã€‚</p><hr></div><footer class=post-footer-modern><div class=post-tags-modern><span class=tags-label>ğŸ·ï¸ æ ‡ç­¾</span><div class=tags-list><a href=/blog/tags/node.js/ class=tag-pill>Node.js
</a><a href=/blog/tags/%E5%AE%89%E5%85%A8/ class=tag-pill>å®‰å…¨
</a><a href=/blog/tags/express/ class=tag-pill>Express
</a><a href=/blog/tags/jwt/ class=tag-pill>JWT
</a><a href=/blog/tags/owasp/ class=tag-pill>OWASP</a></div></div><style>.post-footer-modern{margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border,#333333)}.post-tags-modern{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}.tags-label{font-size:.875rem;font-weight:600;color:var(--secondary,#999999) !important;white-space:nowrap}.tags-list{display:flex;flex-wrap:wrap;gap:.5rem;flex:1}.tag-pill{display:inline-block;padding:.25rem .75rem;background:rgba(255,255,255,5%);border:1px solid var(--border,#333333);border-radius:0;color:var(--secondary,#cccccc) !important;text-decoration:none;font-size:.8rem;font-weight:500;transition:all .2s ease}.tag-pill:hover{background:var(--primary,#ffffff);color:var(--background,#000000) !important;border-color:var(--primary,#ffffff);transform:translateY(-1px)}.post-nav-modern{margin-top:2rem}.nav-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.nav-card{display:flex;align-items:center;gap:1rem;padding:1.25rem;background:rgba(255,255,255,2%);border:1px solid var(--border,#333333);border-radius:12px;text-decoration:none;transition:all .2s ease;min-height:80px}.nav-card:hover{background:rgba(255,255,255,5%);border-color:var(--primary,#ffffff);transform:translateY(-2px)}.nav-card.nav-prev{justify-content:flex-start}.nav-card.nav-next{justify-content:flex-end;text-align:right}.nav-card.nav-next .nav-content{text-align:right}.nav-empty{display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,1%);border:1px dashed var(--border,#333333);color:var(--secondary,#666666)}.nav-arrow{font-size:1.5rem;color:var(--primary,#ffffff);font-weight:300}.nav-content{flex:1}.nav-title{font-size:.95rem;font-weight:600;color:var(--primary,#ffffff) !important;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}[data-theme=light] .post-footer-modern{border-color:var(--border-light,#dee2e6)}[data-theme=light] .tags-label{color:var(--secondary-light,#6c757d) !important}[data-theme=light] .tag-pill{background:rgba(0,0,0,5%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#495057) !important}[data-theme=light] .tag-pill:hover{background:var(--primary-light,#0066cc);color:var(--background-light,#ffffff) !important;border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-card{background:rgba(0,0,0,2%);border-color:var(--border-light,#dee2e6)}[data-theme=light] .nav-card:hover{background:rgba(0,102,204,5%);border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-empty{background:rgba(0,0,0,1%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#6c757d)}[data-theme=light] .nav-arrow{color:var(--primary-light,#0066cc)}[data-theme=light] .nav-title{color:var(--primary-light,#212529) !important}@media(max-width:768px){.nav-grid{grid-template-columns:1fr;gap:.75rem}.nav-card{padding:1rem;min-height:70px}.nav-card.nav-next{text-align:left}.nav-card.nav-next .nav-content{text-align:left}.nav-title{font-size:.875rem}.post-tags-modern{flex-direction:column;gap:.75rem}}@media(max-width:480px){.nav-arrow{font-size:1.25rem}.nav-card{padding:.875rem}.nav-title{font-size:.8rem;-webkit-line-clamp:1}}</style><nav class=post-nav-modern><div class=nav-grid><a href=/blog/articles/react-performance-optimization/ class="nav-card nav-prev"><div class=nav-arrow>â†</div><div class=nav-content><div class=nav-title>Reactæ€§èƒ½ä¼˜åŒ–å®Œå…¨æŒ‡å—ï¼šä»åŸºç¡€åˆ°é«˜çº§çš„æ€§èƒ½æå‡æŠ€å·§</div></div></a><a href=/blog/articles/git-workflow-guide/ class="nav-card nav-next"><div class=nav-content><div class=nav-title>Gitå·¥ä½œæµå®Œå…¨æŒ‡å—ï¼šä»å…¥é—¨åˆ°ç²¾é€šçš„ç‰ˆæœ¬æ§åˆ¶å®è·µ</div></div><div class=nav-arrow>â†’</div></a></div></nav></footer></main><aside class=post-sidebar><div class=sidebar-toc id=sidebar-toc><div class=toc-header><div class=toc-title>ç›®å½•</div><button class=toc-toggle id=toc-toggle aria-label="Toggle TOC">
<svg class="toc-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div class=toc-content id=toc-content><ul class=toc-list><li class="toc-item toc-h2"><a href=#h2-0 class=toc-item-link><span class=toc-item-text>1. è¾“å…¥éªŒè¯å’Œæ•°æ®æ¸…ç†</span></a></li><li class="toc-item toc-h2"><a href=#h2-1 class=toc-item-link><span class=toc-item-text>2. è®¤è¯å’Œæˆæƒ</span></a></li><li class="toc-item toc-h2"><a href=#h2-2 class=toc-item-link><span class=toc-item-text>3. æ•°æ®åŠ å¯†å’Œå­˜å‚¨å®‰å…¨</span></a></li><li class="toc-item toc-h2"><a href=#h2-3 class=toc-item-link><span class=toc-item-text>4. ä¼šè¯å’ŒCookieå®‰å…¨</span></a></li><li class="toc-item toc-h2"><a href=#h2-4 class=toc-item-link><span class=toc-item-text>5. é™æµå’Œé˜²æŠ¤</span></a></li><li class="toc-item toc-h2"><a href=#h2-5 class=toc-item-link><span class=toc-item-text>6. æ—¥å¿—å’Œç›‘æ§</span></a></li><li class="toc-item toc-h2"><a href=#h2-6 class=toc-item-link><span class=toc-item-text>7. ç¯å¢ƒå’Œéƒ¨ç½²å®‰å…¨</span></a></li><li class="toc-item toc-h2"><a href=#h2-7 class=toc-item-link><span class=toc-item-text>8. å®‰å…¨æ£€æŸ¥æ¸…å•</span></a></li><li class="toc-item toc-h2"><a href=#h2-8 class=toc-item-link><span class=toc-item-text>æ€»ç»“</span></a></li></ul></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("sidebar-toc"),t=document.getElementById("toc-toggle"),o=document.getElementById("toc-content"),i=t?.querySelector(".toc-toggle-icon");if(!e)return;let n=!1;t&&t.addEventListener("click",function(){n=!n,n?(o.style.display="none",e.style.width="auto",i.innerHTML='<path d="M9 18l6-6-6-6"/>'):(o.style.display="block",e.style.width="200px",i.innerHTML='<path d="M18 6L6 18M6 6l12 12"/>')});const s=document.querySelector(".post-content");if(s){const e=s.querySelectorAll("h1");e.forEach((e,t)=>{e.id=`h1-${t}`});const t=s.querySelectorAll("h2");t.forEach((e,t)=>{e.id=`h2-${t}`})}const a=document.querySelectorAll(".toc-item-link");a.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const n=this.getAttribute("href").substring(1),t=document.getElementById(n);if(t){const e=document.querySelector(".post-header-main")?.offsetHeight||0,n=t.offsetTop-e-20;window.scrollTo({top:n,behavior:"smooth"})}})})})</script><style>.sidebar-toc{position:sticky;top:2rem;width:200px;background:#fff;border:1px solid #e5e7eb;border-radius:4px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);z-index:100}.sidebar-toc.hidden{display:none}.toc-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fafbfc;display:flex;align-items:center;justify-content:space-between}.toc-title{margin:0;font-size:13px;font-weight:500;color:#374151 !important;font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,sans-serif;text-transform:uppercase;letter-spacing:1px}.toc-toggle{background:0 0;border:none;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .2s ease;color:#6b7280}.toc-toggle:hover{background:#e5e7eb;color:#374151}.toc-toggle-icon{transition:transform .2s ease}.toc-content{padding:12px 0}.toc-list{list-style:none;margin:0;padding:0}.toc-item{margin-bottom:4px;display:block !important;visibility:visible !important}.toc-h1,.toc-h2{display:block !important}.toc-h2{margin-left:0}.toc-item-link{display:flex;align-items:center;gap:8px;padding:8px 12px;color:#374151 !important;text-decoration:none;font-size:13px;line-height:1.4;border-radius:3px;transition:all .2s ease;font-weight:400}.toc-item-link:hover{background:#f8fafc;color:#1f2937 !important}.toc-item-link.active{background:#e0f2fe;color:#01579b !important;font-weight:500}.toc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.dot-red{background:#ef4444}.dot-blue{background:#2196f3}.toc-item-text{color:#1f2937 !important;font-weight:400;flex:1;display:inline !important;visibility:visible !important;opacity:1 !important;font-size:13px !important;line-height:1.4 !important}.toc-item-link .toc-item-text{color:#1f2937 !important;display:inline !important;visibility:visible !important;opacity:1 !important}.toc-item.active .dot-red{background:#d32f2f}.toc-item.active .dot-blue{background:#1976d2}[data-theme=dark] .sidebar-toc{background:#1f2937;border-color:#374151;box-shadow:0 1px 3px rgba(0,0,0,.3)}[data-theme=dark] .toc-header{background:#111827;border-color:#374151}[data-theme=dark] .toc-title{color:#f3f4f6 !important}[data-theme=dark] .toc-toggle{color:#9ca3af}[data-theme=dark] .toc-toggle:hover{background:#374151;color:#f3f4f6}[data-theme=dark] .toc-item-link{color:#e5e7eb !important}[data-theme=dark] .toc-item-link:hover{background:#374151;color:#f9fafb !important}[data-theme=dark] .toc-item-link.active{background:#0d47a1;color:#fff !important}[data-theme=dark] .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}[data-theme=dark] .toc-item-link .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}@media(max-width:1024px){.sidebar-toc{display:none}.post-content-wrapper{grid-template-columns:1fr !important;padding:0 1rem !important}}</style><style>.post-content-wrapper{display:grid;grid-template-columns:1fr 200px;gap:2rem;padding:0 2rem;max-width:100%}.post-content-main{min-width:0}.post-sidebar{position:sticky;top:2rem;height:fit-content;min-width:0}.post-header-main{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border,#333333)}.post-header-main .post-title{color:var(--primary,#ffffff) !important;font-size:2.5rem;font-weight:700;line-height:1.2;margin-bottom:1rem}.post-header-main .post-description{color:var(--secondary,#cccccc) !important;font-size:1.1rem;line-height:1.6;margin-bottom:1rem}.post-header-main .post-meta{margin-bottom:0}@media(max-width:1024px){.post-content-wrapper{grid-template-columns:1fr !important;gap:1rem;padding:0 1rem !important}.post-sidebar{display:none}}@media(max-width:768px){.post-header-main .post-title{font-size:2rem}.post-header-main .post-description{font-size:1rem}}</style></aside></div></article></main><footer class=footer><span>Â© 2024-2025 æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢</span> Â·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>