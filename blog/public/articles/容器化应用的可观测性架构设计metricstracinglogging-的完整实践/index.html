<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>å®¹å™¨åŒ–åº”ç”¨çš„å¯è§‚æµ‹æ€§æ¶æ„è®¾è®¡ï¼šMetricsã€Tracingã€Logging çš„å®Œæ•´å®è·µ | æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</title><meta name=keywords content="å¯è§‚æµ‹æ€§,ç›‘æ§,Prometheus,Kubernetes,Logging"><meta name=description content="æ·±å…¥æ¢è®¨äº‘åŸç”Ÿæ—¶ä»£çš„å¯è§‚æµ‹æ€§ä½“ç³»ï¼Œè¯¦ç»†ä»‹ç» Prometheus + Grafana + Jaeger + Loki çš„ç»„åˆä½¿ç”¨ï¼Œä»¥åŠå¦‚ä½•åœ¨ Kubernetes ç¯å¢ƒä¸‹æ„å»ºå®Œæ•´çš„ç›‘æ§ä½“ç³»"><meta name=author content="æŠ€æœ¯å›¢é˜Ÿ"><link rel=canonical href=/blog/articles/%E5%AE%B9%E5%99%A8%E5%8C%96%E5%BA%94%E7%94%A8%E7%9A%84%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1metricstracinglogging-%E7%9A%84%E5%AE%8C%E6%95%B4%E5%AE%9E%E8%B7%B5/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.7e8505b7cdf8bb22ab2305e53c2700bb06c7e64faeb72cd3468823a9a3bd3d6e.css integrity="sha256-foUFt834uyKrIwXlPCcAuwbH5k+utyzTRogjqaO9PW4=" rel="preload stylesheet" as=style><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=apple-touch-icon href=/blog/apple-touch-icon.png><link rel=mask-icon href=/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=/blog/articles/%E5%AE%B9%E5%99%A8%E5%8C%96%E5%BA%94%E7%94%A8%E7%9A%84%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1metricstracinglogging-%E7%9A%84%E5%AE%8C%E6%95%B4%E5%AE%9E%E8%B7%B5/feed.xml title=rss><link rel=alternate hreflang=zh-cn href=/blog/articles/%E5%AE%B9%E5%99%A8%E5%8C%96%E5%BA%94%E7%94%A8%E7%9A%84%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1metricstracinglogging-%E7%9A%84%E5%AE%8C%E6%95%B4%E5%AE%9E%E8%B7%B5/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=/js/external-link-config.js></script><script src=/js/external-link-interceptor.js></script><link rel=stylesheet href=/blog/css/custom.css media=screen><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«","url":"https://www.util.cn/blog/","description":"æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚","publisher":{"@type":"Organization","name":"æœ‰æ¡å·¥å…·","url":"https://www.util.cn","logo":{"@type":"ImageObject","url":"https://www.util.cn/blog/logo/logo-256.png","width":256,"height":256}},"potentialAction":[{"@type":"SearchAction","target":"https://www.util.cn/blog/search?q={search_term_string}","query-input":"required name=search_term_string"}]}</script><meta property="og:type" content="website"><meta property="og:title" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta property="og:description" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚"><meta property="og:url" content="https://www.util.cn/blog/"><meta property="og:site_name" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢"><meta property="og:image" content="https://www.util.cn/blog/logo/logo-256.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta name=twitter:description content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚"><meta name=twitter:image content="https://www.util.cn/blog/logo/logo-256.png"><meta name=baidu-site-verification content><meta name=category content="æŠ€æœ¯åšå®¢,å¼€å‘è€…å·¥å…·,ç¼–ç¨‹æ•™ç¨‹"><meta name=coverage content="Worldwide"><meta name=distribution content="Global"><meta name=rating content="General"><script id=51la_code async crossorigin=anonymous src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=pro"></script><script>window.addEventListener("load",function(){setTimeout(function(){typeof la!="undefined"?console.log("51laç»Ÿè®¡å·²åŠ è½½"):(console.warn("51laç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"),function(){var e=document.createElement("script");e.src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=backup",e.async=!0,document.head.appendChild(e)}())},3e3)})</script><meta property="og:url" content="/blog/articles/%E5%AE%B9%E5%99%A8%E5%8C%96%E5%BA%94%E7%94%A8%E7%9A%84%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1metricstracinglogging-%E7%9A%84%E5%AE%8C%E6%95%B4%E5%AE%9E%E8%B7%B5/"><meta property="og:site_name" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·"><meta property="og:title" content="å®¹å™¨åŒ–åº”ç”¨çš„å¯è§‚æµ‹æ€§æ¶æ„è®¾è®¡ï¼šMetricsã€Tracingã€Logging çš„å®Œæ•´å®è·µ"><meta property="og:description" content="æ·±å…¥æ¢è®¨äº‘åŸç”Ÿæ—¶ä»£çš„å¯è§‚æµ‹æ€§ä½“ç³»ï¼Œè¯¦ç»†ä»‹ç» Prometheus + Grafana + Jaeger + Loki çš„ç»„åˆä½¿ç”¨ï¼Œä»¥åŠå¦‚ä½•åœ¨ Kubernetes ç¯å¢ƒä¸‹æ„å»ºå®Œæ•´çš„ç›‘æ§ä½“ç³»"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-01-05T00:00:00+00:00"><meta property="article:modified_time" content="2026-01-05T00:00:00+00:00"><meta property="article:tag" content="å¯è§‚æµ‹æ€§"><meta property="article:tag" content="ç›‘æ§"><meta property="article:tag" content="Prometheus"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Logging"><meta name=twitter:card content="summary"><meta name=twitter:title content="å®¹å™¨åŒ–åº”ç”¨çš„å¯è§‚æµ‹æ€§æ¶æ„è®¾è®¡ï¼šMetricsã€Tracingã€Logging çš„å®Œæ•´å®è·µ"><meta name=twitter:description content="æ·±å…¥æ¢è®¨äº‘åŸç”Ÿæ—¶ä»£çš„å¯è§‚æµ‹æ€§ä½“ç³»ï¼Œè¯¦ç»†ä»‹ç» Prometheus + Grafana + Jaeger + Loki çš„ç»„åˆä½¿ç”¨ï¼Œä»¥åŠå¦‚ä½•åœ¨ Kubernetes ç¯å¢ƒä¸‹æ„å»ºå®Œæ•´çš„ç›‘æ§ä½“ç³»"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"æ‰€æœ‰æ–‡ç« ","item":"/blog/posts/"},{"@type":"ListItem","position":2,"name":"å®¹å™¨åŒ–åº”ç”¨çš„å¯è§‚æµ‹æ€§æ¶æ„è®¾è®¡ï¼šMetricsã€Tracingã€Logging çš„å®Œæ•´å®è·µ","item":"/blog/articles/%E5%AE%B9%E5%99%A8%E5%8C%96%E5%BA%94%E7%94%A8%E7%9A%84%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1metricstracinglogging-%E7%9A%84%E5%AE%8C%E6%95%B4%E5%AE%9E%E8%B7%B5/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"å®¹å™¨åŒ–åº”ç”¨çš„å¯è§‚æµ‹æ€§æ¶æ„è®¾è®¡ï¼šMetricsã€Tracingã€Logging çš„å®Œæ•´å®è·µ","name":"å®¹å™¨åŒ–åº”ç”¨çš„å¯è§‚æµ‹æ€§æ¶æ„è®¾è®¡ï¼šMetricsã€Tracingã€Logging çš„å®Œæ•´å®è·µ","description":"æ·±å…¥æ¢è®¨äº‘åŸç”Ÿæ—¶ä»£çš„å¯è§‚æµ‹æ€§ä½“ç³»ï¼Œè¯¦ç»†ä»‹ç» Prometheus + Grafana + Jaeger + Loki çš„ç»„åˆä½¿ç”¨ï¼Œä»¥åŠå¦‚ä½•åœ¨ Kubernetes ç¯å¢ƒä¸‹æ„å»ºå®Œæ•´çš„ç›‘æ§ä½“ç³»","keywords":["å¯è§‚æµ‹æ€§","ç›‘æ§","Prometheus","Kubernetes","Logging"],"articleBody":"å¼•è¨€ï¼šä»ç›‘æ§åˆ°å¯è§‚æµ‹æ€§ ä¼ ç»Ÿçš„ç›‘æ§ç³»ç»Ÿï¼ˆå¦‚ Nagiosã€Zabbixï¼‰ä¸“æ³¨äºåŸºç¡€è®¾æ–½ç›‘æ§ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œã€‚ä½†åœ¨å®¹å™¨åŒ–å’Œå¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œè¿™äº›è¿œè¿œä¸å¤Ÿã€‚\nå¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰çš„ä¸‰å¤§æ”¯æŸ±ï¼š\nMetricsï¼ˆæŒ‡æ ‡ï¼‰ï¼šæ•°å€¼åŒ–çš„æ—¶é—´åºåˆ—æ•°æ®ï¼Œå‘Šè­¦åŸºç¡€ Tracingï¼ˆè¿½è¸ªï¼‰ï¼šè¯·æ±‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å®Œæ•´è·¯å¾„ Loggingï¼ˆæ—¥å¿—ï¼‰ï¼šç¦»æ•£äº‹ä»¶çš„è®°å½•ï¼Œé—®é¢˜è¯Šæ–­ æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes ç¯å¢ƒä¸‹æ„å»ºå®Œæ•´çš„å¯è§‚æµ‹æ€§ä½“ç³»ã€‚\nä¸€ã€Metricsï¼šä»é»‘ç›’åˆ°ç™½ç›’ 1.1 å››å¤§é»„é‡‘æŒ‡æ ‡ Latencyï¼ˆå»¶è¿Ÿï¼‰ï¼šè¯·æ±‚çš„å“åº”æ—¶é—´ Trafficï¼ˆæµé‡ï¼‰ï¼šæ¯ç§’è¯·æ±‚æ•°ï¼ˆQPSï¼‰ Errorsï¼ˆé”™è¯¯ç‡ï¼‰ï¼šå¤±è´¥è¯·æ±‚çš„ç™¾åˆ†æ¯” Saturationï¼ˆé¥±å’Œåº¦ï¼‰ï¼šèµ„æºä½¿ç”¨ç‡ 1.2 Prometheus + Grafana ç›‘æ§æ¶æ„ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Grafana â”‚ â”‚ ï¼ˆç»Ÿä¸€å¯è§†åŒ–å¤§ç›˜ï¼‰ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†‘ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Prometheus â”‚ â”‚ ï¼ˆæŒ‡æ ‡é‡‡é›† + å­˜å‚¨ + å‘Šè­¦ï¼‰ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Service A â”‚ â”‚ Service B â”‚ â”‚ Service C â”‚ â”‚ â”‚ â”‚ /metrics â”‚ â”‚ /metrics â”‚ â”‚ /metrics â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ AlertManager â”‚ â”‚ ï¼ˆå‘Šè­¦è·¯ç”±ï¼‰ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 1.3 è‡ªå®šä¹‰ Metricsï¼šGo + Prometheus ä¾èµ–ï¼š\n1 2 go get github.com/prometheus/client_golang/prometheus go get github.com/prometheus/client_golang/prometheus/promhttp å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 import ( \"github.com/prometheus/client_golang/prometheus\" \"github.com/prometheus/client_golang/prometheus/promhttp\" ) var ( // Counterï¼šåªå¢ä¸å‡çš„è®¡æ•°å™¨ requestsTotal = prometheus.NewCounterVec( prometheus.CounterOpts{ Name: \"http_requests_total\", Help: \"Total number of HTTP requests\", }, []string{\"method\", \"endpoint\", \"status\"}, ) // Histogramï¼šåˆ†å¸ƒç»Ÿè®¡ï¼ˆå»¶è¿Ÿã€è¯·æ±‚å¤§å°ï¼‰ requestDuration = prometheus.NewHistogramVec( prometheus.HistogramOpts{ Name: \"http_request_duration_seconds\", Help: \"HTTP request latency distributions\", Buckets: []float64{0.001, 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10}, }, []string{\"method\", \"endpoint\"}, ) // Gaugeï¼šå¯å¢å¯å‡çš„æ•°å€¼ï¼ˆå½“å‰è¿æ¥æ•°ã€é˜Ÿåˆ—é•¿åº¦ï¼‰ activeConnections = prometheus.NewGauge( prometheus.GaugeOpts{ Name: \"http_active_connections\", Help: \"Current number of active connections\", }, ) // Summaryï¼šç±»ä¼¼ Histogramï¼Œä½†å®¢æˆ·ç«¯è®¡ç®—åˆ†ä½æ•° responseSize = prometheus.NewSummaryVec( prometheus.SummaryOpts{ Name: \"http_response_size_bytes\", Help: \"HTTP response size distributions\", Objectives: map[float64]float64{0.5: 0.05, 0.9: 0.01, 0.99: 0.001}, }, []string{\"method\", \"endpoint\"}, ) ) func init() { // æ³¨å†ŒæŒ‡æ ‡ prometheus.MustRegister(requestsTotal) prometheus.MustRegister(requestDuration) prometheus.MustRegister(activeConnections) prometheus.MustRegister(responseSize) } // HTTP ä¸­é—´ä»¶ func PrometheusMiddleware(next http.Handler) http.Handler { return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { start := time.Now() // åŒ…è£… ResponseWriter ä»¥è·å–çŠ¶æ€ç  rw := \u0026responseWriter{ResponseWriter: w, statusCode: 200} // å¤„ç†è¯·æ±‚ next.ServeHTTP(rw, r) // è®°å½•æŒ‡æ ‡ duration := time.Since(start).Seconds() requestsTotal.WithLabelValues(r.Method, r.URL.Path, strconv.Itoa(rw.statusCode)).Inc() requestDuration.WithLabelValues(r.Method, r.URL.Path).Observe(duration) }) } // ä¸šåŠ¡æŒ‡æ ‡ç¤ºä¾‹ type OrderService struct { ordersCreated prometheus.Counter orderAmount prometheus.Histogram } func (s *OrderService) CreateOrder(order *Order) error { start := time.Now() // ä¸šåŠ¡é€»è¾‘ if err := s.repo.Create(order); err != nil { return err } // è®°å½•ä¸šåŠ¡æŒ‡æ ‡ s.ordersCreated.Inc() s.orderAmount.Observe(order.Amount) // è®°å½•å¤„ç†æ—¶é—´ duration := time.Since(start).Seconds() orderProcessingDuration.Observe(duration) return nil } HTTP æš´éœ²ï¼š\n1 2 3 4 5 6 7 func main() { // æ³¨å†Œ /metrics ç«¯ç‚¹ http.Handle(\"/metrics\", promhttp.Handler()) // å¯åŠ¨æœåŠ¡ http.ListenAndServe(\":8080\", nil) } 1.4 Kubernetes ServiceMonitor 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # ServiceMonitor: å‘Šè¯‰ Prometheus æŠ“å–ç›®æ ‡ apiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: name: my-app namespace: monitoring spec: selector: matchLabels: app: my-app endpoints: - port: web path: /metrics interval: 15s scrapeTimeout: 10s 1.5 Grafana å¤§ç›˜é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 { \"dashboard\": { \"title\": \"æœåŠ¡ç›‘æ§å¤§ç›˜\", \"panels\": [ { \"title\": \"QPS\", \"targets\": [ { \"expr\": \"rate(http_requests_total[1m])\" } ], \"type\": \"graph\" }, { \"title\": \"P95 å»¶è¿Ÿ\", \"targets\": [ { \"expr\": \"histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))\" } ], \"type\": \"graph\" }, { \"title\": \"é”™è¯¯ç‡\", \"targets\": [ { \"expr\": \"sum(rate(http_requests_total{status=~\\\"5..\\\"}[5m])) / sum(rate(http_requests_total[5m]))\" } ], \"type\": \"graph\" } ] } } 1.6 å‘Šè­¦è§„åˆ™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 # prometheus-rules.yaml groups: - name: alert.rules rules: # P95 å»¶è¿Ÿå‘Šè­¦ - alert: HighLatency expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) \u003e 0.5 for: 5m labels: severity: warning annotations: summary: \"P95 å»¶è¿Ÿè¿‡é«˜\" description: \"P95 å»¶è¿Ÿ {{ $value }}s è¶…è¿‡ 500ms\" # é”™è¯¯ç‡å‘Šè­¦ - alert: HighErrorRate expr: sum(rate(http_requests_total{status=~\"5..\"}[5m])) / sum(rate(http_requests_total[5m])) \u003e 0.05 for: 5m labels: severity: critical annotations: summary: \"é”™è¯¯ç‡è¿‡é«˜\" description: \"é”™è¯¯ç‡ {{ $value | humanizePercentage }} è¶…è¿‡ 5%\" # Pod é‡å¯å‘Šè­¦ - alert: PodRestarting expr: increase(kube_pod_status_phase{phase=\"Failed\"}[15m]) \u003e 3 for: 5m labels: severity: warning annotations: summary: \"Pod é¢‘ç¹é‡å¯\" description: \"Pod {{ $labels.pod }} 15åˆ†é’Ÿå†…é‡å¯ {{ $value }} æ¬¡\" äºŒã€Distributed Tracingï¼šåˆ†å¸ƒå¼è¿½è¸ª 2.1 OpenTelemetry Tracing è¯·æ±‚é“¾è·¯ï¼š ç”¨æˆ· â†’ API Gateway â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†“ â†“ â†“ Web Shop æ”¯ä»˜æœåŠ¡ æ•°æ®åº“ 2.2 Go + OpenTelemetry å®ç° ä¾èµ–ï¼š\n1 2 3 4 5 go get go.opentelemetry.io/otel go get go.opentelemetry.io/otel/exporters/jaeger go get go.opentelemetry.io/otel/sdk go get go.opentelemetry.io/otel/sdk/resource go get go.opentelemetry.io/otel/semconv/v1.4.0 åˆå§‹åŒ– Tracerï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 import ( \"go.opentelemetry.io/otel\" \"go.opentelemetry.io/otel/exporters/jaeger\" \"go.opentelemetry.io/otel/sdk/resource\" tracesdk \"go.opentelemetry.io/otel/sdk/trace\" semconv \"go.opentelemetry.io/otel/semconv/v1.4.0\" ) func InitTracer(serviceName, jaegerEndpoint string) (*tracesdk.TracerProvider, error) { // åˆ›å»º Resource res, err := resource.New( context.Background(), resource.WithAttributes( semconv.ServiceNameKey.String(serviceName), semconv.DeploymentEnvironmentKey.String(\"production\"), ), ) if err != nil { return nil, err } // åˆ›å»º Jaeger Exporter exporter, err := jaeger.New(jaeger.WithCollectorEndpoint( jaeger.WithEndpoint(jaegerEndpoint), )) if err != nil { return nil, err } // åˆ›å»º TracerProvider tp := tracesdk.NewTracerProvider( tracesdk.WithBatcher(exporter), tracesdk.WithResource(res), tracesdk.WithSampler(tracesdk.TraceIDRatioBased(0.1)), // 10% é‡‡æ · ) // æ³¨å†Œä¸ºå…¨å±€ TracerProvider otel.SetTracerProvider(tp) return tp, nil } ä½¿ç”¨ Tracerï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 import ( \"go.opentelemetry.io/otel/trace\" ) type OrderService struct { tracer trace.Tracer } func (s *OrderService) CreateOrder(ctx context.Context, req *CreateOrderRequest) error { // åˆ›å»º Span ctx, span := s.tracer.Start(ctx, \"CreateOrder\") defer span.End() span.SetAttributes( attribute.String(\"user.id\", req.UserID), attribute.String(\"product.id\", req.ProductID), attribute.Float64(\"order.amount\", req.Amount), ) // è°ƒç”¨åº“å­˜æœåŠ¡ inventory, err := s.inventoryClient.CheckStock(ctx, req.ProductID) if err != nil { span.RecordError(err) span.SetStatus(codes.Error, err.Error()) return err } // åˆ›å»ºè®¢å• order := \u0026Order{ ID: generateID(), UserID: req.UserID, ProductID: req.ProductID, Amount: req.Amount, } if err := s.repo.Create(ctx, order); err != nil { span.RecordError(err) return err } span.SetStatus(codes.Ok, \"Order created\") return nil } 2.3 Jaeger éƒ¨ç½²ï¼ˆKubernetesï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 # jaeger-deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: jaeger spec: replicas: 1 selector: matchLabels: app: jaeger template: metadata: labels: app: jaeger spec: containers: - name: jaeger image: jaegertracing/all-in-one:1.50 ports: - containerPort: 5775 // acceptor name: acceptor - containerPort: 16686 // query name: query env: - name: COLLECTOR_ZIPKIN_HOST_PORT value: \":9411\" - name: SPAN_STORAGE_TYPE value: elasticsearch - name: ES_SERVER_URLS value: http://elasticsearch:9200 --- apiVersion: v1 kind: Service metadata: name: jaeger spec: selector: app: jaeger ports: - port: 5775 name: acceptor - port: 16686 name: query ä¸‰ã€Loggingï¼šé›†ä¸­å¼æ—¥å¿—ç®¡ç† 3.1 æ—¥å¿—æ¶æ„æ¼”è¿› é˜¶æ®µ1ï¼šæ—¥å¿—æ•£è½åœ¨å„å®¹å™¨ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ Pod1 â”‚ â”‚ Pod2 â”‚ â”‚ Pod3 â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ kubectl logs (æ‰‹åŠ¨æŸ¥çœ‹) é˜¶æ®µ2ï¼šEFKï¼ˆElasticsearch + Fluentd + Kibanaï¼‰ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ Pod1 â”‚ â”‚ Pod2 â”‚ â”‚ Pod3 â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ Fluentd (æ—¥å¿—æ”¶é›†) â†“ Elasticsearch (å­˜å‚¨) â†“ Kibana (å¯è§†åŒ–) é˜¶æ®µ3ï¼šPLGï¼ˆPromtail + Loki + Grafanaï¼‰ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ Pod1 â”‚ â”‚ Pod2 â”‚ â”‚ Pod3 â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†“ Promtail (æ—¥å¿—ä»£ç†) â†“ Loki (å­˜å‚¨) â†“ Grafana (å¯è§†åŒ–) 3.2 ç»“æ„åŒ–æ—¥å¿— æ—¥å¿—æ ¼å¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 { \"timestamp\": \"2026-01-05T12:34:56.789Z\", \"level\": \"info\", \"service\": \"order-service\", \"trace_id\": \"7f8a9b6c\", \"span_id\": \"1a2b3c4d\", \"user_id\": \"12345\", \"message\": \"Order created successfully\", \"order\": { \"id\": \"ord_12345\", \"amount\": 99.99, \"product_id\": \"prod_67890\" } } Go + zap ç»“æ„åŒ–æ—¥å¿—ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 import ( \"go.uber.org/zap\" \"go.uber.org/zap/zapcore\" ) func NewLogger(serviceName string) *zap.Logger { config := zap.NewProductionConfig() config.InitialFields = map[string]interface{}{ \"service\": serviceName, \"pod\": os.Getenv(\"POD_NAME\"), } logger, _ := config.Build( zap.AddCallerSkip(2), // è·³è¿‡åŒ…è£…å±‚ zap.Wrap(func(zapcore.Core) zapcore.Core { // æ³¨å…¥ trace_id å’Œ span_id return \u0026TraceIDCore{Core: zapcore.New(zapcore.NewJSONEncoder())} }), ) return logger } type TraceIDCore struct { zapcore.Core } func (c *TraceIDCore) With(fields []zapcore.Field) zapcore.Core { // ä» OpenTelemetry Context æå– trace_id å’Œ span_id ctx := context.Background() if span := trace.SpanFromContext(ctx); span.SpanContext().IsValid() { fields = append(fields, zap.String(\"trace_id\", span.SpanContext().TraceID().String()), zap.String(\"span_id\", span.SpanContext().SpanID().String()), ) } return c.Core.With(fields) } ä½¿ç”¨ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 var logger *zap.Logger func (s *OrderService) CreateOrder(ctx context.Context, req *CreateOrderRequest) error { logger.Info(\"Creating order\", zap.String(\"user_id\", req.UserID), zap.String(\"product_id\", req.ProductID), zap.Float64(\"amount\", req.Amount), ) order := \u0026Order{...} if err := s.repo.Create(order); err != nil { logger.Error(\"Failed to create order\", zap.String(\"order_id\", order.ID), zap.Error(err), ) return err } logger.Info(\"Order created successfully\", zap.String(\"order_id\", order.ID), ) return nil } 3.3 Promtail é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # promtail-config.yaml server: http_listen_port: 9080 positions: filename: /tmp/positions.yaml clients: - url: http://loki:3100/loki/api/v1/push scrape_configs: - job_name: pods kubernetes_sd_configs: - role: pod relabel_configs: - source_labels: - __meta_kubernetes_pod_name - __meta_kubernetes_namespace - __meta_kubernetes_pod_label_app target_label: filename replacement: /var/log/pods/*$1*/*.log 3.4 Loki æŸ¥è¯¢è¯­æ³• # æŸ¥è¯¢æ‰€æœ‰é”™è¯¯æ—¥å¿— {level=\"error\"} # æŸ¥è¯¢ç‰¹å®šæœåŠ¡çš„æ—¥å¿— {service=\"order-service\"} # æ—¶é—´èŒƒå›´æŸ¥è¯¢ {service=\"order-service\"} |= \"Order created\" | line_format \"{{.timestamp}} {{.message}}\" å››ã€å®Œæ•´å¯è§‚æµ‹æ€§æ¶æ„ 4.1 æ¶æ„å›¾ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Grafana â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Metrics â”‚ Tracing â”‚ Logging â”‚ â”‚ â”‚ â”‚ (Prometheus)â”‚ (Jaeger) â”‚ (Loki) â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†‘ â†‘ â†‘ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Kubernetes Cluster â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Pod A â”‚ â”‚ Pod B â”‚ â”‚ Pod C â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ App â”‚ â”‚ â”‚ â”‚ App â”‚ â”‚ â”‚ â”‚ App â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ /metricsâ”‚ â”‚ â”‚ â”‚ /metricsâ”‚ â”‚ â”‚ â”‚ /metricsâ”‚ â”‚ â”‚ â”‚ â”‚ â”‚ /tracingâ”‚ â”‚ â”‚ â”‚ /tracingâ”‚ â”‚ â”‚ â”‚ /tracingâ”‚ â”‚ â”‚ â”‚ â”‚ â”‚ /logs â”‚ â”‚ â”‚ â”‚ /logs â”‚ â”‚ â”‚ â”‚ /logs â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Operator (è‡ªåŠ¨è¿ç»´) â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 4.2 ç»Ÿä¸€ Dashboard 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 { \"dashboard\": { \"title\": \"å¯è§‚æµ‹æ€§ç»Ÿä¸€å¤§ç›˜\", \"panels\": [ { \"title\": \"QPS\", \"type\": \"graph\", \"gridPos\": {\"x\": 0, \"y\": 0, \"w\": 12, \"h\": 8}, \"targets\": [{\"expr\": \"sum(rate(http_requests_total{namespace=~\\\"prod\\\"}[5m]))\"}] }, { \"title\": \"P95 å»¶è¿Ÿ\", \"type\": \"graph\", \"gridPos\": {\"x\": 12, \"y\": 0, \"w\": 12, \"h\": 8}, \"targets\": [{\"expr\": \"histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))\"}] }, { \"title\": \"é”™è¯¯æ—¥å¿—\", \"type\": \"logs\", \"gridPos\": {\"x\": 0, \"y\": 8, \"w\": 12, \"h\": 8}, \"targets\": [{\"expr\": \"{level=\\\"error\\\"}\"}] }, { \"title\": \"Trace æœç´¢\", \"type\": \"tracejaeger\", \"gridPos\": {\"x\": 12, \"y\": 8, \"w\": 12, \"h\": 8} } ] } } äº”ã€æœ€ä½³å®è·µ 5.1 RED æ–¹æ³•å‘Šè­¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 groups: - name: red-method rules: # Rate: è¯·æ±‚é€Ÿç‡ - alert: LowRequestRate expr: sum(rate(http_requests_total[5m])) \u003c 100 for: 5m labels: severity: warning # Errors: é”™è¯¯ç‡ - alert: HighErrorRate expr: sum(rate(http_requests_total{status=~\"5..\"}[5m])) / sum(rate(http_requests_total[5m])) \u003e 0.01 for: 5m labels: severity: critical # Duration: æŒç»­æ—¶é—´ï¼ˆP99ï¼‰ - alert: HighP99Latency expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) \u003e 1 for: 5m labels: severity: warning 5.2 æ—¥å¿—åˆ†çº§ä¸é‡‡æ · 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // æ ¹æ®æ—¥å¿—çº§åˆ«é‡‡æ · type SamplingLogger struct { base *zap.Logger sample map[zapcore.Level]float64 } func (l *SamplingLogger) Debug(msg string, fields ...zap.Field) { if rand.Float64() \u003e l.sample[zap.DebugLevel] { return // è·³è¿‡ } l.base.Debug(msg, fields...) } func (l *SamplingLogger) Error(msg string, fields ...zap.Field) { // é”™è¯¯æ—¥å¿—ä¸é‡‡æ · l.base.Error(msg, fields...) } 5.3 Trace ä¸ Log çš„å…³è” 1 2 3 4 5 6 7 8 9 10 11 12 func (s *OrderService) CreateOrder(ctx context.Context, req *CreateOrderRequest) error { span := trace.SpanFromContext(ctx) logger := logger.With( zap.String(\"trace_id\", span.SpanContext().TraceID().String()), zap.String(\"span_id\", span.SpanContext().SpanID().String()), ) logger.Info(\"Creating order\", ...) return nil } å…­ã€æ€»ç»“ å¯è§‚æµ‹æ€§æ˜¯äº‘åŸç”Ÿç³»ç»Ÿçš„å¿…å¤‡èƒ½åŠ›ã€‚é€šè¿‡ï¼š\nMetricsï¼šç›‘æ§èµ„æºä½¿ç”¨å’Œä¸šåŠ¡æŒ‡æ ‡ Tracingï¼šè¿½è¸ªåˆ†å¸ƒå¼è¯·æ±‚é“¾è·¯ Loggingï¼šè®°å½•ç¦»æ•£äº‹ä»¶å’Œé”™è¯¯ä¿¡æ¯ æ„å»ºå®Œæ•´çš„å¯è§‚æµ‹æ€§ä½“ç³»ï¼Œè®©ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ä¸€ç›®äº†ç„¶ã€‚\nå¯è§‚æµ‹æ€§ä¸æ˜¯äº‹åè¯¸è‘›äº®ï¼Œè€Œæ˜¯æ¶æ„è®¾è®¡çš„ä¸€ç­‰å…¬æ°‘ã€‚åœ¨è®¾è®¡ç³»ç»Ÿæ—¶ï¼Œå°±è¦è€ƒè™‘å¦‚ä½•è§‚å¯Ÿå®ƒã€‚\n","wordCount":"2026","inLanguage":"zh-cn","datePublished":"2026-01-05T00:00:00Z","dateModified":"2026-01-05T00:00:00Z","author":{"@type":"Person","name":"æŠ€æœ¯å›¢é˜Ÿ"},"mainEntityOfPage":{"@type":"WebPage","@id":"/blog/articles/%E5%AE%B9%E5%99%A8%E5%8C%96%E5%BA%94%E7%94%A8%E7%9A%84%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1metricstracinglogging-%E7%9A%84%E5%AE%8C%E6%95%B4%E5%AE%9E%E8%B7%B5/"},"publisher":{"@type":"Organization","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·","logo":{"@type":"ImageObject","url":"/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=/blog/ accesskey=h title="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· (Alt + H)">æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=/blog/posts/ title="æ‰€æœ‰æ–‡ç« åˆ—è¡¨ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŸ¥çœ‹æ‰€æœ‰æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ–‡ç« </span></a></li><li><a href=https://www.util.cn title="æœ‰æ¡å·¥å…· - å¼€å‘è€…çš„å¸¸ç”¨å·¥å…·é›†åˆï¼šæ— å¹¿å‘Š Â· æœ¬åœ°è®¡ç®— Â· å³å¼€å³ç”¨çš„åœ¨çº¿å·¥å…·å¹³å°ï¼Œæä¾›JSONæ ¼å¼åŒ–ã€SQLæ ¼å¼åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰å®ç”¨å·¥å…·"><span>æœ‰æ¡å·¥å…·</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=/blog/categories/ title="æ–‡ç« åˆ†ç±» - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æŠ€æœ¯é¢†åŸŸåˆ†ç±»çš„ä¼˜è´¨æ–‡ç« ï¼ŒåŒ…æ‹¬å‰ç«¯å¼€å‘ã€å·¥å…·ä½¿ç”¨ã€ç¼–ç¨‹æŠ€å·§ç­‰"><span>åˆ†ç±»</span></a></li><li><a href=/blog/tags/ title="æ ‡ç­¾äº‘ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡æ ‡ç­¾å¿«é€Ÿæ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ ‡ç­¾</span></a></li><li><a href=/blog/archives/ title="æ–‡ç« å½’æ¡£ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æ—¶é—´æŸ¥çœ‹å†å²æ–‡ç« "><span>å½’æ¡£</span></a></li><li><a href=/blog/search/ title="æœç´¢æ–‡ç«  - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡å…³é”®è¯æœç´¢æ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹ï¼Œæ”¯æŒæ ‡é¢˜ã€å†…å®¹ã€åˆ†ç±»å’Œæ ‡ç­¾æœç´¢"><span>æœç´¢</span></a></li></ul></nav></header><main class=main><article class=post-single><div class=post-content-wrapper><main class=post-content-main><header class=post-header-main><h1 class="post-title entry-hint-parent">å®¹å™¨åŒ–åº”ç”¨çš„å¯è§‚æµ‹æ€§æ¶æ„è®¾è®¡ï¼šMetricsã€Tracingã€Logging çš„å®Œæ•´å®è·µ</h1><div class=post-description>æ·±å…¥æ¢è®¨äº‘åŸç”Ÿæ—¶ä»£çš„å¯è§‚æµ‹æ€§ä½“ç³»ï¼Œè¯¦ç»†ä»‹ç» Prometheus + Grafana + Jaeger + Loki çš„ç»„åˆä½¿ç”¨ï¼Œä»¥åŠå¦‚ä½•åœ¨ Kubernetes ç¯å¢ƒä¸‹æ„å»ºå®Œæ•´çš„ç›‘æ§ä½“ç³»</div><div class=post-meta><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/ class=category-link>æ¶æ„è®¾è®¡</a></div><span class=post-date>2026-01-05</span><span class=post-author>æŠ€æœ¯å›¢é˜Ÿ</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></div></header><div class=post-content><h2 id=å¼•è¨€ä»ç›‘æ§åˆ°å¯è§‚æµ‹æ€§>å¼•è¨€ï¼šä»ç›‘æ§åˆ°å¯è§‚æµ‹æ€§<a hidden class=anchor aria-hidden=true href=#å¼•è¨€ä»ç›‘æ§åˆ°å¯è§‚æµ‹æ€§>#</a></h2><p>ä¼ ç»Ÿçš„ç›‘æ§ç³»ç»Ÿï¼ˆå¦‚ Nagiosã€Zabbixï¼‰ä¸“æ³¨äº<strong>åŸºç¡€è®¾æ–½ç›‘æ§</strong>ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œã€‚ä½†åœ¨å®¹å™¨åŒ–å’Œå¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œè¿™äº›è¿œè¿œä¸å¤Ÿã€‚</p><p>å¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰çš„ä¸‰å¤§æ”¯æŸ±ï¼š</p><ol><li><strong>Metricsï¼ˆæŒ‡æ ‡ï¼‰</strong>ï¼šæ•°å€¼åŒ–çš„æ—¶é—´åºåˆ—æ•°æ®ï¼Œå‘Šè­¦åŸºç¡€</li><li><strong>Tracingï¼ˆè¿½è¸ªï¼‰</strong>ï¼šè¯·æ±‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å®Œæ•´è·¯å¾„</li><li><strong>Loggingï¼ˆæ—¥å¿—ï¼‰</strong>ï¼šç¦»æ•£äº‹ä»¶çš„è®°å½•ï¼Œé—®é¢˜è¯Šæ–­</li></ol><p>æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes ç¯å¢ƒä¸‹æ„å»ºå®Œæ•´çš„å¯è§‚æµ‹æ€§ä½“ç³»ã€‚</p><h2 id=ä¸€metricsä»é»‘ç›’åˆ°ç™½ç›’>ä¸€ã€Metricsï¼šä»é»‘ç›’åˆ°ç™½ç›’<a hidden class=anchor aria-hidden=true href=#ä¸€metricsä»é»‘ç›’åˆ°ç™½ç›’>#</a></h2><h3 id=11-å››å¤§é»„é‡‘æŒ‡æ ‡>1.1 å››å¤§é»„é‡‘æŒ‡æ ‡<a hidden class=anchor aria-hidden=true href=#11-å››å¤§é»„é‡‘æŒ‡æ ‡>#</a></h3><ol><li><strong>Latencyï¼ˆå»¶è¿Ÿï¼‰</strong>ï¼šè¯·æ±‚çš„å“åº”æ—¶é—´</li><li><strong>Trafficï¼ˆæµé‡ï¼‰</strong>ï¼šæ¯ç§’è¯·æ±‚æ•°ï¼ˆQPSï¼‰</li><li><strong>Errorsï¼ˆé”™è¯¯ç‡ï¼‰</strong>ï¼šå¤±è´¥è¯·æ±‚çš„ç™¾åˆ†æ¯”</li><li><strong>Saturationï¼ˆé¥±å’Œåº¦ï¼‰</strong>ï¼šèµ„æºä½¿ç”¨ç‡</li></ol><h3 id=12-prometheus--grafana-ç›‘æ§æ¶æ„>1.2 Prometheus + Grafana ç›‘æ§æ¶æ„<a hidden class=anchor aria-hidden=true href=#12-prometheus--grafana-ç›‘æ§æ¶æ„>#</a></h3><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Grafana                           â”‚
â”‚             ï¼ˆç»Ÿä¸€å¯è§†åŒ–å¤§ç›˜ï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Prometheus                          â”‚
â”‚              ï¼ˆæŒ‡æ ‡é‡‡é›† + å­˜å‚¨ + å‘Šè­¦ï¼‰                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Service A   â”‚  â”‚ Service B   â”‚  â”‚ Service C   â”‚   â”‚
â”‚  â”‚  /metrics   â”‚  â”‚  /metrics   â”‚  â”‚  /metrics   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ AlertManager â”‚
                  â”‚  ï¼ˆå‘Šè­¦è·¯ç”±ï¼‰  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><h3 id=13-è‡ªå®šä¹‰-metricsgo--prometheus>1.3 è‡ªå®šä¹‰ Metricsï¼šGo + Prometheus<a hidden class=anchor aria-hidden=true href=#13-è‡ªå®šä¹‰-metricsgo--prometheus>#</a></h3><p><strong>ä¾èµ–</strong>ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>go get github.com/prometheus/client_golang/prometheus
</span></span><span style=display:flex><span>go get github.com/prometheus/client_golang/prometheus/promhttp
</span></span></code></pre></td></tr></table></div></div><p><strong>å®ç°</strong>ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">94
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;github.com/prometheus/client_golang/prometheus&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;github.com/prometheus/client_golang/prometheus/promhttp&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// Counterï¼šåªå¢ä¸å‡çš„è®¡æ•°å™¨</span>
</span></span><span style=display:flex><span>    requestsTotal = prometheus.<span style=color:#d2a8ff;font-weight:700>NewCounterVec</span>(
</span></span><span style=display:flex><span>        prometheus.CounterOpts{
</span></span><span style=display:flex><span>            Name: <span style=color:#a5d6ff>&#34;http_requests_total&#34;</span>,
</span></span><span style=display:flex><span>            Help: <span style=color:#a5d6ff>&#34;Total number of HTTP requests&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        []<span style=color:#ff7b72>string</span>{<span style=color:#a5d6ff>&#34;method&#34;</span>, <span style=color:#a5d6ff>&#34;endpoint&#34;</span>, <span style=color:#a5d6ff>&#34;status&#34;</span>},
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// Histogramï¼šåˆ†å¸ƒç»Ÿè®¡ï¼ˆå»¶è¿Ÿã€è¯·æ±‚å¤§å°ï¼‰</span>
</span></span><span style=display:flex><span>    requestDuration = prometheus.<span style=color:#d2a8ff;font-weight:700>NewHistogramVec</span>(
</span></span><span style=display:flex><span>        prometheus.HistogramOpts{
</span></span><span style=display:flex><span>            Name:    <span style=color:#a5d6ff>&#34;http_request_duration_seconds&#34;</span>,
</span></span><span style=display:flex><span>            Help:    <span style=color:#a5d6ff>&#34;HTTP request latency distributions&#34;</span>,
</span></span><span style=display:flex><span>            Buckets: []<span style=color:#ff7b72>float64</span>{<span style=color:#a5d6ff>0.001</span>, <span style=color:#a5d6ff>0.005</span>, <span style=color:#a5d6ff>0.01</span>, <span style=color:#a5d6ff>0.025</span>, <span style=color:#a5d6ff>0.05</span>, <span style=color:#a5d6ff>0.1</span>, <span style=color:#a5d6ff>0.25</span>, <span style=color:#a5d6ff>0.5</span>, <span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>2.5</span>, <span style=color:#a5d6ff>5</span>, <span style=color:#a5d6ff>10</span>},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        []<span style=color:#ff7b72>string</span>{<span style=color:#a5d6ff>&#34;method&#34;</span>, <span style=color:#a5d6ff>&#34;endpoint&#34;</span>},
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// Gaugeï¼šå¯å¢å¯å‡çš„æ•°å€¼ï¼ˆå½“å‰è¿æ¥æ•°ã€é˜Ÿåˆ—é•¿åº¦ï¼‰</span>
</span></span><span style=display:flex><span>    activeConnections = prometheus.<span style=color:#d2a8ff;font-weight:700>NewGauge</span>(
</span></span><span style=display:flex><span>        prometheus.GaugeOpts{
</span></span><span style=display:flex><span>            Name: <span style=color:#a5d6ff>&#34;http_active_connections&#34;</span>,
</span></span><span style=display:flex><span>            Help: <span style=color:#a5d6ff>&#34;Current number of active connections&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// Summaryï¼šç±»ä¼¼ Histogramï¼Œä½†å®¢æˆ·ç«¯è®¡ç®—åˆ†ä½æ•°</span>
</span></span><span style=display:flex><span>    responseSize = prometheus.<span style=color:#d2a8ff;font-weight:700>NewSummaryVec</span>(
</span></span><span style=display:flex><span>        prometheus.SummaryOpts{
</span></span><span style=display:flex><span>            Name:       <span style=color:#a5d6ff>&#34;http_response_size_bytes&#34;</span>,
</span></span><span style=display:flex><span>            Help:       <span style=color:#a5d6ff>&#34;HTTP response size distributions&#34;</span>,
</span></span><span style=display:flex><span>            Objectives: <span style=color:#ff7b72>map</span>[<span style=color:#ff7b72>float64</span>]<span style=color:#ff7b72>float64</span>{<span style=color:#a5d6ff>0.5</span>: <span style=color:#a5d6ff>0.05</span>, <span style=color:#a5d6ff>0.9</span>: <span style=color:#a5d6ff>0.01</span>, <span style=color:#a5d6ff>0.99</span>: <span style=color:#a5d6ff>0.001</span>},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        []<span style=color:#ff7b72>string</span>{<span style=color:#a5d6ff>&#34;method&#34;</span>, <span style=color:#a5d6ff>&#34;endpoint&#34;</span>},
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ³¨å†ŒæŒ‡æ ‡</span>
</span></span><span style=display:flex><span>    prometheus.<span style=color:#d2a8ff;font-weight:700>MustRegister</span>(requestsTotal)
</span></span><span style=display:flex><span>    prometheus.<span style=color:#d2a8ff;font-weight:700>MustRegister</span>(requestDuration)
</span></span><span style=display:flex><span>    prometheus.<span style=color:#d2a8ff;font-weight:700>MustRegister</span>(activeConnections)
</span></span><span style=display:flex><span>    prometheus.<span style=color:#d2a8ff;font-weight:700>MustRegister</span>(responseSize)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// HTTP ä¸­é—´ä»¶</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>PrometheusMiddleware</span>(next http.Handler) http.Handler {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> http.<span style=color:#d2a8ff;font-weight:700>HandlerFunc</span>(<span style=color:#ff7b72>func</span>(w http.ResponseWriter, r <span style=color:#ff7b72;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>        start <span style=color:#ff7b72;font-weight:700>:=</span> time.<span style=color:#d2a8ff;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// åŒ…è£… ResponseWriter ä»¥è·å–çŠ¶æ€ç </span>
</span></span><span style=display:flex><span>        rw <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>responseWriter{ResponseWriter: w, statusCode: <span style=color:#a5d6ff>200</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å¤„ç†è¯·æ±‚</span>
</span></span><span style=display:flex><span>        next.<span style=color:#d2a8ff;font-weight:700>ServeHTTP</span>(rw, r)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// è®°å½•æŒ‡æ ‡</span>
</span></span><span style=display:flex><span>        duration <span style=color:#ff7b72;font-weight:700>:=</span> time.<span style=color:#d2a8ff;font-weight:700>Since</span>(start).<span style=color:#d2a8ff;font-weight:700>Seconds</span>()
</span></span><span style=display:flex><span>        requestsTotal.<span style=color:#d2a8ff;font-weight:700>WithLabelValues</span>(r.Method, r.URL.Path, strconv.<span style=color:#d2a8ff;font-weight:700>Itoa</span>(rw.statusCode)).<span style=color:#d2a8ff;font-weight:700>Inc</span>()
</span></span><span style=display:flex><span>        requestDuration.<span style=color:#d2a8ff;font-weight:700>WithLabelValues</span>(r.Method, r.URL.Path).<span style=color:#d2a8ff;font-weight:700>Observe</span>(duration)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä¸šåŠ¡æŒ‡æ ‡ç¤ºä¾‹</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> OrderService <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    ordersCreated prometheus.Counter
</span></span><span style=display:flex><span>    orderAmount   prometheus.Histogram
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (s <span style=color:#ff7b72;font-weight:700>*</span>OrderService) <span style=color:#d2a8ff;font-weight:700>CreateOrder</span>(order <span style=color:#ff7b72;font-weight:700>*</span>Order) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    start <span style=color:#ff7b72;font-weight:700>:=</span> time.<span style=color:#d2a8ff;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä¸šåŠ¡é€»è¾‘</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> s.repo.<span style=color:#d2a8ff;font-weight:700>Create</span>(order); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è®°å½•ä¸šåŠ¡æŒ‡æ ‡</span>
</span></span><span style=display:flex><span>    s.ordersCreated.<span style=color:#d2a8ff;font-weight:700>Inc</span>()
</span></span><span style=display:flex><span>    s.orderAmount.<span style=color:#d2a8ff;font-weight:700>Observe</span>(order.Amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è®°å½•å¤„ç†æ—¶é—´</span>
</span></span><span style=display:flex><span>    duration <span style=color:#ff7b72;font-weight:700>:=</span> time.<span style=color:#d2a8ff;font-weight:700>Since</span>(start).<span style=color:#d2a8ff;font-weight:700>Seconds</span>()
</span></span><span style=display:flex><span>    orderProcessingDuration.<span style=color:#d2a8ff;font-weight:700>Observe</span>(duration)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><strong>HTTP æš´éœ²</strong>ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ³¨å†Œ /metrics ç«¯ç‚¹</span>
</span></span><span style=display:flex><span>    http.<span style=color:#d2a8ff;font-weight:700>Handle</span>(<span style=color:#a5d6ff>&#34;/metrics&#34;</span>, promhttp.<span style=color:#d2a8ff;font-weight:700>Handler</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å¯åŠ¨æœåŠ¡</span>
</span></span><span style=display:flex><span>    http.<span style=color:#d2a8ff;font-weight:700>ListenAndServe</span>(<span style=color:#a5d6ff>&#34;:8080&#34;</span>, <span style=color:#79c0ff>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=14-kubernetes-servicemonitor>1.4 Kubernetes ServiceMonitor<a hidden class=anchor aria-hidden=true href=#14-kubernetes-servicemonitor>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b949e;font-style:italic># ServiceMonitor: å‘Šè¯‰ Prometheus æŠ“å–ç›®æ ‡</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>monitoring.coreos.com/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>ServiceMonitor</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>my-app</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>namespace</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>monitoring</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>selector</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>matchLabels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>my-app</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>endpoints</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>web</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>path</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/metrics</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>interval</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>15s</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>scrapeTimeout</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>10s</span><span style=color:#6e7681>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=15-grafana-å¤§ç›˜é…ç½®>1.5 Grafana å¤§ç›˜é…ç½®<a hidden class=anchor aria-hidden=true href=#15-grafana-å¤§ç›˜é…ç½®>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;dashboard&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&#34;title&#34;</span>: <span style=color:#a5d6ff>&#34;æœåŠ¡ç›‘æ§å¤§ç›˜&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&#34;panels&#34;</span>: [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;title&#34;</span>: <span style=color:#a5d6ff>&#34;QPS&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;targets&#34;</span>: [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#7ee787>&#34;expr&#34;</span>: <span style=color:#a5d6ff>&#34;rate(http_requests_total[1m])&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;graph&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;title&#34;</span>: <span style=color:#a5d6ff>&#34;P95 å»¶è¿Ÿ&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;targets&#34;</span>: [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#7ee787>&#34;expr&#34;</span>: <span style=color:#a5d6ff>&#34;histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;graph&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;title&#34;</span>: <span style=color:#a5d6ff>&#34;é”™è¯¯ç‡&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;targets&#34;</span>: [
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#7ee787>&#34;expr&#34;</span>: <span style=color:#a5d6ff>&#34;sum(rate(http_requests_total{status=~\&#34;5..\&#34;}[5m])) / sum(rate(http_requests_total[5m]))&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;graph&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=16-å‘Šè­¦è§„åˆ™>1.6 å‘Šè­¦è§„åˆ™<a hidden class=anchor aria-hidden=true href=#16-å‘Šè­¦è§„åˆ™>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b949e;font-style:italic># prometheus-rules.yaml</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>groups</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>alert.rules</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>rules</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#8b949e;font-style:italic># P95 å»¶è¿Ÿå‘Šè­¦</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>alert</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HighLatency</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>expr</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) &gt; 0.5</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>for</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>5m</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>severity</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>warning</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>annotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>summary</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;P95 å»¶è¿Ÿè¿‡é«˜&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>description</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;P95 å»¶è¿Ÿ {{ $value }}s è¶…è¿‡ 500ms&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#8b949e;font-style:italic># é”™è¯¯ç‡å‘Šè­¦</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>alert</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HighErrorRate</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>expr</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>sum(rate(http_requests_total{status=~&#34;5..&#34;}[5m])) / sum(rate(http_requests_total[5m])) &gt; 0.05</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>for</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>5m</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>severity</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>critical</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>annotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>summary</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;é”™è¯¯ç‡è¿‡é«˜&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>description</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;é”™è¯¯ç‡ {{ $value | humanizePercentage }} è¶…è¿‡ 5%&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#8b949e;font-style:italic># Pod é‡å¯å‘Šè­¦</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>alert</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>PodRestarting</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>expr</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>increase(kube_pod_status_phase{phase=&#34;Failed&#34;}[15m]) &gt; 3</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>for</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>5m</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>severity</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>warning</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>annotations</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>summary</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;Pod é¢‘ç¹é‡å¯&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>description</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;Pod {{ $labels.pod }} 15åˆ†é’Ÿå†…é‡å¯ {{ $value }} æ¬¡&#34;</span><span style=color:#6e7681>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=äºŒdistributed-tracingåˆ†å¸ƒå¼è¿½è¸ª>äºŒã€Distributed Tracingï¼šåˆ†å¸ƒå¼è¿½è¸ª<a hidden class=anchor aria-hidden=true href=#äºŒdistributed-tracingåˆ†å¸ƒå¼è¿½è¸ª>#</a></h2><h3 id=21-opentelemetry-tracing>2.1 OpenTelemetry Tracing<a hidden class=anchor aria-hidden=true href=#21-opentelemetry-tracing>#</a></h3><pre tabindex=0><code>è¯·æ±‚é“¾è·¯ï¼š
ç”¨æˆ· â†’ API Gateway â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡
      â†“              â†“           â†“
   Web Shop      æ”¯ä»˜æœåŠ¡    æ•°æ®åº“
</code></pre><h3 id=22-go--opentelemetry-å®ç°>2.2 Go + OpenTelemetry å®ç°<a hidden class=anchor aria-hidden=true href=#22-go--opentelemetry-å®ç°>#</a></h3><p><strong>ä¾èµ–</strong>ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>go get go.opentelemetry.io/otel
</span></span><span style=display:flex><span>go get go.opentelemetry.io/otel/exporters/jaeger
</span></span><span style=display:flex><span>go get go.opentelemetry.io/otel/sdk
</span></span><span style=display:flex><span>go get go.opentelemetry.io/otel/sdk/resource
</span></span><span style=display:flex><span>go get go.opentelemetry.io/otel/semconv/v1.4.0
</span></span></code></pre></td></tr></table></div></div><p><strong>åˆå§‹åŒ– Tracer</strong>ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;go.opentelemetry.io/otel&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;go.opentelemetry.io/otel/exporters/jaeger&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;go.opentelemetry.io/otel/sdk/resource&#34;</span>
</span></span><span style=display:flex><span>    tracesdk <span style=color:#a5d6ff>&#34;go.opentelemetry.io/otel/sdk/trace&#34;</span>
</span></span><span style=display:flex><span>    semconv <span style=color:#a5d6ff>&#34;go.opentelemetry.io/otel/semconv/v1.4.0&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>InitTracer</span>(serviceName, jaegerEndpoint <span style=color:#ff7b72>string</span>) (<span style=color:#ff7b72;font-weight:700>*</span>tracesdk.TracerProvider, <span style=color:#ff7b72>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åˆ›å»º Resource</span>
</span></span><span style=display:flex><span>    res, err <span style=color:#ff7b72;font-weight:700>:=</span> resource.<span style=color:#d2a8ff;font-weight:700>New</span>(
</span></span><span style=display:flex><span>        context.<span style=color:#d2a8ff;font-weight:700>Background</span>(),
</span></span><span style=display:flex><span>        resource.<span style=color:#d2a8ff;font-weight:700>WithAttributes</span>(
</span></span><span style=display:flex><span>            semconv.ServiceNameKey.<span style=color:#d2a8ff;font-weight:700>String</span>(serviceName),
</span></span><span style=display:flex><span>            semconv.DeploymentEnvironmentKey.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;production&#34;</span>),
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åˆ›å»º Jaeger Exporter</span>
</span></span><span style=display:flex><span>    exporter, err <span style=color:#ff7b72;font-weight:700>:=</span> jaeger.<span style=color:#d2a8ff;font-weight:700>New</span>(jaeger.<span style=color:#d2a8ff;font-weight:700>WithCollectorEndpoint</span>(
</span></span><span style=display:flex><span>        jaeger.<span style=color:#d2a8ff;font-weight:700>WithEndpoint</span>(jaegerEndpoint),
</span></span><span style=display:flex><span>    ))
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åˆ›å»º TracerProvider</span>
</span></span><span style=display:flex><span>    tp <span style=color:#ff7b72;font-weight:700>:=</span> tracesdk.<span style=color:#d2a8ff;font-weight:700>NewTracerProvider</span>(
</span></span><span style=display:flex><span>        tracesdk.<span style=color:#d2a8ff;font-weight:700>WithBatcher</span>(exporter),
</span></span><span style=display:flex><span>        tracesdk.<span style=color:#d2a8ff;font-weight:700>WithResource</span>(res),
</span></span><span style=display:flex><span>        tracesdk.<span style=color:#d2a8ff;font-weight:700>WithSampler</span>(tracesdk.<span style=color:#d2a8ff;font-weight:700>TraceIDRatioBased</span>(<span style=color:#a5d6ff>0.1</span>)),  <span style=color:#8b949e;font-style:italic>// 10% é‡‡æ ·</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ³¨å†Œä¸ºå…¨å±€ TracerProvider</span>
</span></span><span style=display:flex><span>    otel.<span style=color:#d2a8ff;font-weight:700>SetTracerProvider</span>(tp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> tp, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><strong>ä½¿ç”¨ Tracer</strong>ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;go.opentelemetry.io/otel/trace&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> OrderService <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    tracer trace.Tracer
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (s <span style=color:#ff7b72;font-weight:700>*</span>OrderService) <span style=color:#d2a8ff;font-weight:700>CreateOrder</span>(ctx context.Context, req <span style=color:#ff7b72;font-weight:700>*</span>CreateOrderRequest) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åˆ›å»º Span</span>
</span></span><span style=display:flex><span>    ctx, span <span style=color:#ff7b72;font-weight:700>:=</span> s.tracer.<span style=color:#d2a8ff;font-weight:700>Start</span>(ctx, <span style=color:#a5d6ff>&#34;CreateOrder&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>defer</span> span.<span style=color:#d2a8ff;font-weight:700>End</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    span.<span style=color:#d2a8ff;font-weight:700>SetAttributes</span>(
</span></span><span style=display:flex><span>        attribute.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;user.id&#34;</span>, req.UserID),
</span></span><span style=display:flex><span>        attribute.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;product.id&#34;</span>, req.ProductID),
</span></span><span style=display:flex><span>        attribute.<span style=color:#d2a8ff;font-weight:700>Float64</span>(<span style=color:#a5d6ff>&#34;order.amount&#34;</span>, req.Amount),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è°ƒç”¨åº“å­˜æœåŠ¡</span>
</span></span><span style=display:flex><span>    inventory, err <span style=color:#ff7b72;font-weight:700>:=</span> s.inventoryClient.<span style=color:#d2a8ff;font-weight:700>CheckStock</span>(ctx, req.ProductID)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        span.<span style=color:#d2a8ff;font-weight:700>RecordError</span>(err)
</span></span><span style=display:flex><span>        span.<span style=color:#d2a8ff;font-weight:700>SetStatus</span>(codes.Error, err.<span style=color:#d2a8ff;font-weight:700>Error</span>())
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åˆ›å»ºè®¢å•</span>
</span></span><span style=display:flex><span>    order <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>Order{
</span></span><span style=display:flex><span>        ID:        <span style=color:#d2a8ff;font-weight:700>generateID</span>(),
</span></span><span style=display:flex><span>        UserID:    req.UserID,
</span></span><span style=display:flex><span>        ProductID: req.ProductID,
</span></span><span style=display:flex><span>        Amount:    req.Amount,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> s.repo.<span style=color:#d2a8ff;font-weight:700>Create</span>(ctx, order); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        span.<span style=color:#d2a8ff;font-weight:700>RecordError</span>(err)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    span.<span style=color:#d2a8ff;font-weight:700>SetStatus</span>(codes.Ok, <span style=color:#a5d6ff>&#34;Order created&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=23-jaeger-éƒ¨ç½²kubernetes>2.3 Jaeger éƒ¨ç½²ï¼ˆKubernetesï¼‰<a hidden class=anchor aria-hidden=true href=#23-jaeger-éƒ¨ç½²kubernetes>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b949e;font-style:italic># jaeger-deployment.yaml</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>apps/v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Deployment</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>jaeger</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>replicas</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>selector</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>matchLabels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>jaeger</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>template</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>jaeger</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>containers</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>jaeger</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>image</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>jaegertracing/all-in-one:1.50</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>ports</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>containerPort</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>5775</span><span style=color:#6e7681>  </span><span style=color:#a5d6ff>// acceptor</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>acceptor</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>containerPort</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>16686</span><span style=color:#6e7681>  </span><span style=color:#a5d6ff>// query</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>query</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>env</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>COLLECTOR_ZIPKIN_HOST_PORT</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;:9411&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>SPAN_STORAGE_TYPE</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>elasticsearch</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>ES_SERVER_URLS</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>http://elasticsearch:9200</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>---</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>Service</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>jaeger</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>selector</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>app</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>jaeger</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>ports</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>5775</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>acceptor</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>16686</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>query</span><span style=color:#6e7681>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=ä¸‰loggingé›†ä¸­å¼æ—¥å¿—ç®¡ç†>ä¸‰ã€Loggingï¼šé›†ä¸­å¼æ—¥å¿—ç®¡ç†<a hidden class=anchor aria-hidden=true href=#ä¸‰loggingé›†ä¸­å¼æ—¥å¿—ç®¡ç†>#</a></h2><h3 id=31-æ—¥å¿—æ¶æ„æ¼”è¿›>3.1 æ—¥å¿—æ¶æ„æ¼”è¿›<a hidden class=anchor aria-hidden=true href=#31-æ—¥å¿—æ¶æ„æ¼”è¿›>#</a></h3><pre tabindex=0><code>é˜¶æ®µ1ï¼šæ—¥å¿—æ•£è½åœ¨å„å®¹å™¨
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ Pod1 â”‚ â”‚ Pod2 â”‚ â”‚ Pod3 â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚        â”‚        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    kubectl logs (æ‰‹åŠ¨æŸ¥çœ‹)

é˜¶æ®µ2ï¼šEFKï¼ˆElasticsearch + Fluentd + Kibanaï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ Pod1 â”‚ â”‚ Pod2 â”‚ â”‚ Pod3 â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚        â”‚        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    Fluentd (æ—¥å¿—æ”¶é›†)
         â†“
   Elasticsearch (å­˜å‚¨)
         â†“
     Kibana (å¯è§†åŒ–)

é˜¶æ®µ3ï¼šPLGï¼ˆPromtail + Loki + Grafanaï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ Pod1 â”‚ â”‚ Pod2 â”‚ â”‚ Pod3 â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚        â”‚        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    Promtail (æ—¥å¿—ä»£ç†)
         â†“
       Loki (å­˜å‚¨)
         â†“
     Grafana (å¯è§†åŒ–)
</code></pre><h3 id=32-ç»“æ„åŒ–æ—¥å¿—>3.2 ç»“æ„åŒ–æ—¥å¿—<a hidden class=anchor aria-hidden=true href=#32-ç»“æ„åŒ–æ—¥å¿—>#</a></h3><p><strong>æ—¥å¿—æ ¼å¼</strong>ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;timestamp&#34;</span>: <span style=color:#a5d6ff>&#34;2026-01-05T12:34:56.789Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;level&#34;</span>: <span style=color:#a5d6ff>&#34;info&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;service&#34;</span>: <span style=color:#a5d6ff>&#34;order-service&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;trace_id&#34;</span>: <span style=color:#a5d6ff>&#34;7f8a9b6c&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;span_id&#34;</span>: <span style=color:#a5d6ff>&#34;1a2b3c4d&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;user_id&#34;</span>: <span style=color:#a5d6ff>&#34;12345&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;message&#34;</span>: <span style=color:#a5d6ff>&#34;Order created successfully&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;order&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&#34;id&#34;</span>: <span style=color:#a5d6ff>&#34;ord_12345&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&#34;amount&#34;</span>: <span style=color:#a5d6ff>99.99</span>,
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&#34;product_id&#34;</span>: <span style=color:#a5d6ff>&#34;prod_67890&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><strong>Go + zap ç»“æ„åŒ–æ—¥å¿—</strong>ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;go.uber.org/zap&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;go.uber.org/zap/zapcore&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>NewLogger</span>(serviceName <span style=color:#ff7b72>string</span>) <span style=color:#ff7b72;font-weight:700>*</span>zap.Logger {
</span></span><span style=display:flex><span>    config <span style=color:#ff7b72;font-weight:700>:=</span> zap.<span style=color:#d2a8ff;font-weight:700>NewProductionConfig</span>()
</span></span><span style=display:flex><span>    config.InitialFields = <span style=color:#ff7b72>map</span>[<span style=color:#ff7b72>string</span>]<span style=color:#ff7b72>interface</span>{}{
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;service&#34;</span>: serviceName,
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;pod&#34;</span>:     os.<span style=color:#d2a8ff;font-weight:700>Getenv</span>(<span style=color:#a5d6ff>&#34;POD_NAME&#34;</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    logger, _ <span style=color:#ff7b72;font-weight:700>:=</span> config.<span style=color:#d2a8ff;font-weight:700>Build</span>(
</span></span><span style=display:flex><span>        zap.<span style=color:#d2a8ff;font-weight:700>AddCallerSkip</span>(<span style=color:#a5d6ff>2</span>),  <span style=color:#8b949e;font-style:italic>// è·³è¿‡åŒ…è£…å±‚</span>
</span></span><span style=display:flex><span>        zap.<span style=color:#d2a8ff;font-weight:700>Wrap</span>(<span style=color:#ff7b72>func</span>(zapcore.Core) zapcore.Core {
</span></span><span style=display:flex><span>          <span style=color:#8b949e;font-style:italic>// æ³¨å…¥ trace_id å’Œ span_id</span>
</span></span><span style=display:flex><span>          <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>TraceIDCore{Core: zapcore.<span style=color:#d2a8ff;font-weight:700>New</span>(zapcore.<span style=color:#d2a8ff;font-weight:700>NewJSONEncoder</span>())}
</span></span><span style=display:flex><span>        }),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> logger
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> TraceIDCore <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    zapcore.Core
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (c <span style=color:#ff7b72;font-weight:700>*</span>TraceIDCore) <span style=color:#d2a8ff;font-weight:700>With</span>(fields []zapcore.Field) zapcore.Core {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä» OpenTelemetry Context æå– trace_id å’Œ span_id</span>
</span></span><span style=display:flex><span>    ctx <span style=color:#ff7b72;font-weight:700>:=</span> context.<span style=color:#d2a8ff;font-weight:700>Background</span>()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> span <span style=color:#ff7b72;font-weight:700>:=</span> trace.<span style=color:#d2a8ff;font-weight:700>SpanFromContext</span>(ctx); span.<span style=color:#d2a8ff;font-weight:700>SpanContext</span>().<span style=color:#d2a8ff;font-weight:700>IsValid</span>() {
</span></span><span style=display:flex><span>        fields = append(fields,
</span></span><span style=display:flex><span>            zap.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;trace_id&#34;</span>, span.<span style=color:#d2a8ff;font-weight:700>SpanContext</span>().<span style=color:#d2a8ff;font-weight:700>TraceID</span>().<span style=color:#d2a8ff;font-weight:700>String</span>()),
</span></span><span style=display:flex><span>            zap.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;span_id&#34;</span>, span.<span style=color:#d2a8ff;font-weight:700>SpanContext</span>().<span style=color:#d2a8ff;font-weight:700>SpanID</span>().<span style=color:#d2a8ff;font-weight:700>String</span>()),
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> c.Core.<span style=color:#d2a8ff;font-weight:700>With</span>(fields)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><strong>ä½¿ç”¨ç¤ºä¾‹</strong>ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>var</span> logger <span style=color:#ff7b72;font-weight:700>*</span>zap.Logger
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (s <span style=color:#ff7b72;font-weight:700>*</span>OrderService) <span style=color:#d2a8ff;font-weight:700>CreateOrder</span>(ctx context.Context, req <span style=color:#ff7b72;font-weight:700>*</span>CreateOrderRequest) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    logger.<span style=color:#d2a8ff;font-weight:700>Info</span>(<span style=color:#a5d6ff>&#34;Creating order&#34;</span>,
</span></span><span style=display:flex><span>        zap.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;user_id&#34;</span>, req.UserID),
</span></span><span style=display:flex><span>        zap.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;product_id&#34;</span>, req.ProductID),
</span></span><span style=display:flex><span>        zap.<span style=color:#d2a8ff;font-weight:700>Float64</span>(<span style=color:#a5d6ff>&#34;amount&#34;</span>, req.Amount),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    order <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>Order{<span style=color:#ff7b72;font-weight:700>...</span>}
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>:=</span> s.repo.<span style=color:#d2a8ff;font-weight:700>Create</span>(order); err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        logger.<span style=color:#d2a8ff;font-weight:700>Error</span>(<span style=color:#a5d6ff>&#34;Failed to create order&#34;</span>,
</span></span><span style=display:flex><span>            zap.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;order_id&#34;</span>, order.ID),
</span></span><span style=display:flex><span>            zap.<span style=color:#d2a8ff;font-weight:700>Error</span>(err),
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    logger.<span style=color:#d2a8ff;font-weight:700>Info</span>(<span style=color:#a5d6ff>&#34;Order created successfully&#34;</span>,
</span></span><span style=display:flex><span>        zap.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;order_id&#34;</span>, order.ID),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=33-promtail-é…ç½®>3.3 Promtail é…ç½®<a hidden class=anchor aria-hidden=true href=#33-promtail-é…ç½®>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b949e;font-style:italic># promtail-config.yaml</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>server</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>http_listen_port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>9080</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>positions</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>filename</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/tmp/positions.yaml</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>clients</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>url</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>http://loki:3100/loki/api/v1/push</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>scrape_configs</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>job_name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>pods</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>kubernetes_sd_configs</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>role</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>pod</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>relabel_configs</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>source_labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span>- <span style=color:#a5d6ff>__meta_kubernetes_pod_name</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span>- <span style=color:#a5d6ff>__meta_kubernetes_namespace</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span>- <span style=color:#a5d6ff>__meta_kubernetes_pod_label_app</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>target_label</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>filename</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>replacement</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>/var/log/pods/*$1*/*.log</span><span style=color:#6e7681>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=34-loki-æŸ¥è¯¢è¯­æ³•>3.4 Loki æŸ¥è¯¢è¯­æ³•<a hidden class=anchor aria-hidden=true href=#34-loki-æŸ¥è¯¢è¯­æ³•>#</a></h3><pre tabindex=0><code># æŸ¥è¯¢æ‰€æœ‰é”™è¯¯æ—¥å¿—
{level=&#34;error&#34;}

# æŸ¥è¯¢ç‰¹å®šæœåŠ¡çš„æ—¥å¿—
{service=&#34;order-service&#34;}

# æ—¶é—´èŒƒå›´æŸ¥è¯¢
{service=&#34;order-service&#34;} |= &#34;Order created&#34; | line_format &#34;{{.timestamp}} {{.message}}&#34;
</code></pre><h2 id=å››å®Œæ•´å¯è§‚æµ‹æ€§æ¶æ„>å››ã€å®Œæ•´å¯è§‚æµ‹æ€§æ¶æ„<a hidden class=anchor aria-hidden=true href=#å››å®Œæ•´å¯è§‚æµ‹æ€§æ¶æ„>#</a></h2><h3 id=41-æ¶æ„å›¾>4.1 æ¶æ„å›¾<a hidden class=anchor aria-hidden=true href=#41-æ¶æ„å›¾>#</a></h3><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Grafana                           â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚       â”‚  Metrics     â”‚   Tracing    â”‚   Logging    â”‚        â”‚
â”‚       â”‚  (Prometheus)â”‚  (Jaeger)    â”‚    (Loki)    â”‚        â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†‘                â†‘               â†‘
            â”‚                â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚               Kubernetes Cluster                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Pod A     â”‚  â”‚   Pod B     â”‚  â”‚   Pod C     â”‚         â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚
â”‚  â”‚ â”‚ App     â”‚ â”‚  â”‚ â”‚ App     â”‚ â”‚  â”‚ â”‚ App     â”‚ â”‚         â”‚
â”‚  â”‚ â”‚         â”‚ â”‚  â”‚ â”‚         â”‚ â”‚  â”‚ â”‚         â”‚ â”‚         â”‚
â”‚  â”‚ â”‚ /metricsâ”‚ â”‚  â”‚ â”‚ /metricsâ”‚ â”‚  â”‚ â”‚ /metricsâ”‚ â”‚         â”‚
â”‚  â”‚ â”‚ /tracingâ”‚ â”‚  â”‚ â”‚ /tracingâ”‚ â”‚  â”‚ â”‚ /tracingâ”‚ â”‚         â”‚
â”‚  â”‚ â”‚ /logs   â”‚ â”‚  â”‚ â”‚ /logs   â”‚ â”‚  â”‚ â”‚ /logs   â”‚ â”‚         â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            Operator (è‡ªåŠ¨è¿ç»´)                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><h3 id=42-ç»Ÿä¸€-dashboard>4.2 ç»Ÿä¸€ Dashboard<a hidden class=anchor aria-hidden=true href=#42-ç»Ÿä¸€-dashboard>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#7ee787>&#34;dashboard&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&#34;title&#34;</span>: <span style=color:#a5d6ff>&#34;å¯è§‚æµ‹æ€§ç»Ÿä¸€å¤§ç›˜&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&#34;panels&#34;</span>: [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;title&#34;</span>: <span style=color:#a5d6ff>&#34;QPS&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;graph&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;gridPos&#34;</span>: {<span style=color:#7ee787>&#34;x&#34;</span>: <span style=color:#a5d6ff>0</span>, <span style=color:#7ee787>&#34;y&#34;</span>: <span style=color:#a5d6ff>0</span>, <span style=color:#7ee787>&#34;w&#34;</span>: <span style=color:#a5d6ff>12</span>, <span style=color:#7ee787>&#34;h&#34;</span>: <span style=color:#a5d6ff>8</span>},
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;targets&#34;</span>: [{<span style=color:#7ee787>&#34;expr&#34;</span>: <span style=color:#a5d6ff>&#34;sum(rate(http_requests_total{namespace=~\&#34;prod\&#34;}[5m]))&#34;</span>}]
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;title&#34;</span>: <span style=color:#a5d6ff>&#34;P95 å»¶è¿Ÿ&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;graph&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;gridPos&#34;</span>: {<span style=color:#7ee787>&#34;x&#34;</span>: <span style=color:#a5d6ff>12</span>, <span style=color:#7ee787>&#34;y&#34;</span>: <span style=color:#a5d6ff>0</span>, <span style=color:#7ee787>&#34;w&#34;</span>: <span style=color:#a5d6ff>12</span>, <span style=color:#7ee787>&#34;h&#34;</span>: <span style=color:#a5d6ff>8</span>},
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;targets&#34;</span>: [{<span style=color:#7ee787>&#34;expr&#34;</span>: <span style=color:#a5d6ff>&#34;histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))&#34;</span>}]
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;title&#34;</span>: <span style=color:#a5d6ff>&#34;é”™è¯¯æ—¥å¿—&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;logs&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;gridPos&#34;</span>: {<span style=color:#7ee787>&#34;x&#34;</span>: <span style=color:#a5d6ff>0</span>, <span style=color:#7ee787>&#34;y&#34;</span>: <span style=color:#a5d6ff>8</span>, <span style=color:#7ee787>&#34;w&#34;</span>: <span style=color:#a5d6ff>12</span>, <span style=color:#7ee787>&#34;h&#34;</span>: <span style=color:#a5d6ff>8</span>},
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;targets&#34;</span>: [{<span style=color:#7ee787>&#34;expr&#34;</span>: <span style=color:#a5d6ff>&#34;{level=\&#34;error\&#34;}&#34;</span>}]
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;title&#34;</span>: <span style=color:#a5d6ff>&#34;Trace æœç´¢&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;type&#34;</span>: <span style=color:#a5d6ff>&#34;tracejaeger&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&#34;gridPos&#34;</span>: {<span style=color:#7ee787>&#34;x&#34;</span>: <span style=color:#a5d6ff>12</span>, <span style=color:#7ee787>&#34;y&#34;</span>: <span style=color:#a5d6ff>8</span>, <span style=color:#7ee787>&#34;w&#34;</span>: <span style=color:#a5d6ff>12</span>, <span style=color:#7ee787>&#34;h&#34;</span>: <span style=color:#a5d6ff>8</span>}
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=äº”æœ€ä½³å®è·µ>äº”ã€æœ€ä½³å®è·µ<a hidden class=anchor aria-hidden=true href=#äº”æœ€ä½³å®è·µ>#</a></h2><h3 id=51-red-æ–¹æ³•å‘Šè­¦>5.1 RED æ–¹æ³•å‘Šè­¦<a hidden class=anchor aria-hidden=true href=#51-red-æ–¹æ³•å‘Šè­¦>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>groups</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>red-method</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>rules</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#8b949e;font-style:italic># Rate: è¯·æ±‚é€Ÿç‡</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>alert</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>LowRequestRate</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>expr</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>sum(rate(http_requests_total[5m])) &lt; 100</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>for</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>5m</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>severity</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>warning</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#8b949e;font-style:italic># Errors: é”™è¯¯ç‡</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>alert</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HighErrorRate</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>expr</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>sum(rate(http_requests_total{status=~&#34;5..&#34;}[5m])) / sum(rate(http_requests_total[5m])) &gt; 0.01</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>for</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>5m</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>severity</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>critical</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#8b949e;font-style:italic># Duration: æŒç»­æ—¶é—´ï¼ˆP99ï¼‰</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>- <span style=color:#7ee787>alert</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>HighP99Latency</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>expr</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) &gt; 1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>for</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>5m</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>severity</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>warning</span><span style=color:#6e7681>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=52-æ—¥å¿—åˆ†çº§ä¸é‡‡æ ·>5.2 æ—¥å¿—åˆ†çº§ä¸é‡‡æ ·<a hidden class=anchor aria-hidden=true href=#52-æ—¥å¿—åˆ†çº§ä¸é‡‡æ ·>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ ¹æ®æ—¥å¿—çº§åˆ«é‡‡æ ·</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> SamplingLogger <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    base   <span style=color:#ff7b72;font-weight:700>*</span>zap.Logger
</span></span><span style=display:flex><span>    sample <span style=color:#ff7b72>map</span>[zapcore.Level]<span style=color:#ff7b72>float64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (l <span style=color:#ff7b72;font-weight:700>*</span>SamplingLogger) <span style=color:#d2a8ff;font-weight:700>Debug</span>(msg <span style=color:#ff7b72>string</span>, fields <span style=color:#ff7b72;font-weight:700>...</span>zap.Field) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> rand.<span style=color:#d2a8ff;font-weight:700>Float64</span>() &gt; l.sample[zap.DebugLevel] {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span>  <span style=color:#8b949e;font-style:italic>// è·³è¿‡</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    l.base.<span style=color:#d2a8ff;font-weight:700>Debug</span>(msg, fields<span style=color:#ff7b72;font-weight:700>...</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (l <span style=color:#ff7b72;font-weight:700>*</span>SamplingLogger) <span style=color:#d2a8ff;font-weight:700>Error</span>(msg <span style=color:#ff7b72>string</span>, fields <span style=color:#ff7b72;font-weight:700>...</span>zap.Field) {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// é”™è¯¯æ—¥å¿—ä¸é‡‡æ ·</span>
</span></span><span style=display:flex><span>    l.base.<span style=color:#d2a8ff;font-weight:700>Error</span>(msg, fields<span style=color:#ff7b72;font-weight:700>...</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=53-trace-ä¸-log-çš„å…³è”>5.3 Trace ä¸ Log çš„å…³è”<a hidden class=anchor aria-hidden=true href=#53-trace-ä¸-log-çš„å…³è”>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>func</span> (s <span style=color:#ff7b72;font-weight:700>*</span>OrderService) <span style=color:#d2a8ff;font-weight:700>CreateOrder</span>(ctx context.Context, req <span style=color:#ff7b72;font-weight:700>*</span>CreateOrderRequest) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    span <span style=color:#ff7b72;font-weight:700>:=</span> trace.<span style=color:#d2a8ff;font-weight:700>SpanFromContext</span>(ctx)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    logger <span style=color:#ff7b72;font-weight:700>:=</span> logger.<span style=color:#d2a8ff;font-weight:700>With</span>(
</span></span><span style=display:flex><span>        zap.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;trace_id&#34;</span>, span.<span style=color:#d2a8ff;font-weight:700>SpanContext</span>().<span style=color:#d2a8ff;font-weight:700>TraceID</span>().<span style=color:#d2a8ff;font-weight:700>String</span>()),
</span></span><span style=display:flex><span>        zap.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;span_id&#34;</span>, span.<span style=color:#d2a8ff;font-weight:700>SpanContext</span>().<span style=color:#d2a8ff;font-weight:700>SpanID</span>().<span style=color:#d2a8ff;font-weight:700>String</span>()),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    logger.<span style=color:#d2a8ff;font-weight:700>Info</span>(<span style=color:#a5d6ff>&#34;Creating order&#34;</span>, <span style=color:#ff7b72;font-weight:700>...</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=å…­æ€»ç»“>å…­ã€æ€»ç»“<a hidden class=anchor aria-hidden=true href=#å…­æ€»ç»“>#</a></h2><p>å¯è§‚æµ‹æ€§æ˜¯äº‘åŸç”Ÿç³»ç»Ÿçš„å¿…å¤‡èƒ½åŠ›ã€‚é€šè¿‡ï¼š</p><ol><li><strong>Metrics</strong>ï¼šç›‘æ§èµ„æºä½¿ç”¨å’Œä¸šåŠ¡æŒ‡æ ‡</li><li><strong>Tracing</strong>ï¼šè¿½è¸ªåˆ†å¸ƒå¼è¯·æ±‚é“¾è·¯</li><li><strong>Logging</strong>ï¼šè®°å½•ç¦»æ•£äº‹ä»¶å’Œé”™è¯¯ä¿¡æ¯</li></ol><p>æ„å»ºå®Œæ•´çš„å¯è§‚æµ‹æ€§ä½“ç³»ï¼Œè®©ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ä¸€ç›®äº†ç„¶ã€‚</p><hr><blockquote><p>å¯è§‚æµ‹æ€§ä¸æ˜¯äº‹åè¯¸è‘›äº®ï¼Œè€Œæ˜¯æ¶æ„è®¾è®¡çš„ä¸€ç­‰å…¬æ°‘ã€‚åœ¨è®¾è®¡ç³»ç»Ÿæ—¶ï¼Œå°±è¦è€ƒè™‘å¦‚ä½•è§‚å¯Ÿå®ƒã€‚</p></blockquote></div><footer class=post-footer-modern><div class=post-tags-modern><span class=tags-label>ğŸ·ï¸ æ ‡ç­¾</span><div class=tags-list><a href=/blog/tags/%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/ class=tag-pill>å¯è§‚æµ‹æ€§
</a><a href=/blog/tags/%E7%9B%91%E6%8E%A7/ class=tag-pill>ç›‘æ§
</a><a href=/blog/tags/prometheus/ class=tag-pill>Prometheus
</a><a href=/blog/tags/kubernetes/ class=tag-pill>Kubernetes
</a><a href=/blog/tags/logging/ class=tag-pill>Logging</a></div></div><style>.post-footer-modern{margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border,#333333)}.post-tags-modern{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}.tags-label{font-size:.875rem;font-weight:600;color:var(--secondary,#999999) !important;white-space:nowrap}.tags-list{display:flex;flex-wrap:wrap;gap:.5rem;flex:1}.tag-pill{display:inline-block;padding:.25rem .75rem;background:rgba(255,255,255,5%);border:1px solid var(--border,#333333);border-radius:0;color:var(--secondary,#cccccc) !important;text-decoration:none;font-size:.8rem;font-weight:500;transition:all .2s ease}.tag-pill:hover{background:var(--primary,#ffffff);color:var(--background,#000000) !important;border-color:var(--primary,#ffffff);transform:translateY(-1px)}.post-nav-modern{margin-top:2rem}.nav-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.nav-card{display:flex;align-items:center;gap:1rem;padding:1.25rem;background:rgba(255,255,255,2%);border:1px solid var(--border,#333333);border-radius:12px;text-decoration:none;transition:all .2s ease;min-height:80px}.nav-card:hover{background:rgba(255,255,255,5%);border-color:var(--primary,#ffffff);transform:translateY(-2px)}.nav-card.nav-prev{justify-content:flex-start}.nav-card.nav-next{justify-content:flex-end;text-align:right}.nav-card.nav-next .nav-content{text-align:right}.nav-empty{display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,1%);border:1px dashed var(--border,#333333);color:var(--secondary,#666666)}.nav-arrow{font-size:1.5rem;color:var(--primary,#ffffff);font-weight:300}.nav-content{flex:1}.nav-title{font-size:.95rem;font-weight:600;color:var(--primary,#ffffff) !important;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}[data-theme=light] .post-footer-modern{border-color:var(--border-light,#dee2e6)}[data-theme=light] .tags-label{color:var(--secondary-light,#6c757d) !important}[data-theme=light] .tag-pill{background:rgba(0,0,0,5%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#495057) !important}[data-theme=light] .tag-pill:hover{background:var(--primary-light,#0066cc);color:var(--background-light,#ffffff) !important;border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-card{background:rgba(0,0,0,2%);border-color:var(--border-light,#dee2e6)}[data-theme=light] .nav-card:hover{background:rgba(0,102,204,5%);border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-empty{background:rgba(0,0,0,1%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#6c757d)}[data-theme=light] .nav-arrow{color:var(--primary-light,#0066cc)}[data-theme=light] .nav-title{color:var(--primary-light,#212529) !important}@media(max-width:768px){.nav-grid{grid-template-columns:1fr;gap:.75rem}.nav-card{padding:1rem;min-height:70px}.nav-card.nav-next{text-align:left}.nav-card.nav-next .nav-content{text-align:left}.nav-title{font-size:.875rem}.post-tags-modern{flex-direction:column;gap:.75rem}}@media(max-width:480px){.nav-arrow{font-size:1.25rem}.nav-card{padding:.875rem}.nav-title{font-size:.8rem;-webkit-line-clamp:1}}</style><nav class=post-nav-modern><div class=nav-grid><a href=/blog/articles/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E6%8C%87%E5%8D%97%E4%BB%8E%E5%8D%95%E8%A1%A8%E5%88%B0%E7%99%BE%E4%BA%BF%E7%BA%A7%E6%95%B0%E6%8D%AE%E7%9A%84%E6%BC%94%E8%BF%9B%E4%B9%8B%E8%B7%AF/ class="nav-card nav-prev"><div class=nav-arrow>â†</div><div class=nav-content><div class=nav-title>æ•°æ®åº“åˆ†åº“åˆ†è¡¨æ¶æ„è®¾è®¡æŒ‡å—ï¼šä»å•è¡¨åˆ°ç™¾äº¿çº§æ•°æ®çš„æ¼”è¿›ä¹‹è·¯</div></div></a><a href=/blog/articles/%E9%AB%98%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%9A%84%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B%E4%BB%8E%E5%8D%95%E4%B8%80-redis-%E5%88%B0%E5%A4%9A%E5%B1%82%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9E%E6%88%98%E4%B9%8B%E8%B7%AF/ class="nav-card nav-next"><div class=nav-content><div class=nav-title>é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ç¼“å­˜æ¶æ„æ¼”è¿›ï¼šä»å•ä¸€ Redis åˆ°å¤šå±‚ç¼“å­˜çš„å®æˆ˜ä¹‹è·¯</div></div><div class=nav-arrow>â†’</div></a></div></nav></footer></main><aside class=post-sidebar><div class=sidebar-toc id=sidebar-toc><div class=toc-header><div class=toc-title>ç›®å½•</div><button class=toc-toggle id=toc-toggle aria-label="Toggle TOC">
<svg class="toc-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div class=toc-content id=toc-content><ul class=toc-list><li class="toc-item toc-h2"><a href=#h2-0 class=toc-item-link><span class=toc-item-text>å¼•è¨€ï¼šä»ç›‘æ§åˆ°å¯è§‚æµ‹æ€§</span></a></li><li class="toc-item toc-h2"><a href=#h2-1 class=toc-item-link><span class=toc-item-text>ä¸€ã€Metricsï¼šä»é»‘ç›’åˆ°ç™½ç›’</span></a></li><li class="toc-item toc-h2"><a href=#h2-2 class=toc-item-link><span class=toc-item-text>äºŒã€Distributed Tracingï¼šåˆ†å¸ƒå¼è¿½è¸ª</span></a></li><li class="toc-item toc-h2"><a href=#h2-3 class=toc-item-link><span class=toc-item-text>ä¸‰ã€Loggingï¼šé›†ä¸­å¼æ—¥å¿—ç®¡ç†</span></a></li><li class="toc-item toc-h2"><a href=#h2-4 class=toc-item-link><span class=toc-item-text>å››ã€å®Œæ•´å¯è§‚æµ‹æ€§æ¶æ„</span></a></li><li class="toc-item toc-h2"><a href=#h2-5 class=toc-item-link><span class=toc-item-text>äº”ã€æœ€ä½³å®è·µ</span></a></li><li class="toc-item toc-h2"><a href=#h2-6 class=toc-item-link><span class=toc-item-text>å…­ã€æ€»ç»“</span></a></li></ul></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("sidebar-toc"),t=document.getElementById("toc-toggle"),o=document.getElementById("toc-content"),i=t?.querySelector(".toc-toggle-icon");if(!e)return;let n=!1;t&&t.addEventListener("click",function(){n=!n,n?(o.style.display="none",e.style.width="auto",i.innerHTML='<path d="M9 18l6-6-6-6"/>'):(o.style.display="block",e.style.width="200px",i.innerHTML='<path d="M18 6L6 18M6 6l12 12"/>')});const s=document.querySelector(".post-content");if(s){const e=s.querySelectorAll("h1");e.forEach((e,t)=>{e.id=`h1-${t}`});const t=s.querySelectorAll("h2");t.forEach((e,t)=>{e.id=`h2-${t}`})}const a=document.querySelectorAll(".toc-item-link");a.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const n=this.getAttribute("href").substring(1),t=document.getElementById(n);if(t){const e=document.querySelector(".post-header-main")?.offsetHeight||0,n=t.offsetTop-e-20;window.scrollTo({top:n,behavior:"smooth"})}})})})</script><style>.sidebar-toc{position:sticky;top:2rem;width:200px;background:#fff;border:1px solid #e5e7eb;border-radius:4px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);z-index:100}.sidebar-toc.hidden{display:none}.toc-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fafbfc;display:flex;align-items:center;justify-content:space-between}.toc-title{margin:0;font-size:13px;font-weight:500;color:#374151 !important;font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,sans-serif;text-transform:uppercase;letter-spacing:1px}.toc-toggle{background:0 0;border:none;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .2s ease;color:#6b7280}.toc-toggle:hover{background:#e5e7eb;color:#374151}.toc-toggle-icon{transition:transform .2s ease}.toc-content{padding:12px 0}.toc-list{list-style:none;margin:0;padding:0}.toc-item{margin-bottom:4px;display:block !important;visibility:visible !important}.toc-h1,.toc-h2{display:block !important}.toc-h2{margin-left:0}.toc-item-link{display:flex;align-items:center;gap:8px;padding:8px 12px;color:#374151 !important;text-decoration:none;font-size:13px;line-height:1.4;border-radius:3px;transition:all .2s ease;font-weight:400}.toc-item-link:hover{background:#f8fafc;color:#1f2937 !important}.toc-item-link.active{background:#e0f2fe;color:#01579b !important;font-weight:500}.toc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.dot-red{background:#ef4444}.dot-blue{background:#2196f3}.toc-item-text{color:#1f2937 !important;font-weight:400;flex:1;display:inline !important;visibility:visible !important;opacity:1 !important;font-size:13px !important;line-height:1.4 !important}.toc-item-link .toc-item-text{color:#1f2937 !important;display:inline !important;visibility:visible !important;opacity:1 !important}.toc-item.active .dot-red{background:#d32f2f}.toc-item.active .dot-blue{background:#1976d2}[data-theme=dark] .sidebar-toc{background:#1f2937;border-color:#374151;box-shadow:0 1px 3px rgba(0,0,0,.3)}[data-theme=dark] .toc-header{background:#111827;border-color:#374151}[data-theme=dark] .toc-title{color:#f3f4f6 !important}[data-theme=dark] .toc-toggle{color:#9ca3af}[data-theme=dark] .toc-toggle:hover{background:#374151;color:#f3f4f6}[data-theme=dark] .toc-item-link{color:#e5e7eb !important}[data-theme=dark] .toc-item-link:hover{background:#374151;color:#f9fafb !important}[data-theme=dark] .toc-item-link.active{background:#0d47a1;color:#fff !important}[data-theme=dark] .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}[data-theme=dark] .toc-item-link .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}@media(max-width:1024px){.sidebar-toc{display:none}.post-content-wrapper{grid-template-columns:1fr !important;padding:0 1rem !important}}</style><style>.post-content-wrapper{display:grid;grid-template-columns:1fr 200px;gap:2rem;padding:0 2rem;max-width:100%}.post-content-main{min-width:0}.post-sidebar{position:sticky;top:2rem;height:fit-content;min-width:0}.post-header-main{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border,#333333)}.post-header-main .post-title{color:var(--primary,#ffffff) !important;font-size:2.5rem;font-weight:700;line-height:1.2;margin-bottom:1rem}.post-header-main .post-description{color:var(--secondary,#cccccc) !important;font-size:1.1rem;line-height:1.6;margin-bottom:1rem}.post-header-main .post-meta{margin-bottom:0}@media(max-width:1024px){.post-content-wrapper{grid-template-columns:1fr !important;gap:1rem;padding:0 1rem !important}.post-sidebar{display:none}}@media(max-width:768px){.post-header-main .post-title{font-size:2rem}.post-header-main .post-description{font-size:1rem}}</style></aside></div></article></main><footer class=footer><span>Â© 2024-2025 æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢</span> Â·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>