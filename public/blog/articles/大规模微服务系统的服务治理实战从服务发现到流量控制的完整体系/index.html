<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>å¤§è§„æ¨¡å¾®æœåŠ¡ç³»ç»Ÿçš„æœåŠ¡æ²»ç†å®æˆ˜ï¼šä»æœåŠ¡å‘ç°åˆ°æµé‡æ§åˆ¶çš„å®Œæ•´ä½“ç³» | æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</title><meta name=keywords content="å¾®æœåŠ¡,æœåŠ¡æ²»ç†,Service Mesh,Istio,æµé‡æ§åˆ¶"><meta name=description content="æ·±å…¥æ¢è®¨å¾®æœåŠ¡æ²»ç†çš„æ ¸å¿ƒç»„ä»¶ï¼šæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­é™çº§ã€é™æµã€ç°åº¦å‘å¸ƒï¼Œä»¥åŠå¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è½åœ° Istio Service Mesh"><meta name=author content="æŠ€æœ¯å›¢é˜Ÿ"><link rel=canonical href=/blog/articles/%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%AE%9E%E6%88%98%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E5%88%B0%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%9A%84%E5%AE%8C%E6%95%B4%E4%BD%93%E7%B3%BB/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.7e8505b7cdf8bb22ab2305e53c2700bb06c7e64faeb72cd3468823a9a3bd3d6e.css integrity="sha256-foUFt834uyKrIwXlPCcAuwbH5k+utyzTRogjqaO9PW4=" rel="preload stylesheet" as=style><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=apple-touch-icon href=/blog/apple-touch-icon.png><link rel=mask-icon href=/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=/blog/articles/%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%AE%9E%E6%88%98%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E5%88%B0%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%9A%84%E5%AE%8C%E6%95%B4%E4%BD%93%E7%B3%BB/feed.xml title=rss><link rel=alternate hreflang=zh-cn href=/blog/articles/%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%AE%9E%E6%88%98%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E5%88%B0%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%9A%84%E5%AE%8C%E6%95%B4%E4%BD%93%E7%B3%BB/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=/js/external-link-config.js></script><script src=/js/external-link-interceptor.js></script><link rel=stylesheet href=/blog/css/custom.css media=screen><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«","url":"https://www.util.cn/blog/","description":"æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚","publisher":{"@type":"Organization","name":"æœ‰æ¡å·¥å…·","url":"https://www.util.cn","logo":{"@type":"ImageObject","url":"https://www.util.cn/blog/logo/logo-256.png","width":256,"height":256}},"potentialAction":[{"@type":"SearchAction","target":"https://www.util.cn/blog/search?q={search_term_string}","query-input":"required name=search_term_string"}]}</script><meta property="og:type" content="website"><meta property="og:title" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta property="og:description" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚"><meta property="og:url" content="https://www.util.cn/blog/"><meta property="og:site_name" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢"><meta property="og:image" content="https://www.util.cn/blog/logo/logo-256.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta name=twitter:description content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚"><meta name=twitter:image content="https://www.util.cn/blog/logo/logo-256.png"><meta name=baidu-site-verification content><meta name=category content="æŠ€æœ¯åšå®¢,å¼€å‘è€…å·¥å…·,ç¼–ç¨‹æ•™ç¨‹"><meta name=coverage content="Worldwide"><meta name=distribution content="Global"><meta name=rating content="General"><script id=51la_code async crossorigin=anonymous src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=pro"></script><script>window.addEventListener("load",function(){setTimeout(function(){typeof la!="undefined"?console.log("51laç»Ÿè®¡å·²åŠ è½½"):(console.warn("51laç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"),function(){var e=document.createElement("script");e.src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=backup",e.async=!0,document.head.appendChild(e)}())},3e3)})</script><meta property="og:url" content="/blog/articles/%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%AE%9E%E6%88%98%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E5%88%B0%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%9A%84%E5%AE%8C%E6%95%B4%E4%BD%93%E7%B3%BB/"><meta property="og:site_name" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·"><meta property="og:title" content="å¤§è§„æ¨¡å¾®æœåŠ¡ç³»ç»Ÿçš„æœåŠ¡æ²»ç†å®æˆ˜ï¼šä»æœåŠ¡å‘ç°åˆ°æµé‡æ§åˆ¶çš„å®Œæ•´ä½“ç³»"><meta property="og:description" content="æ·±å…¥æ¢è®¨å¾®æœåŠ¡æ²»ç†çš„æ ¸å¿ƒç»„ä»¶ï¼šæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­é™çº§ã€é™æµã€ç°åº¦å‘å¸ƒï¼Œä»¥åŠå¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è½åœ° Istio Service Mesh"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-01-05T00:00:00+00:00"><meta property="article:modified_time" content="2026-01-05T00:00:00+00:00"><meta property="article:tag" content="å¾®æœåŠ¡"><meta property="article:tag" content="æœåŠ¡æ²»ç†"><meta property="article:tag" content="Service Mesh"><meta property="article:tag" content="Istio"><meta property="article:tag" content="æµé‡æ§åˆ¶"><meta name=twitter:card content="summary"><meta name=twitter:title content="å¤§è§„æ¨¡å¾®æœåŠ¡ç³»ç»Ÿçš„æœåŠ¡æ²»ç†å®æˆ˜ï¼šä»æœåŠ¡å‘ç°åˆ°æµé‡æ§åˆ¶çš„å®Œæ•´ä½“ç³»"><meta name=twitter:description content="æ·±å…¥æ¢è®¨å¾®æœåŠ¡æ²»ç†çš„æ ¸å¿ƒç»„ä»¶ï¼šæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­é™çº§ã€é™æµã€ç°åº¦å‘å¸ƒï¼Œä»¥åŠå¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è½åœ° Istio Service Mesh"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"æ‰€æœ‰æ–‡ç« ","item":"/blog/posts/"},{"@type":"ListItem","position":2,"name":"å¤§è§„æ¨¡å¾®æœåŠ¡ç³»ç»Ÿçš„æœåŠ¡æ²»ç†å®æˆ˜ï¼šä»æœåŠ¡å‘ç°åˆ°æµé‡æ§åˆ¶çš„å®Œæ•´ä½“ç³»","item":"/blog/articles/%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%AE%9E%E6%88%98%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E5%88%B0%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%9A%84%E5%AE%8C%E6%95%B4%E4%BD%93%E7%B3%BB/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"å¤§è§„æ¨¡å¾®æœåŠ¡ç³»ç»Ÿçš„æœåŠ¡æ²»ç†å®æˆ˜ï¼šä»æœåŠ¡å‘ç°åˆ°æµé‡æ§åˆ¶çš„å®Œæ•´ä½“ç³»","name":"å¤§è§„æ¨¡å¾®æœåŠ¡ç³»ç»Ÿçš„æœåŠ¡æ²»ç†å®æˆ˜ï¼šä»æœåŠ¡å‘ç°åˆ°æµé‡æ§åˆ¶çš„å®Œæ•´ä½“ç³»","description":"æ·±å…¥æ¢è®¨å¾®æœåŠ¡æ²»ç†çš„æ ¸å¿ƒç»„ä»¶ï¼šæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­é™çº§ã€é™æµã€ç°åº¦å‘å¸ƒï¼Œä»¥åŠå¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è½åœ° Istio Service Mesh","keywords":["å¾®æœåŠ¡","æœåŠ¡æ²»ç†","Service Mesh","Istio","æµé‡æ§åˆ¶"],"articleBody":"å¼•è¨€ï¼šå¾®æœåŠ¡æ²»ç†çš„æŒ‘æˆ˜ éšç€å¾®æœåŠ¡æ•°é‡çš„å¢é•¿ï¼ŒæœåŠ¡æ²»ç†æˆä¸ºä¸å¯å›é¿çš„é—®é¢˜ã€‚å½“ä¸€ä¸ªç³»ç»Ÿä» 10 ä¸ªæœåŠ¡å¢é•¿åˆ° 100 ä¸ªã€ç”šè‡³ 1000 ä¸ªæœåŠ¡æ—¶ï¼Œä»¥ä¸‹é—®é¢˜ä¼šæ—¥ç›Šå‡¸æ˜¾ï¼š\næœåŠ¡å‘ç°ï¼šå¦‚ä½•åŠ¨æ€æ„ŸçŸ¥æœåŠ¡çš„ä¸Šä¸‹çº¿ï¼Ÿ è´Ÿè½½å‡è¡¡ï¼šå¦‚ä½•å°†æµé‡å‡åŒ€åˆ†é…åˆ°å¥åº·å®ä¾‹ï¼Ÿ æ•…éšœéš”ç¦»ï¼šå¦‚ä½•é˜²æ­¢çº§è”æ•…éšœï¼ˆé›ªå´©æ•ˆåº”ï¼‰ï¼Ÿ æµé‡æ§åˆ¶ï¼šå¦‚ä½•ä¿æŠ¤ç³»ç»Ÿä¸è¢«çªå‘æµé‡æ‰“å®ï¼Ÿ ç°åº¦å‘å¸ƒï¼šå¦‚ä½•å®‰å…¨åœ°å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Ÿ æœ¬æ–‡å°†ç³»ç»Ÿåœ°ä»‹ç»æœåŠ¡æ²»ç†çš„ç†è®ºä¸å®è·µã€‚\nä¸€ã€æœåŠ¡æ³¨å†Œä¸å‘ç° 1.1 æœåŠ¡æ³¨å†Œä¸­å¿ƒé€‰å‹ ç‰¹æ€§ Eureka Consul Nacos Etcd CAP AP CP AP/CP CP ä¸€è‡´æ€§åè®® æœ€ç»ˆä¸€è‡´ Raft Raft/Distro Raft å¥åº·æ£€æŸ¥ å®¢æˆ·ç«¯å¿ƒè·³ TCP/HTTP/gRPC TCP/HTTP/gRPC Lease è´Ÿè½½å‡è¡¡ Ribbon å†…ç½® å†…ç½® éœ€é›†æˆ é€‚ç”¨åœºæ™¯ é€šç”¨ å¼ºä¸€è‡´æ€§ é€šç”¨ Kubernetes 1.2 Nacos æœåŠ¡æ³¨å†Œå®æˆ˜ æœåŠ¡ç«¯é…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # application.yml (Nacos Server) spring: datasource: platform: mysql mode: mysql num: 1 user: root password: password url: jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8 nacos: raft: metadata: port: 8848 å®¢æˆ·ç«¯æ³¨å†Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 import ( \"github.com/nacos-group/nacos-sdk-go/v2/clients\" \"github.com/nacos-group/nacos-sdk-go/v2/common/constant\" \"github.com/nacos-group/nacos-sdk-go/v2/model\" \"github.com/nacos-group/nacos-sdk-go/v2/vo\" ) func NewNamingClient() (naming_client.INamingClient, error) { // æœåŠ¡ç«¯é…ç½® serverConfigs := []constant.ServerConfig{ {IpAddr: \"127.0.0.1\", Port: 8848}, } // å®¢æˆ·ç«¯é…ç½® clientConfig := constant.ClientConfig{ NamespaceId: \"public\", TimeoutMs: 5000, LogLevel: \"info\", } return clients.NewNamingClient( vo.NacosClientParam{ ClientConfig: \u0026clientConfig, ServerConfigs: serverConfigs, }, ) } // æ³¨å†ŒæœåŠ¡å®ä¾‹ func RegisterService(client naming_client.INamingClient, serviceName, ip string, port uint64) error { success, err := client.RegisterInstance(vo.RegisterInstanceParam{ ServiceName: serviceName, Ip: ip, Port: port, Weight: 1, Enable: true, Healthy: true, Ephemeral: true, // ä¸´æ—¶å®ä¾‹ Metadata: map[string]string{ \"version\": \"1.0.0\", \"env\": \"production\", \"preserved_register_source\": \"GO_SDK\", }, }) if !success || err != nil { return fmt.Errorf(\"register failed: %v\", err) } return nil } // å‘é€å¿ƒè·³ func SendHeartbeat(client naming_client.INamingClient, serviceName, ip string, port uint64) { ticker := time.NewTicker(5 * time.Second) defer ticker.Stop() for range ticker.C { client.Beat(\u0026vo.BeatParam{ ServiceName: serviceName, Ip: ip, Port: port, }) } } 1.3 æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 type ServiceDiscovery struct { client naming_client.INamingClient loadBalancer LoadBalancer localCache *sync.Map // æœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘ Nacos å‹åŠ› } func (sd *ServiceDiscovery) SelectOneInstance(serviceName string) (*model.Instance, error) { // 1. å°è¯•ä»æœ¬åœ°ç¼“å­˜è·å– if cached, ok := sd.localCache.Load(serviceName); ok { instances := cached.([]*model.Instance) if len(instances) \u003e 0 { selected := sd.loadBalancer.Select(instances) return selected, nil } } // 2. ä» Nacos è·å–å®ä¾‹åˆ—è¡¨ instances, err := sd.client.SelectInstances(vo.SelectInstancesParam{ ServiceName: serviceName, HealthyOnly: true, }) if err != nil { return nil, err } if len(instances) == 0 { return nil, ErrNoAvailableInstance } // 3. æ›´æ–°æœ¬åœ°ç¼“å­˜ sd.localCache.Store(serviceName, instances) // 4. è´Ÿè½½å‡è¡¡é€‰æ‹© selected := sd.loadBalancer.Select(instances) // 5. å¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼ˆä¸é˜»å¡è¯·æ±‚ï¼‰ go sd.watchInstances(serviceName) return selected, nil } // ç›‘å¬å®ä¾‹å˜åŒ– func (sd *ServiceDiscovery) watchInstances(serviceName string) { sd.client.Subscribe(\u0026vo.SubscribeParam{ ServiceName: serviceName, SubscribeCallback: func(instances []model.Instance) { sd.localCache.Store(serviceName, instances) log.Printf(\"Service %s instances updated: %d\", serviceName, len(instances)) }, }) } 1.4 è´Ÿè½½å‡è¡¡ç®—æ³•å®ç° åŠ æƒéšæœºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 type WeightedRandomBalancer struct{} func (b *WeightedRandomBalancer) Select(instances []*model.Instance) *model.Instance { totalWeight := 0 for _, instance := range instances { totalWeight += int(instance.Weight) } // ç”Ÿæˆéšæœºæ•° [0, totalWeight) rand := rand.Intn(totalWeight) // æ ¹æ®æƒé‡é€‰æ‹©å®ä¾‹ sum := 0 for _, instance := range instances { sum += int(instance.Weight) if rand \u003c sum { return instance } } return instances[0] } æœ€å°è¿æ¥æ•°ï¼š\n```go` type LeastConnBalancer struct { connections sync.Map // instance key -\u003e connection count }\nfunc (b *LeastConnBalancer) Select(instances []*model.Instance) *model.Instance { var selected *model.Instance minConn := int64(math.MaxInt64)\nfor _, instance := range instances { key := fmt.Sprintf(\"%s:%d\", instance.Ip, instance.Port) connCount, _ := b.connections.LoadOrStore(key, \u0026atomic.Int64{}) count := connCount.(*atomic.Int64).Load() if count \u003c minConn { minConn = count selected = instance } } return selected }\nfunc (b *LeastConnBalancer) OnRequest(instance *model.Instance) { key := fmt.Sprintf(\"%s:%d\", instance.Ip, instance.Port) if connCount, ok := b.connections.Load(key); ok { connCount.(*atomic.Int64).Add(1) } }\nfunc (b *LeastConnBalancer) OnResponse(instance *model.Instance) { key := fmt.Sprintf(\"%s:%d\", instance.Ip, instance.Port) if connCount, ok := b.connections.Load(key); ok { connCount.(*atomic.Int64).Add(-1) } }\n## äºŒã€ç†”æ–­ä¸é™çº§ ### 2.1 ç†”æ–­å™¨åŸç† ç†”æ–­å™¨æ¨¡å¼å€Ÿé‰´äºç”µè·¯ç†”æ–­å™¨ï¼Œå½“æ£€æµ‹åˆ°æ•…éšœç‡è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œé¿å…çº§è”æ•…éšœï¼š æ­£å¸¸çŠ¶æ€ï¼ˆClosedï¼‰ â”‚ â”‚ æ•…éšœç‡ \u003e é˜ˆå€¼ â–¼ æ‰“å¼€çŠ¶æ€ï¼ˆOpenï¼‰ â”‚ â”‚ å†·å´æ—¶é—´å â–¼ åŠå¼€çŠ¶æ€ï¼ˆHalf-Openï¼‰ â”‚ â”œâ”€ æˆåŠŸ â†’ Closed â”‚ â””â”€ å¤±è´¥ â†’ Open\n### 2.2 Hystrix-go ç†”æ–­å™¨å®ç° ```go import ( \"github.com/afex/hystrix-go/hystrix\" ) func init() { // é…ç½®ç†”æ–­å™¨ hystrix.ConfigureCommand(\"get_user\", hystrix.CommandConfig{ Timeout: 1000, // è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ MaxConcurrentRequests: 100, // æœ€å¤§å¹¶å‘æ•° ErrorPercentThreshold: 50, // é”™è¯¯ç‡é˜ˆå€¼ SleepWindow: 5000, // ç†”æ–­åç­‰å¾…æ—¶é—´ RequestVolumeThreshold: 20, // æœ€å°è¯·æ±‚æ•°ï¼ˆä½äºæ­¤å€¼ä¸è®¡ç®—é”™è¯¯ç‡ï¼‰ }) // é…ç½®ç†”æ–­åçš„é™çº§å¤„ç† hystrix.InstallFallback(\"get_user\", func(err error) error { // é™çº§é€»è¾‘ï¼šè¿”å›é»˜è®¤å€¼æˆ–ç¼“å­˜ log.Printf(\"Circuit breaker opened: %v\", err) return ErrCircuitBreakerOpen }) } func GetUserWithCircuitBreaker(userID string) (*User, error) { var user *User var err error // ä½¿ç”¨ç†”æ–­å™¨åŒ…è£¹è°ƒç”¨ err = hystrix.DoC(\"get_user\", func(ctx context.Context) error { user, err = getUserFromDB(ctx, userID) return err }, func(err error) error { // é™çº§é€»è¾‘ return hystrix.InstallFallback(\"get_user\", nil)(err) }) return user, err } 2.3 è‡ªé€‚åº”ç†”æ–­å™¨ åŸºäº Google Sre Workshop çš„ç†”æ–­ç®—æ³•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 type AdaptiveCircuitBreaker struct { mu sync.Mutex state State requests []int64 // æ»‘åŠ¨çª—å£å†…çš„è¯·æ±‚æ—¶é—´æˆ³ acceptCount int // æ¥å—çš„è¯·æ±‚æ•° dropCount int // æ‹’ç»çš„è¯·æ±‚æ•° k float64 // å€æ•°ï¼ˆé»˜è®¤ 2.0ï¼‰ } type State int const ( StateClosed State = iota StateOpen ) func (cb *AdaptiveCircuitBreaker) Allow() bool { cb.mu.Lock() defer cb.mu.Unlock() now := time.Now().UnixNano() // æ¸…ç†è¿‡æœŸè¯·æ±‚ï¼ˆä¿ç•™æœ€è¿‘ 10 ç§’ï¼‰ cutoff := now - 10*time.Second.Nanoseconds() cb.requests = filter(cb.requests, func(t int64) bool { return t \u003e cutoff }) // è®¡ç®—æ»‘åŠ¨çª—å£å†…çš„è¯·æ±‚æ•° requestCount := len(cb.requests) dropRatio := float64(cb.dropCount) / float64(requestCount) // è®¡ç®—é˜ˆå€¼ threshold := float64(cb.acceptCount) / cb.k if requestCount \u003e threshold \u0026\u0026 dropRatio \u003e 0.5 { // æ‰“å¼€ç†”æ–­å™¨ cb.state = StateOpen return false } // è®°å½•è¯·æ±‚ cb.requests = append(cb.requests, now) cb.acceptCount++ return true } func (cb *AdaptiveCircuitBreaker) RecordSuccess() { cb.mu.Lock() defer cb.mu.Unlock() cb.acceptCount++ } func (cb *AdaptiveCircuitBreaker) RecordFailure() { cb.mu.Lock() defer cb.mu.Unlock() cb.dropCount++ } ä¸‰ã€é™æµä¸æµé‡æ§åˆ¶ 3.1 é™æµç®—æ³•å¯¹æ¯” ç®—æ³• ä¼˜ç‚¹ ç¼ºç‚¹ é€‚ç”¨åœºæ™¯ å›ºå®šçª—å£ å®ç°ç®€å• è¾¹ç•Œçªå‘ ä¸€èˆ¬é™æµ æ»‘åŠ¨çª—å£ å¹³æ»‘é™æµ å†…å­˜å ç”¨å¤§ ç²¾ç¡®é™æµ æ¼æ¡¶ æ’å®šé€Ÿç‡ æ— æ³•åº”å¯¹çªå‘ æ¶ˆæ¯é˜Ÿåˆ— ä»¤ç‰Œæ¡¶ å…è®¸çªå‘ å‚æ•°è°ƒæ•´å¤æ‚ API é™æµ 3.2 ä»¤ç‰Œæ¡¶å®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 import ( \"golang.org/x/time/rate\" ) type RateLimiter struct { limiters sync.Map // per-key limiter global *rate.Limiter // å…¨å±€é™æµ } func NewRateLimiter(globalRPS int) *RateLimiter { return \u0026RateLimiter{ global: rate.NewLimiter(rate.Limit(globalRPS), globalRPS), } } func (rl *RateLimiter) Allow(key string, rps int) bool { // è·å–æˆ–åˆ›å»ºè¯¥ key çš„é™æµå™¨ limiter, _ := rl.limiters.LoadOrStore(key, rate.NewLimiter(rate.Limit(rps), rps)) return limiter.(*rate.Limiter).Allow() } // ä¸­é—´ä»¶é›†æˆ func RateLimitMiddleware(limiter *RateLimiter) gin.HandlerFunc { return func(c *gin.Context) { // æå–é™æµ keyï¼ˆå¦‚ user_id æˆ– ipï¼‰ key := c.ClientIP() // æ£€æŸ¥æ˜¯å¦å…è®¸ if !limiter.Allow(key, 100) { // 100 RPS c.AbortWithStatusJSON(http.StatusTooManyRequests, gin.H{ \"error\": \"rate limit exceeded\", }) return } c.Next() } } 3.3 åˆ†å¸ƒå¼é™æµï¼ˆåŸºäº Redisï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 type DistributedRateLimiter struct { redis *redis.Client } func (drl *DistributedRateLimiter) Allow(ctx context.Context, key string, limit int, window time.Duration) bool { // ä½¿ç”¨ Redis INCR å®ç°æ»‘åŠ¨çª—å£ now := time.Now().Unix() pipe := drl.redis.Pipeline() // 1. ç§»é™¤çª—å£å¤–çš„è®°å½• pipe.ZRemRangeByScore(ctx, key, \"0\", fmt.Sprintf(\"%d\", now-window.Seconds())) // 2. æ·»åŠ å½“å‰è¯·æ±‚ pipe.ZAdd(ctx, key, redis.Z{Score: float64(now), Member: now}) // 3. ç»Ÿè®¡çª—å£å†…è¯·æ±‚æ•° pipe.ZCard(ctx, key) // 4. è®¾ç½®è¿‡æœŸæ—¶é—´ pipe.Expire(ctx, key, window) results, err := pipe.Exec(ctx) if err != nil { return false } count := results[2].(*redis.IntCmd).Val() return count \u003c= int64(limit) } å››ã€ç°åº¦å‘å¸ƒä¸é‡‘ä¸é›€å‘å¸ƒ 4.1 ç°åº¦å‘å¸ƒç­–ç•¥ v1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% â”‚ â”‚ ç°åº¦ 5% â–¼ v2: â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 5% (ç°åº¦) â”‚ â”‚ ç°åº¦ 50% â–¼ v2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 50% â”‚ â”‚ å…¨é‡å‘å¸ƒ â–¼ v2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% 4.2 åŸºäº Istio çš„ç°åº¦å‘å¸ƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 # VirtualServiceï¼šæµé‡è·¯ç”± apiVersion: networking.istio.io/v1beta1 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - match: - headers: x-user-group: exact: internal route: - destination: host: reviews subset: v2 # å†…éƒ¨ç”¨æˆ·æµé‡åˆ° v2 - route: - destination: host: reviews subset: v1 weight: 90 # 90% æµé‡åˆ° v1 - destination: host: reviews subset: v2 weight: 10 # 10% æµé‡åˆ° v2 --- # DestinationRuleï¼šå®šä¹‰å­é›†ç‰ˆæœ¬ apiVersion: networking.istio.io/v1beta1 kind: DestinationRule metadata: name: reviews spec: host: reviews subsets: - name: v1 labels: version: v1 - name: v2 labels: version: v2 4.3 é‡‘ä¸é›€å‘å¸ƒç›‘æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 type CanaryReleaser struct { metrics MetricsCollector thresholds CanaryThresholds } type CanaryThresholds struct { ErrorRate float64 // é”™è¯¯ç‡é˜ˆå€¼ï¼ˆå¦‚ 1%ï¼‰ LatencyP95 time.Duration // P95 å»¶è¿Ÿé˜ˆå€¼ TrafficPercent int // æµé‡ç™¾åˆ†æ¯” } func (cr *CanaryReleaser) Monitor(serviceName, version string) error { for { metrics := cr.metrics.Get(serviceName, version) // æ£€æŸ¥é”™è¯¯ç‡ if metrics.ErrorRate \u003e cr.thresholds.ErrorRate { log.Printf(\"Canary error rate too high: %.2f%% (threshold: %.2f%%)\", metrics.ErrorRate*100, cr.thresholds.ErrorRate*100) // è‡ªåŠ¨å›æ»š cr.Rollback(serviceName, version) return ErrCanaryFailed } // æ£€æŸ¥å»¶è¿Ÿ if metrics.LatencyP95 \u003e cr.thresholds.LatencyP95 { log.Printf(\"Canary latency too high: %v (threshold: %v)\", metrics.LatencyP95, cr.thresholds.LatencyP95) cr.Rollback(serviceName, version) return ErrCanaryFailed } // æ‰€æœ‰æŒ‡æ ‡æ­£å¸¸ï¼Œå¢åŠ æµé‡ if cr.thresholds.TrafficPercent \u003c 100 { cr.IncreaseTraffic(serviceName, version) } time.Sleep(1 * time.Minute) } } äº”ã€Service Mesh å®æˆ˜ 5.1 Istio æ¶æ„ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Control Plane â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Pilot â”‚ â”‚ Citadel â”‚ â”‚ Galley â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Data Plane â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ Pod (with Envoy Sidecar) â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ App â”‚â—„â”€â”€â”€â”€â–ºâ”‚ Envoy â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ Containerâ”‚ â”‚ Proxy â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 5.2 æµé‡é•œåƒ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 apiVersion: networking.istio.io/v1beta1 kind: VirtualService metadata: name: httpbin spec: hosts: - httpbin http: - route: - destination: host: httpbin subset: v1 mirror: host: httpbin subset: v2 mirrorPercentage: value: 100 # 100% æµé‡é•œåƒåˆ° v2 5.3 æ•…éšœæ³¨å…¥ï¼ˆChaos Engineeringï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 apiVersion: networking.istio.io/v1beta1 kind: VirtualService metadata: name: reviews spec: hosts: - reviews http: - fault: delay: percentage: value: 10 # 10% çš„è¯·æ±‚ fixedDelay: 5s # å»¶è¿Ÿ 5 ç§’ route: - destination: host: reviews subset: v1 - fault: abort: percentage: value: 1 # 1% çš„è¯·æ±‚ httpStatus: 503 # è¿”å› 503 route: - destination: host: reviews subset: v1 å…­ã€ç›‘æ§ä¸å¯è§‚æµ‹æ€§ 6.1 åˆ†å¸ƒå¼è¿½è¸ª 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 import ( \"go.opentelemetry.io/otel\" \"go.opentelemetry.io/otel/exporters/jaeger\" \"go.opentelemetry.io/otel/sdk/resource\" tracesdk \"go.opentelemetry.io/otel/sdk/trace\" semconv \"go.opentelemetry.io/otel/semconv/v1.4.0\" ) func InitTracer(serviceName, jaegerEndpoint string) error { // åˆ›å»º Jaeger exporter exporter, err := jaeger.New(jaeger.WithCollectorEndpoint( jaeger.WithEndpoint(jaegerEndpoint), )) if err != nil { return err } // åˆ›å»º TracerProvider tp := tracesdk.NewTracerProvider( tracesdk.WithBatcher(exporter), tracesdk.WithResource(resource.NewWithAttributes( semconv.ServiceNameKey.String(serviceName), )), ) // æ³¨å†Œä¸ºå…¨å±€ TracerProvider otel.SetTracerProvider(tp) return nil } // ä½¿ç”¨ç¤ºä¾‹ func (s *UserService) GetUser(ctx context.Context, userID string) (*User, error) { ctx, span := otel.Tracer(\"user-service\").Start(ctx, \"GetUser\") defer span.End() span.SetAttributes( attribute.String(\"user.id\", userID), ) // è°ƒç”¨å…¶ä»–æœåŠ¡ user, err := s.dbClient.QueryUser(ctx, userID) if err != nil { span.RecordError(err) return nil, err } return user, nil } ä¸ƒã€æœ€ä½³å®è·µ æœåŠ¡æ³¨å†Œï¼šä½¿ç”¨ Nacos æˆ– Consulï¼Œæ”¯æŒå¥åº·æ£€æŸ¥ è´Ÿè½½å‡è¡¡ï¼šåŠ æƒéšæœº + æœ€å°è¿æ¥æ•° ç†”æ–­é™çº§ï¼šHystrix-go æˆ– Sentinel é™æµï¼šä»¤ç‰Œæ¡¶ç®—æ³• + åˆ†å¸ƒå¼ Redis ç°åº¦å‘å¸ƒï¼šIstio VirtualService + é‡‘ä¸é›€ç›‘æ§ å¯è§‚æµ‹æ€§ï¼šOpenTelemetry + Prometheus + Grafana å¾®æœåŠ¡æ²»ç†æ˜¯ä¸€ä¸ªæŒç»­æ¼”è¿›çš„è¿‡ç¨‹ã€‚ä»å°æ­¥å¿«è·‘å¼€å§‹ï¼Œé€æ­¥å®Œå–„æ²»ç†ä½“ç³»ï¼Œæ‰æ˜¯æ˜æ™ºä¹‹ä¸¾ã€‚\n","wordCount":"1950","inLanguage":"zh-cn","datePublished":"2026-01-05T00:00:00Z","dateModified":"2026-01-05T00:00:00Z","author":{"@type":"Person","name":"æŠ€æœ¯å›¢é˜Ÿ"},"mainEntityOfPage":{"@type":"WebPage","@id":"/blog/articles/%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%AE%9E%E6%88%98%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E5%88%B0%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E7%9A%84%E5%AE%8C%E6%95%B4%E4%BD%93%E7%B3%BB/"},"publisher":{"@type":"Organization","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·","logo":{"@type":"ImageObject","url":"/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=/blog/ accesskey=h title="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· (Alt + H)">æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=/blog/posts/ title="æ‰€æœ‰æ–‡ç« åˆ—è¡¨ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŸ¥çœ‹æ‰€æœ‰æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ–‡ç« </span></a></li><li><a href=https://www.util.cn title="æœ‰æ¡å·¥å…· - å¼€å‘è€…çš„å¸¸ç”¨å·¥å…·é›†åˆï¼šæ— å¹¿å‘Š Â· æœ¬åœ°è®¡ç®— Â· å³å¼€å³ç”¨çš„åœ¨çº¿å·¥å…·å¹³å°ï¼Œæä¾›JSONæ ¼å¼åŒ–ã€SQLæ ¼å¼åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰å®ç”¨å·¥å…·"><span>æœ‰æ¡å·¥å…·</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=/blog/categories/ title="æ–‡ç« åˆ†ç±» - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æŠ€æœ¯é¢†åŸŸåˆ†ç±»çš„ä¼˜è´¨æ–‡ç« ï¼ŒåŒ…æ‹¬å‰ç«¯å¼€å‘ã€å·¥å…·ä½¿ç”¨ã€ç¼–ç¨‹æŠ€å·§ç­‰"><span>åˆ†ç±»</span></a></li><li><a href=/blog/tags/ title="æ ‡ç­¾äº‘ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡æ ‡ç­¾å¿«é€Ÿæ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ ‡ç­¾</span></a></li><li><a href=/blog/archives/ title="æ–‡ç« å½’æ¡£ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æ—¶é—´æŸ¥çœ‹å†å²æ–‡ç« "><span>å½’æ¡£</span></a></li><li><a href=/blog/search/ title="æœç´¢æ–‡ç«  - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡å…³é”®è¯æœç´¢æ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹ï¼Œæ”¯æŒæ ‡é¢˜ã€å†…å®¹ã€åˆ†ç±»å’Œæ ‡ç­¾æœç´¢"><span>æœç´¢</span></a></li></ul></nav></header><main class=main><article class=post-single><div class=post-content-wrapper><main class=post-content-main><header class=post-header-main><h1 class="post-title entry-hint-parent">å¤§è§„æ¨¡å¾®æœåŠ¡ç³»ç»Ÿçš„æœåŠ¡æ²»ç†å®æˆ˜ï¼šä»æœåŠ¡å‘ç°åˆ°æµé‡æ§åˆ¶çš„å®Œæ•´ä½“ç³»</h1><div class=post-description>æ·±å…¥æ¢è®¨å¾®æœåŠ¡æ²»ç†çš„æ ¸å¿ƒç»„ä»¶ï¼šæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­é™çº§ã€é™æµã€ç°åº¦å‘å¸ƒï¼Œä»¥åŠå¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è½åœ° Istio Service Mesh</div><div class=post-meta><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/ class=category-link>æ¶æ„è®¾è®¡</a></div><span class=post-date>2026-01-05</span><span class=post-author>æŠ€æœ¯å›¢é˜Ÿ</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></div></header><div class=post-content><h2 id=å¼•è¨€å¾®æœåŠ¡æ²»ç†çš„æŒ‘æˆ˜>å¼•è¨€ï¼šå¾®æœåŠ¡æ²»ç†çš„æŒ‘æˆ˜<a hidden class=anchor aria-hidden=true href=#å¼•è¨€å¾®æœåŠ¡æ²»ç†çš„æŒ‘æˆ˜>#</a></h2><p>éšç€å¾®æœåŠ¡æ•°é‡çš„å¢é•¿ï¼Œ<strong>æœåŠ¡æ²»ç†</strong>æˆä¸ºä¸å¯å›é¿çš„é—®é¢˜ã€‚å½“ä¸€ä¸ªç³»ç»Ÿä» 10 ä¸ªæœåŠ¡å¢é•¿åˆ° 100 ä¸ªã€ç”šè‡³ 1000 ä¸ªæœåŠ¡æ—¶ï¼Œä»¥ä¸‹é—®é¢˜ä¼šæ—¥ç›Šå‡¸æ˜¾ï¼š</p><ul><li>æœåŠ¡å‘ç°ï¼šå¦‚ä½•åŠ¨æ€æ„ŸçŸ¥æœåŠ¡çš„ä¸Šä¸‹çº¿ï¼Ÿ</li><li>è´Ÿè½½å‡è¡¡ï¼šå¦‚ä½•å°†æµé‡å‡åŒ€åˆ†é…åˆ°å¥åº·å®ä¾‹ï¼Ÿ</li><li>æ•…éšœéš”ç¦»ï¼šå¦‚ä½•é˜²æ­¢çº§è”æ•…éšœï¼ˆé›ªå´©æ•ˆåº”ï¼‰ï¼Ÿ</li><li>æµé‡æ§åˆ¶ï¼šå¦‚ä½•ä¿æŠ¤ç³»ç»Ÿä¸è¢«çªå‘æµé‡æ‰“å®ï¼Ÿ</li><li>ç°åº¦å‘å¸ƒï¼šå¦‚ä½•å®‰å…¨åœ°å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Ÿ</li></ul><p>æœ¬æ–‡å°†ç³»ç»Ÿåœ°ä»‹ç»æœåŠ¡æ²»ç†çš„ç†è®ºä¸å®è·µã€‚</p><h2 id=ä¸€æœåŠ¡æ³¨å†Œä¸å‘ç°>ä¸€ã€æœåŠ¡æ³¨å†Œä¸å‘ç°<a hidden class=anchor aria-hidden=true href=#ä¸€æœåŠ¡æ³¨å†Œä¸å‘ç°>#</a></h2><h3 id=11-æœåŠ¡æ³¨å†Œä¸­å¿ƒé€‰å‹>1.1 æœåŠ¡æ³¨å†Œä¸­å¿ƒé€‰å‹<a hidden class=anchor aria-hidden=true href=#11-æœåŠ¡æ³¨å†Œä¸­å¿ƒé€‰å‹>#</a></h3><table><thead><tr><th>ç‰¹æ€§</th><th>Eureka</th><th>Consul</th><th>Nacos</th><th>Etcd</th></tr></thead><tbody><tr><td>CAP</td><td>AP</td><td>CP</td><td>AP/CP</td><td>CP</td></tr><tr><td>ä¸€è‡´æ€§åè®®</td><td>æœ€ç»ˆä¸€è‡´</td><td>Raft</td><td>Raft/Distro</td><td>Raft</td></tr><tr><td>å¥åº·æ£€æŸ¥</td><td>å®¢æˆ·ç«¯å¿ƒè·³</td><td>TCP/HTTP/gRPC</td><td>TCP/HTTP/gRPC</td><td>Lease</td></tr><tr><td>è´Ÿè½½å‡è¡¡</td><td>Ribbon</td><td>å†…ç½®</td><td>å†…ç½®</td><td>éœ€é›†æˆ</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>é€šç”¨</td><td>å¼ºä¸€è‡´æ€§</td><td>é€šç”¨</td><td>Kubernetes</td></tr></tbody></table><h3 id=12-nacos-æœåŠ¡æ³¨å†Œå®æˆ˜>1.2 Nacos æœåŠ¡æ³¨å†Œå®æˆ˜<a hidden class=anchor aria-hidden=true href=#12-nacos-æœåŠ¡æ³¨å†Œå®æˆ˜>#</a></h3><p><strong>æœåŠ¡ç«¯é…ç½®</strong>ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b949e;font-style:italic># application.yml (Nacos Server)</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spring</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>datasource</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>platform</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>mysql</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>mode</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>mysql</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>num</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>user</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>root</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>password</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>password</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>url</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>nacos</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>raft</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>port</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>8848</span><span style=color:#6e7681>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>å®¢æˆ·ç«¯æ³¨å†Œ</strong>ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;github.com/nacos-group/nacos-sdk-go/v2/clients&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;github.com/nacos-group/nacos-sdk-go/v2/common/constant&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;github.com/nacos-group/nacos-sdk-go/v2/model&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;github.com/nacos-group/nacos-sdk-go/v2/vo&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>NewNamingClient</span>() (naming_client.INamingClient, <span style=color:#ff7b72>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æœåŠ¡ç«¯é…ç½®</span>
</span></span><span style=display:flex><span>    serverConfigs <span style=color:#ff7b72;font-weight:700>:=</span> []constant.ServerConfig{
</span></span><span style=display:flex><span>        {IpAddr: <span style=color:#a5d6ff>&#34;127.0.0.1&#34;</span>, Port: <span style=color:#a5d6ff>8848</span>},
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å®¢æˆ·ç«¯é…ç½®</span>
</span></span><span style=display:flex><span>    clientConfig <span style=color:#ff7b72;font-weight:700>:=</span> constant.ClientConfig{
</span></span><span style=display:flex><span>        NamespaceId: <span style=color:#a5d6ff>&#34;public&#34;</span>,
</span></span><span style=display:flex><span>        TimeoutMs:   <span style=color:#a5d6ff>5000</span>,
</span></span><span style=display:flex><span>        LogLevel:    <span style=color:#a5d6ff>&#34;info&#34;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> clients.<span style=color:#d2a8ff;font-weight:700>NewNamingClient</span>(
</span></span><span style=display:flex><span>        vo.NacosClientParam{
</span></span><span style=display:flex><span>            ClientConfig:  <span style=color:#ff7b72;font-weight:700>&amp;</span>clientConfig,
</span></span><span style=display:flex><span>            ServerConfigs: serverConfigs,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ³¨å†ŒæœåŠ¡å®ä¾‹</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>RegisterService</span>(client naming_client.INamingClient, serviceName, ip <span style=color:#ff7b72>string</span>, port <span style=color:#ff7b72>uint64</span>) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    success, err <span style=color:#ff7b72;font-weight:700>:=</span> client.<span style=color:#d2a8ff;font-weight:700>RegisterInstance</span>(vo.RegisterInstanceParam{
</span></span><span style=display:flex><span>        ServiceName: serviceName,
</span></span><span style=display:flex><span>        Ip:          ip,
</span></span><span style=display:flex><span>        Port:        port,
</span></span><span style=display:flex><span>        Weight:      <span style=color:#a5d6ff>1</span>,
</span></span><span style=display:flex><span>        Enable:      <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        Healthy:     <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>        Ephemeral:   <span style=color:#79c0ff>true</span>,  <span style=color:#8b949e;font-style:italic>// ä¸´æ—¶å®ä¾‹</span>
</span></span><span style=display:flex><span>        Metadata: <span style=color:#ff7b72>map</span>[<span style=color:#ff7b72>string</span>]<span style=color:#ff7b72>string</span>{
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;version&#34;</span>:    <span style=color:#a5d6ff>&#34;1.0.0&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;env&#34;</span>:        <span style=color:#a5d6ff>&#34;production&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#34;preserved_register_source&#34;</span>: <span style=color:#a5d6ff>&#34;GO_SDK&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> !success <span style=color:#ff7b72;font-weight:700>||</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> fmt.<span style=color:#d2a8ff;font-weight:700>Errorf</span>(<span style=color:#a5d6ff>&#34;register failed: %v&#34;</span>, err)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å‘é€å¿ƒè·³</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>SendHeartbeat</span>(client naming_client.INamingClient, serviceName, ip <span style=color:#ff7b72>string</span>, port <span style=color:#ff7b72>uint64</span>) {
</span></span><span style=display:flex><span>    ticker <span style=color:#ff7b72;font-weight:700>:=</span> time.<span style=color:#d2a8ff;font-weight:700>NewTicker</span>(<span style=color:#a5d6ff>5</span> <span style=color:#ff7b72;font-weight:700>*</span> time.Second)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>defer</span> ticker.<span style=color:#d2a8ff;font-weight:700>Stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> <span style=color:#ff7b72>range</span> ticker.C {
</span></span><span style=display:flex><span>        client.<span style=color:#d2a8ff;font-weight:700>Beat</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>vo.BeatParam{
</span></span><span style=display:flex><span>            ServiceName: serviceName,
</span></span><span style=display:flex><span>            Ip:          ip,
</span></span><span style=display:flex><span>            Port:        port,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=13-æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡>1.3 æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡<a hidden class=anchor aria-hidden=true href=#13-æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> ServiceDiscovery <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    client       naming_client.INamingClient
</span></span><span style=display:flex><span>    loadBalancer LoadBalancer
</span></span><span style=display:flex><span>    localCache  <span style=color:#ff7b72;font-weight:700>*</span>sync.Map  <span style=color:#8b949e;font-style:italic>// æœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘ Nacos å‹åŠ›</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (sd <span style=color:#ff7b72;font-weight:700>*</span>ServiceDiscovery) <span style=color:#d2a8ff;font-weight:700>SelectOneInstance</span>(serviceName <span style=color:#ff7b72>string</span>) (<span style=color:#ff7b72;font-weight:700>*</span>model.Instance, <span style=color:#ff7b72>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 1. å°è¯•ä»æœ¬åœ°ç¼“å­˜è·å–</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> cached, ok <span style=color:#ff7b72;font-weight:700>:=</span> sd.localCache.<span style=color:#d2a8ff;font-weight:700>Load</span>(serviceName); ok {
</span></span><span style=display:flex><span>        instances <span style=color:#ff7b72;font-weight:700>:=</span> cached.([]<span style=color:#ff7b72;font-weight:700>*</span>model.Instance)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> len(instances) &gt; <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>            selected <span style=color:#ff7b72;font-weight:700>:=</span> sd.loadBalancer.<span style=color:#d2a8ff;font-weight:700>Select</span>(instances)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> selected, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 2. ä» Nacos è·å–å®ä¾‹åˆ—è¡¨</span>
</span></span><span style=display:flex><span>    instances, err <span style=color:#ff7b72;font-weight:700>:=</span> sd.client.<span style=color:#d2a8ff;font-weight:700>SelectInstances</span>(vo.SelectInstancesParam{
</span></span><span style=display:flex><span>        ServiceName: serviceName,
</span></span><span style=display:flex><span>        HealthyOnly: <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> len(instances) <span style=color:#ff7b72;font-weight:700>==</span> <span style=color:#a5d6ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, ErrNoAvailableInstance
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 3. æ›´æ–°æœ¬åœ°ç¼“å­˜</span>
</span></span><span style=display:flex><span>    sd.localCache.<span style=color:#d2a8ff;font-weight:700>Store</span>(serviceName, instances)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 4. è´Ÿè½½å‡è¡¡é€‰æ‹©</span>
</span></span><span style=display:flex><span>    selected <span style=color:#ff7b72;font-weight:700>:=</span> sd.loadBalancer.<span style=color:#d2a8ff;font-weight:700>Select</span>(instances)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 5. å¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼ˆä¸é˜»å¡è¯·æ±‚ï¼‰</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>go</span> sd.<span style=color:#d2a8ff;font-weight:700>watchInstances</span>(serviceName)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> selected, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç›‘å¬å®ä¾‹å˜åŒ–</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (sd <span style=color:#ff7b72;font-weight:700>*</span>ServiceDiscovery) <span style=color:#d2a8ff;font-weight:700>watchInstances</span>(serviceName <span style=color:#ff7b72>string</span>) {
</span></span><span style=display:flex><span>    sd.client.<span style=color:#d2a8ff;font-weight:700>Subscribe</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>vo.SubscribeParam{
</span></span><span style=display:flex><span>        ServiceName: serviceName,
</span></span><span style=display:flex><span>        SubscribeCallback: <span style=color:#ff7b72>func</span>(instances []model.Instance) {
</span></span><span style=display:flex><span>            sd.localCache.<span style=color:#d2a8ff;font-weight:700>Store</span>(serviceName, instances)
</span></span><span style=display:flex><span>            log.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;Service %s instances updated: %d&#34;</span>, serviceName, len(instances))
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=14-è´Ÿè½½å‡è¡¡ç®—æ³•å®ç°>1.4 è´Ÿè½½å‡è¡¡ç®—æ³•å®ç°<a hidden class=anchor aria-hidden=true href=#14-è´Ÿè½½å‡è¡¡ç®—æ³•å®ç°>#</a></h3><p><strong>åŠ æƒéšæœº</strong>ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> WeightedRandomBalancer <span style=color:#ff7b72>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (b <span style=color:#ff7b72;font-weight:700>*</span>WeightedRandomBalancer) <span style=color:#d2a8ff;font-weight:700>Select</span>(instances []<span style=color:#ff7b72;font-weight:700>*</span>model.Instance) <span style=color:#ff7b72;font-weight:700>*</span>model.Instance {
</span></span><span style=display:flex><span>    totalWeight <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> _, instance <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>range</span> instances {
</span></span><span style=display:flex><span>        totalWeight <span style=color:#ff7b72;font-weight:700>+=</span> int(instance.Weight)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ç”Ÿæˆéšæœºæ•° [0, totalWeight)</span>
</span></span><span style=display:flex><span>    rand <span style=color:#ff7b72;font-weight:700>:=</span> rand.<span style=color:#d2a8ff;font-weight:700>Intn</span>(totalWeight)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ ¹æ®æƒé‡é€‰æ‹©å®ä¾‹</span>
</span></span><span style=display:flex><span>    sum <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> _, instance <span style=color:#ff7b72;font-weight:700>:=</span> <span style=color:#ff7b72>range</span> instances {
</span></span><span style=display:flex><span>        sum <span style=color:#ff7b72;font-weight:700>+=</span> int(instance.Weight)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> rand &lt; sum {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> instance
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> instances[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><strong>æœ€å°è¿æ¥æ•°</strong>ï¼š</p><p>```go`
type LeastConnBalancer struct {
connections sync.Map // instance key -> connection count
}</p><p>func (b *LeastConnBalancer) Select(instances []*model.Instance) *model.Instance {
var selected *model.Instance
minConn := int64(math.MaxInt64)</p><pre><code>for _, instance := range instances {
    key := fmt.Sprintf(&quot;%s:%d&quot;, instance.Ip, instance.Port)
    connCount, _ := b.connections.LoadOrStore(key, &amp;atomic.Int64{})

    count := connCount.(*atomic.Int64).Load()
    if count &lt; minConn {
        minConn = count
        selected = instance
    }
}

return selected
</code></pre><p>}</p><p>func (b *LeastConnBalancer) OnRequest(instance *model.Instance) {
key := fmt.Sprintf("%s:%d", instance.Ip, instance.Port)
if connCount, ok := b.connections.Load(key); ok {
connCount.(*atomic.Int64).Add(1)
}
}</p><p>func (b *LeastConnBalancer) OnResponse(instance *model.Instance) {
key := fmt.Sprintf("%s:%d", instance.Ip, instance.Port)
if connCount, ok := b.connections.Load(key); ok {
connCount.(*atomic.Int64).Add(-1)
}
}</p><pre tabindex=0><code>
## äºŒã€ç†”æ–­ä¸é™çº§

### 2.1 ç†”æ–­å™¨åŸç†

ç†”æ–­å™¨æ¨¡å¼å€Ÿé‰´äºç”µè·¯ç†”æ–­å™¨ï¼Œå½“æ£€æµ‹åˆ°æ•…éšœç‡è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œé¿å…çº§è”æ•…éšœï¼š
</code></pre><p>æ­£å¸¸çŠ¶æ€ï¼ˆClosedï¼‰
â”‚
â”‚ æ•…éšœç‡ > é˜ˆå€¼
â–¼
æ‰“å¼€çŠ¶æ€ï¼ˆOpenï¼‰
â”‚
â”‚ å†·å´æ—¶é—´å
â–¼
åŠå¼€çŠ¶æ€ï¼ˆHalf-Openï¼‰
â”‚
â”œâ”€ æˆåŠŸ â†’ Closed
â”‚
â””â”€ å¤±è´¥ â†’ Open</p><pre tabindex=0><code>
### 2.2 Hystrix-go ç†”æ–­å™¨å®ç°

```go
import (
    &#34;github.com/afex/hystrix-go/hystrix&#34;
)

func init() {
    // é…ç½®ç†”æ–­å™¨
    hystrix.ConfigureCommand(&#34;get_user&#34;, hystrix.CommandConfig{
        Timeout:                1000,  // è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        MaxConcurrentRequests:  100,   // æœ€å¤§å¹¶å‘æ•°
        ErrorPercentThreshold:  50,    // é”™è¯¯ç‡é˜ˆå€¼
        SleepWindow:            5000,  // ç†”æ–­åç­‰å¾…æ—¶é—´
        RequestVolumeThreshold: 20,    // æœ€å°è¯·æ±‚æ•°ï¼ˆä½äºæ­¤å€¼ä¸è®¡ç®—é”™è¯¯ç‡ï¼‰
    })

    // é…ç½®ç†”æ–­åçš„é™çº§å¤„ç†
    hystrix.InstallFallback(&#34;get_user&#34;, func(err error) error {
        // é™çº§é€»è¾‘ï¼šè¿”å›é»˜è®¤å€¼æˆ–ç¼“å­˜
        log.Printf(&#34;Circuit breaker opened: %v&#34;, err)
        return ErrCircuitBreakerOpen
    })
}

func GetUserWithCircuitBreaker(userID string) (*User, error) {
    var user *User
    var err error

    // ä½¿ç”¨ç†”æ–­å™¨åŒ…è£¹è°ƒç”¨
    err = hystrix.DoC(&#34;get_user&#34;, func(ctx context.Context) error {
        user, err = getUserFromDB(ctx, userID)
        return err
    }, func(err error) error {
        // é™çº§é€»è¾‘
        return hystrix.InstallFallback(&#34;get_user&#34;, nil)(err)
    })

    return user, err
}
</code></pre><h3 id=23-è‡ªé€‚åº”ç†”æ–­å™¨>2.3 è‡ªé€‚åº”ç†”æ–­å™¨<a hidden class=anchor aria-hidden=true href=#23-è‡ªé€‚åº”ç†”æ–­å™¨>#</a></h3><p>åŸºäº Google Sre Workshop çš„ç†”æ–­ç®—æ³•ï¼š</p><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> AdaptiveCircuitBreaker <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    mu              sync.Mutex
</span></span><span style=display:flex><span>    state           State
</span></span><span style=display:flex><span>    requests        []<span style=color:#ff7b72>int64</span>  <span style=color:#8b949e;font-style:italic>// æ»‘åŠ¨çª—å£å†…çš„è¯·æ±‚æ—¶é—´æˆ³</span>
</span></span><span style=display:flex><span>    acceptCount     <span style=color:#ff7b72>int</span>      <span style=color:#8b949e;font-style:italic>// æ¥å—çš„è¯·æ±‚æ•°</span>
</span></span><span style=display:flex><span>    dropCount       <span style=color:#ff7b72>int</span>      <span style=color:#8b949e;font-style:italic>// æ‹’ç»çš„è¯·æ±‚æ•°</span>
</span></span><span style=display:flex><span>    k               <span style=color:#ff7b72>float64</span>  <span style=color:#8b949e;font-style:italic>// å€æ•°ï¼ˆé»˜è®¤ 2.0ï¼‰</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> State <span style=color:#ff7b72>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> (
</span></span><span style=display:flex><span>    StateClosed State = <span style=color:#79c0ff>iota</span>
</span></span><span style=display:flex><span>    StateOpen
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (cb <span style=color:#ff7b72;font-weight:700>*</span>AdaptiveCircuitBreaker) <span style=color:#d2a8ff;font-weight:700>Allow</span>() <span style=color:#ff7b72>bool</span> {
</span></span><span style=display:flex><span>    cb.mu.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>defer</span> cb.mu.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    now <span style=color:#ff7b72;font-weight:700>:=</span> time.<span style=color:#d2a8ff;font-weight:700>Now</span>().<span style=color:#d2a8ff;font-weight:700>UnixNano</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ¸…ç†è¿‡æœŸè¯·æ±‚ï¼ˆä¿ç•™æœ€è¿‘ 10 ç§’ï¼‰</span>
</span></span><span style=display:flex><span>    cutoff <span style=color:#ff7b72;font-weight:700>:=</span> now <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#a5d6ff>10</span><span style=color:#ff7b72;font-weight:700>*</span>time.Second.<span style=color:#d2a8ff;font-weight:700>Nanoseconds</span>()
</span></span><span style=display:flex><span>    cb.requests = <span style=color:#d2a8ff;font-weight:700>filter</span>(cb.requests, <span style=color:#ff7b72>func</span>(t <span style=color:#ff7b72>int64</span>) <span style=color:#ff7b72>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> t &gt; cutoff
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è®¡ç®—æ»‘åŠ¨çª—å£å†…çš„è¯·æ±‚æ•°</span>
</span></span><span style=display:flex><span>    requestCount <span style=color:#ff7b72;font-weight:700>:=</span> len(cb.requests)
</span></span><span style=display:flex><span>    dropRatio <span style=color:#ff7b72;font-weight:700>:=</span> float64(cb.dropCount) <span style=color:#ff7b72;font-weight:700>/</span> float64(requestCount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è®¡ç®—é˜ˆå€¼</span>
</span></span><span style=display:flex><span>    threshold <span style=color:#ff7b72;font-weight:700>:=</span> float64(cb.acceptCount) <span style=color:#ff7b72;font-weight:700>/</span> cb.k
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> requestCount &gt; threshold <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> dropRatio &gt; <span style=color:#a5d6ff>0.5</span> {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ‰“å¼€ç†”æ–­å™¨</span>
</span></span><span style=display:flex><span>        cb.state = StateOpen
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è®°å½•è¯·æ±‚</span>
</span></span><span style=display:flex><span>    cb.requests = append(cb.requests, now)
</span></span><span style=display:flex><span>    cb.acceptCount<span style=color:#ff7b72;font-weight:700>++</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (cb <span style=color:#ff7b72;font-weight:700>*</span>AdaptiveCircuitBreaker) <span style=color:#d2a8ff;font-weight:700>RecordSuccess</span>() {
</span></span><span style=display:flex><span>    cb.mu.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>defer</span> cb.mu.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span>    cb.acceptCount<span style=color:#ff7b72;font-weight:700>++</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (cb <span style=color:#ff7b72;font-weight:700>*</span>AdaptiveCircuitBreaker) <span style=color:#d2a8ff;font-weight:700>RecordFailure</span>() {
</span></span><span style=display:flex><span>    cb.mu.<span style=color:#d2a8ff;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>defer</span> cb.mu.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span>    cb.dropCount<span style=color:#ff7b72;font-weight:700>++</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=ä¸‰é™æµä¸æµé‡æ§åˆ¶>ä¸‰ã€é™æµä¸æµé‡æ§åˆ¶<a hidden class=anchor aria-hidden=true href=#ä¸‰é™æµä¸æµé‡æ§åˆ¶>#</a></h2><h3 id=31-é™æµç®—æ³•å¯¹æ¯”>3.1 é™æµç®—æ³•å¯¹æ¯”<a hidden class=anchor aria-hidden=true href=#31-é™æµç®—æ³•å¯¹æ¯”>#</a></h3><table><thead><tr><th>ç®—æ³•</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>å›ºå®šçª—å£</td><td>å®ç°ç®€å•</td><td>è¾¹ç•Œçªå‘</td><td>ä¸€èˆ¬é™æµ</td></tr><tr><td>æ»‘åŠ¨çª—å£</td><td>å¹³æ»‘é™æµ</td><td>å†…å­˜å ç”¨å¤§</td><td>ç²¾ç¡®é™æµ</td></tr><tr><td>æ¼æ¡¶</td><td>æ’å®šé€Ÿç‡</td><td>æ— æ³•åº”å¯¹çªå‘</td><td>æ¶ˆæ¯é˜Ÿåˆ—</td></tr><tr><td>ä»¤ç‰Œæ¡¶</td><td>å…è®¸çªå‘</td><td>å‚æ•°è°ƒæ•´å¤æ‚</td><td>API é™æµ</td></tr></tbody></table><h3 id=32-ä»¤ç‰Œæ¡¶å®ç°>3.2 ä»¤ç‰Œæ¡¶å®ç°<a hidden class=anchor aria-hidden=true href=#32-ä»¤ç‰Œæ¡¶å®ç°>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;golang.org/x/time/rate&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> RateLimiter <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    limiters sync.Map  <span style=color:#8b949e;font-style:italic>// per-key limiter</span>
</span></span><span style=display:flex><span>    global   <span style=color:#ff7b72;font-weight:700>*</span>rate.Limiter  <span style=color:#8b949e;font-style:italic>// å…¨å±€é™æµ</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>NewRateLimiter</span>(globalRPS <span style=color:#ff7b72>int</span>) <span style=color:#ff7b72;font-weight:700>*</span>RateLimiter {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>&amp;</span>RateLimiter{
</span></span><span style=display:flex><span>        global: rate.<span style=color:#d2a8ff;font-weight:700>NewLimiter</span>(rate.<span style=color:#d2a8ff;font-weight:700>Limit</span>(globalRPS), globalRPS),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (rl <span style=color:#ff7b72;font-weight:700>*</span>RateLimiter) <span style=color:#d2a8ff;font-weight:700>Allow</span>(key <span style=color:#ff7b72>string</span>, rps <span style=color:#ff7b72>int</span>) <span style=color:#ff7b72>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è·å–æˆ–åˆ›å»ºè¯¥ key çš„é™æµå™¨</span>
</span></span><span style=display:flex><span>    limiter, _ <span style=color:#ff7b72;font-weight:700>:=</span> rl.limiters.<span style=color:#d2a8ff;font-weight:700>LoadOrStore</span>(key, rate.<span style=color:#d2a8ff;font-weight:700>NewLimiter</span>(rate.<span style=color:#d2a8ff;font-weight:700>Limit</span>(rps), rps))
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> limiter.(<span style=color:#ff7b72;font-weight:700>*</span>rate.Limiter).<span style=color:#d2a8ff;font-weight:700>Allow</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä¸­é—´ä»¶é›†æˆ</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>RateLimitMiddleware</span>(limiter <span style=color:#ff7b72;font-weight:700>*</span>RateLimiter) gin.HandlerFunc {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>func</span>(c <span style=color:#ff7b72;font-weight:700>*</span>gin.Context) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æå–é™æµ keyï¼ˆå¦‚ user_id æˆ– ipï¼‰</span>
</span></span><span style=display:flex><span>        key <span style=color:#ff7b72;font-weight:700>:=</span> c.<span style=color:#d2a8ff;font-weight:700>ClientIP</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥æ˜¯å¦å…è®¸</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> !limiter.<span style=color:#d2a8ff;font-weight:700>Allow</span>(key, <span style=color:#a5d6ff>100</span>) {  <span style=color:#8b949e;font-style:italic>// 100 RPS</span>
</span></span><span style=display:flex><span>            c.<span style=color:#d2a8ff;font-weight:700>AbortWithStatusJSON</span>(http.StatusTooManyRequests, gin.H{
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#34;error&#34;</span>: <span style=color:#a5d6ff>&#34;rate limit exceeded&#34;</span>,
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        c.<span style=color:#d2a8ff;font-weight:700>Next</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=33-åˆ†å¸ƒå¼é™æµåŸºäº-redis>3.3 åˆ†å¸ƒå¼é™æµï¼ˆåŸºäº Redisï¼‰<a hidden class=anchor aria-hidden=true href=#33-åˆ†å¸ƒå¼é™æµåŸºäº-redis>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> DistributedRateLimiter <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    redis <span style=color:#ff7b72;font-weight:700>*</span>redis.Client
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (drl <span style=color:#ff7b72;font-weight:700>*</span>DistributedRateLimiter) <span style=color:#d2a8ff;font-weight:700>Allow</span>(ctx context.Context, key <span style=color:#ff7b72>string</span>, limit <span style=color:#ff7b72>int</span>, window time.Duration) <span style=color:#ff7b72>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ Redis INCR å®ç°æ»‘åŠ¨çª—å£</span>
</span></span><span style=display:flex><span>    now <span style=color:#ff7b72;font-weight:700>:=</span> time.<span style=color:#d2a8ff;font-weight:700>Now</span>().<span style=color:#d2a8ff;font-weight:700>Unix</span>()
</span></span><span style=display:flex><span>    pipe <span style=color:#ff7b72;font-weight:700>:=</span> drl.redis.<span style=color:#d2a8ff;font-weight:700>Pipeline</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 1. ç§»é™¤çª—å£å¤–çš„è®°å½•</span>
</span></span><span style=display:flex><span>    pipe.<span style=color:#d2a8ff;font-weight:700>ZRemRangeByScore</span>(ctx, key, <span style=color:#a5d6ff>&#34;0&#34;</span>, fmt.<span style=color:#d2a8ff;font-weight:700>Sprintf</span>(<span style=color:#a5d6ff>&#34;%d&#34;</span>, now<span style=color:#ff7b72;font-weight:700>-</span>window.<span style=color:#d2a8ff;font-weight:700>Seconds</span>()))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 2. æ·»åŠ å½“å‰è¯·æ±‚</span>
</span></span><span style=display:flex><span>    pipe.<span style=color:#d2a8ff;font-weight:700>ZAdd</span>(ctx, key, redis.Z{Score: float64(now), Member: now})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 3. ç»Ÿè®¡çª—å£å†…è¯·æ±‚æ•°</span>
</span></span><span style=display:flex><span>    pipe.<span style=color:#d2a8ff;font-weight:700>ZCard</span>(ctx, key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// 4. è®¾ç½®è¿‡æœŸæ—¶é—´</span>
</span></span><span style=display:flex><span>    pipe.<span style=color:#d2a8ff;font-weight:700>Expire</span>(ctx, key, window)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    results, err <span style=color:#ff7b72;font-weight:700>:=</span> pipe.<span style=color:#d2a8ff;font-weight:700>Exec</span>(ctx)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    count <span style=color:#ff7b72;font-weight:700>:=</span> results[<span style=color:#a5d6ff>2</span>].(<span style=color:#ff7b72;font-weight:700>*</span>redis.IntCmd).<span style=color:#d2a8ff;font-weight:700>Val</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> count <span style=color:#ff7b72;font-weight:700>&lt;=</span> int64(limit)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=å››ç°åº¦å‘å¸ƒä¸é‡‘ä¸é›€å‘å¸ƒ>å››ã€ç°åº¦å‘å¸ƒä¸é‡‘ä¸é›€å‘å¸ƒ<a hidden class=anchor aria-hidden=true href=#å››ç°åº¦å‘å¸ƒä¸é‡‘ä¸é›€å‘å¸ƒ>#</a></h2><h3 id=41-ç°åº¦å‘å¸ƒç­–ç•¥>4.1 ç°åº¦å‘å¸ƒç­–ç•¥<a hidden class=anchor aria-hidden=true href=#41-ç°åº¦å‘å¸ƒç­–ç•¥>#</a></h3><pre tabindex=0><code>v1:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
      â”‚
      â”‚ ç°åº¦ 5%
      â–¼
v2:  â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  5% (ç°åº¦)
      â”‚
      â”‚ ç°åº¦ 50%
      â–¼
v2:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  50%
      â”‚
      â”‚ å…¨é‡å‘å¸ƒ
      â–¼
v2:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
</code></pre><h3 id=42-åŸºäº-istio-çš„ç°åº¦å‘å¸ƒ>4.2 åŸºäº Istio çš„ç°åº¦å‘å¸ƒ<a hidden class=anchor aria-hidden=true href=#42-åŸºäº-istio-çš„ç°åº¦å‘å¸ƒ>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b949e;font-style:italic># VirtualServiceï¼šæµé‡è·¯ç”±</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>networking.istio.io/v1beta1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>VirtualService</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>reviews</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>hosts</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#a5d6ff>reviews</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>http</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>match</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>headers</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>x-user-group</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>exact</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>internal</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>route</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>destination</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>host</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>reviews</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>subset</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v2 </span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic># å†…éƒ¨ç”¨æˆ·æµé‡åˆ° v2</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>route</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>destination</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>host</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>reviews</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>subset</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>weight</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>90</span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic># 90% æµé‡åˆ° v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>destination</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>host</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>reviews</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>subset</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v2</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>weight</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>10</span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic># 10% æµé‡åˆ° v2</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>---</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic># DestinationRuleï¼šå®šä¹‰å­é›†ç‰ˆæœ¬</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>networking.istio.io/v1beta1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>DestinationRule</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>reviews</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>host</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>reviews</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>subsets</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>version</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v2</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>labels</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>version</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v2</span><span style=color:#6e7681>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=43-é‡‘ä¸é›€å‘å¸ƒç›‘æ§>4.3 é‡‘ä¸é›€å‘å¸ƒç›‘æ§<a hidden class=anchor aria-hidden=true href=#43-é‡‘ä¸é›€å‘å¸ƒç›‘æ§>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>type</span> CanaryReleaser <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    metrics       MetricsCollector
</span></span><span style=display:flex><span>    thresholds    CanaryThresholds
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>type</span> CanaryThresholds <span style=color:#ff7b72>struct</span> {
</span></span><span style=display:flex><span>    ErrorRate      <span style=color:#ff7b72>float64</span>  <span style=color:#8b949e;font-style:italic>// é”™è¯¯ç‡é˜ˆå€¼ï¼ˆå¦‚ 1%ï¼‰</span>
</span></span><span style=display:flex><span>    LatencyP95     time.Duration  <span style=color:#8b949e;font-style:italic>// P95 å»¶è¿Ÿé˜ˆå€¼</span>
</span></span><span style=display:flex><span>    TrafficPercent <span style=color:#ff7b72>int</span>      <span style=color:#8b949e;font-style:italic>// æµé‡ç™¾åˆ†æ¯”</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (cr <span style=color:#ff7b72;font-weight:700>*</span>CanaryReleaser) <span style=color:#d2a8ff;font-weight:700>Monitor</span>(serviceName, version <span style=color:#ff7b72>string</span>) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> {
</span></span><span style=display:flex><span>        metrics <span style=color:#ff7b72;font-weight:700>:=</span> cr.metrics.<span style=color:#d2a8ff;font-weight:700>Get</span>(serviceName, version)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥é”™è¯¯ç‡</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> metrics.ErrorRate &gt; cr.thresholds.ErrorRate {
</span></span><span style=display:flex><span>            log.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;Canary error rate too high: %.2f%% (threshold: %.2f%%)&#34;</span>,
</span></span><span style=display:flex><span>                metrics.ErrorRate<span style=color:#ff7b72;font-weight:700>*</span><span style=color:#a5d6ff>100</span>, cr.thresholds.ErrorRate<span style=color:#ff7b72;font-weight:700>*</span><span style=color:#a5d6ff>100</span>)
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// è‡ªåŠ¨å›æ»š</span>
</span></span><span style=display:flex><span>            cr.<span style=color:#d2a8ff;font-weight:700>Rollback</span>(serviceName, version)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> ErrCanaryFailed
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥å»¶è¿Ÿ</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> metrics.LatencyP95 &gt; cr.thresholds.LatencyP95 {
</span></span><span style=display:flex><span>            log.<span style=color:#d2a8ff;font-weight:700>Printf</span>(<span style=color:#a5d6ff>&#34;Canary latency too high: %v (threshold: %v)&#34;</span>,
</span></span><span style=display:flex><span>                metrics.LatencyP95, cr.thresholds.LatencyP95)
</span></span><span style=display:flex><span>            cr.<span style=color:#d2a8ff;font-weight:700>Rollback</span>(serviceName, version)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> ErrCanaryFailed
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ‰€æœ‰æŒ‡æ ‡æ­£å¸¸ï¼Œå¢åŠ æµé‡</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> cr.thresholds.TrafficPercent &lt; <span style=color:#a5d6ff>100</span> {
</span></span><span style=display:flex><span>            cr.<span style=color:#d2a8ff;font-weight:700>IncreaseTraffic</span>(serviceName, version)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        time.<span style=color:#d2a8ff;font-weight:700>Sleep</span>(<span style=color:#a5d6ff>1</span> <span style=color:#ff7b72;font-weight:700>*</span> time.Minute)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=äº”service-mesh-å®æˆ˜>äº”ã€Service Mesh å®æˆ˜<a hidden class=anchor aria-hidden=true href=#äº”service-mesh-å®æˆ˜>#</a></h2><h3 id=51-istio-æ¶æ„>5.1 Istio æ¶æ„<a hidden class=anchor aria-hidden=true href=#51-istio-æ¶æ„>#</a></h3><pre tabindex=0><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Control Plane              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Pilot   â”‚  â”‚ Citadel  â”‚  â”‚ Galley    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Data Plane                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      Pod (with Envoy Sidecar)       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ App      â”‚â—„â”€â”€â”€â”€â–ºâ”‚ Envoy      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ Containerâ”‚      â”‚ Proxy      â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><h3 id=52-æµé‡é•œåƒ>5.2 æµé‡é•œåƒ<a hidden class=anchor aria-hidden=true href=#52-æµé‡é•œåƒ>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>networking.istio.io/v1beta1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>VirtualService</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>httpbin</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>hosts</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#a5d6ff>httpbin</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>http</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>route</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>destination</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>host</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>httpbin</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>subset</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>mirror</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>host</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>httpbin</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>subset</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v2</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>mirrorPercentage</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>100</span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic># 100% æµé‡é•œåƒåˆ° v2</span><span style=color:#6e7681>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=53-æ•…éšœæ³¨å…¥chaos-engineering>5.3 æ•…éšœæ³¨å…¥ï¼ˆChaos Engineeringï¼‰<a hidden class=anchor aria-hidden=true href=#53-æ•…éšœæ³¨å…¥chaos-engineering>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#7ee787>apiVersion</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>networking.istio.io/v1beta1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>kind</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>VirtualService</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>metadata</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>name</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>reviews</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#7ee787>spec</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>hosts</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#a5d6ff>reviews</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#7ee787>http</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>fault</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>delay</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>percentage</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>10</span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic># 10% çš„è¯·æ±‚</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>fixedDelay</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>5s </span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic># å»¶è¿Ÿ 5 ç§’</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>route</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>destination</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>host</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>reviews</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>subset</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>- <span style=color:#7ee787>fault</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#7ee787>abort</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>percentage</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>          </span><span style=color:#7ee787>value</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>1</span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic># 1% çš„è¯·æ±‚</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>httpStatus</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>503</span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic># è¿”å› 503</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#7ee787>route</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>- <span style=color:#7ee787>destination</span>:<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>host</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>reviews</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#7ee787>subset</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>v1</span><span style=color:#6e7681>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=å…­ç›‘æ§ä¸å¯è§‚æµ‹æ€§>å…­ã€ç›‘æ§ä¸å¯è§‚æµ‹æ€§<a hidden class=anchor aria-hidden=true href=#å…­ç›‘æ§ä¸å¯è§‚æµ‹æ€§>#</a></h2><h3 id=61-åˆ†å¸ƒå¼è¿½è¸ª>6.1 åˆ†å¸ƒå¼è¿½è¸ª<a hidden class=anchor aria-hidden=true href=#61-åˆ†å¸ƒå¼è¿½è¸ª>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff7b72>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;go.opentelemetry.io/otel&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;go.opentelemetry.io/otel/exporters/jaeger&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;go.opentelemetry.io/otel/sdk/resource&#34;</span>
</span></span><span style=display:flex><span>    tracesdk <span style=color:#a5d6ff>&#34;go.opentelemetry.io/otel/sdk/trace&#34;</span>
</span></span><span style=display:flex><span>    semconv <span style=color:#a5d6ff>&#34;go.opentelemetry.io/otel/semconv/v1.4.0&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> <span style=color:#d2a8ff;font-weight:700>InitTracer</span>(serviceName, jaegerEndpoint <span style=color:#ff7b72>string</span>) <span style=color:#ff7b72>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åˆ›å»º Jaeger exporter</span>
</span></span><span style=display:flex><span>    exporter, err <span style=color:#ff7b72;font-weight:700>:=</span> jaeger.<span style=color:#d2a8ff;font-weight:700>New</span>(jaeger.<span style=color:#d2a8ff;font-weight:700>WithCollectorEndpoint</span>(
</span></span><span style=display:flex><span>        jaeger.<span style=color:#d2a8ff;font-weight:700>WithEndpoint</span>(jaegerEndpoint),
</span></span><span style=display:flex><span>    ))
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åˆ›å»º TracerProvider</span>
</span></span><span style=display:flex><span>    tp <span style=color:#ff7b72;font-weight:700>:=</span> tracesdk.<span style=color:#d2a8ff;font-weight:700>NewTracerProvider</span>(
</span></span><span style=display:flex><span>        tracesdk.<span style=color:#d2a8ff;font-weight:700>WithBatcher</span>(exporter),
</span></span><span style=display:flex><span>        tracesdk.<span style=color:#d2a8ff;font-weight:700>WithResource</span>(resource.<span style=color:#d2a8ff;font-weight:700>NewWithAttributes</span>(
</span></span><span style=display:flex><span>            semconv.ServiceNameKey.<span style=color:#d2a8ff;font-weight:700>String</span>(serviceName),
</span></span><span style=display:flex><span>        )),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ³¨å†Œä¸ºå…¨å±€ TracerProvider</span>
</span></span><span style=display:flex><span>    otel.<span style=color:#d2a8ff;font-weight:700>SetTracerProvider</span>(tp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ç¤ºä¾‹</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>func</span> (s <span style=color:#ff7b72;font-weight:700>*</span>UserService) <span style=color:#d2a8ff;font-weight:700>GetUser</span>(ctx context.Context, userID <span style=color:#ff7b72>string</span>) (<span style=color:#ff7b72;font-weight:700>*</span>User, <span style=color:#ff7b72>error</span>) {
</span></span><span style=display:flex><span>    ctx, span <span style=color:#ff7b72;font-weight:700>:=</span> otel.<span style=color:#d2a8ff;font-weight:700>Tracer</span>(<span style=color:#a5d6ff>&#34;user-service&#34;</span>).<span style=color:#d2a8ff;font-weight:700>Start</span>(ctx, <span style=color:#a5d6ff>&#34;GetUser&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>defer</span> span.<span style=color:#d2a8ff;font-weight:700>End</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    span.<span style=color:#d2a8ff;font-weight:700>SetAttributes</span>(
</span></span><span style=display:flex><span>        attribute.<span style=color:#d2a8ff;font-weight:700>String</span>(<span style=color:#a5d6ff>&#34;user.id&#34;</span>, userID),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è°ƒç”¨å…¶ä»–æœåŠ¡</span>
</span></span><span style=display:flex><span>    user, err <span style=color:#ff7b72;font-weight:700>:=</span> s.dbClient.<span style=color:#d2a8ff;font-weight:700>QueryUser</span>(ctx, userID)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> err <span style=color:#ff7b72;font-weight:700>!=</span> <span style=color:#79c0ff>nil</span> {
</span></span><span style=display:flex><span>        span.<span style=color:#d2a8ff;font-weight:700>RecordError</span>(err)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>nil</span>, err
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> user, <span style=color:#79c0ff>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=ä¸ƒæœ€ä½³å®è·µ>ä¸ƒã€æœ€ä½³å®è·µ<a hidden class=anchor aria-hidden=true href=#ä¸ƒæœ€ä½³å®è·µ>#</a></h2><ol><li><strong>æœåŠ¡æ³¨å†Œ</strong>ï¼šä½¿ç”¨ Nacos æˆ– Consulï¼Œæ”¯æŒå¥åº·æ£€æŸ¥</li><li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šåŠ æƒéšæœº + æœ€å°è¿æ¥æ•°</li><li><strong>ç†”æ–­é™çº§</strong>ï¼šHystrix-go æˆ– Sentinel</li><li><strong>é™æµ</strong>ï¼šä»¤ç‰Œæ¡¶ç®—æ³• + åˆ†å¸ƒå¼ Redis</li><li><strong>ç°åº¦å‘å¸ƒ</strong>ï¼šIstio VirtualService + é‡‘ä¸é›€ç›‘æ§</li><li><strong>å¯è§‚æµ‹æ€§</strong>ï¼šOpenTelemetry + Prometheus + Grafana</li></ol><hr><blockquote><p>å¾®æœåŠ¡æ²»ç†æ˜¯ä¸€ä¸ªæŒç»­æ¼”è¿›çš„è¿‡ç¨‹ã€‚ä»å°æ­¥å¿«è·‘å¼€å§‹ï¼Œé€æ­¥å®Œå–„æ²»ç†ä½“ç³»ï¼Œæ‰æ˜¯æ˜æ™ºä¹‹ä¸¾ã€‚</p></blockquote></div><footer class=post-footer-modern><div class=post-tags-modern><span class=tags-label>ğŸ·ï¸ æ ‡ç­¾</span><div class=tags-list><a href=/blog/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/ class=tag-pill>å¾®æœåŠ¡
</a><a href=/blog/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/ class=tag-pill>æœåŠ¡æ²»ç†
</a><a href=/blog/tags/service-mesh/ class=tag-pill>Service Mesh
</a><a href=/blog/tags/istio/ class=tag-pill>Istio
</a><a href=/blog/tags/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/ class=tag-pill>æµé‡æ§åˆ¶</a></div></div><style>.post-footer-modern{margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border,#333333)}.post-tags-modern{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}.tags-label{font-size:.875rem;font-weight:600;color:var(--secondary,#999999) !important;white-space:nowrap}.tags-list{display:flex;flex-wrap:wrap;gap:.5rem;flex:1}.tag-pill{display:inline-block;padding:.25rem .75rem;background:rgba(255,255,255,5%);border:1px solid var(--border,#333333);border-radius:0;color:var(--secondary,#cccccc) !important;text-decoration:none;font-size:.8rem;font-weight:500;transition:all .2s ease}.tag-pill:hover{background:var(--primary,#ffffff);color:var(--background,#000000) !important;border-color:var(--primary,#ffffff);transform:translateY(-1px)}.post-nav-modern{margin-top:2rem}.nav-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.nav-card{display:flex;align-items:center;gap:1rem;padding:1.25rem;background:rgba(255,255,255,2%);border:1px solid var(--border,#333333);border-radius:12px;text-decoration:none;transition:all .2s ease;min-height:80px}.nav-card:hover{background:rgba(255,255,255,5%);border-color:var(--primary,#ffffff);transform:translateY(-2px)}.nav-card.nav-prev{justify-content:flex-start}.nav-card.nav-next{justify-content:flex-end;text-align:right}.nav-card.nav-next .nav-content{text-align:right}.nav-empty{display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,1%);border:1px dashed var(--border,#333333);color:var(--secondary,#666666)}.nav-arrow{font-size:1.5rem;color:var(--primary,#ffffff);font-weight:300}.nav-content{flex:1}.nav-title{font-size:.95rem;font-weight:600;color:var(--primary,#ffffff) !important;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}[data-theme=light] .post-footer-modern{border-color:var(--border-light,#dee2e6)}[data-theme=light] .tags-label{color:var(--secondary-light,#6c757d) !important}[data-theme=light] .tag-pill{background:rgba(0,0,0,5%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#495057) !important}[data-theme=light] .tag-pill:hover{background:var(--primary-light,#0066cc);color:var(--background-light,#ffffff) !important;border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-card{background:rgba(0,0,0,2%);border-color:var(--border-light,#dee2e6)}[data-theme=light] .nav-card:hover{background:rgba(0,102,204,5%);border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-empty{background:rgba(0,0,0,1%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#6c757d)}[data-theme=light] .nav-arrow{color:var(--primary-light,#0066cc)}[data-theme=light] .nav-title{color:var(--primary-light,#212529) !important}@media(max-width:768px){.nav-grid{grid-template-columns:1fr;gap:.75rem}.nav-card{padding:1rem;min-height:70px}.nav-card.nav-next{text-align:left}.nav-card.nav-next .nav-content{text-align:left}.nav-title{font-size:.875rem}.post-tags-modern{flex-direction:column;gap:.75rem}}@media(max-width:480px){.nav-arrow{font-size:1.25rem}.nav-card{padding:.875rem}.nav-title{font-size:.8rem;-webkit-line-clamp:1}}</style><nav class=post-nav-modern><div class=nav-grid><a href=/blog/articles/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%80%E8%87%B4%E6%80%A7%E4%BF%9D%E9%9A%9C%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E8%90%BD%E5%9C%B0%E7%9A%84%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/ class="nav-card nav-prev"><div class=nav-arrow>â†</div><div class=nav-content><div class=nav-title>åˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§ä¿éšœæ–¹æ¡ˆè®¾è®¡ï¼šä»ç†è®ºåˆ°è½åœ°çš„å®Œæ•´æŒ‡å—</div></div></a><a href=/blog/articles/go%E8%AF%AD%E8%A8%80%E9%AB%98%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E8%90%BD%E5%9C%B0%E7%9A%84%E5%AE%8C%E6%95%B4%E6%8C%87%E5%8D%97/ class="nav-card nav-next"><div class=nav-content><div class=nav-title>Goè¯­è¨€é«˜å¹¶å‘æœåŠ¡æ€§èƒ½ä¼˜åŒ–å®æˆ˜ï¼šä»ç†è®ºåˆ°è½åœ°çš„å®Œæ•´æŒ‡å—</div></div><div class=nav-arrow>â†’</div></a></div></nav></footer></main><aside class=post-sidebar><div class=sidebar-toc id=sidebar-toc><div class=toc-header><div class=toc-title>ç›®å½•</div><button class=toc-toggle id=toc-toggle aria-label="Toggle TOC">
<svg class="toc-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div class=toc-content id=toc-content><ul class=toc-list><li class="toc-item toc-h2"><a href=#h2-0 class=toc-item-link><span class=toc-item-text>å¼•è¨€ï¼šå¾®æœåŠ¡æ²»ç†çš„æŒ‘æˆ˜</span></a></li><li class="toc-item toc-h2"><a href=#h2-1 class=toc-item-link><span class=toc-item-text>ä¸€ã€æœåŠ¡æ³¨å†Œä¸å‘ç°</span></a></li><li class="toc-item toc-h2"><a href=#h2-2 class=toc-item-link><span class=toc-item-text>ä¸‰ã€é™æµä¸æµé‡æ§åˆ¶</span></a></li><li class="toc-item toc-h2"><a href=#h2-3 class=toc-item-link><span class=toc-item-text>å››ã€ç°åº¦å‘å¸ƒä¸é‡‘ä¸é›€å‘å¸ƒ</span></a></li><li class="toc-item toc-h2"><a href=#h2-4 class=toc-item-link><span class=toc-item-text>äº”ã€Service Mesh å®æˆ˜</span></a></li><li class="toc-item toc-h2"><a href=#h2-5 class=toc-item-link><span class=toc-item-text>å…­ã€ç›‘æ§ä¸å¯è§‚æµ‹æ€§</span></a></li><li class="toc-item toc-h2"><a href=#h2-6 class=toc-item-link><span class=toc-item-text>ä¸ƒã€æœ€ä½³å®è·µ</span></a></li></ul></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("sidebar-toc"),t=document.getElementById("toc-toggle"),o=document.getElementById("toc-content"),i=t?.querySelector(".toc-toggle-icon");if(!e)return;let n=!1;t&&t.addEventListener("click",function(){n=!n,n?(o.style.display="none",e.style.width="auto",i.innerHTML='<path d="M9 18l6-6-6-6"/>'):(o.style.display="block",e.style.width="200px",i.innerHTML='<path d="M18 6L6 18M6 6l12 12"/>')});const s=document.querySelector(".post-content");if(s){const e=s.querySelectorAll("h1");e.forEach((e,t)=>{e.id=`h1-${t}`});const t=s.querySelectorAll("h2");t.forEach((e,t)=>{e.id=`h2-${t}`})}const a=document.querySelectorAll(".toc-item-link");a.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const n=this.getAttribute("href").substring(1),t=document.getElementById(n);if(t){const e=document.querySelector(".post-header-main")?.offsetHeight||0,n=t.offsetTop-e-20;window.scrollTo({top:n,behavior:"smooth"})}})})})</script><style>.sidebar-toc{position:sticky;top:2rem;width:200px;background:#fff;border:1px solid #e5e7eb;border-radius:4px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);z-index:100}.sidebar-toc.hidden{display:none}.toc-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fafbfc;display:flex;align-items:center;justify-content:space-between}.toc-title{margin:0;font-size:13px;font-weight:500;color:#374151 !important;font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,sans-serif;text-transform:uppercase;letter-spacing:1px}.toc-toggle{background:0 0;border:none;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .2s ease;color:#6b7280}.toc-toggle:hover{background:#e5e7eb;color:#374151}.toc-toggle-icon{transition:transform .2s ease}.toc-content{padding:12px 0}.toc-list{list-style:none;margin:0;padding:0}.toc-item{margin-bottom:4px;display:block !important;visibility:visible !important}.toc-h1,.toc-h2{display:block !important}.toc-h2{margin-left:0}.toc-item-link{display:flex;align-items:center;gap:8px;padding:8px 12px;color:#374151 !important;text-decoration:none;font-size:13px;line-height:1.4;border-radius:3px;transition:all .2s ease;font-weight:400}.toc-item-link:hover{background:#f8fafc;color:#1f2937 !important}.toc-item-link.active{background:#e0f2fe;color:#01579b !important;font-weight:500}.toc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.dot-red{background:#ef4444}.dot-blue{background:#2196f3}.toc-item-text{color:#1f2937 !important;font-weight:400;flex:1;display:inline !important;visibility:visible !important;opacity:1 !important;font-size:13px !important;line-height:1.4 !important}.toc-item-link .toc-item-text{color:#1f2937 !important;display:inline !important;visibility:visible !important;opacity:1 !important}.toc-item.active .dot-red{background:#d32f2f}.toc-item.active .dot-blue{background:#1976d2}[data-theme=dark] .sidebar-toc{background:#1f2937;border-color:#374151;box-shadow:0 1px 3px rgba(0,0,0,.3)}[data-theme=dark] .toc-header{background:#111827;border-color:#374151}[data-theme=dark] .toc-title{color:#f3f4f6 !important}[data-theme=dark] .toc-toggle{color:#9ca3af}[data-theme=dark] .toc-toggle:hover{background:#374151;color:#f3f4f6}[data-theme=dark] .toc-item-link{color:#e5e7eb !important}[data-theme=dark] .toc-item-link:hover{background:#374151;color:#f9fafb !important}[data-theme=dark] .toc-item-link.active{background:#0d47a1;color:#fff !important}[data-theme=dark] .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}[data-theme=dark] .toc-item-link .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}@media(max-width:1024px){.sidebar-toc{display:none}.post-content-wrapper{grid-template-columns:1fr !important;padding:0 1rem !important}}</style><style>.post-content-wrapper{display:grid;grid-template-columns:1fr 200px;gap:2rem;padding:0 2rem;max-width:100%}.post-content-main{min-width:0}.post-sidebar{position:sticky;top:2rem;height:fit-content;min-width:0}.post-header-main{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border,#333333)}.post-header-main .post-title{color:var(--primary,#ffffff) !important;font-size:2.5rem;font-weight:700;line-height:1.2;margin-bottom:1rem}.post-header-main .post-description{color:var(--secondary,#cccccc) !important;font-size:1.1rem;line-height:1.6;margin-bottom:1rem}.post-header-main .post-meta{margin-bottom:0}@media(max-width:1024px){.post-content-wrapper{grid-template-columns:1fr !important;gap:1rem;padding:0 1rem !important}.post-sidebar{display:none}}@media(max-width:768px){.post-header-main .post-title{font-size:2rem}.post-header-main .post-description{font-size:1rem}}</style></aside></div></article></main><footer class=footer><span>Â© 2024-2025 æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢</span> Â·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>