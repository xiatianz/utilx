<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { StickyNote, Save, Download2, Trash2, Plus, Search } from 'lucide-vue-next'

// SEOé…ç½®
useHead({
  title: 'å¿«é€Ÿç¬”è®°å·¥å…· - åœ¨çº¿Markdownç¬”è®° | è‡ªåŠ¨ä¿å­˜æœ¬åœ°å­˜å‚¨',
  meta: [
    {
      name: 'description',
      content: 'å…è´¹åœ¨çº¿å¿«é€Ÿç¬”è®°å·¥å…·ï¼Œæ”¯æŒMarkdownç¼–è¾‘ã€æœ¬åœ°å­˜å‚¨ã€è‡ªåŠ¨ä¿å­˜ï¼Œå¯å¿«é€Ÿè®°å½•æƒ³æ³•ã€å¾…åŠäº‹é¡¹å’Œå­¦ä¹ ç¬”è®°ã€‚'
    },
    {
      name: 'keywords',
      content: 'åœ¨çº¿ç¬”è®°,Markdownç¬”è®°,å¿«é€Ÿè®°å½•,åœ¨çº¿ç¼–è¾‘å™¨,æœ¬åœ°ç¬”è®°,ç¬”è®°å·¥å…·,è‡ªåŠ¨ä¿å­˜'
    }
  ]
)

const notes = ref([])
const activeNoteId = ref(null)
const searchQuery = ref('')

// å½“å‰æ¿€æ´»çš„ç¬”è®°
const activeNote = computed(() => {
  return notes.value.find(n => n.id === activeNoteId.value)
})

// è¿‡æ»¤åçš„ç¬”è®°
const filteredNotes = computed(() => {
  if (!searchQuery.value) return notes.value
  const query = searchQuery.value.toLowerCase()
  return notes.value.filter(n =>
    n.title.toLowerCase().includes(query) ||
    n.content.toLowerCase().includes(query)
  )
})

// åˆ›å»ºæ–°ç¬”è®°
const createNote = () => {
  const newNote = {
    id: Date.now(),
    title: 'æ–°ç¬”è®°',
    content: '',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  }
  notes.value.unshift(newNote)
  activeNoteId.value = newNote.id
  saveToStorage()
}

// åˆ é™¤ç¬”è®°
const deleteNote = (noteId) => {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) {
    notes.value = notes.value.filter(n => n.id !== noteId)
    if (activeNoteId.value === noteId) {
      activeNoteId.value = notes.value[0]?.id || null
    }
    saveToStorage()
  }
}

// æ›´æ–°ç¬”è®°
const updateNote = (field, value) => {
  if (!activeNote.value) return
  activeNote.value[field] = value
  activeNote.value.updatedAt = new Date().toISOString()
  saveToStorage()
}

// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
const saveToStorage = () => {
  localStorage.setItem('quick-notes', JSON.stringify(notes.value))
}

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½
const loadFromStorage = () => {
  const saved = localStorage.getItem('quick-notes')
  if (saved) {
    try {
      notes.value = JSON.parse(saved)
      if (notes.value.length > 0) {
        activeNoteId.value = notes.value[0].id
      }
    } catch (e) {
      console.error('åŠ è½½å¤±è´¥', e)
    }
  } else {
    // é¦–æ¬¡ä½¿ç”¨ï¼Œåˆ›å»ºæ¬¢è¿ç¬”è®°
    createNote()
    if (activeNote.value) {
      activeNote.value.title = 'æ¬¢è¿ä½¿ç”¨å¿«é€Ÿç¬”è®° ğŸ“'
      activeNote.value.content = `# æ¬¢è¿ä½¿ç”¨å¿«é€Ÿç¬”è®°

è¿™æ˜¯ä¸€ä¸ªè½»é‡çº§çš„åœ¨çº¿ç¬”è®°å·¥å…·ï¼Œæ”¯æŒ **Markdown** è¯­æ³•ã€‚

## åŠŸèƒ½ç‰¹ç‚¹

- âœ… è‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°
- âœ… æ”¯æŒ Markdown è¯­æ³•
- âœ… å¿«é€Ÿæœç´¢ç¬”è®°
- âœ… å¯¼å‡ºä¸º Markdown æ–‡ä»¶

## Markdown ç¤ºä¾‹

### æ–‡æœ¬æ ¼å¼

**ç²—ä½“** å’Œ *æ–œä½“*ï¼Œè¿˜æœ‰ ~~åˆ é™¤çº¿~~

### åˆ—è¡¨

- æ— åºåˆ—è¡¨é¡¹ 1
- æ— åºåˆ—è¡¨é¡¹ 2
  - åµŒå¥—é¡¹

1. æœ‰åºåˆ—è¡¨é¡¹ 1
2. æœ‰åºåˆ—è¡¨é¡¹ 2

### ä»£ç 

\`\`\`javascript
function hello() {
  console.log('Hello, World!');
}
\`\`\`

### å¼•ç”¨

> è¿™æ˜¯ä¸€æ®µå¼•ç”¨æ–‡æœ¬

### é“¾æ¥

[è®¿é—® GitHub](https://github.com)

---

å¼€å§‹è®°å½•ä½ çš„æƒ³æ³•å§ï¼ ğŸš€`
    }
  }
}

// å¯¼å‡ºå½“å‰ç¬”è®°
const exportNote = () => {
  if (!activeNote.value) return

  const content = `# ${activeNote.value.title}\n\n${activeNote.value.content}`
  const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' })
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = `${activeNote.value.title}.md`
  link.click()
  URL.revokeObjectURL(url)
}

// å¯¼å‡ºæ‰€æœ‰ç¬”è®°
const exportAllNotes = () => {
  const content = notes.value.map(note =>
    `# ${note.title}\n\nåˆ›å»ºæ—¶é—´: ${new Date(note.createdAt).toLocaleString('zh-CN')}\n\n${note.content}\n\n---\n\n`
  ).join('')

  const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' })
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = `æ‰€æœ‰ç¬”è®°_${new Date().toLocaleDateString('zh-CN')}.md`
  link.click()
  URL.revokeObjectURL(url)
}

// è·å–é¢„è§ˆHTML
const previewHtml = computed(() => {
  if (!activeNote.value) return ''

  let html = activeNote.value.content
    // æ ‡é¢˜
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    // ç²—ä½“æ–œä½“
    .replace(/\*\*\*(.*?)\*\*\*/gim, '<strong>$1</strong>')
    .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/gim, '<em>$1</em>')
    .replace(/~~(.*?)~~/gim, '<del>$1</del>')
    // ä»£ç 
    .replace(/```(\w+)?\n([\s\S]*?)```/gim, '<pre><code>$2</code></pre>')
    .replace(/`([^`]+)`/gim, '<code>$1</code>')
    // å¼•ç”¨
    .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
    // åˆ—è¡¨
    .replace(/^\d+\. (.*$)/gim, '<ol><li>$1</li></ol>')
    .replace(/^- (.*$)/gim, '<ul><li>$1</li></ul>')
    // é“¾æ¥
    .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" target="_blank">$1</a>')
    // æ¢è¡Œ
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, '<br>')

  return `<div class="prose prose-sm max-w-none">${html}</div>`
})

onMounted(() => {
  loadFromStorage()
})
</script>

<template>
  <div class="min-h-screen bg-gradient-to-br from-yellow-50 via-white to-orange-50 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
      <!-- æ ‡é¢˜ -->
      <div class="text-center mb-6">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-2">
          <StickyNote :size="36" />
          å¿«é€Ÿç¬”è®°å·¥å…·
        </h1>
        <p class="text-gray-600">è½»é‡çº§åœ¨çº¿ç¬”è®°ï¼Œæ”¯æŒ Markdown</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- å·¦ä¾§ï¼šç¬”è®°åˆ—è¡¨ -->
        <div class="lg:col-span-1 space-y-4">
          <!-- æœç´¢å’Œæ–°å»º -->
          <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex gap-2 mb-3">
              <div class="relative flex-1">
                <Search class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" :size="18" />
                <input
                  v-model="searchQuery"
                  type="text"
                  class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
                  placeholder="æœç´¢ç¬”è®°..."
                />
              </div>
            </div>
            <button
              @click="createNote"
              class="w-full px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition flex items-center justify-center gap-2"
            >
              <Plus :size="18" />
              æ–°å»ºç¬”è®°
            </button>
          </div>

          <!-- ç¬”è®°åˆ—è¡¨ -->
          <div class="bg-white rounded-xl shadow-lg p-4">
            <h3 class="font-semibold text-gray-800 mb-3">
              ç¬”è®°åˆ—è¡¨ ({{ filteredNotes.length }})
            </h3>
            <div class="space-y-2 max-h-[500px] overflow-y-auto">
              <div
                v-for="note in filteredNotes"
                :key="note.id"
                @click="activeNoteId = note.id"
                :class="[
                  'p-3 rounded-lg cursor-pointer transition',
                  activeNoteId === note.id
                    ? 'bg-yellow-100 border-2 border-yellow-400'
                    : 'bg-gray-50 hover:bg-gray-100 border-2 border-transparent'
                ]"
              >
                <div class="flex items-start justify-between mb-1">
                  <div class="font-medium text-gray-800 truncate flex-1">
                    {{ note.title || 'æ— æ ‡é¢˜' }}
                  </div>
                  <button
                    @click.stop="deleteNote(note.id)"
                    class="text-red-500 hover:text-red-700 ml-2 flex-shrink-0"
                  >
                    <Trash2 :size="16" />
                  </button>
                </div>
                <div class="text-xs text-gray-500">
                  {{ new Date(note.updatedAt).toLocaleString('zh-CN') }}
                </div>
                <div class="text-sm text-gray-600 truncate mt-1">
                  {{ note.content.substring(0, 50) || 'ç©ºç¬”è®°' }}...
                </div>
              </div>

              <!-- ç©ºçŠ¶æ€ -->
              <div
                v-if="filteredNotes.length === 0"
                class="text-center py-8 text-gray-400"
              >
                <div class="text-4xl mb-2">ğŸ“</div>
                <div>æš‚æ— ç¬”è®°</div>
              </div>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šç¼–è¾‘å™¨å’Œé¢„è§ˆ -->
        <div class="lg:col-span-3 space-y-4">
          <div v-if="activeNote" class="bg-white rounded-xl shadow-lg p-6">
            <!-- æ ‡é¢˜è¾“å…¥ -->
            <div class="mb-4">
              <input
                :value="activeNote.title"
                @input="updateNote('title', $event.target.value)"
                type="text"
                class="w-full px-4 py-2 text-xl font-semibold border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
                placeholder="ç¬”è®°æ ‡é¢˜"
              />
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="flex gap-2 mb-4">
              <button
                @click="exportNote"
                class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition flex items-center gap-1 text-sm"
              >
                <Download2 :size="16" />
                å¯¼å‡ºå½“å‰
              </button>
              <button
                @click="exportAllNotes"
                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm"
              >
                å¯¼å‡ºå…¨éƒ¨
              </button>
              <div class="flex-1"></div>
              <span class="text-sm text-gray-500 flex items-center gap-1">
                <Save :size="16" />
                è‡ªåŠ¨ä¿å­˜
              </span>
            </div>

            <!-- ç¼–è¾‘æ¨¡å¼å’Œé¢„è§ˆæ¨¡å¼åˆ‡æ¢ -->
            <div class="mb-4">
              <div class="flex gap-2">
                <button
                  @click="activeNote.previewMode = false"
                  :class="[
                    'px-4 py-2 rounded-lg transition',
                    !activeNote.previewMode ? 'bg-yellow-500 text-white' : 'bg-gray-100'
                  ]"
                >
                  ç¼–è¾‘
                </button>
                <button
                  @click="activeNote.previewMode = true"
                  :class="[
                    'px-4 py-2 rounded-lg transition',
                    activeNote.previewMode ? 'bg-yellow-500 text-white' : 'bg-gray-100'
                  ]"
                >
                  é¢„è§ˆ
                </button>
              </div>
            </div>

            <!-- ç¼–è¾‘å™¨ -->
            <div v-if="!activeNote.previewMode" class="relative">
              <textarea
                :value="activeNote.content"
                @input="updateNote('content', $event.target.value)"
                class="w-full h-[500px] px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent font-mono text-sm resize-none"
                placeholder="å¼€å§‹è¾“å…¥å†…å®¹ï¼Œæ”¯æŒ Markdown è¯­æ³•..."
              ></textarea>
              <div class="absolute bottom-3 right-3 text-xs text-gray-400">
                {{ activeNote.content.length }} å­—ç¬¦
              </div>
            </div>

            <!-- é¢„è§ˆ -->
            <div v-else class="h-[500px] px-4 py-3 border border-gray-300 rounded-xl overflow-y-auto bg-gray-50">
              <div class="markdown-preview prose prose-sm max-w-none" v-html="previewHtml"></div>
            </div>
          </div>

          <!-- æ— ç¬”è®°çŠ¶æ€ -->
          <div
            v-else
            class="bg-white rounded-xl shadow-lg p-12 text-center"
          >
            <div class="text-6xl mb-4">ğŸ“</div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">è¿˜æ²¡æœ‰ç¬”è®°</h3>
            <p class="text-gray-600 mb-4">ç‚¹å‡»"æ–°å»ºç¬”è®°"å¼€å§‹è®°å½•</p>
            <button
              @click="createNote"
              class="px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition inline-flex items-center gap-2"
            >
              <Plus :size="20" />
              æ–°å»ºç¬”è®°
            </button>
          </div>
        </div>
      </div>

      <!-- Markdown å¿«æ·é”®æç¤º -->
      <div class="mt-6 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-3">âŒ¨ï¸ Markdown è¯­æ³•æç¤º</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-700">
          <div>
            <code class="bg-gray-200 px-2 py-1 rounded">**ç²—ä½“**</code>
            <span class="ml-2">ç²—ä½“</span>
          </div>
          <div>
            <code class="bg-gray-200 px-2 py-1 rounded">*æ–œä½“*</code>
            <span class="ml-2">æ–œä½“</span>
          </div>
          <div>
            <code class="bg-gray-200 px-2 py-1 rounded"># æ ‡é¢˜</code>
            <span class="ml-2">æ ‡é¢˜</span>
          </div>
          <div>
            <code class="bg-gray-200 px-2 py-1 rounded">- åˆ—è¡¨</code>
            <span class="ml-2">åˆ—è¡¨</span>
          </div>
          <div>
            <code class="bg-gray-200 px-2 py-1 rounded">`ä»£ç `</code>
            <span class="ml-2">è¡Œå†…ä»£ç </span>
          </div>
          <div>
            <code class="bg-gray-200 px-2 py-1 rounded">```ä»£ç å—```</code>
            <span class="ml-2">ä»£ç å—</span>
          </div>
          <div>
            <code class="bg-gray-200 px-2 py-1 rounded">> å¼•ç”¨</code>
            <span class="ml-2">å¼•ç”¨</span>
          </div>
          <div>
            <code class="bg-gray-200 px-2 py-1 rounded">[é“¾æ¥](url)</code>
            <span class="ml-2">é“¾æ¥</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style>
.markdown-preview h1 {
  font-size: 2em;
  font-weight: bold;
  margin: 0.67em 0;
  border-bottom: 1px solid #eee;
  padding-bottom: 0.3em;
}

.markdown-preview h2 {
  font-size: 1.5em;
  font-weight: bold;
  margin: 0.83em 0;
  border-bottom: 1px solid #eee;
  padding-bottom: 0.3em;
}

.markdown-preview h3 {
  font-size: 1.17em;
  font-weight: bold;
  margin: 1em 0;
}

.markdown-preview p {
  margin: 1em 0;
}

.markdown-preview ul, .markdown-preview ol {
  margin: 1em 0;
  padding-left: 2em;
}

.markdown-preview blockquote {
  border-left: 4px solid #ddd;
  padding-left: 1em;
  color: #666;
  margin: 1em 0;
}

.markdown-preview code {
  background: #f4f4f4;
  padding: 0.2em 0.4em;
  border-radius: 3px;
  font-size: 0.9em;
}

.markdown-preview pre {
  background: #f4f4f4;
  padding: 1em;
  border-radius: 5px;
  overflow-x: auto;
  margin: 1em 0;
}

.markdown-preview pre code {
  background: none;
  padding: 0;
}

.markdown-preview a {
  color: #0366d6;
  text-decoration: none;
}

.markdown-preview a:hover {
  text-decoration: underline;
}
</style>
