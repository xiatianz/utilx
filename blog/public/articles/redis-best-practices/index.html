<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Redisæœ€ä½³å®è·µæŒ‡å—ï¼šé«˜æ€§èƒ½å†…å­˜æ•°æ®åº“å®æˆ˜æŠ€å·§ | æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</title><meta name=keywords content="Redis,ç¼“å­˜,æ•°æ®åº“,æ€§èƒ½ä¼˜åŒ–,åˆ†å¸ƒå¼"><meta name=description content="æ·±å…¥æ¢è®¨Redisçš„ä½¿ç”¨æœ€ä½³å®è·µï¼ŒåŒ…æ‹¬æ•°æ®ç»“æ„é€‰æ‹©ã€æ€§èƒ½ä¼˜åŒ–ã€é›†ç¾¤é…ç½®ã€æŒä¹…åŒ–ç­–ç•¥ç­‰ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºé«˜å¯ç”¨çš„Redisåº”ç”¨ã€‚"><meta name=author content="æœ‰æ¡å·¥å…·å›¢é˜Ÿ"><link rel=canonical href=/blog/articles/redis-best-practices/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.7e8505b7cdf8bb22ab2305e53c2700bb06c7e64faeb72cd3468823a9a3bd3d6e.css integrity="sha256-foUFt834uyKrIwXlPCcAuwbH5k+utyzTRogjqaO9PW4=" rel="preload stylesheet" as=style><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=apple-touch-icon href=/blog/apple-touch-icon.png><link rel=mask-icon href=/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=/blog/articles/redis-best-practices/feed.xml title=rss><link rel=alternate hreflang=zh-cn href=/blog/articles/redis-best-practices/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=/js/external-link-config.js></script><script src=/js/external-link-interceptor.js></script><link rel=stylesheet href=/blog/css/custom.css media=screen><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«","url":"https://www.util.cn/blog/","description":"æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚","publisher":{"@type":"Organization","name":"æœ‰æ¡å·¥å…·","url":"https://www.util.cn","logo":{"@type":"ImageObject","url":"https://www.util.cn/blog/logo/logo-256.png","width":256,"height":256}},"potentialAction":[{"@type":"SearchAction","target":"https://www.util.cn/blog/search?q={search_term_string}","query-input":"required name=search_term_string"}]}</script><meta property="og:type" content="website"><meta property="og:title" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta property="og:description" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚"><meta property="og:url" content="https://www.util.cn/blog/"><meta property="og:site_name" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢"><meta property="og:image" content="https://www.util.cn/blog/logo/logo-256.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta name=twitter:description content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚"><meta name=twitter:image content="https://www.util.cn/blog/logo/logo-256.png"><meta name=baidu-site-verification content><meta name=category content="æŠ€æœ¯åšå®¢,å¼€å‘è€…å·¥å…·,ç¼–ç¨‹æ•™ç¨‹"><meta name=coverage content="Worldwide"><meta name=distribution content="Global"><meta name=rating content="General"><script id=51la_code async crossorigin=anonymous src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=pro"></script><script>window.addEventListener("load",function(){setTimeout(function(){typeof la!="undefined"?console.log("51laç»Ÿè®¡å·²åŠ è½½"):(console.warn("51laç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"),function(){var e=document.createElement("script");e.src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=backup",e.async=!0,document.head.appendChild(e)}())},3e3)})</script><meta property="og:url" content="/blog/articles/redis-best-practices/"><meta property="og:site_name" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·"><meta property="og:title" content="Redisæœ€ä½³å®è·µæŒ‡å—ï¼šé«˜æ€§èƒ½å†…å­˜æ•°æ®åº“å®æˆ˜æŠ€å·§"><meta property="og:description" content="æ·±å…¥æ¢è®¨Redisçš„ä½¿ç”¨æœ€ä½³å®è·µï¼ŒåŒ…æ‹¬æ•°æ®ç»“æ„é€‰æ‹©ã€æ€§èƒ½ä¼˜åŒ–ã€é›†ç¾¤é…ç½®ã€æŒä¹…åŒ–ç­–ç•¥ç­‰ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºé«˜å¯ç”¨çš„Redisåº”ç”¨ã€‚"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-16T00:00:00+00:00"><meta property="article:modified_time" content="2025-12-16T00:00:00+00:00"><meta property="article:tag" content="Redis"><meta property="article:tag" content="ç¼“å­˜"><meta property="article:tag" content="æ•°æ®åº“"><meta property="article:tag" content="æ€§èƒ½ä¼˜åŒ–"><meta property="article:tag" content="åˆ†å¸ƒå¼"><meta name=twitter:card content="summary"><meta name=twitter:title content="Redisæœ€ä½³å®è·µæŒ‡å—ï¼šé«˜æ€§èƒ½å†…å­˜æ•°æ®åº“å®æˆ˜æŠ€å·§"><meta name=twitter:description content="æ·±å…¥æ¢è®¨Redisçš„ä½¿ç”¨æœ€ä½³å®è·µï¼ŒåŒ…æ‹¬æ•°æ®ç»“æ„é€‰æ‹©ã€æ€§èƒ½ä¼˜åŒ–ã€é›†ç¾¤é…ç½®ã€æŒä¹…åŒ–ç­–ç•¥ç­‰ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºé«˜å¯ç”¨çš„Redisåº”ç”¨ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"æ‰€æœ‰æ–‡ç« ","item":"/blog/posts/"},{"@type":"ListItem","position":2,"name":"Redisæœ€ä½³å®è·µæŒ‡å—ï¼šé«˜æ€§èƒ½å†…å­˜æ•°æ®åº“å®æˆ˜æŠ€å·§","item":"/blog/articles/redis-best-practices/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Redisæœ€ä½³å®è·µæŒ‡å—ï¼šé«˜æ€§èƒ½å†…å­˜æ•°æ®åº“å®æˆ˜æŠ€å·§","name":"Redisæœ€ä½³å®è·µæŒ‡å—ï¼šé«˜æ€§èƒ½å†…å­˜æ•°æ®åº“å®æˆ˜æŠ€å·§","description":"æ·±å…¥æ¢è®¨Redisçš„ä½¿ç”¨æœ€ä½³å®è·µï¼ŒåŒ…æ‹¬æ•°æ®ç»“æ„é€‰æ‹©ã€æ€§èƒ½ä¼˜åŒ–ã€é›†ç¾¤é…ç½®ã€æŒä¹…åŒ–ç­–ç•¥ç­‰ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºé«˜å¯ç”¨çš„Redisåº”ç”¨ã€‚","keywords":["Redis","ç¼“å­˜","æ•°æ®åº“","æ€§èƒ½ä¼˜åŒ–","åˆ†å¸ƒå¼"],"articleBody":"Redisä½œä¸ºé«˜æ€§èƒ½çš„å†…å­˜æ•°æ®åº“ï¼Œåœ¨ç°ä»£åº”ç”¨æ¶æ„ä¸­æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚æœ¬æ–‡å°†å…¨é¢ä»‹ç»Redisçš„æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ æ„å»ºç¨³å®šã€é«˜æ•ˆçš„Redisåº”ç”¨ã€‚\n1. RedisåŸºç¡€é…ç½® å†…å­˜ä¼˜åŒ–é…ç½® # redis.conf # è®¾ç½®æœ€å¤§å†…å­˜é™åˆ¶ maxmemory 2gb # å†…å­˜æ·˜æ±°ç­–ç•¥ # volatile-lru: åœ¨è®¾ç½®äº†TTLçš„keyä¸­ï¼Œæ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„key # allkeys-lru: åœ¨æ‰€æœ‰keyä¸­ï¼Œæ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„key # volatile-random: åœ¨è®¾ç½®äº†TTLçš„keyä¸­ï¼Œéšæœºæ·˜æ±°key # allkeys-random: åœ¨æ‰€æœ‰keyä¸­ï¼Œéšæœºæ·˜æ±°key # volatile-ttl: æ·˜æ±°å³å°†è¿‡æœŸçš„key # noeviction: ä¸æ·˜æ±°keyï¼Œå†…å­˜ä¸è¶³æ—¶è¿”å›é”™è¯¯ maxmemory-policy allkeys-lru # å¯ç”¨AOFæŒä¹…åŒ– appendonly yes appendfsync everysec # RDBå¿«ç…§é…ç½® save 900 1 # 15åˆ†é’Ÿå†…æœ‰1ä¸ªkeyæ”¹å˜å°±ä¿å­˜ save 300 10 # 5åˆ†é’Ÿå†…æœ‰10ä¸ªkeyæ”¹å˜å°±ä¿å­˜ save 60 10000 # 1åˆ†é’Ÿå†…æœ‰10000ä¸ªkeyæ”¹å˜å°±ä¿å­˜ # å‹ç¼©RDBæ–‡ä»¶ rdbcompression yes rdbchecksum yes ç½‘ç»œå’Œå®‰å…¨é…ç½® # ç½‘ç»œé…ç½® bind 127.0.0.1 192.168.1.100 port 6379 timeout 300 tcp-keepalive 300 # å®‰å…¨é…ç½® requirepass your-strong-password-here # æˆ–ä½¿ç”¨ACL (Redis 6.0+) aclfile /etc/redis/users.acl # ç¦ç”¨å±é™©å‘½ä»¤ rename-command FLUSHDB \"\" rename-command FLUSHALL \"\" rename-command KEYS \"\" rename-command CONFIG \"CONFIG_b835c3f8a5d6e7f2e8c1d9a0b4c5f6e\" rename-command SHUTDOWN SHUTDOWN_b835c3f8a5d6e7f2e8c1d9a0b4c5f6e rename-command DEBUG DEBUG_b835c3f8a5d6e7f2e8c1d9a0b4c5f6e # å®¢æˆ·ç«¯è¿æ¥é™åˆ¶ maxclients 10000 2. æ•°æ®ç»“æ„é€‰æ‹©ç­–ç•¥ Stringç±»å‹ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 // åŸå­è®¡æ•°å™¨ const incrementCounter = async (key, increment = 1) =\u003e { return await redis.incrBy(key, increment); }; // è®¾ç½®å¸¦TTLçš„ç¼“å­˜ const setCacheWithTTL = async (key, value, ttl = 3600) =\u003e { await redis.setex(key, ttl, JSON.stringify(value)); }; // æ‰¹é‡è·å– const mGetCached = async (keys) =\u003e { const values = await redis.mget(keys); return values.map(value =\u003e value ? JSON.parse(value) : null); }; // ä½¿ç”¨Hashä»£æ›¿å¤šä¸ªStringï¼ˆå½“å­—æ®µè¾ƒå¤šæ—¶ï¼‰ const userInfo = { name: 'John Doe', email: 'john@example.com', age: 30, city: 'New York' }; // âŒ ä¸æ¨èï¼šå¤šä¸ªStringé”® await redis.mset([ 'user:1:name', userInfo.name, 'user:1:email', userInfo.email, 'user:1:age', userInfo.age, 'user:1:city', userInfo.city ]); // âœ… æ¨èï¼šå•ä¸ªHash await redis.hset('user:1', userInfo); Hashç±»å‹ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // ç”¨æˆ·ä¿¡æ¯å­˜å‚¨ const setUserProfile = async (userId, profile) =\u003e { const hashKey = `user:${userId}:profile`; await redis.hset(hashKey, { name: profile.name, email: profile.email, bio: profile.bio, lastUpdate: Date.now() }); // è®¾ç½®è¿‡æœŸæ—¶é—´ await redis.expire(hashKey, 86400); // 24å°æ—¶ }; // è·å–éƒ¨åˆ†å­—æ®µ const getUserFields = async (userId, fields) =\u003e { const hashKey = `user:${userId}:profile`; return await redis.hmget(hashKey, fields); }; // æ›´æ–°å•ä¸ªå­—æ®µ const updateUserField = async (userId, field, value) =\u003e { const hashKey = `user:${userId}:profile`; await redis.hset(hashKey, field, value); await redis.hset(hashKey, 'lastUpdate', Date.now()); }; // Hashè®¡æ•°å™¨ï¼ˆé€‚ç”¨äºå°è§„æ¨¡è®¡æ•°ï¼‰ const hashIncrement = async (key, field, increment = 1) =\u003e { return await redis.hincrby(key, field, increment); }; Listç±»å‹ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 // æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆç®€å•å®ç°ï¼‰ class MessageQueue { constructor(redis, queueName) { this.redis = redis; this.queueName = queueName; this.processingName = `${queueName}:processing`; } async enqueue(message) { return await this.redis.lpush(this.queueName, JSON.stringify(message)); } async dequeue() { return await this.redis.brpoplpush( this.queueName, this.processingName, 0 ); } async complete(messageId) { // ä»å¤„ç†é˜Ÿåˆ—ä¸­ç§»é™¤ return await this.redis.lrem(this.processingName, 1, messageId); } async getQueueLength() { return await this.redis.llen(this.queueName); } async getProcessingLength() { return await this.redis.llen(this.processingName); } } // æ—¶é—´çº¿ï¼ˆæœ€æ–°æ¶ˆæ¯ï¼‰ const addTimelineEvent = async (userId, event) =\u003e { const key = `timeline:${userId}`; const eventData = { id: generateId(), type: event.type, data: event.data, timestamp: Date.now() }; // æ·»åŠ åˆ°æ—¶é—´çº¿å¤´éƒ¨ await redis.lpush(key, JSON.stringify(eventData)); // ä¿æŒæœ€è¿‘100æ¡æ¶ˆæ¯ await redis.ltrim(key, 0, 99); // è®¾ç½®è¿‡æœŸæ—¶é—´ await redis.expire(key, 86400 * 7); // 7å¤© }; const getTimeline = async (userId, limit = 20) =\u003e { const key = `timeline:${userId}`; const events = await redis.lrange(key, 0, limit - 1); return events.map(event =\u003e JSON.parse(event)); }; Setç±»å‹ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 // ç”¨æˆ·æ ‡ç­¾ç³»ç»Ÿ class UserTags { constructor(redis) { this.redis = redis; } async addTag(userId, tag) { const key = `user:${userId}:tags`; await redis.sadd(key, tag); return await redis.expire(key, 86400 * 30); // 30å¤© } async removeTag(userId, tag) { const key = `user:${userId}:tags`; return await redis.srem(key, tag); } async getUserTags(userId) { const key = `user:${userId}:tags`; return await redis.smembers(key); } async getTagUsers(tag) { const key = `tag:${tag}:users`; return await redis.smembers(key); } // åŒå‘ç´¢å¼•ï¼šåŒæ—¶ç»´æŠ¤ç”¨æˆ·æ ‡ç­¾å’Œæ ‡ç­¾ç”¨æˆ· async addTagToUser(userId, tag) { const userTagsKey = `user:${userId}:tags`; const tagUsersKey = `tag:${tag}:users`; await this.redis.multi() .sadd(userTagsKey, tag) .sadd(tagUsersKey, userId) .expire(userTagsKey, 86400 * 30) .expire(tagUsersKey, 86400 * 30) .exec(); } } // é›†åˆæ“ä½œï¼šæ‰¾å‡ºå…±åŒæ ‡ç­¾ const findCommonTags = async (userIds) =\u003e { const keys = userIds.map(id =\u003e `user:${id}:tags`); // å¦‚æœåªæœ‰ä¸€ä¸ªç”¨æˆ·ï¼Œè¿”å›å…¶æ‰€æœ‰æ ‡ç­¾ if (keys.length === 1) { return await this.redis.smembers(keys[0]); } // ä½¿ç”¨SINTERæ‰¾å‡ºå…±åŒæ ‡ç­¾ return await this.redis.sinter(keys); }; // æ¨èç›¸ä¼¼ç”¨æˆ· const findSimilarUsers = async (userId, threshold = 0.3) =\u003e { const userTagsKey = `user:${userId}:tags`; const userTags = await this.redis.smembers(userTagsKey); if (userTags.length === 0) return []; const similarUsers = []; // è¿™é‡Œéœ€è¦è·å–æ‰€æœ‰ç”¨æˆ·æ ‡ç­¾è¿›è¡Œæ¯”è¾ƒ // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨å…¶ä»–æ•°æ®ç»“æ„æ¥ä¼˜åŒ– return similarUsers; }; Sorted Setä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 // æ’è¡Œæ¦œç³»ç»Ÿ class Leaderboard { constructor(redis, leaderboardName) { this.redis = redis; this.leaderboardName = leaderboardName; this.ttl = 86400 * 7; // 7å¤© } async addScore(member, score, memberData = {}) { // æ·»åŠ åˆ†æ•° await this.redis.zadd(this.leaderboardName, score, member); // å­˜å‚¨æˆå‘˜è¯¦ç»†ä¿¡æ¯ if (Object.keys(memberData).length \u003e 0) { const dataKey = `${this.leaderboardName}:data:${member}`; await this.redis.hset(dataKey, memberData); await this.redis.expire(dataKey, this.ttl); } // è®¾ç½®è¿‡æœŸæ—¶é—´ await this.redis.expire(this.leaderboardName, this.ttl); } async getTopRank(limit = 10) { // è·å–æ’è¡Œæ¦œå‰Nå const topUsers = await this.redis.zrevrange( this.leaderboardName, 0, limit - 1, 'WITHSCORES' ); const result = []; for (let i = 0; i \u003c topUsers.length; i += 2) { const member = topUsers[i]; const score = topUsers[i + 1]; const rank = i / 2 + 1; // è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ const dataKey = `${this.leaderboardName}:data:${member}`; const userData = await this.redis.hgetall(dataKey); result.push({ rank, member, score: parseFloat(score), ...userData }); } return result; } async getUserRank(member) { const rank = await this.redis.zrevrank(this.leaderboardName, member); return rank !== null ? rank + 1 : null; } async getScore(member) { return await this.redis.zscore(this.leaderboardName, member); } async updateScore(member, newScore) { return await this.redis.zadd(this.leaderboardName, newScore, member); } } // å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆSorted Setå®ç°ï¼‰ class DelayedQueue { constructor(redis, queueName) { this.redis = redis; this.queueName = queueName; this.processing = false; } async addTask(taskId, taskData, delaySeconds) { const executeAt = Date.now() + delaySeconds * 1000; const task = { id: taskId, data: taskData, executeAt, addedAt: Date.now() }; return await this.redis.zadd( this.queueName, executeAt, JSON.stringify(task) ); } async processNext() { if (this.processing) return; this.processing = true; try { const now = Date.now(); // è·å–åˆ°æœŸçš„ä»»åŠ¡ const tasks = await this.redis.zrangebyscore( this.queueName, 0, now, 'LIMIT', 1 ); if (tasks.length === 0) { this.processing = false; return null; } const task = JSON.parse(tasks[0]); // ä»é˜Ÿåˆ—ä¸­ç§»é™¤ await this.redis.zrem(this.queueName, tasks[0]); // å¤„ç†ä»»åŠ¡ await this.handleTask(task); return task; } finally { this.processing = false; } } async handleTask(task) { console.log(`Processing task ${task.id}:`, task.data); // å®ç°å…·ä½“çš„ä»»åŠ¡å¤„ç†é€»è¾‘ } } 3. æ€§èƒ½ä¼˜åŒ–æŠ€å·§ Pipelineæ‰¹å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 // æ‰¹é‡æ“ä½œä¼˜åŒ– class RedisBatch { constructor(redis) { this.redis = redis; } async batchSet(keyValues) { const pipeline = this.redis.pipeline(); for (const [key, value] of Object.entries(keyValues)) { pipeline.set(key, JSON.stringify(value)); } return await pipeline.exec(); } async batchUpdateScores(leaderboard, updates) { const pipeline = this.redis.pipeline(); for (const [member, score] of updates) { pipeline.zadd(leaderboard, score, member); } return await pipeline.exec(); } // åŸå­æ€§æ‰¹é‡æ“ä½œ async atomicUpdate(userData) { const key = `user:${userData.id}`; return await this.redis.multi() .hset(key, userData) .expire(key, 3600) .sadd('users', userData.id) .exec(); } } å†…å­˜ä¼˜åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 // Keyè®¾è®¡æœ€ä½³å®è·µ class KeyNaming { // ä½¿ç”¨å†’å·åˆ†éš”çš„å±‚çº§ç»“æ„ static user(userId) { return `user:${userId}`; } static userProfile(userId) { return `user:${userId}:profile`; } static userSessions(userId) { return `user:${userId}:sessions`; } static cache(namespace, key) { return `cache:${namespace}:${key}`; } static lock(resource) { return `lock:${resource}`; } static counter(name) { return `counter:${name}`; } } // å‹ç¼©å­˜å‚¨ const compressData = (data) =\u003e { if (typeof data === 'string') { return data; // å·²ç»æ˜¯å­—ç¬¦ä¸² } return JSON.stringify(data); }; // é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„ const chooseDataStructure = (useCase) =\u003e { switch (useCase) { case 'simpleCache': return 'String'; // ç®€å•é”®å€¼ç¼“å­˜ case 'userProfile': return 'Hash'; // ç”¨æˆ·æ¡£æ¡ˆåŒ…å«å¤šä¸ªå­—æ®µ case 'messageQueue': return 'List'; // æ¶ˆæ¯é˜Ÿåˆ— case 'userTags': return 'Set'; // ç”¨æˆ·æ ‡ç­¾é›†åˆ case 'leaderboard': return 'Sorted Set'; // æ’è¡Œæ¦œ case 'rateLimit': return 'String + Expire'; // é™æµå™¨ default: return 'String'; } }; 4. ç¼“å­˜ç­–ç•¥ å¤šçº§ç¼“å­˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 class MultiLevelCache { constructor(redis, localCache) { this.redis = redis; this.localCache = localCache; // ä¾‹å¦‚ï¼šMapæˆ–LRU Cache } async get(key) { // L1ï¼šæœ¬åœ°ç¼“å­˜ let value = this.localCache.get(key); if (value !== undefined) { return value; } // L2ï¼šRedisç¼“å­˜ value = await this.redis.get(key); if (value !== null) { const parsedValue = JSON.parse(value); // å›å¡«æœ¬åœ°ç¼“å­˜ this.localCache.set(key, parsedValue, 300); // 5åˆ†é’Ÿ return parsedValue; } // L3ï¼šæ•°æ®åº“æˆ–å…¶ä»–å­˜å‚¨ value = await this.fetchFromDatabase(key); if (value !== null) { // å†™å…¥æ‰€æœ‰ç¼“å­˜å±‚ await this.set(key, value); } return value; } async set(key, value, ttl = 3600) { // åŒæ—¶å†™å…¥æ‰€æœ‰ç¼“å­˜å±‚ this.localCache.set(key, value, Math.min(ttl, 300)); // æœ¬åœ°ç¼“å­˜æœ€å¤š5åˆ†é’Ÿ await this.redis.setex(key, ttl, JSON.stringify(value)); } async invalidate(key) { this.localCache.delete(key); await this.redis.del(key); } async fetchFromDatabase(key) { // å®é™…çš„æ•°æ®åº“æŸ¥è¯¢é€»è¾‘ console.log(`Fetching ${key} from database`); return null; // ç¤ºä¾‹ } } // ç¼“å­˜ç©¿é€ä¿æŠ¤ const cacheWithProtection = async (key, fetcher) =\u003e { // æ£€æŸ¥æ˜¯å¦å­˜åœ¨\"ç©º\"ç¼“å­˜ const nullKey = `${key}:null`; const isNull = await redis.exists(nullKey); if (isNull) { return null; // å·²çŸ¥ä¸ºç©º } let value = await redis.get(key); if (value !== null) { return JSON.parse(value); } // å¹¶å‘æ§åˆ¶ const lockKey = `lock:${key}`; const lockValue = generateUUID(); const lockAcquired = await redis.setnx(lockKey, lockValue, 10); // 10ç§’é” if (lockAcquired) { try { value = await fetcher(); if (value === null) { // è®¾ç½®\"ç©º\"ç¼“å­˜ï¼Œé˜²æ­¢ç©¿é€ await redis.setex(nullKey, 60, 'null'); // 1åˆ†é’Ÿ } else { await redis.setex(key, 3600, JSON.stringify(value)); } return value; } finally { // é‡Šæ”¾é” const script = ` if redis.call(\"get\", KEYS[1]) == ARGV[1] then return redis.call(\"del\", KEYS[1]) else return 0 end `; await redis.eval(script, 1, lockKey, lockValue); } } else { // ç­‰å¾…é”é‡Šæ”¾åé‡è¯• await new Promise(resolve =\u003e setTimeout(resolve, 100)); return cacheWithProtection(key, fetcher); } }; ç¼“å­˜æ›´æ–°ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 // Cache-Asideæ¨¡å¼ class CacheAside { constructor(redis) { this.redis = redis; } async get(key, fetcher) { let data = await this.redis.get(key); if (data !== null) { return JSON.parse(data); } data = await fetcher(); if (data !== null) { await this.redis.setex(key, 3600, JSON.stringify(data)); } return data; } async update(key, data, ttl = 3600) { // å…ˆæ›´æ–°æ•°æ®åº“ await this.updateDatabase(key, data); // ç„¶åæ›´æ–°ç¼“å­˜ await this.redis.setex(key, ttl, JSON.stringify(data)); } async invalidate(key) { await this.redis.del(key); } } // Write-Throughæ¨¡å¼ class WriteThrough { constructor(redis) { this.redis = redis; } async set(key, data, ttl = 3600) { // åŒæ—¶å†™å…¥æ•°æ®åº“å’Œç¼“å­˜ await Promise.all([ this.updateDatabase(key, data), this.redis.setex(key, ttl, JSON.stringify(data)) ]); } } // Write-Behindæ¨¡å¼ class WriteBehind { constructor(redis) { this.redis = redis; this.writeQueue = []; this.batchSize = 100; this.flushInterval = 5000; // 5ç§’ this.startFlushTimer(); } async set(key, data, ttl = 3600) { // ç«‹å³å†™å…¥ç¼“å­˜ await this.redis.setex(key, ttl, JSON.stringify(data)); // åŠ å…¥å†™é˜Ÿåˆ— this.writeQueue.push({ key, data, timestamp: Date.now() }); // å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œç«‹å³åˆ·æ–° if (this.writeQueue.length \u003e= this.batchSize) { await this.flushQueue(); } } async flushQueue() { if (this.writeQueue.length === 0) return; const batch = this.writeQueue.splice(0); try { // æ‰¹é‡å†™å…¥æ•°æ®åº“ await this.batchWriteToDatabase(batch); } catch (error) { console.error('Write-behind batch failed:', error); // é‡æ–°åŠ å…¥é˜Ÿåˆ— this.writeQueue.unshift(...batch); } } startFlushTimer() { setInterval(() =\u003e { this.flushQueue(); }, this.flushInterval); } async batchWriteToDatabase(batch) { // å®ç°æ‰¹é‡æ•°æ®åº“å†™å…¥é€»è¾‘ console.log(`Writing ${batch.length} items to database`); } } 5. åˆ†å¸ƒå¼é” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 // ç®€å•åˆ†å¸ƒå¼é” class DistributedLock { constructor(redis) { this.redis = redis; } async acquire(key, ttl = 30) { const lockValue = generateUUID(); const result = await this.redis.setnx(key, lockValue, ttl); if (result === 1) { return { acquired: true, value: lockValue }; } return { acquired: false, value: null }; } async release(key, lockValue) { const script = ` if redis.call(\"get\", KEYS[1]) == ARGV[1] then return redis.call(\"del\", KEYS[1]) else return 0 end `; const result = await this.redis.eval(script, 1, key, lockValue); return result === 1; } async extend(key, lockValue, ttl) { const script = ` if redis.call(\"get\", KEYS[1]) == ARGV[1] then return redis.call(\"expire\", KEYS[1], ARGV[2]) else return 0 end `; return await this.redis.eval(script, 1, key, lockValue, ttl); } } // å¯é‡å…¥é” class ReentrantLock { constructor(redis) { this.redis = redis; } async acquire(key, lockId, ttl = 30) { const lockKey = `reentrant:${key}:${lockId}`; const counterKey = `reentrant:${key}:counter`; const script = ` local counter = redis.call(\"incr\", KEYS[2]) redis.call(\"expire\", KEYS[2], ARGV[1]) redis.call(\"set\", KEYS[1], \"1\", \"EX\", ARGV[1]) return counter `; return await this.redis.eval(script, 2, lockKey, counterKey, ttl); } async release(key, lockId) { const lockKey = `reentrant:${key}:${lockId}`; const counterKey = `reentrant:${key}:counter`; const script = ` local count = redis.call(\"get\", KEYS[1]) if count == \"0\" then return 0 end redis.call(\"decr\", KEYS[2]) if tonumber(redis.call(\"get\", KEYS[2])) == 0 then redis.call(\"del\", KEYS[1]) redis.call(\"del\", KEYS[2]) end return 1 `; return await this.redis.eval(script, 2, lockKey, counterKey); } } 6. ç›‘æ§å’Œè¯Šæ–­ æ€§èƒ½ç›‘æ§ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 class RedisMonitor { constructor(redis) { this.redis = redis; } async getMetrics() { const info = await this.redis.info(); const lines = info.split('\\r\\n'); const metrics = {}; for (const line of lines) { if (line.includes(':')) { const [key, value] = line.split(':'); metrics[key] = value; } } return { connected_clients: parseInt(metrics.connected_clients) || 0, used_memory: metrics.used_memory_human || '0B', total_commands_processed: parseInt(metrics.total_commands_processed) || 0, keyspace_hits: parseInt(metrics.keyspace_hits) || 0, keyspace_misses: parseInt(metrics.keyspace_misses) || 0, instantaneous_ops_per_sec: parseFloat(metrics.instantaneous_ops_per_sec) || 0, memory_usage_ratio: parseFloat(metrics.mem_fragmentation_ratio) || 0 }; } async getSlowLog(count = 10) { return await this.redis.slowlog('GET', count); } async getMemoryUsage() { const memoryInfo = await this.redis.memory('usage'); return { peak: memoryInfo.peak, used: memoryInfo.used, rss: memoryInfo.rss, overhead: memoryInfo.overhead, startup: memoryInfo.startup, dataset: memoryInfo.dataset }; } async checkHealth() { try { await this.redis.ping(); const metrics = await this.getMetrics(); return { status: 'healthy', timestamp: new Date().toISOString(), metrics }; } catch (error) { return { status: 'unhealthy', timestamp: new Date().toISOString(), error: error.message }; } } // å®šæœŸç›‘æ§ startMonitoring(interval = 60000) { // 1åˆ†é’Ÿ setInterval(async () =\u003e { const health = await this.checkHealth(); if (health.status === 'unhealthy') { console.error('Redis health check failed:', health.error); // å‘é€å‘Šè­¦ this.sendAlert(health); } // è®°å½•æŒ‡æ ‡ console.log('Redis metrics:', health.metrics); }, interval); } sendAlert(health) { // å®ç°å‘Šè­¦é€»è¾‘ console.error('Redis Alert:', health); } } // ä½¿ç”¨ç¤ºä¾‹ const monitor = new RedisMonitor(redis); monitor.startMonitoring(); æ€§èƒ½åˆ†æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 // æ…¢æŸ¥è¯¢æ£€æµ‹ class SlowQueryDetector { constructor(redis, threshold = 100) { this.redis = redis; this.threshold = threshold; this.slowQueries = []; } async detectSlowQuery(command, startTime, endTime) { const duration = endTime - startTime; if (duration \u003e this.threshold) { const slowQuery = { command, duration, timestamp: new Date().toISOString() }; this.slowQueries.push(slowQuery); console.warn(`Slow query detected: ${command} took ${duration}ms`); // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ this.reportSlowQuery(slowQuery); // ä¿æŒæœ€è¿‘100ä¸ªæ…¢æŸ¥è¯¢ if (this.slowQueries.length \u003e 100) { this.slowQueries.shift(); } } } async reportSlowQuery(query) { // å®ç°æ…¢æŸ¥è¯¢æŠ¥å‘Šé€»è¾‘ } getSlowQueries() { return this.slowQueries; } // è£…é¥°å™¨å‡½æ•° wrapRedisFunction(originalFunction, functionName) { return async (...args) =\u003e { const startTime = Date.now(); try { const result = await originalFunction.apply(this.redis, args); const endTime = Date.now(); await this.detectSlowQuery( `${functionName}(${args.join(', ')})`, startTime, endTime ); return result; } catch (error) { const endTime = Date.now(); await this.detectSlowQuery( `${functionName}(${args.join(', ')}) - ERROR`, startTime, endTime ); throw error; } }; } } 7. é›†ç¾¤å’Œå¤åˆ¶ ä¸»ä»å¤åˆ¶é…ç½® # ä¸»æœåŠ¡å™¨é…ç½® port 6379 bind 0.0.0.0 # ä»æœåŠ¡å™¨é…ç½® port 6380 bind 0.0.0.0 replicaof 192.168.1.100 6379 replica-priority 100 Redis Cluster 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 // Redisé›†ç¾¤å®¢æˆ·ç«¯ class RedisClusterClient { constructor(nodes) { this.nodes = nodes; this.connections = new Map(); this.keySlotCount = 16384; this.initializeConnections(); } initializeConnections() { for (const node of this.nodes) { const redis = new Redis({ host: node.host, port: node.port, retryDelayOnFailover: 100, enableReadyCheck: true, maxRetriesPerRequest: 3 }); this.connections.set(`${node.host}:${node.port}`, redis); } } getSlot(key) { return this.crc16(key) % this.keySlotCount; } getNodeForSlot(slot) { // ç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…åº”è¯¥æ ¹æ®slotèŒƒå›´é€‰æ‹©èŠ‚ç‚¹ const nodeIndex = Math.floor(slot / (this.keySlotCount / this.nodes.length)); return this.nodes[nodeIndex]; } getConnectionForKey(key) { const slot = this.getSlot(key); const node = this.getNodeForSlot(slot); return this.connections.get(`${node.host}:${node.port}`); } async get(key) { const connection = this.getConnectionForKey(key); return await connection.get(key); } async set(key, value, ttl) { const connection = this.getConnectionForKey(key); if (ttl) { return await connection.setex(key, ttl, value); } else { return await connection.set(key, value); } } crc16(str) { let crc = 0xFFFF; for (let i = 0; i \u003c str.length; i++) { crc = ((crc \u003c\u003c 8) \u0026 0xFF00) | (crc \u003e\u003e 8); crc ^= str.charCodeAt(i) \u0026 0xFF; crc ^= ((crc \u0026 0xFF) \u003c\u003c 4) \u003c\u003c 8; crc = ((crc \u003c\u003c 8) \u0026 0xFF00) | (crc \u003e\u003e 8); crc ^= ((crc \u0026 0xFF) \u003e\u003e 4) \u003c\u003c 8; } return crc ^ 0xFFFF; } } 8. æ•…éšœæ¢å¤å’Œå¤‡ä»½ è‡ªåŠ¨æ•…éšœæ¢å¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 class RedisFailover { constructor(primaryConfig, replicaConfigs) { this.primaryConfig = primaryConfig; this.replicaConfigs = replicaConfigs; this.currentPrimary = null; this.replicas = []; this.initializeConnections(); } async initializeConnections() { try { // å°è¯•è¿æ¥ä¸»æœåŠ¡å™¨ this.currentPrimary = new Redis(this.primaryConfig); await this.currentPrimary.ping(); console.log('Connected to primary server'); } catch (error) { console.error('Primary server unavailable:', error); await this.promoteReplica(); } // è¿æ¥ä»æœåŠ¡å™¨ for (const config of this.replicaConfigs) { try { const replica = new Redis(config); await replica.ping(); this.replicas.push(replica); console.log(`Connected to replica server: ${config.host}:${config.port}`); } catch (error) { console.warn(`Replica server unavailable: ${config.host}:${config.port}`); } } } async promoteReplica() { for (let i = 0; i \u003c this.replicas.length; i++) { try { // å°è¯•æå‡ä»æœåŠ¡å™¨ä¸ºä¸»æœåŠ¡å™¨ const replica = this.replicas[i]; await replica.replica('NO ONE'); // ç­‰å¾…ä»æœåŠ¡å™¨å®Œæˆè§’è‰²åˆ‡æ¢ await new Promise(resolve =\u003e setTimeout(resolve, 1000)); this.currentPrimary = replica; console.log(`Promoted replica ${i} to primary`); // é‡æ–°é…ç½®å…¶ä»–ä»æœåŠ¡å™¨ await this.reconfigureReplicas(); break; } catch (error) { console.error(`Failed to promote replica ${i}:`, error); } } if (!this.currentPrimary) { throw new Error('No available replicas to promote'); } } async reconfigureReplicas() { for (const replica of this.replicas) { if (replica !== this.currentPrimary) { try { await replica.replica(this.primaryConfig.host, this.primaryConfig.port); } catch (error) { console.error('Failed to reconfigure replica:', error); } } } } async handleFailover() { if (this.currentPrimary) { try { await this.currentPrimary.ping(); return; // ä¸»æœåŠ¡å™¨æ­£å¸¸ } catch (error) { console.error('Primary server failed:', error); } } await this.promoteReplica(); } startHealthCheck() { setInterval(async () =\u003e { await this.handleFailover(); }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ } } æ•°æ®å¤‡ä»½ç­–ç•¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 class RedisBackup { constructor(redis) { this.redis = redis; } async createSnapshot(backupDir) { const timestamp = new Date().toISOString().replace(/[:.]/g, '-'); const filename = `redis-backup-${timestamp}.rdb`; const filePath = path.join(backupDir, filename); try { // è§¦å‘Redis RDBå¿«ç…§ await this.redis.save(); // ç­‰å¾…å¿«ç…§å®Œæˆ await this.waitForSaveCompletion(); // å¤åˆ¶å¿«ç…§æ–‡ä»¶åˆ°å¤‡ä»½ç›®å½• await this.copyRdbFile(filePath); console.log(`Backup created: ${filePath}`); return filename; } catch (error) { console.error('Backup failed:', error); throw error; } } async waitForSaveCompletion() { let saveInProgress = true; while (saveInProgress) { const info = await this.redis.info('persistence'); if (info.includes('saving: 0')) { saveInProgress = false; } else { await new Promise(resolve =\u003e setTimeout(resolve, 1000)); } } } async copyRdbFile(destination) { const rdbPath = '/var/lib/redis/dump.rdb'; // é»˜è®¤RDBè·¯å¾„ try { await fs.copyFile(rdbPath, destination); } catch (error) { throw new Error(`Failed to copy RDB file: ${error.message}`); } } async scheduleBackups(backupDir, interval = 24 * 60 * 60 * 1000) { // 24å°æ—¶ setInterval(async () =\u003e { try { await this.createSnapshot(backupDir); // æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰ await this.cleanupOldBackups(backupDir, 7); } catch (error) { console.error('Scheduled backup failed:', error); } }, interval); } async cleanupOldBackups(backupDir, daysToKeep) { const files = await fs.readdir(backupDir); const now = Date.now(); for (const file of files) { if (file.startsWith('redis-backup-') \u0026\u0026 file.endsWith('.rdb')) { const filePath = path.join(backupDir, file); const stats = await fs.stat(filePath); const ageInDays = (now - stats.mtime.getTime()) / (24 * 60 * 60 * 1000); if (ageInDays \u003e daysToKeep) { await fs.unlink(filePath); console.log(`Removed old backup: ${file}`); } } } } } 9. å®‰å…¨æœ€ä½³å®è·µ è¿æ¥å®‰å…¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 // TLSè¿æ¥é…ç½® class SecureRedisClient { constructor(config) { this.config = { host: config.host || 'localhost', port: config.port || 6379, tls: config.tls || {}, password: config.password, database: config.database || 0, retryDelayOnFailover: 100, maxRetriesPerRequest: 3, enableReadyCheck: true, lazyConnect: true }; } createClient() { const client = new Redis(this.config); // è¿æ¥é”™è¯¯å¤„ç† client.on('error', (err) =\u003e { console.error('Redis Client Error:', err); }); client.on('connect', () =\u003e { console.log('Redis Client Connected'); }); client.on('reconnecting', () =\u003e { console.log('Redis Client Reconnecting...'); }); return client; } } // è¿æ¥æ± ç®¡ç† class RedisConnectionPool { constructor(config, poolSize = 10) { this.config = config; this.poolSize = poolSize; this.connections = []; this.waitingQueue = []; this.initializePool(); } async initializePool() { for (let i = 0; i \u003c this.poolSize; i++) { const client = new Redis(this.config); this.connections.push({ client, inUse: false, id: i }); } } async getConnection() { return new Promise((resolve, reject) =\u003e { // æŸ¥æ‰¾å¯ç”¨è¿æ¥ const available = this.connections.find(conn =\u003e !conn.inUse); if (available) { available.inUse = true; resolve(available.client); } else { // åŠ å…¥ç­‰å¾…é˜Ÿåˆ— this.waitingQueue.push({ resolve, reject }); } }); } releaseConnection(client) { const connection = this.connections.find(conn =\u003e conn.client === client); if (connection) { connection.inUse = false; // å¤„ç†ç­‰å¾…é˜Ÿåˆ— if (this.waitingQueue.length \u003e 0) { const waiter = this.waitingQueue.shift(); connection.inUse = true; waiter.resolve(connection.client); } } } // è¿æ¥å¥åº·æ£€æŸ¥ async healthCheck() { const client = await this.getConnection(); try { await client.ping(); this.releaseConnection(client); return { status: 'healthy' }; } catch (error) { this.releaseConnection(client); return { status: 'unhealthy', error: error.message }; } } } æ€»ç»“ Redisæœ€ä½³å®è·µæ¶µç›–äº†å¤šä¸ªæ–¹é¢ï¼š\né…ç½®ä¼˜åŒ–ï¼š\nåˆç†çš„å†…å­˜é…ç½® é€‚å½“çš„æ·˜æ±°ç­–ç•¥ ç½‘ç»œå’Œå®‰å…¨è®¾ç½® æ•°æ®ç»“æ„é€‰æ‹©ï¼š\næ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹ ä¼˜åŒ–Keyå‘½åè§„èŒƒ åˆç†çš„æ•°æ®ç»“æ„è®¾è®¡ æ€§èƒ½ä¼˜åŒ–ï¼š\nPipelineæ‰¹å¤„ç† å¤šçº§ç¼“å­˜ç­–ç•¥ å†…å­˜ä½¿ç”¨ä¼˜åŒ– é«˜å¯ç”¨æ€§ï¼š\nåˆ†å¸ƒå¼é”å®ç° ä¸»ä»å¤åˆ¶é…ç½® é›†ç¾¤å’Œæ•…éšœè½¬ç§» è¿ç»´ç›‘æ§ï¼š\næ€§èƒ½æŒ‡æ ‡ç›‘æ§ æ…¢æŸ¥è¯¢æ£€æµ‹ å¥åº·æ£€æŸ¥æœºåˆ¶ å®‰å…¨é˜²æŠ¤ï¼š\nè¿æ¥åŠ å¯† è®¿é—®æ§åˆ¶ å¤‡ä»½æ¢å¤ é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œå¯ä»¥æ„å»ºå‡ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„Redisåº”ç”¨ç³»ç»Ÿï¼Œä¸ºä½ çš„åº”ç”¨æä¾›å¼ºå¤§çš„ç¼“å­˜å’Œæ•°æ®å­˜å‚¨èƒ½åŠ›ã€‚\n","wordCount":"4297","inLanguage":"zh-cn","datePublished":"2025-12-16T00:00:00Z","dateModified":"2025-12-16T00:00:00Z","author":{"@type":"Person","name":"æœ‰æ¡å·¥å…·å›¢é˜Ÿ"},"mainEntityOfPage":{"@type":"WebPage","@id":"/blog/articles/redis-best-practices/"},"publisher":{"@type":"Organization","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·","logo":{"@type":"ImageObject","url":"/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=/blog/ accesskey=h title="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· (Alt + H)">æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=/blog/posts/ title="æ‰€æœ‰æ–‡ç« åˆ—è¡¨ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŸ¥çœ‹æ‰€æœ‰æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ–‡ç« </span></a></li><li><a href=https://www.util.cn title="æœ‰æ¡å·¥å…· - å¼€å‘è€…çš„å¸¸ç”¨å·¥å…·é›†åˆï¼šæ— å¹¿å‘Š Â· æœ¬åœ°è®¡ç®— Â· å³å¼€å³ç”¨çš„åœ¨çº¿å·¥å…·å¹³å°ï¼Œæä¾›JSONæ ¼å¼åŒ–ã€SQLæ ¼å¼åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰å®ç”¨å·¥å…·"><span>æœ‰æ¡å·¥å…·</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=/blog/categories/ title="æ–‡ç« åˆ†ç±» - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æŠ€æœ¯é¢†åŸŸåˆ†ç±»çš„ä¼˜è´¨æ–‡ç« ï¼ŒåŒ…æ‹¬å‰ç«¯å¼€å‘ã€å·¥å…·ä½¿ç”¨ã€ç¼–ç¨‹æŠ€å·§ç­‰"><span>åˆ†ç±»</span></a></li><li><a href=/blog/tags/ title="æ ‡ç­¾äº‘ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡æ ‡ç­¾å¿«é€Ÿæ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ ‡ç­¾</span></a></li><li><a href=/blog/archives/ title="æ–‡ç« å½’æ¡£ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æ—¶é—´æŸ¥çœ‹å†å²æ–‡ç« "><span>å½’æ¡£</span></a></li><li><a href=/blog/search/ title="æœç´¢æ–‡ç«  - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡å…³é”®è¯æœç´¢æ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹ï¼Œæ”¯æŒæ ‡é¢˜ã€å†…å®¹ã€åˆ†ç±»å’Œæ ‡ç­¾æœç´¢"><span>æœç´¢</span></a></li></ul></nav></header><main class=main><article class=post-single><div class=post-content-wrapper><main class=post-content-main><header class=post-header-main><h1 class="post-title entry-hint-parent">Redisæœ€ä½³å®è·µæŒ‡å—ï¼šé«˜æ€§èƒ½å†…å­˜æ•°æ®åº“å®æˆ˜æŠ€å·§</h1><div class=post-meta><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/ class=category-link>æ•°æ®åº“</a><a href=/blog/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/ class=category-link>åç«¯å¼€å‘</a></div><span class=post-date>2025-12-16</span><span class=post-author>æœ‰æ¡å·¥å…·å›¢é˜Ÿ</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></div></header><div class=post-content><p>Redisä½œä¸ºé«˜æ€§èƒ½çš„å†…å­˜æ•°æ®åº“ï¼Œåœ¨ç°ä»£åº”ç”¨æ¶æ„ä¸­æ‰®æ¼”ç€é‡è¦è§’è‰²ã€‚æœ¬æ–‡å°†å…¨é¢ä»‹ç»Redisçš„æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ æ„å»ºç¨³å®šã€é«˜æ•ˆçš„Redisåº”ç”¨ã€‚</p><h2 id=1-redisåŸºç¡€é…ç½®>1. RedisåŸºç¡€é…ç½®<a hidden class=anchor aria-hidden=true href=#1-redisåŸºç¡€é…ç½®>#</a></h2><h3 id=å†…å­˜ä¼˜åŒ–é…ç½®>å†…å­˜ä¼˜åŒ–é…ç½®<a hidden class=anchor aria-hidden=true href=#å†…å­˜ä¼˜åŒ–é…ç½®>#</a></h3><pre tabindex=0><code class=language-conf data-lang=conf># redis.conf

# è®¾ç½®æœ€å¤§å†…å­˜é™åˆ¶
maxmemory 2gb

# å†…å­˜æ·˜æ±°ç­–ç•¥
# volatile-lru: åœ¨è®¾ç½®äº†TTLçš„keyä¸­ï¼Œæ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„key
# allkeys-lru: åœ¨æ‰€æœ‰keyä¸­ï¼Œæ·˜æ±°æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„key
# volatile-random: åœ¨è®¾ç½®äº†TTLçš„keyä¸­ï¼Œéšæœºæ·˜æ±°key
# allkeys-random: åœ¨æ‰€æœ‰keyä¸­ï¼Œéšæœºæ·˜æ±°key
# volatile-ttl: æ·˜æ±°å³å°†è¿‡æœŸçš„key
# noeviction: ä¸æ·˜æ±°keyï¼Œå†…å­˜ä¸è¶³æ—¶è¿”å›é”™è¯¯
maxmemory-policy allkeys-lru

# å¯ç”¨AOFæŒä¹…åŒ–
appendonly yes
appendfsync everysec

# RDBå¿«ç…§é…ç½®
save 900 1    # 15åˆ†é’Ÿå†…æœ‰1ä¸ªkeyæ”¹å˜å°±ä¿å­˜
save 300 10   # 5åˆ†é’Ÿå†…æœ‰10ä¸ªkeyæ”¹å˜å°±ä¿å­˜
save 60 10000 # 1åˆ†é’Ÿå†…æœ‰10000ä¸ªkeyæ”¹å˜å°±ä¿å­˜

# å‹ç¼©RDBæ–‡ä»¶
rdbcompression yes
rdbchecksum yes
</code></pre><h3 id=ç½‘ç»œå’Œå®‰å…¨é…ç½®>ç½‘ç»œå’Œå®‰å…¨é…ç½®<a hidden class=anchor aria-hidden=true href=#ç½‘ç»œå’Œå®‰å…¨é…ç½®>#</a></h3><pre tabindex=0><code class=language-conf data-lang=conf># ç½‘ç»œé…ç½®
bind 127.0.0.1 192.168.1.100
port 6379
timeout 300
tcp-keepalive 300

# å®‰å…¨é…ç½®
requirepass your-strong-password-here
# æˆ–ä½¿ç”¨ACL (Redis 6.0+)
aclfile /etc/redis/users.acl

# ç¦ç”¨å±é™©å‘½ä»¤
rename-command FLUSHDB &#34;&#34;
rename-command FLUSHALL &#34;&#34;
rename-command KEYS &#34;&#34;
rename-command CONFIG &#34;CONFIG_b835c3f8a5d6e7f2e8c1d9a0b4c5f6e&#34;
rename-command SHUTDOWN SHUTDOWN_b835c3f8a5d6e7f2e8c1d9a0b4c5f6e
rename-command DEBUG DEBUG_b835c3f8a5d6e7f2e8c1d9a0b4c5f6e

# å®¢æˆ·ç«¯è¿æ¥é™åˆ¶
maxclients 10000
</code></pre><h2 id=2-æ•°æ®ç»“æ„é€‰æ‹©ç­–ç•¥>2. æ•°æ®ç»“æ„é€‰æ‹©ç­–ç•¥<a hidden class=anchor aria-hidden=true href=#2-æ•°æ®ç»“æ„é€‰æ‹©ç­–ç•¥>#</a></h2><h3 id=stringç±»å‹ä¼˜åŒ–>Stringç±»å‹ä¼˜åŒ–<a hidden class=anchor aria-hidden=true href=#stringç±»å‹ä¼˜åŒ–>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åŸå­è®¡æ•°å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> incrementCounter <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (key, increment <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> redis.incrBy(key, increment);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è®¾ç½®å¸¦TTLçš„ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> setCacheWithTTL <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (key, value, ttl <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3600</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> redis.setex(key, ttl, JSON.stringify(value));
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ‰¹é‡è·å–
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> mGetCached <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (keys) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> values <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> redis.mget(keys);
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> values.map(value =&gt; value <span style=color:#ff7b72;font-weight:700>?</span> JSON.parse(value) <span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>null</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨Hashä»£æ›¿å¤šä¸ªStringï¼ˆå½“å­—æ®µè¾ƒå¤šæ—¶ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> userInfo <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>    name<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;John Doe&#39;</span>,
</span></span><span style=display:flex><span>    email<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;john@example.com&#39;</span>,
</span></span><span style=display:flex><span>    age<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>30</span>,
</span></span><span style=display:flex><span>    city<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;New York&#39;</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// âŒ ä¸æ¨èï¼šå¤šä¸ªStringé”®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>await</span> redis.mset([
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;user:1:name&#39;</span>, userInfo.name,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;user:1:email&#39;</span>, userInfo.email,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;user:1:age&#39;</span>, userInfo.age,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;user:1:city&#39;</span>, userInfo.city
</span></span><span style=display:flex><span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// âœ… æ¨èï¼šå•ä¸ªHash
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>await</span> redis.hset(<span style=color:#a5d6ff>&#39;user:1&#39;</span>, userInfo);
</span></span></code></pre></td></tr></table></div></div><h3 id=hashç±»å‹ä¼˜åŒ–>Hashç±»å‹ä¼˜åŒ–<a hidden class=anchor aria-hidden=true href=#hashç±»å‹ä¼˜åŒ–>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç”¨æˆ·ä¿¡æ¯å­˜å‚¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> setUserProfile <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (userId, profile) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> hashKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:profile`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> redis.hset(hashKey, {
</span></span><span style=display:flex><span>        name<span style=color:#ff7b72;font-weight:700>:</span> profile.name,
</span></span><span style=display:flex><span>        email<span style=color:#ff7b72;font-weight:700>:</span> profile.email,
</span></span><span style=display:flex><span>        bio<span style=color:#ff7b72;font-weight:700>:</span> profile.bio,
</span></span><span style=display:flex><span>        lastUpdate<span style=color:#ff7b72;font-weight:700>:</span> Date.now()
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è®¾ç½®è¿‡æœŸæ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>await</span> redis.expire(hashKey, <span style=color:#a5d6ff>86400</span>); <span style=color:#8b949e;font-style:italic>// 24å°æ—¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è·å–éƒ¨åˆ†å­—æ®µ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> getUserFields <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (userId, fields) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> hashKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:profile`</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> redis.hmget(hashKey, fields);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ›´æ–°å•ä¸ªå­—æ®µ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> updateUserField <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (userId, field, value) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> hashKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:profile`</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> redis.hset(hashKey, field, value);
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> redis.hset(hashKey, <span style=color:#a5d6ff>&#39;lastUpdate&#39;</span>, Date.now());
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Hashè®¡æ•°å™¨ï¼ˆé€‚ç”¨äºå°è§„æ¨¡è®¡æ•°ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> hashIncrement <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (key, field, increment <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>1</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> redis.hincrby(key, field, increment);
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><h3 id=listç±»å‹ä¼˜åŒ–>Listç±»å‹ä¼˜åŒ–<a hidden class=anchor aria-hidden=true href=#listç±»å‹ä¼˜åŒ–>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆç®€å•å®ç°ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> MessageQueue {
</span></span><span style=display:flex><span>    constructor(redis, queueName) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.queueName <span style=color:#ff7b72;font-weight:700>=</span> queueName;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.processingName <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span>queueName<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:processing`</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> enqueue(message) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.lpush(<span style=color:#ff7b72>this</span>.queueName, JSON.stringify(message));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> dequeue() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.brpoplpush(
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.queueName,
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.processingName,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> complete(messageId) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// ä»å¤„ç†é˜Ÿåˆ—ä¸­ç§»é™¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.lrem(<span style=color:#ff7b72>this</span>.processingName, <span style=color:#a5d6ff>1</span>, messageId);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> getQueueLength() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.llen(<span style=color:#ff7b72>this</span>.queueName);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> getProcessingLength() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.llen(<span style=color:#ff7b72>this</span>.processingName);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ—¶é—´çº¿ï¼ˆæœ€æ–°æ¶ˆæ¯ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> addTimelineEvent <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (userId, event) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`timeline:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> eventData <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>        id<span style=color:#ff7b72;font-weight:700>:</span> generateId(),
</span></span><span style=display:flex><span>        type<span style=color:#ff7b72;font-weight:700>:</span> event.type,
</span></span><span style=display:flex><span>        data<span style=color:#ff7b72;font-weight:700>:</span> event.data,
</span></span><span style=display:flex><span>        timestamp<span style=color:#ff7b72;font-weight:700>:</span> Date.now()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ·»åŠ åˆ°æ—¶é—´çº¿å¤´éƒ¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>await</span> redis.lpush(key, JSON.stringify(eventData));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä¿æŒæœ€è¿‘100æ¡æ¶ˆæ¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>await</span> redis.ltrim(key, <span style=color:#a5d6ff>0</span>, <span style=color:#a5d6ff>99</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è®¾ç½®è¿‡æœŸæ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>await</span> redis.expire(key, <span style=color:#a5d6ff>86400</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>7</span>); <span style=color:#8b949e;font-style:italic>// 7å¤©
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> getTimeline <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (userId, limit <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>20</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`timeline:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> events <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> redis.lrange(key, <span style=color:#a5d6ff>0</span>, limit <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#a5d6ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> events.map(event =&gt; JSON.parse(event));
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><h3 id=setç±»å‹ä¼˜åŒ–>Setç±»å‹ä¼˜åŒ–<a hidden class=anchor aria-hidden=true href=#setç±»å‹ä¼˜åŒ–>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç”¨æˆ·æ ‡ç­¾ç³»ç»Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> UserTags {
</span></span><span style=display:flex><span>    constructor(redis) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> addTag(userId, tag) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:tags`</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> redis.sadd(key, tag);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> redis.expire(key, <span style=color:#a5d6ff>86400</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>30</span>); <span style=color:#8b949e;font-style:italic>// 30å¤©
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> removeTag(userId, tag) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:tags`</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> redis.srem(key, tag);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> getUserTags(userId) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:tags`</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> redis.smembers(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> getTagUsers(tag) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`tag:</span><span style=color:#a5d6ff>${</span>tag<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:users`</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> redis.smembers(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åŒå‘ç´¢å¼•ï¼šåŒæ—¶ç»´æŠ¤ç”¨æˆ·æ ‡ç­¾å’Œæ ‡ç­¾ç”¨æˆ·
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>async</span> addTagToUser(userId, tag) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> userTagsKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:tags`</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> tagUsersKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`tag:</span><span style=color:#a5d6ff>${</span>tag<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:users`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.multi()
</span></span><span style=display:flex><span>            .sadd(userTagsKey, tag)
</span></span><span style=display:flex><span>            .sadd(tagUsersKey, userId)
</span></span><span style=display:flex><span>            .expire(userTagsKey, <span style=color:#a5d6ff>86400</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>30</span>)
</span></span><span style=display:flex><span>            .expire(tagUsersKey, <span style=color:#a5d6ff>86400</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>30</span>)
</span></span><span style=display:flex><span>            .exec();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// é›†åˆæ“ä½œï¼šæ‰¾å‡ºå…±åŒæ ‡ç­¾
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> findCommonTags <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (userIds) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> keys <span style=color:#ff7b72;font-weight:700>=</span> userIds.map(id =&gt; <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:tags`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å¦‚æœåªæœ‰ä¸€ä¸ªç”¨æˆ·ï¼Œè¿”å›å…¶æ‰€æœ‰æ ‡ç­¾
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>if</span> (keys.length <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.smembers(keys[<span style=color:#a5d6ff>0</span>]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä½¿ç”¨SINTERæ‰¾å‡ºå…±åŒæ ‡ç­¾
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.sinter(keys);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ¨èç›¸ä¼¼ç”¨æˆ·
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> findSimilarUsers <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (userId, threshold <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0.3</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> userTagsKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:tags`</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> userTags <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.smembers(userTagsKey);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (userTags.length <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>0</span>) <span style=color:#ff7b72>return</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> similarUsers <span style=color:#ff7b72;font-weight:700>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è¿™é‡Œéœ€è¦è·å–æ‰€æœ‰ç”¨æˆ·æ ‡ç­¾è¿›è¡Œæ¯”è¾ƒ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#8b949e;font-style:italic>// åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨å…¶ä»–æ•°æ®ç»“æ„æ¥ä¼˜åŒ–
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>return</span> similarUsers;
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><h3 id=sorted-setä¼˜åŒ–>Sorted Setä¼˜åŒ–<a hidden class=anchor aria-hidden=true href=#sorted-setä¼˜åŒ–>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">133
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ’è¡Œæ¦œç³»ç»Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> Leaderboard {
</span></span><span style=display:flex><span>    constructor(redis, leaderboardName) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.leaderboardName <span style=color:#ff7b72;font-weight:700>=</span> leaderboardName;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.ttl <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>86400</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>7</span>; <span style=color:#8b949e;font-style:italic>// 7å¤©
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> addScore(member, score, memberData <span style=color:#ff7b72;font-weight:700>=</span> {}) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// æ·»åŠ åˆ†æ•°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.zadd(<span style=color:#ff7b72>this</span>.leaderboardName, score, member);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å­˜å‚¨æˆå‘˜è¯¦ç»†ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> (Object.keys(memberData).length <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#a5d6ff>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> dataKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span><span style=color:#ff7b72>this</span>.leaderboardName<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:data:</span><span style=color:#a5d6ff>${</span>member<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.hset(dataKey, memberData);
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.expire(dataKey, <span style=color:#ff7b72>this</span>.ttl);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// è®¾ç½®è¿‡æœŸæ—¶é—´
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.expire(<span style=color:#ff7b72>this</span>.leaderboardName, <span style=color:#ff7b72>this</span>.ttl);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> getTopRank(limit <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>10</span>) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// è·å–æ’è¡Œæ¦œå‰Nå
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>const</span> topUsers <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.zrevrange(
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.leaderboardName,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>            limit <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#a5d6ff>1</span>,
</span></span><span style=display:flex><span>            <span style=color:#a5d6ff>&#39;WITHSCORES&#39;</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> result <span style=color:#ff7b72;font-weight:700>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>let</span> i <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>; i <span style=color:#ff7b72;font-weight:700>&lt;</span> topUsers.length; i <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>2</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> member <span style=color:#ff7b72;font-weight:700>=</span> topUsers[i];
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> score <span style=color:#ff7b72;font-weight:700>=</span> topUsers[i <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>];
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> rank <span style=color:#ff7b72;font-weight:700>=</span> i <span style=color:#ff7b72;font-weight:700>/</span> <span style=color:#a5d6ff>2</span> <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>const</span> dataKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span><span style=color:#ff7b72>this</span>.leaderboardName<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:data:</span><span style=color:#a5d6ff>${</span>member<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> userData <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.hgetall(dataKey);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            result.push({
</span></span><span style=display:flex><span>                rank,
</span></span><span style=display:flex><span>                member,
</span></span><span style=display:flex><span>                score<span style=color:#ff7b72;font-weight:700>:</span> parseFloat(score),
</span></span><span style=display:flex><span>                ...userData
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> getUserRank(member) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> rank <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.zrevrank(<span style=color:#ff7b72>this</span>.leaderboardName, member);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> rank <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#79c0ff>null</span> <span style=color:#ff7b72;font-weight:700>?</span> rank <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span> <span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> getScore(member) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.zscore(<span style=color:#ff7b72>this</span>.leaderboardName, member);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> updateScore(member, newScore) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.zadd(<span style=color:#ff7b72>this</span>.leaderboardName, newScore, member);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆSorted Setå®ç°ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> DelayedQueue {
</span></span><span style=display:flex><span>    constructor(redis, queueName) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.queueName <span style=color:#ff7b72;font-weight:700>=</span> queueName;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.processing <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> addTask(taskId, taskData, delaySeconds) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> executeAt <span style=color:#ff7b72;font-weight:700>=</span> Date.now() <span style=color:#ff7b72;font-weight:700>+</span> delaySeconds <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> task <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>            id<span style=color:#ff7b72;font-weight:700>:</span> taskId,
</span></span><span style=display:flex><span>            data<span style=color:#ff7b72;font-weight:700>:</span> taskData,
</span></span><span style=display:flex><span>            executeAt,
</span></span><span style=display:flex><span>            addedAt<span style=color:#ff7b72;font-weight:700>:</span> Date.now()
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.zadd(
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.queueName,
</span></span><span style=display:flex><span>            executeAt,
</span></span><span style=display:flex><span>            JSON.stringify(task)
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> processNext() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>this</span>.processing) <span style=color:#ff7b72>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.processing <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> now <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// è·å–åˆ°æœŸçš„ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>const</span> tasks <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.zrangebyscore(
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>this</span>.queueName,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>                now,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#39;LIMIT&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> (tasks.length <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>0</span>) {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>this</span>.processing <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span>;
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> task <span style=color:#ff7b72;font-weight:700>=</span> JSON.parse(tasks[<span style=color:#a5d6ff>0</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// ä»é˜Ÿåˆ—ä¸­ç§»é™¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.zrem(<span style=color:#ff7b72>this</span>.queueName, tasks[<span style=color:#a5d6ff>0</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// å¤„ç†ä»»åŠ¡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.handleTask(task);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> task;
</span></span><span style=display:flex><span>        } <span style=color:#ff7b72>finally</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.processing <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> handleTask(task) {
</span></span><span style=display:flex><span>        console.log(<span style=color:#a5d6ff>`Processing task </span><span style=color:#a5d6ff>${</span>task.id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:`</span>, task.data);
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å®ç°å…·ä½“çš„ä»»åŠ¡å¤„ç†é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=3-æ€§èƒ½ä¼˜åŒ–æŠ€å·§>3. æ€§èƒ½ä¼˜åŒ–æŠ€å·§<a hidden class=anchor aria-hidden=true href=#3-æ€§èƒ½ä¼˜åŒ–æŠ€å·§>#</a></h2><h3 id=pipelineæ‰¹å¤„ç†>Pipelineæ‰¹å¤„ç†<a hidden class=anchor aria-hidden=true href=#pipelineæ‰¹å¤„ç†>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ‰¹é‡æ“ä½œä¼˜åŒ–
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> RedisBatch {
</span></span><span style=display:flex><span>    constructor(redis) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> batchSet(keyValues) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> pipeline <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.redis.pipeline();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> [key, value] <span style=color:#ff7b72>of</span> Object.entries(keyValues)) {
</span></span><span style=display:flex><span>            pipeline.set(key, JSON.stringify(value));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> pipeline.exec();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> batchUpdateScores(leaderboard, updates) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> pipeline <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.redis.pipeline();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> [member, score] <span style=color:#ff7b72>of</span> updates) {
</span></span><span style=display:flex><span>            pipeline.zadd(leaderboard, score, member);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> pipeline.exec();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// åŸå­æ€§æ‰¹é‡æ“ä½œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>async</span> atomicUpdate(userData) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>userData.id<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.multi()
</span></span><span style=display:flex><span>            .hset(key, userData)
</span></span><span style=display:flex><span>            .expire(key, <span style=color:#a5d6ff>3600</span>)
</span></span><span style=display:flex><span>            .sadd(<span style=color:#a5d6ff>&#39;users&#39;</span>, userData.id)
</span></span><span style=display:flex><span>            .exec();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=å†…å­˜ä¼˜åŒ–>å†…å­˜ä¼˜åŒ–<a hidden class=anchor aria-hidden=true href=#å†…å­˜ä¼˜åŒ–>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Keyè®¾è®¡æœ€ä½³å®è·µ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> KeyNaming {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ä½¿ç”¨å†’å·åˆ†éš”çš„å±‚çº§ç»“æ„
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>static</span> user(userId) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>static</span> userProfile(userId) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:profile`</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>static</span> userSessions(userId) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>`user:</span><span style=color:#a5d6ff>${</span>userId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:sessions`</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>static</span> cache(namespace, key) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>`cache:</span><span style=color:#a5d6ff>${</span>namespace<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>${</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>static</span> lock(resource) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>`lock:</span><span style=color:#a5d6ff>${</span>resource<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>static</span> counter(name) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>`counter:</span><span style=color:#a5d6ff>${</span>name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å‹ç¼©å­˜å‚¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> compressData <span style=color:#ff7b72;font-weight:700>=</span> (data) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>typeof</span> data <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;string&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> data; <span style=color:#8b949e;font-style:italic>// å·²ç»æ˜¯å­—ç¬¦ä¸²
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> JSON.stringify(data);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> chooseDataStructure <span style=color:#ff7b72;font-weight:700>=</span> (useCase) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>switch</span> (useCase) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>&#39;simpleCache&#39;</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#39;String&#39;</span>; <span style=color:#8b949e;font-style:italic>// ç®€å•é”®å€¼ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>&#39;userProfile&#39;</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#39;Hash&#39;</span>; <span style=color:#8b949e;font-style:italic>// ç”¨æˆ·æ¡£æ¡ˆåŒ…å«å¤šä¸ªå­—æ®µ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>&#39;messageQueue&#39;</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#39;List&#39;</span>; <span style=color:#8b949e;font-style:italic>// æ¶ˆæ¯é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>&#39;userTags&#39;</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#39;Set&#39;</span>; <span style=color:#8b949e;font-style:italic>// ç”¨æˆ·æ ‡ç­¾é›†åˆ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>&#39;leaderboard&#39;</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#39;Sorted Set&#39;</span>; <span style=color:#8b949e;font-style:italic>// æ’è¡Œæ¦œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>case</span> <span style=color:#a5d6ff>&#39;rateLimit&#39;</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#39;String + Expire&#39;</span>; <span style=color:#8b949e;font-style:italic>// é™æµå™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>default</span><span style=color:#ff7b72;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#39;String&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><h2 id=4-ç¼“å­˜ç­–ç•¥>4. ç¼“å­˜ç­–ç•¥<a hidden class=anchor aria-hidden=true href=#4-ç¼“å­˜ç­–ç•¥>#</a></h2><h3 id=å¤šçº§ç¼“å­˜>å¤šçº§ç¼“å­˜<a hidden class=anchor aria-hidden=true href=#å¤šçº§ç¼“å­˜>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>class</span> MultiLevelCache {
</span></span><span style=display:flex><span>    constructor(redis, localCache) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.localCache <span style=color:#ff7b72;font-weight:700>=</span> localCache; <span style=color:#8b949e;font-style:italic>// ä¾‹å¦‚ï¼šMapæˆ–LRU Cache
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> get(key) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// L1ï¼šæœ¬åœ°ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>let</span> value <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.localCache.get(key);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (value <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#79c0ff>undefined</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> value;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// L2ï¼šRedisç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        value <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.get(key);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (value <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#79c0ff>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> parsedValue <span style=color:#ff7b72;font-weight:700>=</span> JSON.parse(value);
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// å›å¡«æœ¬åœ°ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>this</span>.localCache.set(key, parsedValue, <span style=color:#a5d6ff>300</span>); <span style=color:#8b949e;font-style:italic>// 5åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>return</span> parsedValue;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// L3ï¼šæ•°æ®åº“æˆ–å…¶ä»–å­˜å‚¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        value <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.fetchFromDatabase(key);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (value <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#79c0ff>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// å†™å…¥æ‰€æœ‰ç¼“å­˜å±‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.set(key, value);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> value;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> set(key, value, ttl <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3600</span>) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// åŒæ—¶å†™å…¥æ‰€æœ‰ç¼“å­˜å±‚
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>this</span>.localCache.set(key, value, Math.min(ttl, <span style=color:#a5d6ff>300</span>)); <span style=color:#8b949e;font-style:italic>// æœ¬åœ°ç¼“å­˜æœ€å¤š5åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.setex(key, ttl, JSON.stringify(value));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> invalidate(key) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.localCache.<span style=color:#ff7b72>delete</span>(key);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.del(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> fetchFromDatabase(key) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å®é™…çš„æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        console.log(<span style=color:#a5d6ff>`Fetching </span><span style=color:#a5d6ff>${</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> from database`</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span>; <span style=color:#8b949e;font-style:italic>// ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç¼“å­˜ç©¿é€ä¿æŠ¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> cacheWithProtection <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>async</span> (key, fetcher) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// æ£€æŸ¥æ˜¯å¦å­˜åœ¨&#34;ç©º&#34;ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> nullKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:null`</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> isNull <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> redis.exists(nullKey);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (isNull) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>null</span>; <span style=color:#8b949e;font-style:italic>// å·²çŸ¥ä¸ºç©º
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>let</span> value <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> redis.get(key);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (value <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#79c0ff>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> JSON.parse(value);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å¹¶å‘æ§åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> lockKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`lock:</span><span style=color:#a5d6ff>${</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> lockValue <span style=color:#ff7b72;font-weight:700>=</span> generateUUID();
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> lockAcquired <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> redis.setnx(lockKey, lockValue, <span style=color:#a5d6ff>10</span>); <span style=color:#8b949e;font-style:italic>// 10ç§’é”
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (lockAcquired) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>            value <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> fetcher();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> (value <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#79c0ff>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// è®¾ç½®&#34;ç©º&#34;ç¼“å­˜ï¼Œé˜²æ­¢ç©¿é€
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>await</span> redis.setex(nullKey, <span style=color:#a5d6ff>60</span>, <span style=color:#a5d6ff>&#39;null&#39;</span>); <span style=color:#8b949e;font-style:italic>// 1åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            } <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> redis.setex(key, <span style=color:#a5d6ff>3600</span>, JSON.stringify(value));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> value;
</span></span><span style=display:flex><span>        } <span style=color:#ff7b72>finally</span> {
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// é‡Šæ”¾é”
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>const</span> script <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                if redis.call(&#34;get&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    return redis.call(&#34;del&#34;, KEYS[1])
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                else
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                    return 0
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            `</span>;
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> redis.eval(script, <span style=color:#a5d6ff>1</span>, lockKey, lockValue);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// ç­‰å¾…é”é‡Šæ”¾åé‡è¯•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>new</span> Promise(resolve =&gt; setTimeout(resolve, <span style=color:#a5d6ff>100</span>));
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> cacheWithProtection(key, fetcher);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><h3 id=ç¼“å­˜æ›´æ–°ç­–ç•¥>ç¼“å­˜æ›´æ–°ç­–ç•¥<a hidden class=anchor aria-hidden=true href=#ç¼“å­˜æ›´æ–°ç­–ç•¥>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">103
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Cache-Asideæ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> CacheAside {
</span></span><span style=display:flex><span>    constructor(redis) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> get(key, fetcher) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>let</span> data <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.get(key);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (data <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#79c0ff>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> JSON.parse(data);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        data <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> fetcher();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (data <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#79c0ff>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.setex(key, <span style=color:#a5d6ff>3600</span>, JSON.stringify(data));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> data;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> update(key, data, ttl <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3600</span>) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å…ˆæ›´æ–°æ•°æ®åº“
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.updateDatabase(key, data);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// ç„¶åæ›´æ–°ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.setex(key, ttl, JSON.stringify(data));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> invalidate(key) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.del(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Write-Throughæ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> WriteThrough {
</span></span><span style=display:flex><span>    constructor(redis) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> set(key, data, ttl <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3600</span>) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// åŒæ—¶å†™å…¥æ•°æ®åº“å’Œç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>await</span> Promise.all([
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.updateDatabase(key, data),
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.redis.setex(key, ttl, JSON.stringify(data))
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Write-Behindæ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> WriteBehind {
</span></span><span style=display:flex><span>    constructor(redis) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.writeQueue <span style=color:#ff7b72;font-weight:700>=</span> [];
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.batchSize <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>100</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.flushInterval <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>5000</span>; <span style=color:#8b949e;font-style:italic>// 5ç§’
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>this</span>.startFlushTimer();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> set(key, data, ttl <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>3600</span>) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// ç«‹å³å†™å…¥ç¼“å­˜
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.setex(key, ttl, JSON.stringify(data));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// åŠ å…¥å†™é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>this</span>.writeQueue.push({
</span></span><span style=display:flex><span>            key,
</span></span><span style=display:flex><span>            data,
</span></span><span style=display:flex><span>            timestamp<span style=color:#ff7b72;font-weight:700>:</span> Date.now()
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œç«‹å³åˆ·æ–°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>this</span>.writeQueue.length <span style=color:#ff7b72;font-weight:700>&gt;=</span> <span style=color:#ff7b72>this</span>.batchSize) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.flushQueue();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> flushQueue() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>this</span>.writeQueue.length <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>0</span>) <span style=color:#ff7b72>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> batch <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.writeQueue.splice(<span style=color:#a5d6ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// æ‰¹é‡å†™å…¥æ•°æ®åº“
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.batchWriteToDatabase(batch);
</span></span><span style=display:flex><span>        } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>            console.error(<span style=color:#a5d6ff>&#39;Write-behind batch failed:&#39;</span>, error);
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// é‡æ–°åŠ å…¥é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>this</span>.writeQueue.unshift(...batch);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    startFlushTimer() {
</span></span><span style=display:flex><span>        setInterval(() =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.flushQueue();
</span></span><span style=display:flex><span>        }, <span style=color:#ff7b72>this</span>.flushInterval);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> batchWriteToDatabase(batch) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å®ç°æ‰¹é‡æ•°æ®åº“å†™å…¥é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        console.log(<span style=color:#a5d6ff>`Writing </span><span style=color:#a5d6ff>${</span>batch.length<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> items to database`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=5-åˆ†å¸ƒå¼é”>5. åˆ†å¸ƒå¼é”<a hidden class=anchor aria-hidden=true href=#5-åˆ†å¸ƒå¼é”>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">92
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç®€å•åˆ†å¸ƒå¼é”
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> DistributedLock {
</span></span><span style=display:flex><span>    constructor(redis) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> acquire(key, ttl <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>30</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> lockValue <span style=color:#ff7b72;font-weight:700>=</span> generateUUID();
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.setnx(key, lockValue, ttl);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (result <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>1</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                acquired<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>                value<span style=color:#ff7b72;font-weight:700>:</span> lockValue
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>            acquired<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>            value<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>null</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> release(key, lockValue) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> script <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            if redis.call(&#34;get&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                return redis.call(&#34;del&#34;, KEYS[1])
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            else
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                return 0
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        `</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.eval(script, <span style=color:#a5d6ff>1</span>, key, lockValue);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> result <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> extend(key, lockValue, ttl) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> script <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            if redis.call(&#34;get&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                return redis.call(&#34;expire&#34;, KEYS[1], ARGV[2])
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            else
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                return 0
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        `</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.eval(script, <span style=color:#a5d6ff>1</span>, key, lockValue, ttl);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¯é‡å…¥é”
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> ReentrantLock {
</span></span><span style=display:flex><span>    constructor(redis) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> acquire(key, lockId, ttl <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>30</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> lockKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`reentrant:</span><span style=color:#a5d6ff>${</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>${</span>lockId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> counterKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`reentrant:</span><span style=color:#a5d6ff>${</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:counter`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> script <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            local counter = redis.call(&#34;incr&#34;, KEYS[2])
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            redis.call(&#34;expire&#34;, KEYS[2], ARGV[1])
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            redis.call(&#34;set&#34;, KEYS[1], &#34;1&#34;, &#34;EX&#34;, ARGV[1])
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            return counter
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        `</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.eval(script, <span style=color:#a5d6ff>2</span>, lockKey, counterKey, ttl);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> release(key, lockId) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> lockKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`reentrant:</span><span style=color:#a5d6ff>${</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>${</span>lockId<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> counterKey <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`reentrant:</span><span style=color:#a5d6ff>${</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:counter`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> script <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            local count = redis.call(&#34;get&#34;, KEYS[1])
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            if count == &#34;0&#34; then
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                return 0
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            redis.call(&#34;decr&#34;, KEYS[2])
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            if tonumber(redis.call(&#34;get&#34;, KEYS[2])) == 0 then
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                redis.call(&#34;del&#34;, KEYS[1])
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>                redis.call(&#34;del&#34;, KEYS[2])
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            end
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>            return 1
</span></span></span><span style=display:flex><span><span style=color:#a5d6ff>        `</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.eval(script, <span style=color:#a5d6ff>2</span>, lockKey, counterKey);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=6-ç›‘æ§å’Œè¯Šæ–­>6. ç›‘æ§å’Œè¯Šæ–­<a hidden class=anchor aria-hidden=true href=#6-ç›‘æ§å’Œè¯Šæ–­>#</a></h2><h3 id=æ€§èƒ½ç›‘æ§>æ€§èƒ½ç›‘æ§<a hidden class=anchor aria-hidden=true href=#æ€§èƒ½ç›‘æ§>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">91
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>class</span> RedisMonitor {
</span></span><span style=display:flex><span>    constructor(redis) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> getMetrics() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> info <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.info();
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> lines <span style=color:#ff7b72;font-weight:700>=</span> info.split(<span style=color:#a5d6ff>&#39;\r\n&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> metrics <span style=color:#ff7b72;font-weight:700>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> line <span style=color:#ff7b72>of</span> lines) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> (line.includes(<span style=color:#a5d6ff>&#39;:&#39;</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>const</span> [key, value] <span style=color:#ff7b72;font-weight:700>=</span> line.split(<span style=color:#a5d6ff>&#39;:&#39;</span>);
</span></span><span style=display:flex><span>                metrics[key] <span style=color:#ff7b72;font-weight:700>=</span> value;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>            connected_clients<span style=color:#ff7b72;font-weight:700>:</span> parseInt(metrics.connected_clients) <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>            used_memory<span style=color:#ff7b72;font-weight:700>:</span> metrics.used_memory_human <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>&#39;0B&#39;</span>,
</span></span><span style=display:flex><span>            total_commands_processed<span style=color:#ff7b72;font-weight:700>:</span> parseInt(metrics.total_commands_processed) <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>            keyspace_hits<span style=color:#ff7b72;font-weight:700>:</span> parseInt(metrics.keyspace_hits) <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>            keyspace_misses<span style=color:#ff7b72;font-weight:700>:</span> parseInt(metrics.keyspace_misses) <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>            instantaneous_ops_per_sec<span style=color:#ff7b72;font-weight:700>:</span> parseFloat(metrics.instantaneous_ops_per_sec) <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>            memory_usage_ratio<span style=color:#ff7b72;font-weight:700>:</span> parseFloat(metrics.mem_fragmentation_ratio) <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> getSlowLog(count <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>10</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.slowlog(<span style=color:#a5d6ff>&#39;GET&#39;</span>, count);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> getMemoryUsage() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> memoryInfo <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.memory(<span style=color:#a5d6ff>&#39;usage&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>            peak<span style=color:#ff7b72;font-weight:700>:</span> memoryInfo.peak,
</span></span><span style=display:flex><span>            used<span style=color:#ff7b72;font-weight:700>:</span> memoryInfo.used,
</span></span><span style=display:flex><span>            rss<span style=color:#ff7b72;font-weight:700>:</span> memoryInfo.rss,
</span></span><span style=display:flex><span>            overhead<span style=color:#ff7b72;font-weight:700>:</span> memoryInfo.overhead,
</span></span><span style=display:flex><span>            startup<span style=color:#ff7b72;font-weight:700>:</span> memoryInfo.startup,
</span></span><span style=display:flex><span>            dataset<span style=color:#ff7b72;font-weight:700>:</span> memoryInfo.dataset
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> checkHealth() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.ping();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> metrics <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.getMetrics();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                status<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;healthy&#39;</span>,
</span></span><span style=display:flex><span>                timestamp<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>new</span> Date().toISOString(),
</span></span><span style=display:flex><span>                metrics
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>        } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>                status<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;unhealthy&#39;</span>,
</span></span><span style=display:flex><span>                timestamp<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>new</span> Date().toISOString(),
</span></span><span style=display:flex><span>                error<span style=color:#ff7b72;font-weight:700>:</span> error.message
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å®šæœŸç›‘æ§
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    startMonitoring(interval <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>60000</span>) { <span style=color:#8b949e;font-style:italic>// 1åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        setInterval(<span style=color:#ff7b72>async</span> () =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> health <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.checkHealth();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> (health.status <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;unhealthy&#39;</span>) {
</span></span><span style=display:flex><span>                console.error(<span style=color:#a5d6ff>&#39;Redis health check failed:&#39;</span>, health.error);
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// å‘é€å‘Šè­¦
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>this</span>.sendAlert(health);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// è®°å½•æŒ‡æ ‡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            console.log(<span style=color:#a5d6ff>&#39;Redis metrics:&#39;</span>, health.metrics);
</span></span><span style=display:flex><span>        }, interval);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sendAlert(health) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å®ç°å‘Šè­¦é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        console.error(<span style=color:#a5d6ff>&#39;Redis Alert:&#39;</span>, health);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> monitor <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> RedisMonitor(redis);
</span></span><span style=display:flex><span>monitor.startMonitoring();
</span></span></code></pre></td></tr></table></div></div><h3 id=æ€§èƒ½åˆ†æ>æ€§èƒ½åˆ†æ<a hidden class=anchor aria-hidden=true href=#æ€§èƒ½åˆ†æ>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ…¢æŸ¥è¯¢æ£€æµ‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> SlowQueryDetector {
</span></span><span style=display:flex><span>    constructor(redis, threshold <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>100</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.threshold <span style=color:#ff7b72;font-weight:700>=</span> threshold;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.slowQueries <span style=color:#ff7b72;font-weight:700>=</span> [];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> detectSlowQuery(command, startTime, endTime) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> duration <span style=color:#ff7b72;font-weight:700>=</span> endTime <span style=color:#ff7b72;font-weight:700>-</span> startTime;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (duration <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#ff7b72>this</span>.threshold) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> slowQuery <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>                command,
</span></span><span style=display:flex><span>                duration,
</span></span><span style=display:flex><span>                timestamp<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>new</span> Date().toISOString()
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.slowQueries.push(slowQuery);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            console.warn(<span style=color:#a5d6ff>`Slow query detected: </span><span style=color:#a5d6ff>${</span>command<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> took </span><span style=color:#a5d6ff>${</span>duration<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>ms`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>this</span>.reportSlowQuery(slowQuery);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// ä¿æŒæœ€è¿‘100ä¸ªæ…¢æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>this</span>.slowQueries.length <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#a5d6ff>100</span>) {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>this</span>.slowQueries.shift();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> reportSlowQuery(query) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// å®ç°æ…¢æŸ¥è¯¢æŠ¥å‘Šé€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    getSlowQueries() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span>.slowQueries;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è£…é¥°å™¨å‡½æ•°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    wrapRedisFunction(originalFunction, functionName) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>async</span> (...args) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> startTime <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>const</span> result <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> originalFunction.apply(<span style=color:#ff7b72>this</span>.redis, args);
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>const</span> endTime <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.detectSlowQuery(
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span>functionName<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>(</span><span style=color:#a5d6ff>${</span>args.join(<span style=color:#a5d6ff>&#39;, &#39;</span>)<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>)`</span>,
</span></span><span style=display:flex><span>                    startTime,
</span></span><span style=display:flex><span>                    endTime
</span></span><span style=display:flex><span>                );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> result;
</span></span><span style=display:flex><span>            } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>const</span> endTime <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.detectSlowQuery(
</span></span><span style=display:flex><span>                    <span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span>functionName<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>(</span><span style=color:#a5d6ff>${</span>args.join(<span style=color:#a5d6ff>&#39;, &#39;</span>)<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>) - ERROR`</span>,
</span></span><span style=display:flex><span>                    startTime,
</span></span><span style=display:flex><span>                    endTime
</span></span><span style=display:flex><span>                );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>throw</span> error;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=7-é›†ç¾¤å’Œå¤åˆ¶>7. é›†ç¾¤å’Œå¤åˆ¶<a hidden class=anchor aria-hidden=true href=#7-é›†ç¾¤å’Œå¤åˆ¶>#</a></h2><h3 id=ä¸»ä»å¤åˆ¶é…ç½®>ä¸»ä»å¤åˆ¶é…ç½®<a hidden class=anchor aria-hidden=true href=#ä¸»ä»å¤åˆ¶é…ç½®>#</a></h3><pre tabindex=0><code class=language-conf data-lang=conf># ä¸»æœåŠ¡å™¨é…ç½®
port 6379
bind 0.0.0.0

# ä»æœåŠ¡å™¨é…ç½®
port 6380
bind 0.0.0.0
replicaof 192.168.1.100 6379
replica-priority 100
</code></pre><h3 id=redis-cluster>Redis Cluster<a hidden class=anchor aria-hidden=true href=#redis-cluster>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// Redisé›†ç¾¤å®¢æˆ·ç«¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> RedisClusterClient {
</span></span><span style=display:flex><span>    constructor(nodes) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.nodes <span style=color:#ff7b72;font-weight:700>=</span> nodes;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.connections <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Map();
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.keySlotCount <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>16384</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.initializeConnections();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    initializeConnections() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> node <span style=color:#ff7b72>of</span> <span style=color:#ff7b72>this</span>.nodes) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> redis <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Redis({
</span></span><span style=display:flex><span>                host<span style=color:#ff7b72;font-weight:700>:</span> node.host,
</span></span><span style=display:flex><span>                port<span style=color:#ff7b72;font-weight:700>:</span> node.port,
</span></span><span style=display:flex><span>                retryDelayOnFailover<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>100</span>,
</span></span><span style=display:flex><span>                enableReadyCheck<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>                maxRetriesPerRequest<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>3</span>
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.connections.set(<span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span>node.host<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>${</span>node.port<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>, redis);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    getSlot(key) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span>.crc16(key) <span style=color:#ff7b72;font-weight:700>%</span> <span style=color:#ff7b72>this</span>.keySlotCount;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    getNodeForSlot(slot) {
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// ç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…åº”è¯¥æ ¹æ®slotèŒƒå›´é€‰æ‹©èŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>const</span> nodeIndex <span style=color:#ff7b72;font-weight:700>=</span> Math.floor(slot <span style=color:#ff7b72;font-weight:700>/</span> (<span style=color:#ff7b72>this</span>.keySlotCount <span style=color:#ff7b72;font-weight:700>/</span> <span style=color:#ff7b72>this</span>.nodes.length));
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span>.nodes[nodeIndex];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    getConnectionForKey(key) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> slot <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.getSlot(key);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> node <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.getNodeForSlot(slot);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>this</span>.connections.get(<span style=color:#a5d6ff>`</span><span style=color:#a5d6ff>${</span>node.host<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>${</span>node.port<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> get(key) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> connection <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.getConnectionForKey(key);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> connection.get(key);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> set(key, value, ttl) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> connection <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.getConnectionForKey(key);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (ttl) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> connection.setex(key, ttl, value);
</span></span><span style=display:flex><span>        } <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> connection.set(key, value);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    crc16(str) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>let</span> crc <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0xFFFF</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>let</span> i <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>; i <span style=color:#ff7b72;font-weight:700>&lt;</span> str.length; i<span style=color:#ff7b72;font-weight:700>++</span>) {
</span></span><span style=display:flex><span>            crc <span style=color:#ff7b72;font-weight:700>=</span> ((crc <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span> <span style=color:#a5d6ff>8</span>) <span style=color:#ff7b72;font-weight:700>&amp;</span> <span style=color:#a5d6ff>0xFF00</span>) <span style=color:#ff7b72;font-weight:700>|</span> (crc <span style=color:#ff7b72;font-weight:700>&gt;&gt;</span> <span style=color:#a5d6ff>8</span>);
</span></span><span style=display:flex><span>            crc <span style=color:#ff7b72;font-weight:700>^=</span> str.charCodeAt(i) <span style=color:#ff7b72;font-weight:700>&amp;</span> <span style=color:#a5d6ff>0xFF</span>;
</span></span><span style=display:flex><span>            crc <span style=color:#ff7b72;font-weight:700>^=</span> ((crc <span style=color:#ff7b72;font-weight:700>&amp;</span> <span style=color:#a5d6ff>0xFF</span>) <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span> <span style=color:#a5d6ff>4</span>) <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span> <span style=color:#a5d6ff>8</span>;
</span></span><span style=display:flex><span>            crc <span style=color:#ff7b72;font-weight:700>=</span> ((crc <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span> <span style=color:#a5d6ff>8</span>) <span style=color:#ff7b72;font-weight:700>&amp;</span> <span style=color:#a5d6ff>0xFF00</span>) <span style=color:#ff7b72;font-weight:700>|</span> (crc <span style=color:#ff7b72;font-weight:700>&gt;&gt;</span> <span style=color:#a5d6ff>8</span>);
</span></span><span style=display:flex><span>            crc <span style=color:#ff7b72;font-weight:700>^=</span> ((crc <span style=color:#ff7b72;font-weight:700>&amp;</span> <span style=color:#a5d6ff>0xFF</span>) <span style=color:#ff7b72;font-weight:700>&gt;&gt;</span> <span style=color:#a5d6ff>4</span>) <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span> <span style=color:#a5d6ff>8</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> crc <span style=color:#ff7b72;font-weight:700>^</span> <span style=color:#a5d6ff>0xFFFF</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=8-æ•…éšœæ¢å¤å’Œå¤‡ä»½>8. æ•…éšœæ¢å¤å’Œå¤‡ä»½<a hidden class=anchor aria-hidden=true href=#8-æ•…éšœæ¢å¤å’Œå¤‡ä»½>#</a></h2><h3 id=è‡ªåŠ¨æ•…éšœæ¢å¤>è‡ªåŠ¨æ•…éšœæ¢å¤<a hidden class=anchor aria-hidden=true href=#è‡ªåŠ¨æ•…éšœæ¢å¤>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">91
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>class</span> RedisFailover {
</span></span><span style=display:flex><span>    constructor(primaryConfig, replicaConfigs) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.primaryConfig <span style=color:#ff7b72;font-weight:700>=</span> primaryConfig;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.replicaConfigs <span style=color:#ff7b72;font-weight:700>=</span> replicaConfigs;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.currentPrimary <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.replicas <span style=color:#ff7b72;font-weight:700>=</span> [];
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.initializeConnections();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> initializeConnections() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// å°è¯•è¿æ¥ä¸»æœåŠ¡å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>this</span>.currentPrimary <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Redis(<span style=color:#ff7b72>this</span>.primaryConfig);
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.currentPrimary.ping();
</span></span><span style=display:flex><span>            console.log(<span style=color:#a5d6ff>&#39;Connected to primary server&#39;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>            console.error(<span style=color:#a5d6ff>&#39;Primary server unavailable:&#39;</span>, error);
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.promoteReplica();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// è¿æ¥ä»æœåŠ¡å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> config <span style=color:#ff7b72>of</span> <span style=color:#ff7b72>this</span>.replicaConfigs) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>const</span> replica <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Redis(config);
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> replica.ping();
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>this</span>.replicas.push(replica);
</span></span><span style=display:flex><span>                console.log(<span style=color:#a5d6ff>`Connected to replica server: </span><span style=color:#a5d6ff>${</span>config.host<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>${</span>config.port<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>);
</span></span><span style=display:flex><span>            } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>                console.warn(<span style=color:#a5d6ff>`Replica server unavailable: </span><span style=color:#a5d6ff>${</span>config.host<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>${</span>config.port<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> promoteReplica() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>let</span> i <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>; i <span style=color:#ff7b72;font-weight:700>&lt;</span> <span style=color:#ff7b72>this</span>.replicas.length; i<span style=color:#ff7b72;font-weight:700>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// å°è¯•æå‡ä»æœåŠ¡å™¨ä¸ºä¸»æœåŠ¡å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>const</span> replica <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.replicas[i];
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> replica.replica(<span style=color:#a5d6ff>&#39;NO ONE&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// ç­‰å¾…ä»æœåŠ¡å™¨å®Œæˆè§’è‰²åˆ‡æ¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>new</span> Promise(resolve =&gt; setTimeout(resolve, <span style=color:#a5d6ff>1000</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>this</span>.currentPrimary <span style=color:#ff7b72;font-weight:700>=</span> replica;
</span></span><span style=display:flex><span>                console.log(<span style=color:#a5d6ff>`Promoted replica </span><span style=color:#a5d6ff>${</span>i<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> to primary`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// é‡æ–°é…ç½®å…¶ä»–ä»æœåŠ¡å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.reconfigureReplicas();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>break</span>;
</span></span><span style=display:flex><span>            } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>                console.error(<span style=color:#a5d6ff>`Failed to promote replica </span><span style=color:#a5d6ff>${</span>i<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:`</span>, error);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span><span style=color:#ff7b72>this</span>.currentPrimary) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;No available replicas to promote&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> reconfigureReplicas() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> replica <span style=color:#ff7b72>of</span> <span style=color:#ff7b72>this</span>.replicas) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> (replica <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#ff7b72>this</span>.currentPrimary) {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>await</span> replica.replica(<span style=color:#ff7b72>this</span>.primaryConfig.host, <span style=color:#ff7b72>this</span>.primaryConfig.port);
</span></span><span style=display:flex><span>                } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>                    console.error(<span style=color:#a5d6ff>&#39;Failed to reconfigure replica:&#39;</span>, error);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> handleFailover() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>this</span>.currentPrimary) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.currentPrimary.ping();
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span>; <span style=color:#8b949e;font-style:italic>// ä¸»æœåŠ¡å™¨æ­£å¸¸
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>                console.error(<span style=color:#a5d6ff>&#39;Primary server failed:&#39;</span>, error);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.promoteReplica();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    startHealthCheck() {
</span></span><span style=display:flex><span>        setInterval(<span style=color:#ff7b72>async</span> () =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.handleFailover();
</span></span><span style=display:flex><span>        }, <span style=color:#a5d6ff>5000</span>); <span style=color:#8b949e;font-style:italic>// æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=æ•°æ®å¤‡ä»½ç­–ç•¥>æ•°æ®å¤‡ä»½ç­–ç•¥<a hidden class=anchor aria-hidden=true href=#æ•°æ®å¤‡ä»½ç­–ç•¥>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">85
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>class</span> RedisBackup {
</span></span><span style=display:flex><span>    constructor(redis) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.redis <span style=color:#ff7b72;font-weight:700>=</span> redis;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> createSnapshot(backupDir) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> timestamp <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Date().toISOString().replace(<span style=color:#79c0ff>/[:.]/g</span>, <span style=color:#a5d6ff>&#39;-&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> filename <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`redis-backup-</span><span style=color:#a5d6ff>${</span>timestamp<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>.rdb`</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> filePath <span style=color:#ff7b72;font-weight:700>=</span> path.join(backupDir, filename);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// è§¦å‘Redis RDBå¿«ç…§
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.save();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// ç­‰å¾…å¿«ç…§å®Œæˆ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.waitForSaveCompletion();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// å¤åˆ¶å¿«ç…§æ–‡ä»¶åˆ°å¤‡ä»½ç›®å½•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.copyRdbFile(filePath);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            console.log(<span style=color:#a5d6ff>`Backup created: </span><span style=color:#a5d6ff>${</span>filePath<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> filename;
</span></span><span style=display:flex><span>        } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>            console.error(<span style=color:#a5d6ff>&#39;Backup failed:&#39;</span>, error);
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> error;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> waitForSaveCompletion() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>let</span> saveInProgress <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>while</span> (saveInProgress) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> info <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.redis.info(<span style=color:#a5d6ff>&#39;persistence&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> (info.includes(<span style=color:#a5d6ff>&#39;saving: 0&#39;</span>)) {
</span></span><span style=display:flex><span>                saveInProgress <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span>;
</span></span><span style=display:flex><span>            } <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>new</span> Promise(resolve =&gt; setTimeout(resolve, <span style=color:#a5d6ff>1000</span>));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> copyRdbFile(destination) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> rdbPath <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;/var/lib/redis/dump.rdb&#39;</span>; <span style=color:#8b949e;font-style:italic>// é»˜è®¤RDBè·¯å¾„
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> fs.copyFile(rdbPath, destination);
</span></span><span style=display:flex><span>        } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>`Failed to copy RDB file: </span><span style=color:#a5d6ff>${</span>error.message<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> scheduleBackups(backupDir, interval <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>24</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>) { <span style=color:#8b949e;font-style:italic>// 24å°æ—¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        setInterval(<span style=color:#ff7b72>async</span> () =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.createSnapshot(backupDir);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘7å¤©ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.cleanupOldBackups(backupDir, <span style=color:#a5d6ff>7</span>);
</span></span><span style=display:flex><span>            } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>                console.error(<span style=color:#a5d6ff>&#39;Scheduled backup failed:&#39;</span>, error);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }, interval);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> cleanupOldBackups(backupDir, daysToKeep) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> files <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> fs.readdir(backupDir);
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> now <span style=color:#ff7b72;font-weight:700>=</span> Date.now();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> file <span style=color:#ff7b72>of</span> files) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> (file.startsWith(<span style=color:#a5d6ff>&#39;redis-backup-&#39;</span>) <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> file.endsWith(<span style=color:#a5d6ff>&#39;.rdb&#39;</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>const</span> filePath <span style=color:#ff7b72;font-weight:700>=</span> path.join(backupDir, file);
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>const</span> stats <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> fs.stat(filePath);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>const</span> ageInDays <span style=color:#ff7b72;font-weight:700>=</span> (now <span style=color:#ff7b72;font-weight:700>-</span> stats.mtime.getTime()) <span style=color:#ff7b72;font-weight:700>/</span> (<span style=color:#a5d6ff>24</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> (ageInDays <span style=color:#ff7b72;font-weight:700>&gt;</span> daysToKeep) {
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>await</span> fs.unlink(filePath);
</span></span><span style=display:flex><span>                    console.log(<span style=color:#a5d6ff>`Removed old backup: </span><span style=color:#a5d6ff>${</span>file<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=9-å®‰å…¨æœ€ä½³å®è·µ>9. å®‰å…¨æœ€ä½³å®è·µ<a hidden class=anchor aria-hidden=true href=#9-å®‰å…¨æœ€ä½³å®è·µ>#</a></h2><h3 id=è¿æ¥å®‰å…¨>è¿æ¥å®‰å…¨<a hidden class=anchor aria-hidden=true href=#è¿æ¥å®‰å…¨>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">101
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// TLSè¿æ¥é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> SecureRedisClient {
</span></span><span style=display:flex><span>    constructor(config) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.config <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>            host<span style=color:#ff7b72;font-weight:700>:</span> config.host <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>&#39;localhost&#39;</span>,
</span></span><span style=display:flex><span>            port<span style=color:#ff7b72;font-weight:700>:</span> config.port <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>6379</span>,
</span></span><span style=display:flex><span>            tls<span style=color:#ff7b72;font-weight:700>:</span> config.tls <span style=color:#ff7b72;font-weight:700>||</span> {},
</span></span><span style=display:flex><span>            password<span style=color:#ff7b72;font-weight:700>:</span> config.password,
</span></span><span style=display:flex><span>            database<span style=color:#ff7b72;font-weight:700>:</span> config.database <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>0</span>,
</span></span><span style=display:flex><span>            retryDelayOnFailover<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>100</span>,
</span></span><span style=display:flex><span>            maxRetriesPerRequest<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>3</span>,
</span></span><span style=display:flex><span>            enableReadyCheck<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>            lazyConnect<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    createClient() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> client <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Redis(<span style=color:#ff7b72>this</span>.config);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic>// è¿æ¥é”™è¯¯å¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>        client.on(<span style=color:#a5d6ff>&#39;error&#39;</span>, (err) =&gt; {
</span></span><span style=display:flex><span>            console.error(<span style=color:#a5d6ff>&#39;Redis Client Error:&#39;</span>, err);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        client.on(<span style=color:#a5d6ff>&#39;connect&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>            console.log(<span style=color:#a5d6ff>&#39;Redis Client Connected&#39;</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        client.on(<span style=color:#a5d6ff>&#39;reconnecting&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>            console.log(<span style=color:#a5d6ff>&#39;Redis Client Reconnecting...&#39;</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> client;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è¿æ¥æ± ç®¡ç†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>class</span> RedisConnectionPool {
</span></span><span style=display:flex><span>    constructor(config, poolSize <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>10</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.config <span style=color:#ff7b72;font-weight:700>=</span> config;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.poolSize <span style=color:#ff7b72;font-weight:700>=</span> poolSize;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.connections <span style=color:#ff7b72;font-weight:700>=</span> [];
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.waitingQueue <span style=color:#ff7b72;font-weight:700>=</span> [];
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>this</span>.initializePool();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> initializePool() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>let</span> i <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>; i <span style=color:#ff7b72;font-weight:700>&lt;</span> <span style=color:#ff7b72>this</span>.poolSize; i<span style=color:#ff7b72;font-weight:700>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>const</span> client <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Redis(<span style=color:#ff7b72>this</span>.config);
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.connections.push({
</span></span><span style=display:flex><span>                client,
</span></span><span style=display:flex><span>                inUse<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>                id<span style=color:#ff7b72;font-weight:700>:</span> i
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>async</span> getConnection() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>new</span> Promise((resolve, reject) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// æŸ¥æ‰¾å¯ç”¨è¿æ¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>const</span> available <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.connections.find(conn =&gt; <span style=color:#ff7b72;font-weight:700>!</span>conn.inUse);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> (available) {
</span></span><span style=display:flex><span>                available.inUse <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>true</span>;
</span></span><span style=display:flex><span>                resolve(available.client);
</span></span><span style=display:flex><span>            } <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic>// åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>                <span style=color:#ff7b72>this</span>.waitingQueue.push({ resolve, reject });
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    releaseConnection(client) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> connection <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.connections.find(conn =&gt; conn.client <span style=color:#ff7b72;font-weight:700>===</span> client);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> (connection) {
</span></span><span style=display:flex><span>            connection.inUse <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic>// å¤„ç†ç­‰å¾…é˜Ÿåˆ—
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>            <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>this</span>.waitingQueue.length <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#a5d6ff>0</span>) {
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>const</span> waiter <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>this</span>.waitingQueue.shift();
</span></span><span style=display:flex><span>                connection.inUse <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>true</span>;
</span></span><span style=display:flex><span>                waiter.resolve(connection.client);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// è¿æ¥å¥åº·æ£€æŸ¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>async</span> healthCheck() {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>const</span> client <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>this</span>.getConnection();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>await</span> client.ping();
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.releaseConnection(client);
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> { status<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;healthy&#39;</span> };
</span></span><span style=display:flex><span>        } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>this</span>.releaseConnection(client);
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> { status<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;unhealthy&#39;</span>, error<span style=color:#ff7b72;font-weight:700>:</span> error.message };
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h2><p>Redisæœ€ä½³å®è·µæ¶µç›–äº†å¤šä¸ªæ–¹é¢ï¼š</p><p><strong>é…ç½®ä¼˜åŒ–ï¼š</strong></p><ul><li>åˆç†çš„å†…å­˜é…ç½®</li><li>é€‚å½“çš„æ·˜æ±°ç­–ç•¥</li><li>ç½‘ç»œå’Œå®‰å…¨è®¾ç½®</li></ul><p><strong>æ•°æ®ç»“æ„é€‰æ‹©ï¼š</strong></p><ul><li>æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹</li><li>ä¼˜åŒ–Keyå‘½åè§„èŒƒ</li><li>åˆç†çš„æ•°æ®ç»“æ„è®¾è®¡</li></ul><p><strong>æ€§èƒ½ä¼˜åŒ–ï¼š</strong></p><ul><li>Pipelineæ‰¹å¤„ç†</li><li>å¤šçº§ç¼“å­˜ç­–ç•¥</li><li>å†…å­˜ä½¿ç”¨ä¼˜åŒ–</li></ul><p><strong>é«˜å¯ç”¨æ€§ï¼š</strong></p><ul><li>åˆ†å¸ƒå¼é”å®ç°</li><li>ä¸»ä»å¤åˆ¶é…ç½®</li><li>é›†ç¾¤å’Œæ•…éšœè½¬ç§»</li></ul><p><strong>è¿ç»´ç›‘æ§ï¼š</strong></p><ul><li>æ€§èƒ½æŒ‡æ ‡ç›‘æ§</li><li>æ…¢æŸ¥è¯¢æ£€æµ‹</li><li>å¥åº·æ£€æŸ¥æœºåˆ¶</li></ul><p><strong>å®‰å…¨é˜²æŠ¤ï¼š</strong></p><ul><li>è¿æ¥åŠ å¯†</li><li>è®¿é—®æ§åˆ¶</li><li>å¤‡ä»½æ¢å¤</li></ul><p>é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œå¯ä»¥æ„å»ºå‡ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„Redisåº”ç”¨ç³»ç»Ÿï¼Œä¸ºä½ çš„åº”ç”¨æä¾›å¼ºå¤§çš„ç¼“å­˜å’Œæ•°æ®å­˜å‚¨èƒ½åŠ›ã€‚</p><hr></div><footer class=post-footer-modern><div class=post-tags-modern><span class=tags-label>ğŸ·ï¸ æ ‡ç­¾</span><div class=tags-list><a href=/blog/tags/redis/ class=tag-pill>Redis
</a><a href=/blog/tags/%E7%BC%93%E5%AD%98/ class=tag-pill>ç¼“å­˜
</a><a href=/blog/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/ class=tag-pill>æ•°æ®åº“
</a><a href=/blog/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ class=tag-pill>æ€§èƒ½ä¼˜åŒ–
</a><a href=/blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F/ class=tag-pill>åˆ†å¸ƒå¼</a></div></div><style>.post-footer-modern{margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border,#333333)}.post-tags-modern{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}.tags-label{font-size:.875rem;font-weight:600;color:var(--secondary,#999999) !important;white-space:nowrap}.tags-list{display:flex;flex-wrap:wrap;gap:.5rem;flex:1}.tag-pill{display:inline-block;padding:.25rem .75rem;background:rgba(255,255,255,5%);border:1px solid var(--border,#333333);border-radius:0;color:var(--secondary,#cccccc) !important;text-decoration:none;font-size:.8rem;font-weight:500;transition:all .2s ease}.tag-pill:hover{background:var(--primary,#ffffff);color:var(--background,#000000) !important;border-color:var(--primary,#ffffff);transform:translateY(-1px)}.post-nav-modern{margin-top:2rem}.nav-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.nav-card{display:flex;align-items:center;gap:1rem;padding:1.25rem;background:rgba(255,255,255,2%);border:1px solid var(--border,#333333);border-radius:12px;text-decoration:none;transition:all .2s ease;min-height:80px}.nav-card:hover{background:rgba(255,255,255,5%);border-color:var(--primary,#ffffff);transform:translateY(-2px)}.nav-card.nav-prev{justify-content:flex-start}.nav-card.nav-next{justify-content:flex-end;text-align:right}.nav-card.nav-next .nav-content{text-align:right}.nav-empty{display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,1%);border:1px dashed var(--border,#333333);color:var(--secondary,#666666)}.nav-arrow{font-size:1.5rem;color:var(--primary,#ffffff);font-weight:300}.nav-content{flex:1}.nav-title{font-size:.95rem;font-weight:600;color:var(--primary,#ffffff) !important;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}[data-theme=light] .post-footer-modern{border-color:var(--border-light,#dee2e6)}[data-theme=light] .tags-label{color:var(--secondary-light,#6c757d) !important}[data-theme=light] .tag-pill{background:rgba(0,0,0,5%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#495057) !important}[data-theme=light] .tag-pill:hover{background:var(--primary-light,#0066cc);color:var(--background-light,#ffffff) !important;border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-card{background:rgba(0,0,0,2%);border-color:var(--border-light,#dee2e6)}[data-theme=light] .nav-card:hover{background:rgba(0,102,204,5%);border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-empty{background:rgba(0,0,0,1%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#6c757d)}[data-theme=light] .nav-arrow{color:var(--primary-light,#0066cc)}[data-theme=light] .nav-title{color:var(--primary-light,#212529) !important}@media(max-width:768px){.nav-grid{grid-template-columns:1fr;gap:.75rem}.nav-card{padding:1rem;min-height:70px}.nav-card.nav-next{text-align:left}.nav-card.nav-next .nav-content{text-align:left}.nav-title{font-size:.875rem}.post-tags-modern{flex-direction:column;gap:.75rem}}@media(max-width:480px){.nav-arrow{font-size:1.25rem}.nav-card{padding:.875rem}.nav-title{font-size:.8rem;-webkit-line-clamp:1}}</style><nav class=post-nav-modern><div class=nav-grid><a href=/blog/articles/api-design-principles/ class="nav-card nav-prev"><div class=nav-arrow>â†</div><div class=nav-content><div class=nav-title>RESTful APIè®¾è®¡åŸåˆ™ï¼šæ„å»ºå¯æ‰©å±•çš„WebæœåŠ¡æ¥å£</div></div></a><a href=/blog/articles/react-performance-optimization/ class="nav-card nav-next"><div class=nav-content><div class=nav-title>Reactæ€§èƒ½ä¼˜åŒ–å®Œå…¨æŒ‡å—ï¼šä»åŸºç¡€åˆ°é«˜çº§çš„æ€§èƒ½æå‡æŠ€å·§</div></div><div class=nav-arrow>â†’</div></a></div></nav></footer></main><aside class=post-sidebar><div class=sidebar-toc id=sidebar-toc><div class=toc-header><div class=toc-title>ç›®å½•</div><button class=toc-toggle id=toc-toggle aria-label="Toggle TOC">
<svg class="toc-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div class=toc-content id=toc-content><ul class=toc-list><li class="toc-item toc-h2"><a href=#h2-0 class=toc-item-link><span class=toc-item-text>1. RedisåŸºç¡€é…ç½®</span></a></li><li class="toc-item toc-h2"><a href=#h2-1 class=toc-item-link><span class=toc-item-text>2. æ•°æ®ç»“æ„é€‰æ‹©ç­–ç•¥</span></a></li><li class="toc-item toc-h2"><a href=#h2-2 class=toc-item-link><span class=toc-item-text>3. æ€§èƒ½ä¼˜åŒ–æŠ€å·§</span></a></li><li class="toc-item toc-h2"><a href=#h2-3 class=toc-item-link><span class=toc-item-text>4. ç¼“å­˜ç­–ç•¥</span></a></li><li class="toc-item toc-h2"><a href=#h2-4 class=toc-item-link><span class=toc-item-text>5. åˆ†å¸ƒå¼é”</span></a></li><li class="toc-item toc-h2"><a href=#h2-5 class=toc-item-link><span class=toc-item-text>6. ç›‘æ§å’Œè¯Šæ–­</span></a></li><li class="toc-item toc-h2"><a href=#h2-6 class=toc-item-link><span class=toc-item-text>7. é›†ç¾¤å’Œå¤åˆ¶</span></a></li><li class="toc-item toc-h2"><a href=#h2-7 class=toc-item-link><span class=toc-item-text>8. æ•…éšœæ¢å¤å’Œå¤‡ä»½</span></a></li><li class="toc-item toc-h2"><a href=#h2-8 class=toc-item-link><span class=toc-item-text>9. å®‰å…¨æœ€ä½³å®è·µ</span></a></li><li class="toc-item toc-h2"><a href=#h2-9 class=toc-item-link><span class=toc-item-text>æ€»ç»“</span></a></li></ul></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("sidebar-toc"),t=document.getElementById("toc-toggle"),o=document.getElementById("toc-content"),i=t?.querySelector(".toc-toggle-icon");if(!e)return;let n=!1;t&&t.addEventListener("click",function(){n=!n,n?(o.style.display="none",e.style.width="auto",i.innerHTML='<path d="M9 18l6-6-6-6"/>'):(o.style.display="block",e.style.width="200px",i.innerHTML='<path d="M18 6L6 18M6 6l12 12"/>')});const s=document.querySelector(".post-content");if(s){const e=s.querySelectorAll("h1");e.forEach((e,t)=>{e.id=`h1-${t}`});const t=s.querySelectorAll("h2");t.forEach((e,t)=>{e.id=`h2-${t}`})}const a=document.querySelectorAll(".toc-item-link");a.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const n=this.getAttribute("href").substring(1),t=document.getElementById(n);if(t){const e=document.querySelector(".post-header-main")?.offsetHeight||0,n=t.offsetTop-e-20;window.scrollTo({top:n,behavior:"smooth"})}})})})</script><style>.sidebar-toc{position:sticky;top:2rem;width:200px;background:#fff;border:1px solid #e5e7eb;border-radius:4px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);z-index:100}.sidebar-toc.hidden{display:none}.toc-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fafbfc;display:flex;align-items:center;justify-content:space-between}.toc-title{margin:0;font-size:13px;font-weight:500;color:#374151 !important;font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,sans-serif;text-transform:uppercase;letter-spacing:1px}.toc-toggle{background:0 0;border:none;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .2s ease;color:#6b7280}.toc-toggle:hover{background:#e5e7eb;color:#374151}.toc-toggle-icon{transition:transform .2s ease}.toc-content{padding:12px 0}.toc-list{list-style:none;margin:0;padding:0}.toc-item{margin-bottom:4px;display:block !important;visibility:visible !important}.toc-h1,.toc-h2{display:block !important}.toc-h2{margin-left:0}.toc-item-link{display:flex;align-items:center;gap:8px;padding:8px 12px;color:#374151 !important;text-decoration:none;font-size:13px;line-height:1.4;border-radius:3px;transition:all .2s ease;font-weight:400}.toc-item-link:hover{background:#f8fafc;color:#1f2937 !important}.toc-item-link.active{background:#e0f2fe;color:#01579b !important;font-weight:500}.toc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.dot-red{background:#ef4444}.dot-blue{background:#2196f3}.toc-item-text{color:#1f2937 !important;font-weight:400;flex:1;display:inline !important;visibility:visible !important;opacity:1 !important;font-size:13px !important;line-height:1.4 !important}.toc-item-link .toc-item-text{color:#1f2937 !important;display:inline !important;visibility:visible !important;opacity:1 !important}.toc-item.active .dot-red{background:#d32f2f}.toc-item.active .dot-blue{background:#1976d2}[data-theme=dark] .sidebar-toc{background:#1f2937;border-color:#374151;box-shadow:0 1px 3px rgba(0,0,0,.3)}[data-theme=dark] .toc-header{background:#111827;border-color:#374151}[data-theme=dark] .toc-title{color:#f3f4f6 !important}[data-theme=dark] .toc-toggle{color:#9ca3af}[data-theme=dark] .toc-toggle:hover{background:#374151;color:#f3f4f6}[data-theme=dark] .toc-item-link{color:#e5e7eb !important}[data-theme=dark] .toc-item-link:hover{background:#374151;color:#f9fafb !important}[data-theme=dark] .toc-item-link.active{background:#0d47a1;color:#fff !important}[data-theme=dark] .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}[data-theme=dark] .toc-item-link .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}@media(max-width:1024px){.sidebar-toc{display:none}.post-content-wrapper{grid-template-columns:1fr !important;padding:0 1rem !important}}</style><style>.post-content-wrapper{display:grid;grid-template-columns:1fr 200px;gap:2rem;padding:0 2rem;max-width:100%}.post-content-main{min-width:0}.post-sidebar{position:sticky;top:2rem;height:fit-content;min-width:0}.post-header-main{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border,#333333)}.post-header-main .post-title{color:var(--primary,#ffffff) !important;font-size:2.5rem;font-weight:700;line-height:1.2;margin-bottom:1rem}.post-header-main .post-description{color:var(--secondary,#cccccc) !important;font-size:1.1rem;line-height:1.6;margin-bottom:1rem}.post-header-main .post-meta{margin-bottom:0}@media(max-width:1024px){.post-content-wrapper{grid-template-columns:1fr !important;gap:1rem;padding:0 1rem !important}.post-sidebar{display:none}}@media(max-width:768px){.post-header-main .post-title{font-size:2rem}.post-header-main .post-description{font-size:1rem}}</style></aside></div></article></main><footer class=footer><span>Â© 2024-2025 æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢</span> Â·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>