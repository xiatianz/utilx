<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨çš„åç«¯åº”ç”¨ | æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</title><meta name=keywords content="Node.jså®‰å…¨,Webå®‰å…¨,OWASP,è®¤è¯æˆæƒ,æ•°æ®åŠ å¯†,å®‰å…¨ä¸­é—´ä»¶"><meta name=description content="æœ¬æ–‡è¯¦ç»†ä»‹ç»Node.jsåº”ç”¨çš„å®‰å…¨é˜²æŠ¤ç­–ç•¥ï¼ŒåŒ…æ‹¬ä¾èµ–ç®¡ç†ã€è¾“å…¥éªŒè¯ã€è®¤è¯æˆæƒã€æ•°æ®åŠ å¯†ç­‰æ ¸å¿ƒå®‰å…¨æªæ–½ã€‚"><meta name=author content="Util Tech Team"><link rel=canonical href=/blog/articles/nodejs-security-best-practices/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.7e8505b7cdf8bb22ab2305e53c2700bb06c7e64faeb72cd3468823a9a3bd3d6e.css integrity="sha256-foUFt834uyKrIwXlPCcAuwbH5k+utyzTRogjqaO9PW4=" rel="preload stylesheet" as=style><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/blog/favicon-32x32.png><link rel=apple-touch-icon href=/blog/apple-touch-icon.png><link rel=mask-icon href=/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=/blog/articles/nodejs-security-best-practices/feed.xml title=rss><link rel=alternate hreflang=zh-cn href=/blog/articles/nodejs-security-best-practices/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><script src=/js/external-link-config.js></script><script src=/js/external-link-interceptor.js></script><link rel=stylesheet href=/blog/css/custom.css media=screen><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«","url":"https://www.util.cn/blog/","description":"æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚","publisher":{"@type":"Organization","name":"æœ‰æ¡å·¥å…·","url":"https://www.util.cn","logo":{"@type":"ImageObject","url":"https://www.util.cn/blog/logo/logo-256.png","width":256,"height":256}},"potentialAction":[{"@type":"SearchAction","target":"https://www.util.cn/blog/search?q={search_term_string}","query-input":"required name=search_term_string"}]}</script><meta property="og:type" content="website"><meta property="og:title" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta property="og:description" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚æä¾›JSONæ ¼å¼åŒ–ã€SQLä¼˜åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰åœ¨çº¿å·¥å…·çš„è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼Œå¸®åŠ©å¼€å‘è€…æå‡å·¥ä½œæ•ˆç‡ã€‚"><meta property="og:url" content="https://www.util.cn/blog/"><meta property="og:site_name" content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢"><meta property="og:image" content="https://www.util.cn/blog/logo/logo-256.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· | å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ & ç¼–ç¨‹æŠ€å·§åˆ†äº«"><meta name=twitter:description content="æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ - åˆ†äº«å¼€å‘è€…å·¥å…·ä½¿ç”¨æ•™ç¨‹ã€ç¼–ç¨‹æŠ€å·§å’Œå®æˆ˜å¼€å‘ç»éªŒã€‚"><meta name=twitter:image content="https://www.util.cn/blog/logo/logo-256.png"><meta name=baidu-site-verification content><meta name=category content="æŠ€æœ¯åšå®¢,å¼€å‘è€…å·¥å…·,ç¼–ç¨‹æ•™ç¨‹"><meta name=coverage content="Worldwide"><meta name=distribution content="Global"><meta name=rating content="General"><script id=51la_code async crossorigin=anonymous src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=pro"></script><script>window.addEventListener("load",function(){setTimeout(function(){typeof la!="undefined"?console.log("51laç»Ÿè®¡å·²åŠ è½½"):(console.warn("51laç»Ÿè®¡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"),function(){var e=document.createElement("script");e.src="https://sdk.51.la/js-sdk-pro.min.js?id=3OM52V0xJAPv6ozF&hash=backup",e.async=!0,document.head.appendChild(e)}())},3e3)})</script><meta property="og:url" content="/blog/articles/nodejs-security-best-practices/"><meta property="og:site_name" content="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·"><meta property="og:title" content="Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨çš„åç«¯åº”ç”¨"><meta property="og:description" content="æœ¬æ–‡è¯¦ç»†ä»‹ç»Node.jsåº”ç”¨çš„å®‰å…¨é˜²æŠ¤ç­–ç•¥ï¼ŒåŒ…æ‹¬ä¾èµ–ç®¡ç†ã€è¾“å…¥éªŒè¯ã€è®¤è¯æˆæƒã€æ•°æ®åŠ å¯†ç­‰æ ¸å¿ƒå®‰å…¨æªæ–½ã€‚"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-21T19:00:00+08:00"><meta property="article:modified_time" content="2025-12-21T19:00:00+08:00"><meta property="article:tag" content="Node.js"><meta property="article:tag" content="å®‰å…¨"><meta property="article:tag" content="åç«¯å¼€å‘"><meta property="article:tag" content="ç½‘ç»œå®‰å…¨"><meta property="article:tag" content="æœ€ä½³å®è·µ"><meta name=twitter:card content="summary"><meta name=twitter:title content="Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨çš„åç«¯åº”ç”¨"><meta name=twitter:description content="æœ¬æ–‡è¯¦ç»†ä»‹ç»Node.jsåº”ç”¨çš„å®‰å…¨é˜²æŠ¤ç­–ç•¥ï¼ŒåŒ…æ‹¬ä¾èµ–ç®¡ç†ã€è¾“å…¥éªŒè¯ã€è®¤è¯æˆæƒã€æ•°æ®åŠ å¯†ç­‰æ ¸å¿ƒå®‰å…¨æªæ–½ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"æ‰€æœ‰æ–‡ç« ","item":"/blog/posts/"},{"@type":"ListItem","position":2,"name":"Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨çš„åç«¯åº”ç”¨","item":"/blog/articles/nodejs-security-best-practices/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨çš„åç«¯åº”ç”¨","name":"Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨çš„åç«¯åº”ç”¨","description":"æœ¬æ–‡è¯¦ç»†ä»‹ç»Node.jsåº”ç”¨çš„å®‰å…¨é˜²æŠ¤ç­–ç•¥ï¼ŒåŒ…æ‹¬ä¾èµ–ç®¡ç†ã€è¾“å…¥éªŒè¯ã€è®¤è¯æˆæƒã€æ•°æ®åŠ å¯†ç­‰æ ¸å¿ƒå®‰å…¨æªæ–½ã€‚","keywords":["Node.jså®‰å…¨","Webå®‰å…¨","OWASP","è®¤è¯æˆæƒ","æ•°æ®åŠ å¯†","å®‰å…¨ä¸­é—´ä»¶"],"articleBody":"å¼•è¨€ éšç€Node.jsåœ¨åç«¯å¼€å‘ä¸­çš„å¹¿æ³›åº”ç”¨ï¼Œå®‰å…¨é—®é¢˜å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚ä¸€ä¸ªå®‰å…¨æ¼æ´å¯èƒ½å¯¼è‡´æ•°æ®æ³„éœ²ã€æœåŠ¡ä¸­æ–­ç”šè‡³ä¼ä¸šå£°èª‰å—æŸã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Node.jså®‰å…¨å¼€å‘çš„æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ æ„å»ºå®‰å…¨ã€å¯é çš„Webåº”ç”¨ã€‚\nOWASP Top 10é˜²æŠ¤ 1. æ³¨å…¥æ”»å‡»é˜²æŠ¤ SQLæ³¨å…¥é˜²æŠ¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 // âŒ ä¸å®‰å…¨çš„æŸ¥è¯¢ const query = `SELECT * FROM users WHERE email = '${email}'` db.query(query) // âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ const mysql = require('mysql2/promise') async function getUser(email) { const connection = await mysql.createConnection({ host: 'localhost', user: 'root', password: 'password', database: 'myapp' }) const [rows] = await connection.execute( 'SELECT * FROM users WHERE email = ?', [email] ) await connection.end() return rows[0] } // ä½¿ç”¨ORM const { Sequelize, DataTypes } = require('sequelize') const sequelize = new Sequelize('database', 'username', 'password', { host: 'localhost', dialect: 'mysql' }) const User = sequelize.define('User', { email: DataTypes.STRING, password: DataTypes.STRING }) // å®‰å…¨æŸ¥è¯¢ const user = await User.findOne({ where: { email } }) NoSQLæ³¨å…¥é˜²æŠ¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // âŒ ä¸å®‰å…¨çš„MongoDBæŸ¥è¯¢ const query = { email: req.body.email } db.users.findOne(query) // âœ… ä½¿ç”¨ç±»å‹æ£€æŸ¥å’Œè¿‡æ»¤ const { ObjectId } = require('mongodb') const { body, validationResult } = require('express-validator') async function findUser(req, res) { const errors = validationResult(req) if (!errors.isEmpty()) { return res.status(400).json({ errors: errors.array() }) } const { email } = req.body // éªŒè¯é‚®ç®±æ ¼å¼ if (!validator.isEmail(email)) { return res.status(400).json({ error: 'Invalid email format' }) } const user = await db.users.findOne({ email }) res.json(user) } 2. èº«ä»½éªŒè¯å’Œæˆæƒ JWTå®ç° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 const jwt = require('jsonwebtoken') const bcrypt = require('bcrypt') const { promisify } = require('util') const signToken = promisify(jwt.sign) const verifyToken = promisify(jwt.verify) // JWTé…ç½® const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key' const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '7d' // ç”ŸæˆToken async function generateToken(payload) { return await signToken(payload, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN, issuer: 'your-app', audience: 'your-users' }) } // éªŒè¯Tokenä¸­é—´ä»¶ async function authenticateToken(req, res, next) { try { const authHeader = req.headers['authorization'] const token = authHeader \u0026\u0026 authHeader.split(' ')[1] if (!token) { return res.status(401).json({ error: 'Access token required' }) } const decoded = await verifyToken(token, JWT_SECRET) req.user = decoded next() } catch (error) { return res.status(403).json({ error: 'Invalid or expired token' }) } } // è§’è‰²æˆæƒä¸­é—´ä»¶ function authorize(roles) { return (req, res, next) =\u003e { if (!req.user) { return res.status(401).json({ error: 'Authentication required' }) } if (!roles.includes(req.user.role)) { return res.status(403).json({ error: 'Insufficient permissions' }) } next() } } // ä½¿ç”¨ç¤ºä¾‹ app.get('/admin/users', authenticateToken, authorize(['admin']), async (req, res) =\u003e { // ç®¡ç†å‘˜åŠŸèƒ½ } ) å¯†ç å®‰å…¨å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 const bcrypt = require('bcrypt') const crypto = require('crypto') // å¯†ç å“ˆå¸Œ async function hashPassword(password) { const saltRounds = 12 return await bcrypt.hash(password, saltRounds) } // éªŒè¯å¯†ç  async function verifyPassword(password, hash) { return await bcrypt.compare(password, hash) } // å¯†ç é‡ç½®Token function generateResetToken() { return crypto.randomBytes(32).toString('hex') } // å¯†ç éªŒè¯è§„åˆ™ const passwordPolicy = { minLength: 8, requireUppercase: true, requireLowercase: true, requireNumbers: true, requireSpecialChars: true } function validatePassword(password) { const errors = [] if (password.length \u003c passwordPolicy.minLength) { errors.push(`Password must be at least ${passwordPolicy.minLength} characters`) } if (passwordPolicy.requireUppercase \u0026\u0026 !/[A-Z]/.test(password)) { errors.push('Password must contain uppercase letters') } if (passwordPolicy.requireLowercase \u0026\u0026 !/[a-z]/.test(password)) { errors.push('Password must contain lowercase letters') } if (passwordPolicy.requireNumbers \u0026\u0026 !/\\d/.test(password)) { errors.push('Password must contain numbers') } if (passwordPolicy.requireSpecialChars \u0026\u0026 !/[!@#$%^\u0026*]/.test(password)) { errors.push('Password must contain special characters') } return errors } 3. æ•°æ®åŠ å¯† æ•æ„Ÿæ•°æ®åŠ å¯† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 const crypto = require('crypto') class EncryptionService { constructor(algorithm = 'aes-256-gcm', secretKey = process.env.ENCRYPTION_KEY) { this.algorithm = algorithm this.secretKey = Buffer.from(secretKey, 'hex') this.ivLength = 16 this.tagLength = 16 } encrypt(text) { const iv = crypto.randomBytes(this.ivLength) const cipher = crypto.createCipher(this.algorithm, this.secretKey) cipher.setAAD(Buffer.from('additional-data')) let encrypted = cipher.update(text, 'utf8', 'hex') encrypted += cipher.final('hex') const tag = cipher.getAuthTag() return { iv: iv.toString('hex'), encryptedData: encrypted, tag: tag.toString('hex') } } decrypt(encryptedData) { const decipher = crypto.createDecipher(this.algorithm, this.secretKey) decipher.setAAD(Buffer.from('additional-data')) decipher.setAuthTag(Buffer.from(encryptedData.tag, 'hex')) let decrypted = decipher.update(encryptedData.encryptedData, 'hex', 'utf8') decrypted += decipher.final('utf8') return decrypted } } // ä½¿ç”¨ç¤ºä¾‹ const encryption = new EncryptionService() // åŠ å¯†ç”¨æˆ·æ•æ„Ÿä¿¡æ¯ const userData = { name: 'John Doe', email: 'john@example.com', ssn: encryption.encrypt('123-45-6789') } // è§£å¯† const decryptedSSN = encryption.decrypt(userData.ssn) HTTPSé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 const https = require('https') const fs = require('fs') // HTTPSæœåŠ¡å™¨é…ç½® const httpsOptions = { key: fs.readFileSync('/path/to/private.key'), cert: fs.readFileSync('/path/to/certificate.crt'), ca: fs.readFileSync('/path/to/ca_bundle.crt'), minVersion: 'TLSv1.2', ciphers: [ 'ECDHE-ECDSA-AES256-GCM-SHA384', 'ECDHE-RSA-AES256-GCM-SHA384', 'ECDHE-ECDSA-CHACHA20-POLY1305', 'ECDHE-RSA-CHACHA20-POLY1305', 'ECDHE-ECDSA-AES128-GCM-SHA256', 'ECDHE-RSA-AES128-GCM-SHA256' ].join(':'), honorCipherOrder: true } const app = express() const server = https.createServer(httpsOptions, app) // HSTSä¸­é—´ä»¶ app.use((req, res, next) =\u003e { res.setHeader( 'Strict-Transport-Security', 'max-age=31536000; includeSubDomains; preload' ) next() }) 4. å®‰å…¨å¤´éƒ¨é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 const helmet = require('helmet') // åŸºç¡€å®‰å…¨å¤´éƒ¨ app.use(helmet()) // è‡ªå®šä¹‰å®‰å…¨å¤´éƒ¨ app.use(helmet({ contentSecurityPolicy: { directives: { defaultSrc: [\"'self'\"], styleSrc: [\"'self'\", \"'unsafe-inline'\", \"https://fonts.googleapis.com\"], scriptSrc: [\"'self'\", \"'unsafe-inline'\", \"https://cdn.trusted.com\"], imgSrc: [\"'self'\", \"data:\", \"https:\"], connectSrc: [\"'self'\", \"https://api.example.com\"], fontSrc: [\"'self'\", \"https://fonts.gstatic.com\"], objectSrc: [\"'none'\"], mediaSrc: [\"'self'\"], frameSrc: [\"'none'\"], manifestSrc: [\"'self'\"], workerSrc: [\"'self'\"] } }, crossOriginEmbedderPolicy: false, hsts: { maxAge: 31536000, includeSubDomains: true, preload: true } })) // CORSé…ç½® const cors = require('cors') const corsOptions = { origin: function (origin, callback) { const allowedOrigins = [ 'https://example.com', 'https://app.example.com' ] if (!origin || allowedOrigins.includes(origin)) { callback(null, true) } else { callback(new Error('Not allowed by CORS')) } }, credentials: true, optionsSuccessStatus: 200 } app.use(cors(corsOptions)) è¾“å…¥éªŒè¯å’Œæ¸…ç† Express-validatoré›†æˆ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 const { body, param, query, validationResult } = require('express-validator') const { sanitizeBody } = require('express-validator') // ç”¨æˆ·æ³¨å†ŒéªŒè¯ const validateUserRegistration = [ body('email') .isEmail() .normalizeEmail() .withMessage('Valid email required'), body('password') .isLength({ min: 8 }) .withMessage('Password must be at least 8 characters') .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?\u0026])[A-Za-z\\d@$!%*?\u0026]/) .withMessage('Password must include uppercase, lowercase, number and special character'), body('name') .trim() .isLength({ min: 2, max: 50 }) .escape() .withMessage('Name must be between 2 and 50 characters'), body('age') .optional() .isInt({ min: 13, max: 120 }) .withMessage('Age must be between 13 and 120') ] // æ¸…ç†è¾“å…¥æ•°æ® const sanitizeInput = [ sanitizeBody('bio').escape(), sanitizeBody('website').escape(), sanitizeBody('location').escape() ] // éªŒè¯ç»“æœå¤„ç†ä¸­é—´ä»¶ function handleValidationErrors(req, res, next) { const errors = validationResult(req) if (!errors.isEmpty()) { return res.status(400).json({ error: 'Validation failed', details: errors.array() }) } next() } // ä½¿ç”¨ç¤ºä¾‹ app.post('/api/users', validateUserRegistration, sanitizeInput, handleValidationErrors, async (req, res) =\u003e { // å¤„ç†ç”¨æˆ·æ³¨å†Œ } ) XSSé˜²æŠ¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 const xss = require('xss') const validator = require('validator') // XSSè¿‡æ»¤å™¨é…ç½® const xssOptions = { whiteList: { a: ['href', 'title', 'target'], b: [], br: [], em: [], strong: [], i: [], li: [], ol: [], p: [], ul: [] }, stripIgnoreTag: true, stripIgnoreTagBody: ['script'] } // æ¸…ç†ç”¨æˆ·è¾“å…¥ function sanitizeInput(input) { if (typeof input === 'string') { return xss(validator.escape(input), xssOptions) } if (typeof input === 'object' \u0026\u0026 input !== null) { const sanitized = {} for (const [key, value] of Object.entries(input)) { sanitized[key] = sanitizeInput(value) } return sanitized } return input } // ä¸­é—´ä»¶ function sanitizeRequest(req, res, next) { req.body = sanitizeInput(req.body) req.query = sanitizeInput(req.query) req.params = sanitizeInput(req.params) next() } app.use(sanitizeRequest) æ–‡ä»¶ä¸Šä¼ å®‰å…¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 const multer = require('multer') const path = require('path') const fs = require('fs') // æ–‡ä»¶è¿‡æ»¤å™¨ const fileFilter = (req, file, cb) =\u003e { const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'] if (allowedTypes.includes(file.mimetype)) { cb(null, true) } else { cb(new Error('Invalid file type'), false) } } // å­˜å‚¨é…ç½® const storage = multer.diskStorage({ destination: (req, file, cb) =\u003e { const uploadDir = 'uploads/' if (!fs.existsSync(uploadDir)) { fs.mkdirSync(uploadDir, { recursive: true }) } cb(null, uploadDir) }, filename: (req, file, cb) =\u003e { // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9) cb(null, uniqueSuffix + path.extname(file.originalname)) } }) const upload = multer({ storage, fileFilter, limits: { fileSize: 5 * 1024 * 1024, // 5MB files: 1 } }) // ç—…æ¯’æ‰«æé›†æˆ const ClamScan = require('clamscan') async function scanFile(filePath) { try { const clamscan = await new ClamScan().init() const scanResult = await clamscan.scanFile(filePath) return scanResult.isInfected } catch (error) { console.error('Virus scan error:', error) return true // ä¿å®ˆå¤„ç†ï¼Œè®¤ä¸ºå¯èƒ½æ„ŸæŸ“ } } // æ–‡ä»¶ä¸Šä¼ è·¯ç”± app.post('/upload', upload.single('file'), async (req, res) =\u003e { try { if (!req.file) { return res.status(400).json({ error: 'No file uploaded' }) } // ç—…æ¯’æ‰«æ const isInfected = await scanFile(req.file.path) if (isInfected) { fs.unlinkSync(req.file.path) return res.status(400).json({ error: 'File contains virus' }) } res.json({ message: 'File uploaded successfully', file: { filename: req.file.filename, originalName: req.file.originalname, size: req.file.size } }) } catch (error) { if (req.file) { fs.unlinkSync(req.file.path) } res.status(500).json({ error: 'Upload failed' }) } }) ä¾èµ–å®‰å…¨ ä¾èµ–æ¼æ´æ‰«æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // ä½¿ç”¨npm audit { \"scripts\": { \"audit\": \"npm audit\", \"audit:fix\": \"npm audit fix\", \"security-check\": \"npm audit --audit-level moderate\" } } // ä½¿ç”¨Snykè¿›è¡Œå®‰å…¨æ‰«æ const snyk = require('snyk') async function checkVulnerabilities() { try { await snyk.test() console.log('No vulnerabilities found') } catch (error) { console.error('Vulnerabilities detected:', error) process.exit(1) } } // CI/CDé›†æˆ if (process.env.CI) { checkVulnerabilities() } å®‰å…¨çš„ä¾èµ–ç®¡ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # package.jsoné…ç½® { \"engines\": { \"node\": \"\u003e=14.0.0\", \"npm\": \"\u003e=6.0.0\" }, \"dependencies\": { \"express\": \"4.17.1\", // é”å®šç‰ˆæœ¬ \"lodash\": \"^4.17.20\" // å…è®¸è¡¥ä¸æ›´æ–° }, \"overrides\": { \"lodash\": { \"node\": \"^14.17.0\" // è¦†ç›–å­ä¾èµ– } } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // è¿è¡Œæ—¶ä¾èµ–éªŒè¯ const { execSync } = require('child_process') const semver = require('semver') function checkNodeVersion() { const nodeVersion = process.version const minVersion = require('../package.json').engines.node.replace('\u003e=', '') if (!semver.satisfies(nodeVersion, minVersion)) { console.error(`Node.js version ${nodeVersion} is not supported. Please use ${minVersion}`) process.exit(1) } } function checkDependencies() { try { const output = execSync('npm ls --depth=0', { encoding: 'utf8' }) const lines = output.split('\\n') for (const line of lines) { if (line.includes('UNMET DEPENDENCY')) { throw new Error('Unmet dependencies detected') } } } catch (error) { console.error('Dependency check failed:', error.message) process.exit(1) } } // åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥ checkNodeVersion() checkDependencies() é”™è¯¯å¤„ç†å’Œæ—¥å¿— å®‰å…¨çš„é”™è¯¯å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 // ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶ function errorHandler(err, req, res, next) { // è®°å½•é”™è¯¯ï¼ˆä¸æš´éœ²æ•æ„Ÿä¿¡æ¯ï¼‰ console.error('Error:', { message: err.message, stack: process.env.NODE_ENV === 'development' ? err.stack : undefined, timestamp: new Date().toISOString(), requestId: req.id, path: req.path, method: req.method }) // ä¸æš´éœ²å†…éƒ¨é”™è¯¯è¯¦æƒ… let statusCode = 500 let message = 'Internal Server Error' if (err.name === 'ValidationError') { statusCode = 400 message = err.message } else if (err.name === 'UnauthorizedError') { statusCode = 401 message = 'Unauthorized' } else if (err.name === 'ForbiddenError') { statusCode = 403 message = 'Forbidden' } else if (err.name === 'NotFoundError') { statusCode = 404 message = 'Resource not found' } res.status(statusCode).json({ error: message, requestId: req.id, timestamp: new Date().toISOString() }) } app.use(errorHandler) å®‰å…¨æ—¥å¿—è®°å½• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 const winston = require('winston') const { requestId } = require('./middleware/requestId') // æ—¥å¿—é…ç½® const logger = winston.createLogger({ level: 'info', format: winston.format.combine( winston.format.timestamp(), winston.format.errors({ stack: true }), winston.format.json() ), defaultMeta: { service: 'api-service' }, transports: [ new winston.transports.File({ filename: 'logs/error.log', level: 'error' }), new winston.transports.File({ filename: 'logs/combined.log' }) ] }) if (process.env.NODE_ENV !== 'production') { logger.add(new winston.transports.Console({ format: winston.format.simple() })) } // å®‰å…¨äº‹ä»¶æ—¥å¿— function logSecurityEvent(event, req, details = {}) { logger.warn('Security Event', { event, ip: req.ip, userAgent: req.get('User-Agent'), requestId: req.id, timestamp: new Date().toISOString(), ...details }) } // ä½¿ç”¨ç¤ºä¾‹ app.use((req, res, next) =\u003e { req.id = Math.random().toString(36).substr(2, 9) // è®°å½•æ•æ„Ÿæ“ä½œ if (req.path.includes('/admin') || req.path.includes('/auth')) { logSecurityEvent('Sensitive Access', req, { path: req.path, method: req.method }) } next() }) ä¼šè¯å’ŒCookieå®‰å…¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 const session = require('express-session') const cookieParser = require('cookie-parser') const MongoStore = require('connect-mongo')(session) // ä¼šè¯é…ç½® const sessionConfig = { name: 'sessionId', // é¿å…é»˜è®¤åç§° secret: process.env.SESSION_SECRET, resave: false, saveUninitialized: false, store: new MongoStore({ url: process.env.MONGODB_URI, collection: 'sessions' }), cookie: { httpOnly: true, // é˜²æ­¢XSS secure: process.env.NODE_ENV === 'production', // HTTPS only sameSite: 'strict', // CSRFé˜²æŠ¤ maxAge: 24 * 60 * 60 * 1000 // 24å°æ—¶ } } app.use(session(sessionConfig)) // é€Ÿç‡é™åˆ¶ const rateLimit = require('express-rate-limit') const loginLimiter = rateLimit({ windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ max: 5, // é™åˆ¶5æ¬¡å°è¯• skipSuccessfulRequests: true, handler: (req, res) =\u003e { logSecurityEvent('Rate Limit Exceeded', req, { endpoint: '/login', attempts: 5 }) res.status(429).json({ error: 'Too many login attempts' }) } }) app.post('/login', loginLimiter, async (req, res) =\u003e { // ç™»å½•é€»è¾‘ }) æ€»ç»“ Node.jsåº”ç”¨å®‰å…¨éœ€è¦å¤šå±‚æ¬¡çš„é˜²æŠ¤ç­–ç•¥ï¼š\nåŸºç¡€é˜²æŠ¤ï¼š\nè¾“å…¥éªŒè¯å’Œæ¸…ç† è¾“å‡ºç¼–ç å’ŒXSSé˜²æŠ¤ SQL/NoSQLæ³¨å…¥é˜²æŠ¤ æ–‡ä»¶ä¸Šä¼ å®‰å…¨ è®¤è¯å’Œæˆæƒï¼š\nå¼ºå¯†ç ç­–ç•¥ å®‰å…¨çš„ä¼šè¯ç®¡ç† JWTä»¤ç‰Œå®‰å…¨ è§’è‰²æƒé™æ§åˆ¶ æ•°æ®ä¿æŠ¤ï¼š\nHTTPSåŠ å¯†ä¼ è¾“ æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨ å®‰å…¨å¤´éƒ¨é…ç½® ä¾èµ–æ¼æ´ç®¡ç† ç›‘æ§å’Œå“åº”ï¼š\nå®‰å…¨äº‹ä»¶æ—¥å¿— é”™è¯¯å¤„ç†æœºåˆ¶ é€Ÿç‡é™åˆ¶ å®‰å…¨å®¡è®¡ éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œå¯ä»¥å¤§å¤§æé«˜Node.jsåº”ç”¨çš„å®‰å…¨æ€§ï¼Œä¿æŠ¤åº”ç”¨å’Œç”¨æˆ·æ•°æ®å…å—æ”»å‡»ã€‚\nç›¸å…³èµ„æºï¼š\nOWASP Top 10 Node.js Security Checklist Express Security Best Practices Snyk Vulnerability Database ","wordCount":"2498","inLanguage":"zh-cn","datePublished":"2025-12-21T19:00:00+08:00","dateModified":"2025-12-21T19:00:00+08:00","author":{"@type":"Person","name":"Util Tech Team"},"mainEntityOfPage":{"@type":"WebPage","@id":"/blog/articles/nodejs-security-best-practices/"},"publisher":{"@type":"Organization","name":"æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·","logo":{"@type":"ImageObject","url":"/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=/blog/ accesskey=h title="æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…· (Alt + H)">æŠ€æœ¯åšå®¢ - æœ‰æ¡å·¥å…·</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=/blog/posts/ title="æ‰€æœ‰æ–‡ç« åˆ—è¡¨ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŸ¥çœ‹æ‰€æœ‰æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ–‡ç« </span></a></li><li><a href=https://www.util.cn title="æœ‰æ¡å·¥å…· - å¼€å‘è€…çš„å¸¸ç”¨å·¥å…·é›†åˆï¼šæ— å¹¿å‘Š Â· æœ¬åœ°è®¡ç®— Â· å³å¼€å³ç”¨çš„åœ¨çº¿å·¥å…·å¹³å°ï¼Œæä¾›JSONæ ¼å¼åŒ–ã€SQLæ ¼å¼åŒ–ã€Markdownç¼–è¾‘å™¨ç­‰å®ç”¨å·¥å…·"><span>æœ‰æ¡å·¥å…·</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=/blog/categories/ title="æ–‡ç« åˆ†ç±» - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æŠ€æœ¯é¢†åŸŸåˆ†ç±»çš„ä¼˜è´¨æ–‡ç« ï¼ŒåŒ…æ‹¬å‰ç«¯å¼€å‘ã€å·¥å…·ä½¿ç”¨ã€ç¼–ç¨‹æŠ€å·§ç­‰"><span>åˆ†ç±»</span></a></li><li><a href=/blog/tags/ title="æ ‡ç­¾äº‘ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡æ ‡ç­¾å¿«é€Ÿæ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹"><span>æ ‡ç­¾</span></a></li><li><a href=/blog/archives/ title="æ–‡ç« å½’æ¡£ - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šæŒ‰æ—¶é—´æŸ¥çœ‹å†å²æ–‡ç« "><span>å½’æ¡£</span></a></li><li><a href=/blog/search/ title="æœç´¢æ–‡ç«  - æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢ï¼šé€šè¿‡å…³é”®è¯æœç´¢æ‰¾åˆ°æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« å’Œæ•™ç¨‹å†…å®¹ï¼Œæ”¯æŒæ ‡é¢˜ã€å†…å®¹ã€åˆ†ç±»å’Œæ ‡ç­¾æœç´¢"><span>æœç´¢</span></a></li></ul></nav></header><main class=main><article class=post-single><div class=post-content-wrapper><main class=post-content-main><header class=post-header-main><h1 class="post-title entry-hint-parent">Node.jså®‰å…¨æœ€ä½³å®è·µï¼šæ„å»ºå®‰å…¨çš„åç«¯åº”ç”¨</h1><div class=post-description>æœ¬æ–‡è¯¦ç»†ä»‹ç»Node.jsåº”ç”¨çš„å®‰å…¨é˜²æŠ¤ç­–ç•¥ï¼ŒåŒ…æ‹¬ä¾èµ–ç®¡ç†ã€è¾“å…¥éªŒè¯ã€è®¤è¯æˆæƒã€æ•°æ®åŠ å¯†ç­‰æ ¸å¿ƒå®‰å…¨æªæ–½ã€‚</div><div class=post-meta><div class=post-meta-content><div class=post-categories-inline><a href=/blog/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/ class=category-link>åç«¯å¼€å‘</a><a href=/blog/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/ class=category-link>ç½‘ç»œå®‰å…¨</a></div><span class=post-date>2025-12-21</span><span class=post-author>Util Tech Team</span></div><style>.post-meta-content{display:flex;align-items:center;flex-wrap:wrap;gap:.75rem;font-family:sf mono,monaco,courier new,monospace;font-size:.875rem;color:#9ca3af !important}.post-categories-inline{display:inline-flex;align-items:center;gap:.5rem}.category-link{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .75rem;background:rgba(255,255,255,.1);color:#e5e7eb !important;text-decoration:none;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border:1px solid rgba(255,255,255,.2);border-radius:0;transition:all .3s ease;white-space:nowrap}.category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3);transform:translateY(-1px)}.category-link::before{content:'ğŸ“';font-size:.7rem;opacity:.8}.post-date,.post-reading-time,.post-word-count,.post-author{color:#9ca3af !important}[data-theme=dark] .post-meta-content{color:#9ca3af !important}[data-theme=dark] .category-link{background:rgba(255,255,255,.1);color:#e5e7eb !important;border-color:rgba(255,255,255,.2)}[data-theme=dark] .category-link:hover{background:rgba(255,255,255,.2);color:#fff !important;border-color:rgba(255,255,255,.3)}[data-theme=dark] .post-date,[data-theme=dark] .post-reading-time,[data-theme=dark] .post-word-count,[data-theme=dark] .post-author{color:#9ca3af !important}[data-theme=light] .post-meta-content{color:#6c757d !important}[data-theme=light] .category-link{background:rgba(0,0,0,5%);color:#495057 !important;border-color:rgba(0,0,0,.15)}[data-theme=light] .category-link:hover{background:rgba(0,102,204,.1);color:#212529 !important;border-color:rgba(0,102,204,.3)}[data-theme=light] .post-date,[data-theme=light] .post-reading-time,[data-theme=light] .post-word-count,[data-theme=light] .post-author{color:#6c757d !important}@media(max-width:768px){.post-meta-content{gap:.5rem;font-size:.8rem}.category-link{padding:.2rem .6rem;font-size:.7rem}}</style></div></header><div class=post-content><h2 id=å¼•è¨€>å¼•è¨€<a hidden class=anchor aria-hidden=true href=#å¼•è¨€>#</a></h2><p>éšç€Node.jsåœ¨åç«¯å¼€å‘ä¸­çš„å¹¿æ³›åº”ç”¨ï¼Œå®‰å…¨é—®é¢˜å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚ä¸€ä¸ªå®‰å…¨æ¼æ´å¯èƒ½å¯¼è‡´æ•°æ®æ³„éœ²ã€æœåŠ¡ä¸­æ–­ç”šè‡³ä¼ä¸šå£°èª‰å—æŸã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Node.jså®‰å…¨å¼€å‘çš„æœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ æ„å»ºå®‰å…¨ã€å¯é çš„Webåº”ç”¨ã€‚</p><h2 id=owasp-top-10é˜²æŠ¤>OWASP Top 10é˜²æŠ¤<a hidden class=anchor aria-hidden=true href=#owasp-top-10é˜²æŠ¤>#</a></h2><h3 id=1-æ³¨å…¥æ”»å‡»é˜²æŠ¤>1. æ³¨å…¥æ”»å‡»é˜²æŠ¤<a hidden class=anchor aria-hidden=true href=#1-æ³¨å…¥æ”»å‡»é˜²æŠ¤>#</a></h3><h4 id=sqlæ³¨å…¥é˜²æŠ¤>SQLæ³¨å…¥é˜²æŠ¤<a hidden class=anchor aria-hidden=true href=#sqlæ³¨å…¥é˜²æŠ¤>#</a></h4><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// âŒ ä¸å®‰å…¨çš„æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> query <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>`SELECT * FROM users WHERE email = &#39;</span><span style=color:#a5d6ff>${</span>email<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#39;`</span>
</span></span><span style=display:flex><span>db.query(query)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> mysql <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;mysql2/promise&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> getUser(email) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> connection <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> mysql.createConnection({
</span></span><span style=display:flex><span>    host<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;localhost&#39;</span>,
</span></span><span style=display:flex><span>    user<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;root&#39;</span>,
</span></span><span style=display:flex><span>    password<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;password&#39;</span>,
</span></span><span style=display:flex><span>    database<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;myapp&#39;</span>
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> [rows] <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> connection.execute(
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;SELECT * FROM users WHERE email = ?&#39;</span>,
</span></span><span style=display:flex><span>    [email]
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>await</span> connection.end()
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> rows[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ORM
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> { Sequelize, DataTypes } <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;sequelize&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> sequelize <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> Sequelize(<span style=color:#a5d6ff>&#39;database&#39;</span>, <span style=color:#a5d6ff>&#39;username&#39;</span>, <span style=color:#a5d6ff>&#39;password&#39;</span>, {
</span></span><span style=display:flex><span>  host<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;localhost&#39;</span>,
</span></span><span style=display:flex><span>  dialect<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;mysql&#39;</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> User <span style=color:#ff7b72;font-weight:700>=</span> sequelize.define(<span style=color:#a5d6ff>&#39;User&#39;</span>, {
</span></span><span style=display:flex><span>  email<span style=color:#ff7b72;font-weight:700>:</span> DataTypes.STRING,
</span></span><span style=display:flex><span>  password<span style=color:#ff7b72;font-weight:700>:</span> DataTypes.STRING
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å®‰å…¨æŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> user <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> User.findOne({ where<span style=color:#ff7b72;font-weight:700>:</span> { email } })
</span></span></code></pre></td></tr></table></div></div><h4 id=nosqlæ³¨å…¥é˜²æŠ¤>NoSQLæ³¨å…¥é˜²æŠ¤<a hidden class=anchor aria-hidden=true href=#nosqlæ³¨å…¥é˜²æŠ¤>#</a></h4><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// âŒ ä¸å®‰å…¨çš„MongoDBæŸ¥è¯¢
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> query <span style=color:#ff7b72;font-weight:700>=</span> { email<span style=color:#ff7b72;font-weight:700>:</span> req.body.email }
</span></span><span style=display:flex><span>db.users.findOne(query)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// âœ… ä½¿ç”¨ç±»å‹æ£€æŸ¥å’Œè¿‡æ»¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> { ObjectId } <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;mongodb&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> { body, validationResult } <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;express-validator&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> findUser(req, res) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> errors <span style=color:#ff7b72;font-weight:700>=</span> validationResult(req)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>errors.isEmpty()) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ errors<span style=color:#ff7b72;font-weight:700>:</span> errors.array() })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> { email } <span style=color:#ff7b72;font-weight:700>=</span> req.body
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// éªŒè¯é‚®ç®±æ ¼å¼
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>validator.isEmail(email)) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Invalid email format&#39;</span> })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> user <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> db.users.findOne({ email })
</span></span><span style=display:flex><span>  res.json(user)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=2-èº«ä»½éªŒè¯å’Œæˆæƒ>2. èº«ä»½éªŒè¯å’Œæˆæƒ<a hidden class=anchor aria-hidden=true href=#2-èº«ä»½éªŒè¯å’Œæˆæƒ>#</a></h3><h4 id=jwtå®ç°>JWTå®ç°<a hidden class=anchor aria-hidden=true href=#jwtå®ç°>#</a></h4><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> jwt <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;jsonwebtoken&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> bcrypt <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;bcrypt&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> { promisify } <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;util&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> signToken <span style=color:#ff7b72;font-weight:700>=</span> promisify(jwt.sign)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> verifyToken <span style=color:#ff7b72;font-weight:700>=</span> promisify(jwt.verify)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// JWTé…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> JWT_SECRET <span style=color:#ff7b72;font-weight:700>=</span> process.env.JWT_SECRET <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>&#39;your-secret-key&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> JWT_EXPIRES_IN <span style=color:#ff7b72;font-weight:700>=</span> process.env.JWT_EXPIRES_IN <span style=color:#ff7b72;font-weight:700>||</span> <span style=color:#a5d6ff>&#39;7d&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç”ŸæˆToken
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> generateToken(payload) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> signToken(payload, JWT_SECRET, {
</span></span><span style=display:flex><span>    expiresIn<span style=color:#ff7b72;font-weight:700>:</span> JWT_EXPIRES_IN,
</span></span><span style=display:flex><span>    issuer<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;your-app&#39;</span>,
</span></span><span style=display:flex><span>    audience<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;your-users&#39;</span>
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// éªŒè¯Tokenä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> authenticateToken(req, res, next) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> authHeader <span style=color:#ff7b72;font-weight:700>=</span> req.headers[<span style=color:#a5d6ff>&#39;authorization&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> token <span style=color:#ff7b72;font-weight:700>=</span> authHeader <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> authHeader.split(<span style=color:#a5d6ff>&#39; &#39;</span>)[<span style=color:#a5d6ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>token) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>401</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Access token required&#39;</span> })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> decoded <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> verifyToken(token, JWT_SECRET)
</span></span><span style=display:flex><span>    req.user <span style=color:#ff7b72;font-weight:700>=</span> decoded
</span></span><span style=display:flex><span>    next()
</span></span><span style=display:flex><span>  } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>403</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Invalid or expired token&#39;</span> })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è§’è‰²æˆæƒä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>function</span> authorize(roles) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> (req, res, next) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>req.user) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>401</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Authentication required&#39;</span> })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>roles.includes(req.user.role)) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>403</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Insufficient permissions&#39;</span> })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    next()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.get(<span style=color:#a5d6ff>&#39;/admin/users&#39;</span>,
</span></span><span style=display:flex><span>  authenticateToken,
</span></span><span style=display:flex><span>  authorize([<span style=color:#a5d6ff>&#39;admin&#39;</span>]),
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ç®¡ç†å‘˜åŠŸèƒ½
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  }
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><h4 id=å¯†ç å®‰å…¨å¤„ç†>å¯†ç å®‰å…¨å¤„ç†<a hidden class=anchor aria-hidden=true href=#å¯†ç å®‰å…¨å¤„ç†>#</a></h4><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> bcrypt <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;bcrypt&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> crypto <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;crypto&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¯†ç å“ˆå¸Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> hashPassword(password) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> saltRounds <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>12</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> bcrypt.hash(password, saltRounds)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// éªŒè¯å¯†ç 
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> verifyPassword(password, hash) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> <span style=color:#ff7b72>await</span> bcrypt.compare(password, hash)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¯†ç é‡ç½®Token
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>function</span> generateResetToken() {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> crypto.randomBytes(<span style=color:#a5d6ff>32</span>).toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å¯†ç éªŒè¯è§„åˆ™
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> passwordPolicy <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>  minLength<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>8</span>,
</span></span><span style=display:flex><span>  requireUppercase<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>  requireLowercase<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>  requireNumbers<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>  requireSpecialChars<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>function</span> validatePassword(password) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> errors <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (password.length <span style=color:#ff7b72;font-weight:700>&lt;</span> passwordPolicy.minLength) {
</span></span><span style=display:flex><span>    errors.push(<span style=color:#a5d6ff>`Password must be at least </span><span style=color:#a5d6ff>${</span>passwordPolicy.minLength<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> characters`</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (passwordPolicy.requireUppercase <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#ff7b72;font-weight:700>!</span><span style=color:#79c0ff>/[A-Z]/</span>.test(password)) {
</span></span><span style=display:flex><span>    errors.push(<span style=color:#a5d6ff>&#39;Password must contain uppercase letters&#39;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (passwordPolicy.requireLowercase <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#ff7b72;font-weight:700>!</span><span style=color:#79c0ff>/[a-z]/</span>.test(password)) {
</span></span><span style=display:flex><span>    errors.push(<span style=color:#a5d6ff>&#39;Password must contain lowercase letters&#39;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (passwordPolicy.requireNumbers <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#ff7b72;font-weight:700>!</span><span style=color:#79c0ff>/\d/</span>.test(password)) {
</span></span><span style=display:flex><span>    errors.push(<span style=color:#a5d6ff>&#39;Password must contain numbers&#39;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (passwordPolicy.requireSpecialChars <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> <span style=color:#ff7b72;font-weight:700>!</span><span style=color:#79c0ff>/[!@#$%^&amp;*]/</span>.test(password)) {
</span></span><span style=display:flex><span>    errors.push(<span style=color:#a5d6ff>&#39;Password must contain special characters&#39;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> errors
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=3-æ•°æ®åŠ å¯†>3. æ•°æ®åŠ å¯†<a hidden class=anchor aria-hidden=true href=#3-æ•°æ®åŠ å¯†>#</a></h3><h4 id=æ•æ„Ÿæ•°æ®åŠ å¯†>æ•æ„Ÿæ•°æ®åŠ å¯†<a hidden class=anchor aria-hidden=true href=#æ•æ„Ÿæ•°æ®åŠ å¯†>#</a></h4><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> crypto <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;crypto&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> EncryptionService {
</span></span><span style=display:flex><span>  constructor(algorithm <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;aes-256-gcm&#39;</span>, secretKey <span style=color:#ff7b72;font-weight:700>=</span> process.env.ENCRYPTION_KEY) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.algorithm <span style=color:#ff7b72;font-weight:700>=</span> algorithm
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.secretKey <span style=color:#ff7b72;font-weight:700>=</span> Buffer.from(secretKey, <span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.ivLength <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>16</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>this</span>.tagLength <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>16</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  encrypt(text) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> iv <span style=color:#ff7b72;font-weight:700>=</span> crypto.randomBytes(<span style=color:#ff7b72>this</span>.ivLength)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> cipher <span style=color:#ff7b72;font-weight:700>=</span> crypto.createCipher(<span style=color:#ff7b72>this</span>.algorithm, <span style=color:#ff7b72>this</span>.secretKey)
</span></span><span style=display:flex><span>    cipher.setAAD(Buffer.from(<span style=color:#a5d6ff>&#39;additional-data&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>let</span> encrypted <span style=color:#ff7b72;font-weight:700>=</span> cipher.update(text, <span style=color:#a5d6ff>&#39;utf8&#39;</span>, <span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>    encrypted <span style=color:#ff7b72;font-weight:700>+=</span> cipher.<span style=color:#ff7b72>final</span>(<span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> tag <span style=color:#ff7b72;font-weight:700>=</span> cipher.getAuthTag()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> {
</span></span><span style=display:flex><span>      iv<span style=color:#ff7b72;font-weight:700>:</span> iv.toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>),
</span></span><span style=display:flex><span>      encryptedData<span style=color:#ff7b72;font-weight:700>:</span> encrypted,
</span></span><span style=display:flex><span>      tag<span style=color:#ff7b72;font-weight:700>:</span> tag.toString(<span style=color:#a5d6ff>&#39;hex&#39;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  decrypt(encryptedData) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> decipher <span style=color:#ff7b72;font-weight:700>=</span> crypto.createDecipher(<span style=color:#ff7b72>this</span>.algorithm, <span style=color:#ff7b72>this</span>.secretKey)
</span></span><span style=display:flex><span>    decipher.setAAD(Buffer.from(<span style=color:#a5d6ff>&#39;additional-data&#39;</span>))
</span></span><span style=display:flex><span>    decipher.setAuthTag(Buffer.from(encryptedData.tag, <span style=color:#a5d6ff>&#39;hex&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>let</span> decrypted <span style=color:#ff7b72;font-weight:700>=</span> decipher.update(encryptedData.encryptedData, <span style=color:#a5d6ff>&#39;hex&#39;</span>, <span style=color:#a5d6ff>&#39;utf8&#39;</span>)
</span></span><span style=display:flex><span>    decrypted <span style=color:#ff7b72;font-weight:700>+=</span> decipher.<span style=color:#ff7b72>final</span>(<span style=color:#a5d6ff>&#39;utf8&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> decrypted
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> encryption <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>new</span> EncryptionService()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åŠ å¯†ç”¨æˆ·æ•æ„Ÿä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> userData <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>  name<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;John Doe&#39;</span>,
</span></span><span style=display:flex><span>  email<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;john@example.com&#39;</span>,
</span></span><span style=display:flex><span>  ssn<span style=color:#ff7b72;font-weight:700>:</span> encryption.encrypt(<span style=color:#a5d6ff>&#39;123-45-6789&#39;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è§£å¯†
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> decryptedSSN <span style=color:#ff7b72;font-weight:700>=</span> encryption.decrypt(userData.ssn)
</span></span></code></pre></td></tr></table></div></div><h4 id=httpsé…ç½®>HTTPSé…ç½®<a hidden class=anchor aria-hidden=true href=#httpsé…ç½®>#</a></h4><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> https <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;https&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> fs <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;fs&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// HTTPSæœåŠ¡å™¨é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> httpsOptions <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>  key<span style=color:#ff7b72;font-weight:700>:</span> fs.readFileSync(<span style=color:#a5d6ff>&#39;/path/to/private.key&#39;</span>),
</span></span><span style=display:flex><span>  cert<span style=color:#ff7b72;font-weight:700>:</span> fs.readFileSync(<span style=color:#a5d6ff>&#39;/path/to/certificate.crt&#39;</span>),
</span></span><span style=display:flex><span>  ca<span style=color:#ff7b72;font-weight:700>:</span> fs.readFileSync(<span style=color:#a5d6ff>&#39;/path/to/ca_bundle.crt&#39;</span>),
</span></span><span style=display:flex><span>  minVersion<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;TLSv1.2&#39;</span>,
</span></span><span style=display:flex><span>  ciphers<span style=color:#ff7b72;font-weight:700>:</span> [
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;ECDHE-ECDSA-AES256-GCM-SHA384&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;ECDHE-RSA-AES256-GCM-SHA384&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;ECDHE-ECDSA-CHACHA20-POLY1305&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;ECDHE-RSA-CHACHA20-POLY1305&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;ECDHE-ECDSA-AES128-GCM-SHA256&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;ECDHE-RSA-AES128-GCM-SHA256&#39;</span>
</span></span><span style=display:flex><span>  ].join(<span style=color:#a5d6ff>&#39;:&#39;</span>),
</span></span><span style=display:flex><span>  honorCipherOrder<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> app <span style=color:#ff7b72;font-weight:700>=</span> express()
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> server <span style=color:#ff7b72;font-weight:700>=</span> https.createServer(httpsOptions, app)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// HSTSä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.use((req, res, next) =&gt; {
</span></span><span style=display:flex><span>  res.setHeader(
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;Strict-Transport-Security&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#39;max-age=31536000; includeSubDomains; preload&#39;</span>
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>  next()
</span></span><span style=display:flex><span>})
</span></span></code></pre></td></tr></table></div></div><h3 id=4-å®‰å…¨å¤´éƒ¨é…ç½®>4. å®‰å…¨å¤´éƒ¨é…ç½®<a hidden class=anchor aria-hidden=true href=#4-å®‰å…¨å¤´éƒ¨é…ç½®>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> helmet <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;helmet&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åŸºç¡€å®‰å…¨å¤´éƒ¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.use(helmet())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è‡ªå®šä¹‰å®‰å…¨å¤´éƒ¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.use(helmet({
</span></span><span style=display:flex><span>  contentSecurityPolicy<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>    directives<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>      defaultSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>],
</span></span><span style=display:flex><span>      styleSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>, <span style=color:#a5d6ff>&#34;&#39;unsafe-inline&#39;&#34;</span>, <span style=color:#a5d6ff>&#34;https://fonts.googleapis.com&#34;</span>],
</span></span><span style=display:flex><span>      scriptSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>, <span style=color:#a5d6ff>&#34;&#39;unsafe-inline&#39;&#34;</span>, <span style=color:#a5d6ff>&#34;https://cdn.trusted.com&#34;</span>],
</span></span><span style=display:flex><span>      imgSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>, <span style=color:#a5d6ff>&#34;data:&#34;</span>, <span style=color:#a5d6ff>&#34;https:&#34;</span>],
</span></span><span style=display:flex><span>      connectSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>, <span style=color:#a5d6ff>&#34;https://api.example.com&#34;</span>],
</span></span><span style=display:flex><span>      fontSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>, <span style=color:#a5d6ff>&#34;https://fonts.gstatic.com&#34;</span>],
</span></span><span style=display:flex><span>      objectSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;none&#39;&#34;</span>],
</span></span><span style=display:flex><span>      mediaSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>],
</span></span><span style=display:flex><span>      frameSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;none&#39;&#34;</span>],
</span></span><span style=display:flex><span>      manifestSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>],
</span></span><span style=display:flex><span>      workerSrc<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#34;&#39;self&#39;&#34;</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  crossOriginEmbedderPolicy<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>  hsts<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>    maxAge<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>31536000</span>,
</span></span><span style=display:flex><span>    includeSubDomains<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>    preload<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CORSé…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> cors <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;cors&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> corsOptions <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>  origin<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>function</span> (origin, callback) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> allowedOrigins <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#39;https://example.com&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#39;https://app.example.com&#39;</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>origin <span style=color:#ff7b72;font-weight:700>||</span> allowedOrigins.includes(origin)) {
</span></span><span style=display:flex><span>      callback(<span style=color:#79c0ff>null</span>, <span style=color:#79c0ff>true</span>)
</span></span><span style=display:flex><span>    } <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span>      callback(<span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;Not allowed by CORS&#39;</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  credentials<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>  optionsSuccessStatus<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>200</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(cors(corsOptions))
</span></span></code></pre></td></tr></table></div></div><h2 id=è¾“å…¥éªŒè¯å’Œæ¸…ç†>è¾“å…¥éªŒè¯å’Œæ¸…ç†<a hidden class=anchor aria-hidden=true href=#è¾“å…¥éªŒè¯å’Œæ¸…ç†>#</a></h2><h3 id=express-validatoré›†æˆ>Express-validatoré›†æˆ<a hidden class=anchor aria-hidden=true href=#express-validatoré›†æˆ>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> { body, param, query, validationResult } <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;express-validator&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> { sanitizeBody } <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;express-validator&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç”¨æˆ·æ³¨å†ŒéªŒè¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> validateUserRegistration <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>  body(<span style=color:#a5d6ff>&#39;email&#39;</span>)
</span></span><span style=display:flex><span>    .isEmail()
</span></span><span style=display:flex><span>    .normalizeEmail()
</span></span><span style=display:flex><span>    .withMessage(<span style=color:#a5d6ff>&#39;Valid email required&#39;</span>),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  body(<span style=color:#a5d6ff>&#39;password&#39;</span>)
</span></span><span style=display:flex><span>    .isLength({ min<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>8</span> })
</span></span><span style=display:flex><span>    .withMessage(<span style=color:#a5d6ff>&#39;Password must be at least 8 characters&#39;</span>)
</span></span><span style=display:flex><span>    .matches(<span style=color:#79c0ff>/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&amp;])[A-Za-z\d@$!%*?&amp;]/</span>)
</span></span><span style=display:flex><span>    .withMessage(<span style=color:#a5d6ff>&#39;Password must include uppercase, lowercase, number and special character&#39;</span>),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  body(<span style=color:#a5d6ff>&#39;name&#39;</span>)
</span></span><span style=display:flex><span>    .trim()
</span></span><span style=display:flex><span>    .isLength({ min<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>2</span>, max<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>50</span> })
</span></span><span style=display:flex><span>    .escape()
</span></span><span style=display:flex><span>    .withMessage(<span style=color:#a5d6ff>&#39;Name must be between 2 and 50 characters&#39;</span>),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  body(<span style=color:#a5d6ff>&#39;age&#39;</span>)
</span></span><span style=display:flex><span>    .optional()
</span></span><span style=display:flex><span>    .isInt({ min<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>13</span>, max<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>120</span> })
</span></span><span style=display:flex><span>    .withMessage(<span style=color:#a5d6ff>&#39;Age must be between 13 and 120&#39;</span>)
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ¸…ç†è¾“å…¥æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> sanitizeInput <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>  sanitizeBody(<span style=color:#a5d6ff>&#39;bio&#39;</span>).escape(),
</span></span><span style=display:flex><span>  sanitizeBody(<span style=color:#a5d6ff>&#39;website&#39;</span>).escape(),
</span></span><span style=display:flex><span>  sanitizeBody(<span style=color:#a5d6ff>&#39;location&#39;</span>).escape()
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// éªŒè¯ç»“æœå¤„ç†ä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>function</span> handleValidationErrors(req, res, next) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> errors <span style=color:#ff7b72;font-weight:700>=</span> validationResult(req)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>errors.isEmpty()) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({
</span></span><span style=display:flex><span>      error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Validation failed&#39;</span>,
</span></span><span style=display:flex><span>      details<span style=color:#ff7b72;font-weight:700>:</span> errors.array()
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  next()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.post(<span style=color:#a5d6ff>&#39;/api/users&#39;</span>,
</span></span><span style=display:flex><span>  validateUserRegistration,
</span></span><span style=display:flex><span>  sanitizeInput,
</span></span><span style=display:flex><span>  handleValidationErrors,
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>async</span> (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// å¤„ç†ç”¨æˆ·æ³¨å†Œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  }
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><h3 id=xssé˜²æŠ¤>XSSé˜²æŠ¤<a hidden class=anchor aria-hidden=true href=#xssé˜²æŠ¤>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> xss <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;xss&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> validator <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;validator&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// XSSè¿‡æ»¤å™¨é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> xssOptions <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>  whiteList<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>    a<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#39;href&#39;</span>, <span style=color:#a5d6ff>&#39;title&#39;</span>, <span style=color:#a5d6ff>&#39;target&#39;</span>],
</span></span><span style=display:flex><span>    b<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>    br<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>    em<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>    strong<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>    i<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>    li<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>    ol<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>    p<span style=color:#ff7b72;font-weight:700>:</span> [],
</span></span><span style=display:flex><span>    ul<span style=color:#ff7b72;font-weight:700>:</span> []
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  stripIgnoreTag<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>  stripIgnoreTagBody<span style=color:#ff7b72;font-weight:700>:</span> [<span style=color:#a5d6ff>&#39;script&#39;</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ¸…ç†ç”¨æˆ·è¾“å…¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>function</span> sanitizeInput(input) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>typeof</span> input <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;string&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> xss(validator.escape(input), xssOptions)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72>typeof</span> input <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;object&#39;</span> <span style=color:#ff7b72;font-weight:700>&amp;&amp;</span> input <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#79c0ff>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> sanitized <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> [key, value] <span style=color:#ff7b72>of</span> Object.entries(input)) {
</span></span><span style=display:flex><span>      sanitized[key] <span style=color:#ff7b72;font-weight:700>=</span> sanitizeInput(value)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> sanitized
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> input
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>function</span> sanitizeRequest(req, res, next) {
</span></span><span style=display:flex><span>  req.body <span style=color:#ff7b72;font-weight:700>=</span> sanitizeInput(req.body)
</span></span><span style=display:flex><span>  req.query <span style=color:#ff7b72;font-weight:700>=</span> sanitizeInput(req.query)
</span></span><span style=display:flex><span>  req.params <span style=color:#ff7b72;font-weight:700>=</span> sanitizeInput(req.params)
</span></span><span style=display:flex><span>  next()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(sanitizeRequest)
</span></span></code></pre></td></tr></table></div></div><h3 id=æ–‡ä»¶ä¸Šä¼ å®‰å…¨>æ–‡ä»¶ä¸Šä¼ å®‰å…¨<a hidden class=anchor aria-hidden=true href=#æ–‡ä»¶ä¸Šä¼ å®‰å…¨>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">83
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> multer <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;multer&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> path <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;path&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> fs <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;fs&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ–‡ä»¶è¿‡æ»¤å™¨
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> fileFilter <span style=color:#ff7b72;font-weight:700>=</span> (req, file, cb) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> allowedTypes <span style=color:#ff7b72;font-weight:700>=</span> [<span style=color:#a5d6ff>&#39;image/jpeg&#39;</span>, <span style=color:#a5d6ff>&#39;image/png&#39;</span>, <span style=color:#a5d6ff>&#39;image/gif&#39;</span>, <span style=color:#a5d6ff>&#39;application/pdf&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (allowedTypes.includes(file.mimetype)) {
</span></span><span style=display:flex><span>    cb(<span style=color:#79c0ff>null</span>, <span style=color:#79c0ff>true</span>)
</span></span><span style=display:flex><span>  } <span style=color:#ff7b72>else</span> {
</span></span><span style=display:flex><span>    cb(<span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;Invalid file type&#39;</span>), <span style=color:#79c0ff>false</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å­˜å‚¨é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> storage <span style=color:#ff7b72;font-weight:700>=</span> multer.diskStorage({
</span></span><span style=display:flex><span>  destination<span style=color:#ff7b72;font-weight:700>:</span> (req, file, cb) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> uploadDir <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;uploads/&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>fs.existsSync(uploadDir)) {
</span></span><span style=display:flex><span>      fs.mkdirSync(uploadDir, { recursive<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span> })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    cb(<span style=color:#79c0ff>null</span>, uploadDir)
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  filename<span style=color:#ff7b72;font-weight:700>:</span> (req, file, cb) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> uniqueSuffix <span style=color:#ff7b72;font-weight:700>=</span> Date.now() <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>&#39;-&#39;</span> <span style=color:#ff7b72;font-weight:700>+</span> Math.round(Math.random() <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1E9</span>)
</span></span><span style=display:flex><span>    cb(<span style=color:#79c0ff>null</span>, uniqueSuffix <span style=color:#ff7b72;font-weight:700>+</span> path.extname(file.originalname))
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> upload <span style=color:#ff7b72;font-weight:700>=</span> multer({
</span></span><span style=display:flex><span>  storage,
</span></span><span style=display:flex><span>  fileFilter,
</span></span><span style=display:flex><span>  limits<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>    fileSize<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>5</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1024</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1024</span>, <span style=color:#8b949e;font-style:italic>// 5MB
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    files<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç—…æ¯’æ‰«æé›†æˆ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> ClamScan <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;clamscan&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> scanFile(filePath) {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> clamscan <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> <span style=color:#ff7b72>new</span> ClamScan().init()
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> scanResult <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> clamscan.scanFile(filePath)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> scanResult.isInfected
</span></span><span style=display:flex><span>  } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>    console.error(<span style=color:#a5d6ff>&#39;Virus scan error:&#39;</span>, error)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>true</span> <span style=color:#8b949e;font-style:italic>// ä¿å®ˆå¤„ç†ï¼Œè®¤ä¸ºå¯èƒ½æ„ŸæŸ“
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ–‡ä»¶ä¸Šä¼ è·¯ç”±
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.post(<span style=color:#a5d6ff>&#39;/upload&#39;</span>, upload.single(<span style=color:#a5d6ff>&#39;file&#39;</span>), <span style=color:#ff7b72>async</span> (req, res) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>req.file) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;No file uploaded&#39;</span> })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// ç—…æ¯’æ‰«æ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    <span style=color:#ff7b72>const</span> isInfected <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> scanFile(req.file.path)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (isInfected) {
</span></span><span style=display:flex><span>      fs.unlinkSync(req.file.path)
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;File contains virus&#39;</span> })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    res.json({
</span></span><span style=display:flex><span>      message<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;File uploaded successfully&#39;</span>,
</span></span><span style=display:flex><span>      file<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>        filename<span style=color:#ff7b72;font-weight:700>:</span> req.file.filename,
</span></span><span style=display:flex><span>        originalName<span style=color:#ff7b72;font-weight:700>:</span> req.file.originalname,
</span></span><span style=display:flex><span>        size<span style=color:#ff7b72;font-weight:700>:</span> req.file.size
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> (req.file) {
</span></span><span style=display:flex><span>      fs.unlinkSync(req.file.path)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    res.status(<span style=color:#a5d6ff>500</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Upload failed&#39;</span> })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span></code></pre></td></tr></table></div></div><h2 id=ä¾èµ–å®‰å…¨>ä¾èµ–å®‰å…¨<a hidden class=anchor aria-hidden=true href=#ä¾èµ–å®‰å…¨>#</a></h2><h3 id=ä¾èµ–æ¼æ´æ‰«æ>ä¾èµ–æ¼æ´æ‰«æ<a hidden class=anchor aria-hidden=true href=#ä¾èµ–æ¼æ´æ‰«æ>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨npm audit
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>{
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;scripts&#34;</span><span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;audit&#34;</span><span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#34;npm audit&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;audit:fix&#34;</span><span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#34;npm audit fix&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;security-check&#34;</span><span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#34;npm audit --audit-level moderate&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨Snykè¿›è¡Œå®‰å…¨æ‰«æ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> snyk <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;snyk&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> checkVulnerabilities() {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> snyk.test()
</span></span><span style=display:flex><span>    console.log(<span style=color:#a5d6ff>&#39;No vulnerabilities found&#39;</span>)
</span></span><span style=display:flex><span>  } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>    console.error(<span style=color:#a5d6ff>&#39;Vulnerabilities detected:&#39;</span>, error)
</span></span><span style=display:flex><span>    process.exit(<span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// CI/CDé›†æˆ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>if</span> (process.env.CI) {
</span></span><span style=display:flex><span>  checkVulnerabilities()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=å®‰å…¨çš„ä¾èµ–ç®¡ç†>å®‰å…¨çš„ä¾èµ–ç®¡ç†<a hidden class=anchor aria-hidden=true href=#å®‰å…¨çš„ä¾èµ–ç®¡ç†>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8b949e;font-style:italic># package.jsoné…ç½®</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;engines&#34;</span>: <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;node&#34;</span>: <span style=color:#a5d6ff>&#34;&gt;=14.0.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;npm&#34;</span>: <span style=color:#a5d6ff>&#34;&gt;=6.0.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72;font-weight:700>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;dependencies&#34;</span>: <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;express&#34;</span>: <span style=color:#a5d6ff>&#34;4.17.1&#34;</span>,  // é”å®šç‰ˆæœ¬
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;lodash&#34;</span>: <span style=color:#a5d6ff>&#34;^4.17.20&#34;</span>   // å…è®¸è¡¥ä¸æ›´æ–°
</span></span><span style=display:flex><span>  <span style=color:#ff7b72;font-weight:700>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#a5d6ff>&#34;overrides&#34;</span>: <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;lodash&#34;</span>: <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a5d6ff>&#34;node&#34;</span>: <span style=color:#a5d6ff>&#34;^14.17.0&#34;</span>   // è¦†ç›–å­ä¾èµ–
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// è¿è¡Œæ—¶ä¾èµ–éªŒè¯
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> { execSync } <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;child_process&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> semver <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;semver&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>function</span> checkNodeVersion() {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> nodeVersion <span style=color:#ff7b72;font-weight:700>=</span> process.version
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> minVersion <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;../package.json&#39;</span>).engines.node.replace(<span style=color:#a5d6ff>&#39;&gt;=&#39;</span>, <span style=color:#a5d6ff>&#39;&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>semver.satisfies(nodeVersion, minVersion)) {
</span></span><span style=display:flex><span>    console.error(<span style=color:#a5d6ff>`Node.js version </span><span style=color:#a5d6ff>${</span>nodeVersion<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> is not supported. Please use </span><span style=color:#a5d6ff>${</span>minVersion<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>`</span>)
</span></span><span style=display:flex><span>    process.exit(<span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>function</span> checkDependencies() {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> output <span style=color:#ff7b72;font-weight:700>=</span> execSync(<span style=color:#a5d6ff>&#39;npm ls --depth=0&#39;</span>, { encoding<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;utf8&#39;</span> })
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> lines <span style=color:#ff7b72;font-weight:700>=</span> output.split(<span style=color:#a5d6ff>&#39;\n&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> line <span style=color:#ff7b72>of</span> lines) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>if</span> (line.includes(<span style=color:#a5d6ff>&#39;UNMET DEPENDENCY&#39;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;Unmet dependencies detected&#39;</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#ff7b72>catch</span> (error) {
</span></span><span style=display:flex><span>    console.error(<span style=color:#a5d6ff>&#39;Dependency check failed:&#39;</span>, error.message)
</span></span><span style=display:flex><span>    process.exit(<span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>checkNodeVersion()
</span></span><span style=display:flex><span>checkDependencies()
</span></span></code></pre></td></tr></table></div></div><h2 id=é”™è¯¯å¤„ç†å’Œæ—¥å¿—>é”™è¯¯å¤„ç†å’Œæ—¥å¿—<a hidden class=anchor aria-hidden=true href=#é”™è¯¯å¤„ç†å’Œæ—¥å¿—>#</a></h2><h3 id=å®‰å…¨çš„é”™è¯¯å¤„ç†>å®‰å…¨çš„é”™è¯¯å¤„ç†<a hidden class=anchor aria-hidden=true href=#å®‰å…¨çš„é”™è¯¯å¤„ç†>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>function</span> errorHandler(err, req, res, next) {
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// è®°å½•é”™è¯¯ï¼ˆä¸æš´éœ²æ•æ„Ÿä¿¡æ¯ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  console.error(<span style=color:#a5d6ff>&#39;Error:&#39;</span>, {
</span></span><span style=display:flex><span>    message<span style=color:#ff7b72;font-weight:700>:</span> err.message,
</span></span><span style=display:flex><span>    stack<span style=color:#ff7b72;font-weight:700>:</span> process.env.NODE_ENV <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;development&#39;</span> <span style=color:#ff7b72;font-weight:700>?</span> err.stack <span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>undefined</span>,
</span></span><span style=display:flex><span>    timestamp<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>new</span> Date().toISOString(),
</span></span><span style=display:flex><span>    requestId<span style=color:#ff7b72;font-weight:700>:</span> req.id,
</span></span><span style=display:flex><span>    path<span style=color:#ff7b72;font-weight:700>:</span> req.path,
</span></span><span style=display:flex><span>    method<span style=color:#ff7b72;font-weight:700>:</span> req.method
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ä¸æš´éœ²å†…éƒ¨é”™è¯¯è¯¦æƒ…
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>let</span> statusCode <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>500</span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>let</span> message <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;Internal Server Error&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (err.name <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;ValidationError&#39;</span>) {
</span></span><span style=display:flex><span>    statusCode <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>400</span>
</span></span><span style=display:flex><span>    message <span style=color:#ff7b72;font-weight:700>=</span> err.message
</span></span><span style=display:flex><span>  } <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> (err.name <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;UnauthorizedError&#39;</span>) {
</span></span><span style=display:flex><span>    statusCode <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>401</span>
</span></span><span style=display:flex><span>    message <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;Unauthorized&#39;</span>
</span></span><span style=display:flex><span>  } <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> (err.name <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;ForbiddenError&#39;</span>) {
</span></span><span style=display:flex><span>    statusCode <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>403</span>
</span></span><span style=display:flex><span>    message <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;Forbidden&#39;</span>
</span></span><span style=display:flex><span>  } <span style=color:#ff7b72>else</span> <span style=color:#ff7b72>if</span> (err.name <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;NotFoundError&#39;</span>) {
</span></span><span style=display:flex><span>    statusCode <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>404</span>
</span></span><span style=display:flex><span>    message <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#39;Resource not found&#39;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  res.status(statusCode).json({
</span></span><span style=display:flex><span>    error<span style=color:#ff7b72;font-weight:700>:</span> message,
</span></span><span style=display:flex><span>    requestId<span style=color:#ff7b72;font-weight:700>:</span> req.id,
</span></span><span style=display:flex><span>    timestamp<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>new</span> Date().toISOString()
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(errorHandler)
</span></span></code></pre></td></tr></table></div></div><h3 id=å®‰å…¨æ—¥å¿—è®°å½•>å®‰å…¨æ—¥å¿—è®°å½•<a hidden class=anchor aria-hidden=true href=#å®‰å…¨æ—¥å¿—è®°å½•>#</a></h3><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">55
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> winston <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;winston&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> { requestId } <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;./middleware/requestId&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// æ—¥å¿—é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> logger <span style=color:#ff7b72;font-weight:700>=</span> winston.createLogger({
</span></span><span style=display:flex><span>  level<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;info&#39;</span>,
</span></span><span style=display:flex><span>  format<span style=color:#ff7b72;font-weight:700>:</span> winston.format.combine(
</span></span><span style=display:flex><span>    winston.format.timestamp(),
</span></span><span style=display:flex><span>    winston.format.errors({ stack<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span> }),
</span></span><span style=display:flex><span>    winston.format.json()
</span></span><span style=display:flex><span>  ),
</span></span><span style=display:flex><span>  defaultMeta<span style=color:#ff7b72;font-weight:700>:</span> { service<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;api-service&#39;</span> },
</span></span><span style=display:flex><span>  transports<span style=color:#ff7b72;font-weight:700>:</span> [
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>new</span> winston.transports.File({
</span></span><span style=display:flex><span>      filename<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;logs/error.log&#39;</span>,
</span></span><span style=display:flex><span>      level<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;error&#39;</span>
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>new</span> winston.transports.File({
</span></span><span style=display:flex><span>      filename<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;logs/combined.log&#39;</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>if</span> (process.env.NODE_ENV <span style=color:#ff7b72;font-weight:700>!==</span> <span style=color:#a5d6ff>&#39;production&#39;</span>) {
</span></span><span style=display:flex><span>  logger.add(<span style=color:#ff7b72>new</span> winston.transports.Console({
</span></span><span style=display:flex><span>    format<span style=color:#ff7b72;font-weight:700>:</span> winston.format.simple()
</span></span><span style=display:flex><span>  }))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// å®‰å…¨äº‹ä»¶æ—¥å¿—
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>function</span> logSecurityEvent(event, req, details <span style=color:#ff7b72;font-weight:700>=</span> {}) {
</span></span><span style=display:flex><span>  logger.warn(<span style=color:#a5d6ff>&#39;Security Event&#39;</span>, {
</span></span><span style=display:flex><span>    event,
</span></span><span style=display:flex><span>    ip<span style=color:#ff7b72;font-weight:700>:</span> req.ip,
</span></span><span style=display:flex><span>    userAgent<span style=color:#ff7b72;font-weight:700>:</span> req.get(<span style=color:#a5d6ff>&#39;User-Agent&#39;</span>),
</span></span><span style=display:flex><span>    requestId<span style=color:#ff7b72;font-weight:700>:</span> req.id,
</span></span><span style=display:flex><span>    timestamp<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>new</span> Date().toISOString(),
</span></span><span style=display:flex><span>    ...details
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä½¿ç”¨ç¤ºä¾‹
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>app.use((req, res, next) =&gt; {
</span></span><span style=display:flex><span>  req.id <span style=color:#ff7b72;font-weight:700>=</span> Math.random().toString(<span style=color:#a5d6ff>36</span>).substr(<span style=color:#a5d6ff>2</span>, <span style=color:#a5d6ff>9</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// è®°å½•æ•æ„Ÿæ“ä½œ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  <span style=color:#ff7b72>if</span> (req.path.includes(<span style=color:#a5d6ff>&#39;/admin&#39;</span>) <span style=color:#ff7b72;font-weight:700>||</span> req.path.includes(<span style=color:#a5d6ff>&#39;/auth&#39;</span>)) {
</span></span><span style=display:flex><span>    logSecurityEvent(<span style=color:#a5d6ff>&#39;Sensitive Access&#39;</span>, req, {
</span></span><span style=display:flex><span>      path<span style=color:#ff7b72;font-weight:700>:</span> req.path,
</span></span><span style=display:flex><span>      method<span style=color:#ff7b72;font-weight:700>:</span> req.method
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  next()
</span></span><span style=display:flex><span>})
</span></span></code></pre></td></tr></table></div></div><h2 id=ä¼šè¯å’Œcookieå®‰å…¨>ä¼šè¯å’ŒCookieå®‰å…¨<a hidden class=anchor aria-hidden=true href=#ä¼šè¯å’Œcookieå®‰å…¨>#</a></h2><div class=highlight><div style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#737679">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff7b72>const</span> session <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;express-session&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> cookieParser <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;cookie-parser&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> MongoStore <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;connect-mongo&#39;</span>)(session)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ä¼šè¯é…ç½®
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> sessionConfig <span style=color:#ff7b72;font-weight:700>=</span> {
</span></span><span style=display:flex><span>  name<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;sessionId&#39;</span>, <span style=color:#8b949e;font-style:italic>// é¿å…é»˜è®¤åç§°
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  secret<span style=color:#ff7b72;font-weight:700>:</span> process.env.SESSION_SECRET,
</span></span><span style=display:flex><span>  resave<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>  saveUninitialized<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>false</span>,
</span></span><span style=display:flex><span>  store<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#ff7b72>new</span> MongoStore({
</span></span><span style=display:flex><span>    url<span style=color:#ff7b72;font-weight:700>:</span> process.env.MONGODB_URI,
</span></span><span style=display:flex><span>    collection<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;sessions&#39;</span>
</span></span><span style=display:flex><span>  }),
</span></span><span style=display:flex><span>  cookie<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>    httpOnly<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>, <span style=color:#8b949e;font-style:italic>// é˜²æ­¢XSS
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    secure<span style=color:#ff7b72;font-weight:700>:</span> process.env.NODE_ENV <span style=color:#ff7b72;font-weight:700>===</span> <span style=color:#a5d6ff>&#39;production&#39;</span>, <span style=color:#8b949e;font-style:italic>// HTTPS only
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    sameSite<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;strict&#39;</span>, <span style=color:#8b949e;font-style:italic>// CSRFé˜²æŠ¤
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    maxAge<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>24</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span> <span style=color:#8b949e;font-style:italic>// 24å°æ—¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.use(session(sessionConfig))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// é€Ÿç‡é™åˆ¶
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>const</span> rateLimit <span style=color:#ff7b72;font-weight:700>=</span> require(<span style=color:#a5d6ff>&#39;express-rate-limit&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>const</span> loginLimiter <span style=color:#ff7b72;font-weight:700>=</span> rateLimit({
</span></span><span style=display:flex><span>  windowMs<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>15</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>60</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>1000</span>, <span style=color:#8b949e;font-style:italic>// 15åˆ†é’Ÿ
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  max<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>5</span>, <span style=color:#8b949e;font-style:italic>// é™åˆ¶5æ¬¡å°è¯•
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  skipSuccessfulRequests<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#79c0ff>true</span>,
</span></span><span style=display:flex><span>  handler<span style=color:#ff7b72;font-weight:700>:</span> (req, res) =&gt; {
</span></span><span style=display:flex><span>    logSecurityEvent(<span style=color:#a5d6ff>&#39;Rate Limit Exceeded&#39;</span>, req, {
</span></span><span style=display:flex><span>      endpoint<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;/login&#39;</span>,
</span></span><span style=display:flex><span>      attempts<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>5</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    res.status(<span style=color:#a5d6ff>429</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Too many login attempts&#39;</span> })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.post(<span style=color:#a5d6ff>&#39;/login&#39;</span>, loginLimiter, <span style=color:#ff7b72>async</span> (req, res) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#8b949e;font-style:italic>// ç™»å½•é€»è¾‘
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>})
</span></span></code></pre></td></tr></table></div></div><h2 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h2><p>Node.jsåº”ç”¨å®‰å…¨éœ€è¦å¤šå±‚æ¬¡çš„é˜²æŠ¤ç­–ç•¥ï¼š</p><p><strong>åŸºç¡€é˜²æŠ¤ï¼š</strong></p><ol><li>è¾“å…¥éªŒè¯å’Œæ¸…ç†</li><li>è¾“å‡ºç¼–ç å’ŒXSSé˜²æŠ¤</li><li>SQL/NoSQLæ³¨å…¥é˜²æŠ¤</li><li>æ–‡ä»¶ä¸Šä¼ å®‰å…¨</li></ol><p><strong>è®¤è¯å’Œæˆæƒï¼š</strong></p><ol><li>å¼ºå¯†ç ç­–ç•¥</li><li>å®‰å…¨çš„ä¼šè¯ç®¡ç†</li><li>JWTä»¤ç‰Œå®‰å…¨</li><li>è§’è‰²æƒé™æ§åˆ¶</li></ol><p><strong>æ•°æ®ä¿æŠ¤ï¼š</strong></p><ol><li>HTTPSåŠ å¯†ä¼ è¾“</li><li>æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨</li><li>å®‰å…¨å¤´éƒ¨é…ç½®</li><li>ä¾èµ–æ¼æ´ç®¡ç†</li></ol><p><strong>ç›‘æ§å’Œå“åº”ï¼š</strong></p><ol><li>å®‰å…¨äº‹ä»¶æ—¥å¿—</li><li>é”™è¯¯å¤„ç†æœºåˆ¶</li><li>é€Ÿç‡é™åˆ¶</li><li>å®‰å…¨å®¡è®¡</li></ol><p>éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œå¯ä»¥å¤§å¤§æé«˜Node.jsåº”ç”¨çš„å®‰å…¨æ€§ï¼Œä¿æŠ¤åº”ç”¨å’Œç”¨æˆ·æ•°æ®å…å—æ”»å‡»ã€‚</p><hr><p><strong>ç›¸å…³èµ„æºï¼š</strong></p><ul><li><a href=https://owasp.org/www-project-top-ten/>OWASP Top 10</a></li><li><a href=https://github.com/goldbergyoni/nodebestpractices#-security-best-practices>Node.js Security Checklist</a></li><li><a href=https://expressjs.com/en/advanced/security-best-practices.html>Express Security Best Practices</a></li><li><a href=https://snyk.io/vuln/>Snyk Vulnerability Database</a></li></ul></div><footer class=post-footer-modern><div class=post-tags-modern><span class=tags-label>ğŸ·ï¸ æ ‡ç­¾</span><div class=tags-list><a href=/blog/tags/node.js/ class=tag-pill>Node.js
</a><a href=/blog/tags/%E5%AE%89%E5%85%A8/ class=tag-pill>å®‰å…¨
</a><a href=/blog/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/ class=tag-pill>åç«¯å¼€å‘
</a><a href=/blog/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/ class=tag-pill>ç½‘ç»œå®‰å…¨
</a><a href=/blog/tags/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/ class=tag-pill>æœ€ä½³å®è·µ</a></div></div><style>.post-footer-modern{margin-top:3rem;padding-top:2rem;border-top:1px solid var(--border,#333333)}.post-tags-modern{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}.tags-label{font-size:.875rem;font-weight:600;color:var(--secondary,#999999) !important;white-space:nowrap}.tags-list{display:flex;flex-wrap:wrap;gap:.5rem;flex:1}.tag-pill{display:inline-block;padding:.25rem .75rem;background:rgba(255,255,255,5%);border:1px solid var(--border,#333333);border-radius:0;color:var(--secondary,#cccccc) !important;text-decoration:none;font-size:.8rem;font-weight:500;transition:all .2s ease}.tag-pill:hover{background:var(--primary,#ffffff);color:var(--background,#000000) !important;border-color:var(--primary,#ffffff);transform:translateY(-1px)}.post-nav-modern{margin-top:2rem}.nav-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.nav-card{display:flex;align-items:center;gap:1rem;padding:1.25rem;background:rgba(255,255,255,2%);border:1px solid var(--border,#333333);border-radius:12px;text-decoration:none;transition:all .2s ease;min-height:80px}.nav-card:hover{background:rgba(255,255,255,5%);border-color:var(--primary,#ffffff);transform:translateY(-2px)}.nav-card.nav-prev{justify-content:flex-start}.nav-card.nav-next{justify-content:flex-end;text-align:right}.nav-card.nav-next .nav-content{text-align:right}.nav-empty{display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,1%);border:1px dashed var(--border,#333333);color:var(--secondary,#666666)}.nav-arrow{font-size:1.5rem;color:var(--primary,#ffffff);font-weight:300}.nav-content{flex:1}.nav-title{font-size:.95rem;font-weight:600;color:var(--primary,#ffffff) !important;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}[data-theme=light] .post-footer-modern{border-color:var(--border-light,#dee2e6)}[data-theme=light] .tags-label{color:var(--secondary-light,#6c757d) !important}[data-theme=light] .tag-pill{background:rgba(0,0,0,5%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#495057) !important}[data-theme=light] .tag-pill:hover{background:var(--primary-light,#0066cc);color:var(--background-light,#ffffff) !important;border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-card{background:rgba(0,0,0,2%);border-color:var(--border-light,#dee2e6)}[data-theme=light] .nav-card:hover{background:rgba(0,102,204,5%);border-color:var(--primary-light,#0066cc)}[data-theme=light] .nav-empty{background:rgba(0,0,0,1%);border-color:var(--border-light,#dee2e6);color:var(--secondary-light,#6c757d)}[data-theme=light] .nav-arrow{color:var(--primary-light,#0066cc)}[data-theme=light] .nav-title{color:var(--primary-light,#212529) !important}@media(max-width:768px){.nav-grid{grid-template-columns:1fr;gap:.75rem}.nav-card{padding:1rem;min-height:70px}.nav-card.nav-next{text-align:left}.nav-card.nav-next .nav-content{text-align:left}.nav-title{font-size:.875rem}.post-tags-modern{flex-direction:column;gap:.75rem}}@media(max-width:480px){.nav-arrow{font-size:1.25rem}.nav-card{padding:.875rem}.nav-title{font-size:.8rem;-webkit-line-clamp:1}}</style><nav class=post-nav-modern><div class=nav-grid><a href=/blog/articles/git-advanced-techniques/ class="nav-card nav-prev"><div class=nav-arrow>â†</div><div class=nav-content><div class=nav-title>Gité«˜çº§æŠ€å·§ï¼šæŒæ¡ç‰ˆæœ¬æ§åˆ¶çš„ç²¾é«“</div></div></a><a href=/blog/articles/web-accessibility-guide/ class="nav-card nav-next"><div class=nav-content><div class=nav-title>Webæ— éšœç¢å®è·µæŒ‡å—ï¼šæ„å»ºåŒ…å®¹æ€§ç½‘ç»œåº”ç”¨</div></div><div class=nav-arrow>â†’</div></a></div></nav></footer></main><aside class=post-sidebar><div class=sidebar-toc id=sidebar-toc><div class=toc-header><div class=toc-title>ç›®å½•</div><button class=toc-toggle id=toc-toggle aria-label="Toggle TOC">
<svg class="toc-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button></div><div class=toc-content id=toc-content><ul class=toc-list><li class="toc-item toc-h2"><a href=#h2-0 class=toc-item-link><span class=toc-item-text>å¼•è¨€</span></a></li><li class="toc-item toc-h2"><a href=#h2-1 class=toc-item-link><span class=toc-item-text>OWASP Top 10é˜²æŠ¤</span></a></li><li class="toc-item toc-h2"><a href=#h2-2 class=toc-item-link><span class=toc-item-text>è¾“å…¥éªŒè¯å’Œæ¸…ç†</span></a></li><li class="toc-item toc-h2"><a href=#h2-3 class=toc-item-link><span class=toc-item-text>ä¾èµ–å®‰å…¨</span></a></li><li class="toc-item toc-h2"><a href=#h2-4 class=toc-item-link><span class=toc-item-text>é”™è¯¯å¤„ç†å’Œæ—¥å¿—</span></a></li><li class="toc-item toc-h2"><a href=#h2-5 class=toc-item-link><span class=toc-item-text>ä¼šè¯å’ŒCookieå®‰å…¨</span></a></li><li class="toc-item toc-h2"><a href=#h2-6 class=toc-item-link><span class=toc-item-text>æ€»ç»“</span></a></li></ul></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("sidebar-toc"),t=document.getElementById("toc-toggle"),o=document.getElementById("toc-content"),i=t?.querySelector(".toc-toggle-icon");if(!e)return;let n=!1;t&&t.addEventListener("click",function(){n=!n,n?(o.style.display="none",e.style.width="auto",i.innerHTML='<path d="M9 18l6-6-6-6"/>'):(o.style.display="block",e.style.width="200px",i.innerHTML='<path d="M18 6L6 18M6 6l12 12"/>')});const s=document.querySelector(".post-content");if(s){const e=s.querySelectorAll("h1");e.forEach((e,t)=>{e.id=`h1-${t}`});const t=s.querySelectorAll("h2");t.forEach((e,t)=>{e.id=`h2-${t}`})}const a=document.querySelectorAll(".toc-item-link");a.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const n=this.getAttribute("href").substring(1),t=document.getElementById(n);if(t){const e=document.querySelector(".post-header-main")?.offsetHeight||0,n=t.offsetTop-e-20;window.scrollTo({top:n,behavior:"smooth"})}})})})</script><style>.sidebar-toc{position:sticky;top:2rem;width:200px;background:#fff;border:1px solid #e5e7eb;border-radius:4px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1);z-index:100}.sidebar-toc.hidden{display:none}.toc-header{padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#fafbfc;display:flex;align-items:center;justify-content:space-between}.toc-title{margin:0;font-size:13px;font-weight:500;color:#374151 !important;font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,sans-serif;text-transform:uppercase;letter-spacing:1px}.toc-toggle{background:0 0;border:none;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .2s ease;color:#6b7280}.toc-toggle:hover{background:#e5e7eb;color:#374151}.toc-toggle-icon{transition:transform .2s ease}.toc-content{padding:12px 0}.toc-list{list-style:none;margin:0;padding:0}.toc-item{margin-bottom:4px;display:block !important;visibility:visible !important}.toc-h1,.toc-h2{display:block !important}.toc-h2{margin-left:0}.toc-item-link{display:flex;align-items:center;gap:8px;padding:8px 12px;color:#374151 !important;text-decoration:none;font-size:13px;line-height:1.4;border-radius:3px;transition:all .2s ease;font-weight:400}.toc-item-link:hover{background:#f8fafc;color:#1f2937 !important}.toc-item-link.active{background:#e0f2fe;color:#01579b !important;font-weight:500}.toc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}.dot-red{background:#ef4444}.dot-blue{background:#2196f3}.toc-item-text{color:#1f2937 !important;font-weight:400;flex:1;display:inline !important;visibility:visible !important;opacity:1 !important;font-size:13px !important;line-height:1.4 !important}.toc-item-link .toc-item-text{color:#1f2937 !important;display:inline !important;visibility:visible !important;opacity:1 !important}.toc-item.active .dot-red{background:#d32f2f}.toc-item.active .dot-blue{background:#1976d2}[data-theme=dark] .sidebar-toc{background:#1f2937;border-color:#374151;box-shadow:0 1px 3px rgba(0,0,0,.3)}[data-theme=dark] .toc-header{background:#111827;border-color:#374151}[data-theme=dark] .toc-title{color:#f3f4f6 !important}[data-theme=dark] .toc-toggle{color:#9ca3af}[data-theme=dark] .toc-toggle:hover{background:#374151;color:#f3f4f6}[data-theme=dark] .toc-item-link{color:#e5e7eb !important}[data-theme=dark] .toc-item-link:hover{background:#374151;color:#f9fafb !important}[data-theme=dark] .toc-item-link.active{background:#0d47a1;color:#fff !important}[data-theme=dark] .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}[data-theme=dark] .toc-item-link .toc-item-text{color:#f9fafb !important;display:inline !important;visibility:visible !important;opacity:1 !important}@media(max-width:1024px){.sidebar-toc{display:none}.post-content-wrapper{grid-template-columns:1fr !important;padding:0 1rem !important}}</style><style>.post-content-wrapper{display:grid;grid-template-columns:1fr 200px;gap:2rem;padding:0 2rem;max-width:100%}.post-content-main{min-width:0}.post-sidebar{position:sticky;top:2rem;height:fit-content;min-width:0}.post-header-main{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border,#333333)}.post-header-main .post-title{color:var(--primary,#ffffff) !important;font-size:2.5rem;font-weight:700;line-height:1.2;margin-bottom:1rem}.post-header-main .post-description{color:var(--secondary,#cccccc) !important;font-size:1.1rem;line-height:1.6;margin-bottom:1rem}.post-header-main .post-meta{margin-bottom:0}@media(max-width:1024px){.post-content-wrapper{grid-template-columns:1fr !important;gap:1rem;padding:0 1rem !important}.post-sidebar{display:none}}@media(max-width:768px){.post-header-main .post-title{font-size:2rem}.post-header-main .post-description{font-size:1rem}}</style></aside></div></article></main><footer class=footer><span>Â© 2024-2025 æœ‰æ¡å·¥å…·æŠ€æœ¯åšå®¢</span> Â·</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>